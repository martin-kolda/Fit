<!doctype html>
<html data-theme="max">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prototype prototype</title>
  
  <!-- Favions -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- CDN / dependecies -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/2c7f1c6cae.js" crossorigin="anonymous"></script> 
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="./theme/max-tokens.css"> 
  <script> // cannot be loaded by classic link
    fetch('./theme/tw-mapping.css', { cache: 'no-store' }).then(r => r.text()).then(css => {const s = document.createElement('style');s.type = 'text/tailwindcss';s.textContent = css;document.head.appendChild(s);});
  </script>
  <link rel="stylesheet" href="./theme/max.css" type="text/css">
  <script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>

  <style>
  [x-cloak]{display:none}
  @keyframes slideInLeft  { from { transform: translateX(-6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  @keyframes slideInRight { from { transform: translateX( 6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  .slide-in-left  { animation: slideInLeft  .18s ease-out; }
  .slide-in-right { animation: slideInRight .18s ease-out; }
  body {font-family: 'Figtree', sans-serif;}
  .leaflet-container img { max-width: none !important; }
  .ms-overlay-panel {height: 100vh; max-height: 100vh;}
  @supports (height: 100lvh) { .ms-overlay-panel { height: 100lvh; max-height: 100lvh;}}
  .reflection {-webkit-box-reflect: below -80px linear-gradient(transparent 60%, rgba(0, 0, 0, .5) 100%);}
  .free-ship-bar .fill { position: relative; }
  .free-ship-bar .fill.shimmer::after {content: "";position: absolute;inset: 0; background-image: linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,0.35) 18%,rgba(255,255,255,0) 36%);background-size: 200% 100%;animation: bar-shimmer 2.6s linear infinite;pointer-events: none;}
  @keyframes bar-shimmer {0%   { background-position: 50% 0; } 30%  { background-position: -100% 0; } 100% { background-position: -100% 0; }}
  @media (prefers-reduced-motion: reduce) {.free-ship-bar .fill.shimmer::after { animation: none; }}  

.timeline.no-start > li {grid-template-columns: auto 1fr !important;}
.timeline.no-start > li > .timeline-middle { grid-column: 1 !important; justify-self: center; }
.timeline.no-start > li > .timeline-end    { grid-column: 2 / -1 !important; padding-left: 0 !important; margin-left: 0 !important; }
.timeline.no-start > li > hr {grid-column: 1 !important; justify-self: center !important; align-self: stretch !important; width: 2px !important; border: 0 !important; }

  /* isolate each slide's painting & stacking on iOS to stop z-index flicker */
.banner-slide{
  isolation: isolate;          /* new stacking context */
  contain: paint;              /* confine repaints */
  -webkit-transform: translateZ(0); /* force its own layer on Safari */
  transform: translateZ(0);
  backface-visibility: hidden; /* reduce flicker */
}

/* make the moving track a GPU layer too */
.banner-track{
  will-change: transform;
  transform: translateZ(0);
}

/* optional: on very small screens, avoid backdrop compositing cost on chevrons */
@media (max-width: 640px){
  .banner-chevron{ -webkit-backdrop-filter: none; backdrop-filter: none; }
}



/* Base: set your normal button radius once */
.btn-squish {
  --br: 0.75rem;          /* change if your theme uses a different radius */
  border-radius: var(--br);
  will-change: transform, border-radius;
}

/* Trigger class; adjust duration freely (0.28s ... 1s) */
.btn-squish.is-squishing {
  animation: br-bounce var(--squish-dur, 1s) both;
}

/* Smoother, long-duration friendly bounce */
@keyframes br-bounce {
  /* press in */
  0% {
    transform: scale(1);
    border-radius: var(--br);
    animation-timing-function: cubic-bezier(.2,.7,.2,1); /* ease-in-ish */
  }
  35% {
    transform: scale(.985, .96);
    border-radius: calc(var(--br) - 0.20rem);
  }

  /* rebound */
  65% {
    transform: scale(1.018, 1.035);
    border-radius: calc(var(--br) + 0.10rem);
    animation-timing-function: cubic-bezier(.16,.84,.38,1); /* smooth ease-out */
  }

  /* settle */
  100% {
    transform: scale(1);
    border-radius: var(--br);
  }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .btn-squish.is-squishing { animation: none; }
}


  </style>

  <style>
    .max-gradient-v-red {
      background: linear-gradient(180deg, #f03a54 12%, #c31833 100%);
      box-shadow: 0 -2px 0 0 rgba(0, 0, 0, 0.18) inset, 0 2px 0 0 rgba(255, 255, 255, 0.18) inset;
    }
    .tooltip::before {
      font-weight: 500;
    }
    @media (max-width: 1023px) {
      .touch-target-md > input[type="radio"],
      .touch-target-md > input[type="checkbox"] {
        transform: scale(1.15);
      }
      .touch-target-md {
        padding-top: 0.35rem;
        padding-bottom: 0.35rem;
        padding-left: 0.15rem;
      }
    }
    [data-tap-flash] {
      position: relative;
    overflow: hidden;
  }
  [data-tap-flash]::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.08);
    opacity: 0;
    transition: opacity 0.18s ease-out;
    pointer-events: none;
  }
  [data-tap-flash].is-tap-active::after {
    opacity: 1;
    transition: opacity 0.28s ease-out;
  }
  </style>

<script>
  (() => {
    const activate = (el) => {
      if (!el) return;
      el.classList.add('is-tap-active');
      clearTimeout(el._tapFlashTimer);
      el._tapFlashTimer = setTimeout(() => {
        el.classList.remove('is-tap-active');
      }, 200);
    };
    document.addEventListener('pointerdown', (event) => {
      const target = event.target?.closest?.('[data-tap-flash]');
      if (!target) return;
      activate(target);
    }, { passive: true });
    document.addEventListener('pointerleave', (event) => {
      const target = event.target?.closest?.('[data-tap-flash].is-tap-active');
      if (target) target.classList.remove('is-tap-active');
    }, { passive: true });
    document.addEventListener('pointerup', (event) => {
      const target = event.target?.closest?.('[data-tap-flash].is-tap-active');
      if (target) target.classList.remove('is-tap-active');
    }, { passive: true });
  })();
</script>

<script>
  (function (global) {
    const DEFAULT_LOCALE = 'cs-CZ';
    const FALLBACK_LOCALE = 'cs-CZ';
    const DEFAULT_CURRENCY = 'CZK';
    const LOCALES = {
      'cs-CZ': {
        code: 'cs-CZ',
        nativeName: 'Čeština',
        englishName: 'Czech',
        shortLabel: 'CS',
        currency: 'CZK',
        icon: './icons/languages/Cz.svg'
      },
      'en-EU': {
        code: 'en-EU',
        nativeName: 'English',
        englishName: 'English',
        shortLabel: 'EN',
        currency: 'EUR',
        icon: './icons/languages/En.svg'
      },
      'sk-SK': {
        code: 'sk-SK',
        nativeName: 'Slovenčina',
        englishName: 'Slovak',
        shortLabel: 'SK',
        currency: 'EUR',
        icon: './icons/languages/Sk.svg'
      }
    };
    const NAMESPACES = ['ui'];
    const FALLBACK_MARK = '•';

    const isPlainObject = (value) => Object.prototype.toString.call(value) === '[object Object]';

    const deepClone = (value) => {
      if (Array.isArray(value)) return value.map((item) => deepClone(item));
      if (isPlainObject(value)) {
        return Object.keys(value).reduce((acc, key) => {
          acc[key] = deepClone(value[key]);
          return acc;
        }, {});
      }
      return value;
    };

    const deepMerge = (target, source) => {
      if (Array.isArray(target) && Array.isArray(source)) {
        const result = target.slice();
        source.forEach((value, idx) => {
          if (isPlainObject(value) && isPlainObject(result[idx])) {
            result[idx] = deepMerge(result[idx], value);
          } else if (Array.isArray(value) && Array.isArray(result[idx])) {
            result[idx] = deepMerge(result[idx], value);
          } else {
            result[idx] = deepClone(value);
          }
        });
        return result;
      }
      if (isPlainObject(target) && isPlainObject(source)) {
        const result = { ...target };
        Object.keys(source).forEach((key) => {
          const srcVal = source[key];
          if (Array.isArray(srcVal)) {
            const base = Array.isArray(result[key]) ? result[key] : [];
            result[key] = deepMerge(base, srcVal);
          } else if (isPlainObject(srcVal)) {
            const base = isPlainObject(result[key]) ? result[key] : {};
            result[key] = deepMerge(base, srcVal);
          } else {
            result[key] = srcVal;
          }
        });
        return result;
      }
      if (Array.isArray(source)) return deepMerge([], source);
      if (isPlainObject(source)) return deepMerge({}, source);
      return source;
    };

    const root = typeof globalThis !== 'undefined' ? globalThis : (typeof window !== 'undefined' ? window : {});

    const fetchJson = async (url, fallback = {}) => {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data && (Array.isArray(data) || typeof data === 'object')) return data;
        return Array.isArray(fallback) ? [] : (isPlainObject(fallback) ? {} : fallback);
      } catch (err) {
        console.warn('[i18n] Failed to load', url, err);
        if (Array.isArray(fallback)) return [];
        if (isPlainObject(fallback)) return {};
        return fallback;
      }
    };

    const normalizeDataPath = (path = '') => {
      const raw = String(path || '').replace(/^\.\//, '');
      if (raw.startsWith('data/')) return raw;
      return raw ? `data/${raw}` : 'data/';
    };

    const buildDataUrl = (path) => {
      const normalized = normalizeDataPath(path);
      return normalized.startsWith('./') ? normalized : `./${normalized}`;
    };

    const localizedDataPath = (path, locale) => {
      const normalized = normalizeDataPath(path);
      const rest = normalized.slice('data/'.length);
      return `data/i18n/${locale}/${rest}`;
    };

    async function loadDataFile(path, options = {}) {
      const opts = options && typeof options === 'object' ? options : {};
      const locale = opts.locale
        || (root.Alpine && typeof root.Alpine.store === 'function'
          ? root.Alpine.store('i18n')?.locale
          : null)
        || DEFAULT_LOCALE;

      const normalized = normalizeDataPath(path);
      const baseUrl = buildDataUrl(normalized);
      let base = await fetchJson(baseUrl, null);
      if (base == null) base = [];
      if (!locale || locale === DEFAULT_LOCALE) return base;

      const overlayUrl = buildDataUrl(localizedDataPath(normalized, locale));
      const overlay = await fetchJson(overlayUrl, null);
      if (Array.isArray(base)) {
        if (Array.isArray(overlay) && overlay.length) return overlay;
        return base;
      }
      if (isPlainObject(base)) {
        if (overlay && isPlainObject(overlay) && Object.keys(overlay).length) {
          return overlay;
        }
        return base;
      }
      return overlay ?? base;
    }

    const cache = new Map();

    async function loadNamespace(locale, namespace) {
      const key = `${locale}::${namespace}`;
      const existing = cache.get(key);
      if (existing) return existing;
      const loader = fetchJson(`./data/i18n/${locale}/${namespace}.json`)
        .then((payload) => {
          const normalized = payload && typeof payload === 'object' ? payload : {};
          cache.set(key, normalized);
          return normalized;
        })
        .catch((err) => {
          console.warn('[i18n] Namespace load failed', locale, namespace, err);
          cache.delete(key);
          return {};
        });
      cache.set(key, loader);
      return loader;
    }

    async function loadLocale(locale, namespaces = NAMESPACES) {
      const unique = Array.from(new Set(namespaces.length ? namespaces : NAMESPACES));
      const results = await Promise.all(unique.map((ns) => loadNamespace(locale, ns)));
      return results.reduce((acc, bundle, idx) => {
        const ns = unique[idx];
        acc[ns] = deepMerge(acc[ns] || {}, bundle);
        return acc;
      }, {});
    }

    function walkBundle(bundle, path) {
      const parts = path.split('.');
      let cursor = bundle;
      for (const part of parts) {
        if (cursor == null) return undefined;
        cursor = cursor[part];
      }
      return cursor;
    }

    root.__fitI18n = {
      defaultLocale: DEFAULT_LOCALE,
      fallbackLocale: FALLBACK_LOCALE,
      defaultCurrency: DEFAULT_CURRENCY,
      locales: LOCALES,
      namespaces: NAMESPACES,
      fallbackMark: FALLBACK_MARK,
      cache,
      loadNamespace,
      loadLocale,
      deepMerge,
      walkBundle,
      fetchJson,
      loadData: loadDataFile,
      dataPath: {
        normalize: normalizeDataPath,
        localized: localizedDataPath
      }
    };
  })(window);
</script>

<script>
  document.addEventListener('alpine:init', () => {
    if (!Alpine.store('money')) {
      Alpine.store('money', {
        tick: 0,
        bump() {
          this.tick = (this.tick + 1) % Number.MAX_SAFE_INTEGER;
        }
      });
    }

    if (!Alpine.store('appConfig')) {
      const storageKey = 'fit:app-config';
      const defaults = {
        showBreakpointBadge: true,
        locale: (window.__fitI18n && window.__fitI18n.defaultLocale) || 'cs-CZ',
        currency: (window.__fitI18n && window.__fitI18n.defaultCurrency) || 'CZK',
        drMaxWomanPromo: false,
        showTranslationHints: false
      };
      const load = () => {
        if (typeof localStorage === 'undefined') return {};
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (e) {
          console.warn('config store load failed', e);
          return {};
        }
      };
      const initial = { ...defaults, ...load() };
      if (initial.drMaxWomanPromo == null && initial.valentinePromo != null) {
        initial.drMaxWomanPromo = !!initial.valentinePromo;
        delete initial.valentinePromo;
      }
      const emit = (key, value) => {
        window.dispatchEvent(new CustomEvent('fit:config-change', { detail: { key, value } }));
      };

      Alpine.store('appConfig', {
        key: storageKey,
        defaults,
        showBreakpointBadge: !!initial.showBreakpointBadge,
        locale: String(initial.locale || defaults.locale),
        currency: String(initial.currency || defaults.currency),
        drMaxWomanPromo: !!initial.drMaxWomanPromo,
        showTranslationHints: !!initial.showTranslationHints,
        persist() {
          if (typeof localStorage === 'undefined') return;
          const payload = {
            showBreakpointBadge: !!this.showBreakpointBadge,
            locale: this.locale,
            currency: this.currency,
            drMaxWomanPromo: !!this.drMaxWomanPromo,
            showTranslationHints: !!this.showTranslationHints
          };
          try {
            localStorage.setItem(this.key, JSON.stringify(payload));
          } catch (e) {
            console.warn('config store persist failed', e);
          }
        },
        set(key, value) {
          if (!(key in this)) return;
          let normalized = value;
          if (key === 'showBreakpointBadge') normalized = !!value;
          if (key === 'locale') normalized = String(value || defaults.locale);
          if (key === 'currency') normalized = String(value || defaults.currency);
          if (key === 'drMaxWomanPromo') normalized = !!value;
          if (key === 'showTranslationHints') normalized = !!value;
          if (this[key] === normalized) return;
          this[key] = normalized;
          this.persist();
          emit(key, normalized);
        },
        get(key) {
          if (!(key in this)) return undefined;
          return this[key];
        },
        all() {
          return {
            showBreakpointBadge: !!this.showBreakpointBadge,
            locale: this.locale,
            currency: this.currency,
            drMaxWomanPromo: !!this.drMaxWomanPromo,
            showTranslationHints: !!this.showTranslationHints
          };
        },
        reset() {
          Object.keys(this.defaults).forEach((key) => {
            this.set(key, this.defaults[key]);
          });
        }
      });

      try {
        if (typeof localStorage !== 'undefined' && !localStorage.getItem(storageKey)) {
          Alpine.store('appConfig').persist();
        }
      } catch (_) {}

      const cfgStore = Alpine.store('appConfig');
      emit('showBreakpointBadge', cfgStore.showBreakpointBadge);
      emit('locale', cfgStore.locale);
      emit('currency', cfgStore.currency);
      emit('drMaxWomanPromo', cfgStore.drMaxWomanPromo);
      emit('showTranslationHints', cfgStore.showTranslationHints);
    }

    if (!Alpine.store('auth')) {
      const storageKey = 'fit:auth';
      const defaults = {
        isAuthenticated: false,
        account: null,
        lastLoginAt: null,
        throttleMs: 1300,
        fallbackAccount: {
          id: 'demo-user',
          email: 'demo@fit.test',
          firstName: 'Demo',
          lastName: 'Uživatel'
        }
      };
      const load = () => {
        if (typeof localStorage === 'undefined') return {};
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (e) {
          console.warn('auth store load failed', e);
          return {};
        }
      };
      const clone = (value) => {
        if (value == null || typeof value !== 'object') return value;
        try {
          return JSON.parse(JSON.stringify(value));
        } catch {
          if (Array.isArray(value)) return value.map(clone);
          return { ...value };
        }
      };
      const normalizeAccount = (payload, fallback = {}, options = {}) => {
        const { defaultFallback = false } = options || {};
        const hasPayload = payload && typeof payload === 'object';
        if (!hasPayload && !defaultFallback) return null;
        const base = clone(fallback) || {};
        const incoming = hasPayload ? clone(payload) : {};
        const merged = { ...base, ...incoming };
        if (!Object.keys(merged).length) return null;
        if (merged.email != null) merged.email = String(merged.email).trim();
        if (merged.firstName != null) merged.firstName = String(merged.firstName);
        if (merged.lastName != null) merged.lastName = String(merged.lastName);
        merged.id = String((merged.id || base?.id || 'user') || 'user');
        return merged;
      };
      const accountInitials = (account) => {
        if (!account) return '';
        const getInitial = (value) => {
          if (!value) return '';
          return String(value).trim().charAt(0).toUpperCase();
        };
        const first = getInitial(account.firstName);
        const last = getInitial(account.lastName);
        if (first || last) return `${first}${last || ''}`;
        const email = String(account.email || '').trim();
        if (email) {
          const sanitized = email.replace(/[^A-Za-z0-9]/g, '');
          return sanitized.slice(0, 2).toUpperCase();
        }
        return '';
      };
      const ensureThrottle = (value) => {
        const num = Number(value);
        if (!Number.isFinite(num)) return defaults.throttleMs;
        if (num < 0) return defaults.throttleMs;
        return num;
      };
      const emit = (name, detail = {}) => {
        window.dispatchEvent(new CustomEvent(name, { detail }));
      };

      const stored = load();
      const initial = { ...defaults, ...stored };
      initial.fallbackAccount = normalizeAccount(
        stored?.fallbackAccount ?? initial.fallbackAccount,
        defaults.fallbackAccount,
        { defaultFallback: true }
      ) || clone(defaults.fallbackAccount);
      initial.account = normalizeAccount(
        stored?.account ?? initial.account,
        initial.fallbackAccount,
        { defaultFallback: false }
      );
      const initialThrottle = ensureThrottle(stored?.throttleMs ?? initial.throttleMs);

      Alpine.store('auth', {
        key: storageKey,
        defaults,
        isAuthenticated: !!initial.isAuthenticated && !!initial.account,
        account: initial.account,
        lastLoginAt: initial.lastLoginAt || null,
        fallbackAccount: initial.fallbackAccount,
        throttleMs: initialThrottle,
        modalOpen: false,
        view: 'login',
        status: 'idle',
        error: '',
        loginForm: {
          email: initial.account?.email || initial.fallbackAccount?.email || '',
          password: ''
        },
        registration: {
          loading: false,
          ready: false,
          loadError: '',
          step: 1,
          maxStep: 3,
          schema: [],
          fieldMap: {},
          fieldsByStep: {},
          values: {},
          errors: {},
          touched: {},
          groups: {},
          groupMembers: {},
          groupToggles: {},
          fieldRefs: {},
          flowOptions: [],
          selectedFlow: '',
          emailVerified: false,
          phase: 'idle',
          submitAttempted: false,
          passwordVisible: false,
          addressOptions: [],
          addressLoaded: false
        },
        forgotForm: {
          email: initial.account?.email || initial.fallbackAccount?.email || ''
        },
        passwordVisible: false,
        _timer: null,
        _registrationTimers: {
          email: null,
          process: null,
          success: null
        },
        accountTooltip: {
          visible: false,
          message: 'Váš účet',
          timer: null,
          duration: 3000
        },
        initials() {
          const active = accountInitials(this.account);
          if (active) return active;
          return accountInitials(this.fallbackAccount) || '??';
        },
        showAccountTooltip(message = 'Váš účet', duration = 3000) {
          const tip = this.accountTooltip;
          if (!tip) return;
          tip.message = message;
          tip.visible = true;
          if (tip.timer) {
            clearTimeout(tip.timer);
          }
          const timeout = Number(duration) || tip.duration || 3000;
          tip.timer = setTimeout(() => {
            tip.visible = false;
            tip.timer = null;
          }, timeout);
        },
        celebrateAccountAccess(type = 'success') {
          this.showAccountTooltip();
          this.accountConfetti(type);
        },
        accountConfetti(type = 'success') {
          const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
          if (prefersReduced || typeof window.confetti !== 'function') return;
          const button = document.querySelector('[data-auth-account-button]');
          let origin = { x: 0.5, y: 0.55 };
          if (button?.getBoundingClientRect) {
            const rect = button.getBoundingClientRect();
            const centerX = (rect.left + rect.width / 2) / (window.innerWidth || document.documentElement.clientWidth || 1);
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 1;
            const scrollY = window.scrollY || window.pageYOffset || 0;
            const centerY = (rect.top + rect.height / 2 + scrollY) /
              ((document.documentElement.scrollHeight || viewportHeight) || 1);
            origin = {
              x: Math.min(0.98, Math.max(0.02, centerX)),
              y: Math.min(0.98, Math.max(0.02, centerY))
            };
          }
          const base = { ticks: 200, gravity: 0.9, scalar: 1, spread: 65, origin };
          const burst = (opts) => window.confetti({ ...base, ...opts });
          if (type === 'success') {
            burst({ particleCount: 45, spread: 75, scalar: 0.9 });
          } else if (type === 'celebrate') {
            burst({ particleCount: 70, angle: 60, origin: { x: Math.max(0.05, origin.x - 0.2), y: origin.y } });
            burst({ particleCount: 70, angle: 120, origin: { x: Math.min(0.95, origin.x + 0.2), y: origin.y } });
            burst({ particleCount: 60, spread: 120, scalar: 1.1 });
          } else if (type === 'coupon') {
            burst({ particleCount: 40, spread: 75, scalar: 0.9 });
          } else {
            burst({ particleCount: 60, spread: 100 });
          }
        },
        hideAccountTooltip() {
          const tip = this.accountTooltip;
          if (!tip) return;
          tip.visible = false;
          if (tip.timer) {
            clearTimeout(tip.timer);
            tip.timer = null;
          }
        },
        persist() {
          if (typeof localStorage === 'undefined') return;
          const payload = {
            isAuthenticated: !!this.isAuthenticated,
            account: this.account ? clone(this.account) : null,
            lastLoginAt: this.lastLoginAt || null,
            fallbackAccount: this.fallbackAccount ? clone(this.fallbackAccount) : null,
            throttleMs: this.throttleMs
          };
          try {
            localStorage.setItem(this.key, JSON.stringify(payload));
          } catch (e) {
            console.warn('auth store persist failed', e);
          }
        },
        openModal(view = 'login') {
          this.hideAccountTooltip();
          this.view = view;
          this.modalOpen = true;
          this.status = 'idle';
          this.error = '';
          this.passwordVisible = false;
          if (this.view === 'register') {
            this.prepareRegistration();
          } else {
            this.resetRegistrationState({ keepSchema: true });
          }
          if (!this.loginForm.email) {
            this.loginForm.email = this.fallbackAccount?.email || '';
          }
          this.loginForm.password = '';
          this.forgotForm.email = this.loginForm.email || this.fallbackAccount?.email || '';
        },
        closeModal() {
          this.modalOpen = false;
          this.status = 'idle';
          this.error = '';
          this.view = 'login';
          this.passwordVisible = false;
          this.forgotForm.email = this.loginForm.email || this.fallbackAccount?.email || '';
          if (this._timer) {
            clearTimeout(this._timer);
            this._timer = null;
          }
          this.registrationCancelTimers();
          this.resetRegistrationState({ keepSchema: true });
        },
        handleAccountClick() {
          if (this.isAuthenticated) {
            location.hash = '/my-account';
            return;
          }
          this.openModal('login');
        },
        submitLogin() {
          if (this.status === 'loading') return;
          const email = String(this.loginForm.email || '').trim();
          const password = String(this.loginForm.password || '').trim();
          if (!email || !password) {
            this.status = 'error';
            this.error = 'Zadejte e-mail i heslo.';
            return;
          }
          this.status = 'loading';
          this.error = '';
          if (this._timer) clearTimeout(this._timer);
          const delay = Math.max(400, Number(this.throttleMs) || defaults.throttleMs);
          this._timer = setTimeout(() => {
            this._timer = null;
            const baseAccount = clone(this.fallbackAccount) || {};
            const account = {
              ...baseAccount,
              email,
              id: (baseAccount?.id && String(baseAccount.id)) || 'user',
              lastLoginEmail: email
            };
            this.isAuthenticated = true;
            this.account = account;
            this.lastLoginAt = new Date().toISOString();
            this.loginForm.email = email;
            this.loginForm.password = '';
            this.persist();
            emit('fit:auth-login', { account: this.account, source: 'manual' });
            this.closeModal();
            this.celebrateAccountAccess('success');
          }, delay);
        },
        loginWithFallback() {
          const account = this.fallbackAccount ? clone(this.fallbackAccount) : null;
          this.isAuthenticated = !!account;
          this.account = account;
          this.lastLoginAt = this.isAuthenticated ? new Date().toISOString() : null;
          this.loginForm.email = account?.email || this.loginForm.email;
          this.loginForm.password = '';
          this.persist();
          emit('fit:auth-login', { account: this.account, source: 'fallback' });
          this.closeModal();
          this.celebrateAccountAccess('success');
        },
        logout() {
          this.hideAccountTooltip();
          this.isAuthenticated = false;
          this.account = null;
          this.lastLoginAt = null;
          this.loginForm.password = '';
          if (this.fallbackAccount?.email) {
            this.loginForm.email = this.fallbackAccount.email;
          }
          this.forgotForm.email = this.loginForm.email || this.fallbackAccount?.email || '';
          this.persist();
          emit('fit:auth-logout', {});
        },
        reset() {
          this.hideAccountTooltip();
          this.closeModal();
          this.isAuthenticated = !!defaults.isAuthenticated && !!defaults.account;
          this.account = defaults.account ? clone(defaults.account) : null;
          this.lastLoginAt = defaults.lastLoginAt || null;
          this.fallbackAccount = clone(defaults.fallbackAccount);
          this.throttleMs = defaults.throttleMs;
          this.loginForm.email = this.fallbackAccount?.email || '';
          this.loginForm.password = '';
          this.forgotForm.email = this.fallbackAccount?.email || '';
          this.registrationCancelTimers();
          this.resetRegistrationState({ hard: true });
          this.persist();
          emit('fit:auth-reset', {});
        },
        setFallbackAccount(payload) {
          const normalized = normalizeAccount(payload, defaults.fallbackAccount, { defaultFallback: true }) || clone(defaults.fallbackAccount);
          this.fallbackAccount = clone(normalized);
          if (!this.isAuthenticated) {
            this.loginForm.email = normalized.email || this.loginForm.email;
          }
          if (this.view !== 'register') {
            this.forgotForm.email = normalized.email || this.forgotForm.email;
          }
          this.persist();
          emit('fit:auth-fallback-change', { fallbackAccount: this.fallbackAccount });
        },
        setThrottle(value) {
          this.throttleMs = ensureThrottle(value);
          this.persist();
          emit('fit:auth-throttle-change', { throttleMs: this.throttleMs });
        },
        toggleView(next) {
          const allowed = ['login', 'register', 'forgot'];
          const target = typeof next === 'string' && allowed.includes(next)
            ? next
            : (this.view === 'login' ? 'register' : 'login');
          this.view = target;
          this.status = 'idle';
          this.error = '';
          if (target !== 'login') {
            this.passwordVisible = false;
          }
          if (target === 'login') {
            this.loginForm.password = '';
          }
          if (target === 'forgot') {
            this.forgotForm.email = this.loginForm.email || this.fallbackAccount?.email || this.forgotForm.email || '';
          } else {
            this.forgotForm.email = this.fallbackAccount?.email || this.loginForm.email || this.forgotForm.email || '';
          }
          if (target === 'register') {
            this.prepareRegistration();
          } else {
            this.resetRegistrationState({ keepSchema: true });
          }
        },
        prepareRegistration(force = false) {
          if (this.registration.loading) return;
          if (force || !this.registration.ready) {
            this.loadRegistrationSchema();
            return;
          }
          this.resetRegistrationState({ keepSchema: true });
        },
        async loadRegistrationSchema() {
          if (this.registration.loading) return;
          this.registration.loading = true;
          this.registration.loadError = '';
          try {
            const res = await fetch('data/forms/registration.json', { cache: 'no-store' });
            const data = await res.json();
            this.initRegistration(Array.isArray(data) ? data : []);
          } catch (e) {
            console.warn('registration.json load failed', e);
            this.registration.loadError = 'Nepodařilo se načíst registrační formulář. Zkuste to prosím znovu.';
            this.initRegistration([]);
          } finally {
            this.registration.loading = false;
          }
        },
        initRegistration(schema) {
          const reg = this.registration;
          reg.schema = Array.isArray(schema) ? schema : [];
          reg.fieldMap = {};
          reg.fieldsByStep = {};
          reg.values = {};
          reg.errors = {};
          reg.touched = {};
          reg.groups = {};
          reg.groupMembers = {};
          reg.groupToggles = {};
          reg.fieldRefs = {};
          const flowOptions = [];
          const used = new Set();
          reg.schema.forEach((raw, idx) => {
            const step = Number(raw?.step) || 1;
            if (step === 1 && (raw?.type === 'radio') && !Array.isArray(raw?.items)) {
              flowOptions.push({
                id: `flow-${idx}`,
                label: raw?.label || `Možnost ${idx + 1}`,
                value: raw?.value || `flow-${idx}`,
                disabled: /kartu/i.test(String(raw?.label || ''))
              });
              return;
            }
            const key = this.registrationNormalizeKey(raw?.label || raw?.type || `field-${idx}`, idx, used);
            used.add(key);
            const field = {
              key,
              type: raw?.type || 'text',
              label: raw?.label || '',
              placeholder: raw?.placeholder || '',
              prefix: raw?.prefix || null,
              suffix: raw?.suffix || null,
              note: raw?.note || null,
              validations: Array.isArray(raw?.validations) ? raw.validations : [],
              items: Array.isArray(raw?.items) ? raw.items : [],
              section: raw?.form_section || '',
              groupKey: raw?.fieldset_group || null,
              step
            };
            field.isToggle = field.type === 'checkbox_toggle_fieldset';
            if (!reg.fieldsByStep[step]) reg.fieldsByStep[step] = [];
            reg.fieldsByStep[step].push(field);
            reg.fieldMap[key] = field;
            reg.values[key] = this.registrationDefaultValue(field);
            reg.errors[key] = [];
            reg.touched[key] = false;
            if (field.isToggle && field.groupKey) {
              reg.groupToggles[field.groupKey] = key;
              reg.groups[field.groupKey] = false;
            } else if (field.groupKey) {
              if (!reg.groupMembers[field.groupKey]) reg.groupMembers[field.groupKey] = [];
              reg.groupMembers[field.groupKey].push(key);
              if (!(field.groupKey in reg.groups)) {
                reg.groups[field.groupKey] = false;
              }
            }
            this.registrationCaptureFieldRefs(field, key);
          });
          reg.flowOptions = flowOptions.length
            ? flowOptions.map((opt, idx) => ({
                ...opt,
                value: opt.value || `option-${idx}`,
                disabled: opt.disabled || idx > 0
              }))
            : [{ id: 'flow-default', label: 'Jsem nový člen', value: 'new-member', disabled: false }];
          const firstActive = reg.flowOptions.find(opt => !opt.disabled);
          reg.selectedFlow = firstActive ? firstActive.value : reg.flowOptions[0]?.value;
          reg.step = 1;
          reg.maxStep = Math.max(3, ...Object.keys(reg.fieldsByStep).map(s => Number(s) || 1));
          reg.emailVerified = false;
          reg.phase = 'idle';
          reg.submitAttempted = false;
          reg.passwordVisible = false;
          reg.ready = reg.schema.length > 0;
          reg.addressLoaded = false;
          reg.addressOptions = [];
        },
        resetRegistrationState({ keepSchema = true, hard = false } = {}) {
          const reg = this.registration;
          if (!keepSchema || hard) {
            reg.schema = keepSchema ? reg.schema : [];
            reg.ready = keepSchema ? reg.ready : false;
          }
          const map = reg.fieldMap || {};
          Object.keys(map).forEach((key) => {
            reg.values[key] = this.registrationDefaultValue(map[key]);
            reg.errors[key] = [];
            reg.touched[key] = false;
          });
          Object.keys(reg.groupToggles || {}).forEach((groupKey) => {
            reg.groups[groupKey] = false;
          });
          const flowOptions = Array.isArray(reg.flowOptions) ? reg.flowOptions : [];
          const activeOption = flowOptions.find(opt => !opt.disabled);
          if (flowOptions.length) {
            reg.selectedFlow = (activeOption ? activeOption.value : flowOptions[0].value) || reg.selectedFlow;
          }
          reg.step = 1;
          reg.emailVerified = false;
          reg.phase = 'idle';
          reg.submitAttempted = false;
          reg.passwordVisible = false;
        },
        registrationNormalizeKey(label, idx, existing = new Set()) {
          const base = String(label || `field-${idx}`)
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '') || `field-${idx}`;
          let key = base;
          let counter = 1;
          while (existing.has(key)) {
            key = `${base}-${counter++}`;
          }
          return key;
        },
        registrationDefaultValue(field) {
          if (!field) return '';
          switch (field.type) {
            case 'checkbox':
            case 'checkbox_toggle_fieldset':
              return false;
            case 'address':
              return { street: '', extra: '', city: '', zip: '' };
            default:
              return '';
          }
        },
        registrationCaptureFieldRefs(field, key) {
          if (!field || !key) return;
          const reg = this.registration;
          const normalizedLabel = String(field.label || '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
          if (field.type === 'email') reg.fieldRefs.email = key;
          if (field.type === 'password') reg.fieldRefs.password = key;
          if (field.type === 'tel') reg.fieldRefs.phone = key;
          if (field.type === 'address') reg.fieldRefs.address = key;
          if (field.type === 'date') reg.fieldRefs.birthDate = key;
          if (field.type === 'radio' && /v[ěe]rnostn/i.test(field.fieldset_group || '')) {
            reg.fieldRefs.gender = key;
          }
          if (field.type === 'checkbox') reg.fieldRefs.consent = key;
          if (/jmeno/.test(normalizedLabel) && !/prijmeni/.test(normalizedLabel)) {
            reg.fieldRefs.firstName = key;
          }
          if (/prijmeni/.test(normalizedLabel)) {
            reg.fieldRefs.lastName = key;
          }
          if ((field.groupKey || '').toLowerCase().includes('titul')) {
            if (/pred/.test(normalizedLabel)) reg.fieldRefs.titleBefore = key;
            if (/za/.test(normalizedLabel)) reg.fieldRefs.titleAfter = key;
          }
        },
        registrationStepList() {
          return [
            { id: 1, label: 'Typ registrace' },
            { id: 2, label: 'Osobní údaje' },
            { id: 3, label: 'Kontaktní údaje' }
          ];
        },
        registrationStepFields(step, options = {}) {
          const excludeTypes = Array.isArray(options.excludeTypes) ? options.excludeTypes : [];
          const fields = this.registration.fieldsByStep?.[step] || [];
          return fields.filter((field) => {
            if (!field) return false;
            if (excludeTypes.includes(field.type)) return false;
            if (field.isToggle) return true;
            return this.registrationFieldVisible(field);
          });
        },
        registrationEmailField() {
          const key = this.registration.fieldRefs.email;
          if (!key) return null;
          return this.registration.fieldMap?.[key] || null;
        },
        registrationFieldVisible(field) {
          if (!field) return false;
          if (!field.groupKey) return true;
          if (field.isToggle) return true;
          if (!(field.groupKey in (this.registration.groups || {}))) return true;
          return !!this.registration.groups[field.groupKey];
        },
        registrationHandleInput(fieldKey) {
          const reg = this.registration;
          const field = reg.fieldMap?.[fieldKey];
          if (!field) return;
          if (field.type === 'tel') {
            const digits = String(reg.values[fieldKey] || '').replace(/\D+/g, '');
            reg.values[fieldKey] = digits.slice(0, 12);
          }
          if (field.type === 'address') {
            reg.values[fieldKey] = this.normalizeRegistrationAddress(reg.values[fieldKey]);
          }
          if (reg.fieldRefs.email === fieldKey) {
            if (reg.emailVerified) {
              reg.emailVerified = false;
            }
            if (reg.phase === 'verifying-email') {
              reg.phase = 'idle';
            }
            this.registrationCancelTimers('email');
          }
          if (!field.isToggle && reg.touched[fieldKey]) {
            this.registrationValidateFieldByKey(fieldKey);
          }
        },
        registrationHandleBlur(fieldKey) {
          const reg = this.registration;
          if (!(fieldKey in reg.touched)) return;
          reg.touched[fieldKey] = true;
          this.registrationValidateFieldByKey(fieldKey);
        },
        registrationHandleGroupToggle(fieldKey) {
          const reg = this.registration;
          const field = reg.fieldMap?.[fieldKey];
          if (!field || !field.groupKey) return;
          const active = !!reg.values[fieldKey];
          reg.groups[field.groupKey] = active;
          if (!active) {
            (reg.groupMembers[field.groupKey] || []).forEach((memberKey) => {
              reg.values[memberKey] = this.registrationDefaultValue(reg.fieldMap[memberKey]);
              reg.errors[memberKey] = [];
              reg.touched[memberKey] = false;
            });
          }
        },
        registrationIsPhoneField(field) {
          return !!field && field.type === 'tel';
        },
        registrationHasValue(field, value) {
          if (!field) return false;
          if (field.type === 'checkbox' || field.type === 'checkbox_toggle_fieldset') {
            return !!value;
          }
          if (field.type === 'address') {
            const addr = this.normalizeRegistrationAddress(value);
            return !!(addr.street || addr.city || addr.zip);
          }
          const val = typeof value === 'string' ? value.trim() : value;
          return val !== null && val !== undefined && String(val).trim() !== '';
        },
        registrationComputeFieldErrors(field) {
          if (!field) return [];
          const reg = this.registration;
          const value = reg.values[field.key];
          const errors = [];
          const validations = Array.isArray(field.validations) ? field.validations : [];
          const addr = field.type === 'address' ? this.normalizeRegistrationAddress(value) : null;
          const textValue = typeof value === 'string' ? value.trim() : String(value ?? '').trim();
          for (const rule of validations) {
            const type = (rule?.type || '').toLowerCase();
            const message = rule?.fails || 'Neplatná hodnota';
            switch (type) {
              case 'required':
                if (!this.registrationHasValue(field, value)) errors.push(message);
                break;
              case 'email':
                if (textValue && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(textValue)) errors.push(message);
                break;
              case 'phone': {
                const digits = String(value || '').replace(/\D+/g, '');
                if (digits && digits.length !== 9) errors.push(message);
                break;
              }
              case 'address': {
                const zipPlain = (addr?.zip || '').replace(/\s+/g, '');
                if (!(addr?.street && addr?.city && /^\d{5}$/.test(zipPlain))) errors.push(message);
                break;
              }
              case 'date': {
                if (textValue && !/^\d{4}-\d{2}-\d{2}$/.test(textValue)) {
                  errors.push(message);
                }
                break;
              }
              case 'legth':
              case 'length':
                if (textValue.length < 8) errors.push(message);
                break;
              case 'capital':
                if (textValue && !/[A-ZÁČĎÉĚÍĹĽŇÓŘŠŤÚŮÝŽ]/.test(textValue)) errors.push(message);
                break;
              case 'number':
                if (textValue && !/\d/.test(textValue)) errors.push(message);
                break;
              default:
                break;
            }
          }
          return Array.from(new Set(errors));
        },
        registrationValidateFieldByKey(fieldKey) {
          const field = this.registration.fieldMap?.[fieldKey];
          if (!field) return [];
          const errs = this.registrationComputeFieldErrors(field);
          this.registration.errors[fieldKey] = errs;
          return errs;
        },
        registrationValidateStep(step) {
          let ok = true;
          this.registrationStepFields(step).forEach((field) => {
            if (!field || field.isToggle) return;
            const errs = this.registrationValidateFieldByKey(field.key);
            if (errs.length) ok = false;
          });
          return ok;
        },
        registrationGoToStep(step) {
          const reg = this.registration;
          const max = Number(reg.maxStep) || 3;
          const target = Math.min(Math.max(1, Number(step) || 1), max);
          reg.step = target;
        },
        nextRegistrationStep() {
          this.registrationGoToStep((this.registration.step || 1) + 1);
        },
        prevRegistrationStep() {
          this.registrationGoToStep((this.registration.step || 1) - 1);
        },
        registrationStartEmailVerification() {
          const reg = this.registration;
          const emailField = this.registrationEmailField();
          if (!emailField) return;
          reg.submitAttempted = true;
          reg.touched[emailField.key] = true;
          const errs = this.registrationValidateFieldByKey(emailField.key);
          if (errs.length) return;
          if (reg.emailVerified || reg.phase === 'verifying-email') return;
          reg.phase = 'verifying-email';
          this.registrationCancelTimers('email');
          const delay = Math.max(800, Number(this.throttleMs) || defaults.throttleMs || 1300);
          this._registrationTimers.email = setTimeout(() => {
            reg.phase = 'idle';
            reg.emailVerified = true;
            this._registrationTimers.email = null;
          }, delay);
        },
        advanceAfterStepTwo() {
          const reg = this.registration;
          if (!reg.emailVerified) {
            this.registrationStartEmailVerification();
            return;
          }
          reg.submitAttempted = true;
          if (!this.registrationValidateStep(2)) return;
          reg.submitAttempted = false;
          this.registrationGoToStep(3);
          this.registrationEnsureAddressOptions();
        },
        submitRegistration() {
          const reg = this.registration;
          if (reg.phase === 'processing') return;
          reg.submitAttempted = true;
          const step2Ok = this.registrationValidateStep(2);
          const step3Ok = this.registrationValidateStep(3);
          if (!(step2Ok && step3Ok)) return;
          reg.phase = 'processing';
          this.registrationCancelTimers('process');
          this.registrationCancelTimers('success');
          const delay = Math.max(1000, Number(this.throttleMs) || defaults.throttleMs || 1300);
          this._registrationTimers.process = setTimeout(() => {
            const account = this.registrationCollectAccountPayload();
            this.applyRegistrationAccount(account);
            reg.phase = 'success';
            this._registrationTimers.process = null;
            this.registrationCancelTimers('success');
            this._registrationTimers.success = setTimeout(() => {
              this.closeModal();
              this.celebrateAccountAccess('celebrate');
            }, 1600);
          }, delay);
        },
        registrationCollectAccountPayload() {
          const reg = this.registration;
          const emailKey = reg.fieldRefs.email;
          const firstNameKey = reg.fieldRefs.firstName;
          const lastNameKey = reg.fieldRefs.lastName;
          const phoneKey = reg.fieldRefs.phone;
          const addressKey = reg.fieldRefs.address;
          const genderKey = reg.fieldRefs.gender;
          const birthKey = reg.fieldRefs.birthDate;
          const titleBeforeKey = reg.fieldRefs.titleBefore;
          const titleAfterKey = reg.fieldRefs.titleAfter;
          const phoneDigits = String(reg.values[phoneKey] || '').replace(/\D+/g, '');
          const account = {
            id: `reg-${Date.now()}`,
            email: String(reg.values[emailKey] || '').trim(),
            firstName: String(reg.values[firstNameKey] || '').trim(),
            lastName: String(reg.values[lastNameKey] || '').trim()
          };
          if (titleBeforeKey) account.titleBefore = String(reg.values[titleBeforeKey] || '').trim();
          if (titleAfterKey) account.titleAfter = String(reg.values[titleAfterKey] || '').trim();
          if (genderKey) account.gender = reg.values[genderKey] || '';
          if (birthKey) account.birthDate = reg.values[birthKey] || '';
          if (phoneDigits) {
            account.phone = `+420 ${this.registrationFormatPhoneDisplay(phoneDigits)}`.trim();
          }
          if (addressKey) {
            const addr = this.normalizeRegistrationAddress(reg.values[addressKey]);
            account.address = addr;
            account.addressDisplay = this.formatRegistrationAddressDisplay(addr);
          }
          account.createdAt = new Date().toISOString();
          return account;
        },
        applyRegistrationAccount(account) {
          if (!account || !account.email) return;
          const normalized = normalizeAccount(account, defaults.fallbackAccount, { defaultFallback: true }) || clone(defaults.fallbackAccount);
          this.account = normalized;
          this.isAuthenticated = true;
          this.lastLoginAt = new Date().toISOString();
          this.loginForm.email = normalized.email || '';
          this.loginForm.password = '';
          this.forgotForm.email = normalized.email || this.forgotForm.email || '';
          this.fallbackAccount = clone(normalized);
          this.persist();
          emit('fit:auth-login', { account: this.account, source: 'register' });
        },
        async registrationEnsureAddressOptions() {
          if (this.registration.addressLoaded && Array.isArray(this.registration.addressOptions) && this.registration.addressOptions.length) {
            return this.registration.addressOptions;
          }
          try {
            const res = await fetch('data/addresses/prague.json', { cache: 'no-store' });
            const list = await res.json();
            const normalized = Array.isArray(list) ? list : [];
            this.registration.addressOptions = normalized.map((item, idx) => {
              const street = String(item.street ?? '').trim();
              const extra = String(item.extra ?? '').trim();
              const city = String(item.city ?? '').trim();
              const zip = String(item.zip ?? '').replace(/\s+/g, '');
              const label = String(item.label ?? `${street}, ${city}`).trim();
              const cityLine = [zip, city].filter(Boolean).join(' ');
              const district = String(item.district ?? '').trim();
              const search = [label, street, extra, city, zip, district].filter(Boolean).join(' ').toLowerCase();
              return {
                id: String(item.id ?? `addr-${idx}`),
                label: label || street,
                street,
                extra,
                city,
                zip,
                district,
                cityLine,
                search
              };
            });
          } catch (e) {
            console.warn('registration address suggestions load failed', e);
            this.registration.addressOptions = [];
          } finally {
            this.registration.addressLoaded = true;
          }
          return this.registration.addressOptions;
        },
        registrationAddressField(fieldKey) {
          const store = this;
          return {
            fieldKey,
            query: '',
            open: false,
            highlighted: -1,
            init() {
              store.registrationEnsureAddressOptions().then(() => {
                this.syncFromStore();
              });
              this.$watch(
                () => JSON.stringify(store.normalizeRegistrationAddress(store.registration.values[this.fieldKey] || {})),
                () => this.syncFromStore()
              );
            },
            get options() {
              const opts = Array.isArray(store.registration.addressOptions) ? store.registration.addressOptions : [];
              const q = this.query.trim().toLowerCase();
              if (!q) return opts.slice(0, 8);
              return opts.filter(opt => opt.search.includes(q)).slice(0, 8);
            },
            get hasValue() {
              const val = store.normalizeRegistrationAddress(store.registration.values[this.fieldKey]);
              return !!(val.street || val.extra || val.city || val.zip);
            },
            get summaryBody() {
              return store.formatRegistrationAddressDisplay(store.registration.values[this.fieldKey]);
            },
            openSuggestions() {
              this.open = true;
              if (this.highlighted === -1 && this.options.length) {
                this.highlighted = 0;
              }
            },
            closeSuggestions() {
              this.open = false;
              this.highlighted = -1;
            },
            onInput(event) {
              this.query = event.target.value;
              const next = store.normalizeRegistrationAddress(store.registration.values[this.fieldKey]);
              store.registration.values[this.fieldKey] = { ...next, street: this.query };
              store.registrationHandleInput(this.fieldKey);
              this.openSuggestions();
            },
            onBlur() {
              setTimeout(() => this.closeSuggestions(), 120);
              store.registrationHandleBlur(this.fieldKey);
            },
            highlightNext() {
              if (!this.options.length) return;
              this.openSuggestions();
              this.highlighted = (this.highlighted + 1) % this.options.length;
            },
            highlightPrev() {
              if (!this.options.length) return;
              this.openSuggestions();
              this.highlighted = this.highlighted <= 0 ? this.options.length - 1 : this.highlighted - 1;
            },
            selectHighlighted() {
              if (this.highlighted < 0 || this.highlighted >= this.options.length) return;
              this.selectOption(this.options[this.highlighted]);
            },
            selectOption(opt) {
              const value = store.normalizeRegistrationAddress(opt);
              store.registration.values[this.fieldKey] = value;
              store.registrationHandleInput(this.fieldKey);
              store.registrationHandleBlur(this.fieldKey);
              this.query = store.formatRegistrationAddressLine(value);
              this.closeSuggestions();
            },
            clearSelection() {
              store.registration.values[this.fieldKey] = store.normalizeRegistrationAddress({});
              this.query = '';
              store.registrationHandleInput(this.fieldKey);
              store.registrationHandleBlur(this.fieldKey);
              this.closeSuggestions();
            },
            syncFromStore() {
              const normalized = store.normalizeRegistrationAddress(store.registration.values[this.fieldKey]);
              this.query = store.formatRegistrationAddressLine(normalized);
            }
          };
        },
        normalizeRegistrationAddress(val) {
          if (val && typeof val === 'object') {
            return {
              street: String(val.street ?? val.line1 ?? '').trim(),
              extra: String(val.extra ?? val.line2 ?? '').trim(),
              city: String(val.city ?? '').trim(),
              zip: String(val.zip ?? '').trim()
            };
          }
          if (typeof val === 'string') {
            return { street: val.trim(), extra: '', city: '', zip: '' };
          }
          return { street: '', extra: '', city: '', zip: '' };
        },
        formatRegistrationAddressLine(val) {
          const addr = this.normalizeRegistrationAddress(val);
          const parts = [];
          if (addr.street) parts.push(addr.street);
          const cityLine = [addr.zip, addr.city].filter(Boolean).join(' ');
          if (cityLine) parts.push(cityLine);
          return parts.join(', ');
        },
        formatRegistrationAddressDisplay(val) {
          const addr = this.normalizeRegistrationAddress(val);
          const parts = [];
          if (addr.street) parts.push(addr.street);
          if (addr.extra) parts.push(addr.extra);
          const cityLine = [addr.zip, addr.city].filter(Boolean).join(' ');
          if (cityLine) parts.push(cityLine);
          return parts.join('\n');
        },
        registrationFormatPhoneDisplay(val) {
          const digits = String(val || '').replace(/\D+/g, '');
          if (!digits) return '';
          return digits.replace(/(\d{3})(?=\d)/g, '$1 ').trim();
        },
        registrationCancelTimers(type = null) {
          const targets = type ? [type] : ['email', 'process', 'success'];
          targets.forEach((key) => {
            const timerKey = key === 'email' ? 'email' : (key === 'success' ? 'success' : 'process');
            if (this._registrationTimers[timerKey]) {
              clearTimeout(this._registrationTimers[timerKey]);
              this._registrationTimers[timerKey] = null;
            }
          });
        },
        isAnonymous() {
          return !this.isAuthenticated;
        },
        togglePasswordVisibility() {
          this.passwordVisible = !this.passwordVisible;
        },
        openForgot() {
          this.toggleView('forgot');
        }
      });

      try {
        if (typeof localStorage !== 'undefined' && !localStorage.getItem(storageKey)) {
          Alpine.store('auth').persist();
        }
      } catch (e) {
        console.warn('auth store bootstrap failed', e);
      }

      window.fitAuthStore = () => Alpine.store('auth');
    }

    if (!Alpine.store('i18n')) {
      const configStore = Alpine.store('appConfig');
      const boot = window.__fitI18n || {};
      const localeMap = boot.locales || {};
      const fallbackLocale = boot.fallbackLocale || 'cs-CZ';
      const requestedNamespaces = new Set(Array.isArray(boot.namespaces) ? boot.namespaces : []);

      const resolveLocale = (value) => {
        const normalized = String(value || '').trim();
        if (normalized && localeMap[normalized]) return normalized;
        return fallbackLocale;
      };

      const store = {
        locales: localeMap,
        fallbackLocale,
        fallbackHint: boot.fallbackMark || '•',
        requestedNamespaces,
        locale: resolveLocale(configStore?.get('locale') ?? boot.defaultLocale),
        currency: String(configStore?.get('currency') ?? boot.defaultCurrency ?? 'CZK'),
        bundles: {},
        currencyConfig: null,
        localeConfigs: null,
        _configListener: null,
        showFallbackHint: !!(
          configStore?.get
            ? configStore.get('showTranslationHints')
            : configStore?.showTranslationHints
        ),
        async init() {
          await Promise.all([
            this.ensureCurrencyConfig(),
            this.ensureLocaleConfig()
          ]);
          const namespaces = Array.from(this.requestedNamespaces);
          await this.ensureLocaleBundle(this.locale, namespaces);
          if (this.fallbackLocale !== this.locale) {
            await this.ensureLocaleBundle(this.fallbackLocale, namespaces);
          }
          if (!this._configListener) {
            this._configListener = (event) => {
              const detail = event?.detail;
              if (!detail) return;
              if (detail.key === 'locale') {
                const value = resolveLocale(detail.value);
                if (this.locale !== value) {
                  this.setLocale(value, { persist: false });
                }
              } else if (detail.key === 'currency') {
                const code = String(detail.value || '').trim();
                if (code && this.currency !== code) {
                  this.setCurrency(code, { persist: false, forceEvent: true });
                }
              } else if (detail.key === 'showTranslationHints') {
                this.showFallbackHint = !!detail.value;
              }
            };
            window.addEventListener('fit:config-change', this._configListener);
          }
        },
        listLocales() {
          return Object.keys(this.locales).map((code) => ({
            code,
            ...this.locales[code]
          }));
        },
        getLocaleMeta(code) {
          const meta = this.locales[code];
          if (!meta) return null;
          return { code, ...meta };
        },
        async ensureLocaleBundle(locale, namespaces) {
          const list = Array.from(new Set((namespaces && namespaces.length) ? namespaces : Array.from(this.requestedNamespaces)));
          if (!list.length) return;
          const storage = this.bundles[locale] || (this.bundles[locale] = {});
          const tasks = list
            .filter((ns) => !storage[ns])
            .map(async (ns) => {
              try {
                const data = await window.__fitI18n.loadNamespace(locale, ns);
                storage[ns] = window.__fitI18n.deepMerge({}, data);
              } catch (err) {
                console.warn('[i18n] failed to load namespace', locale, ns, err);
                storage[ns] = {};
              }
            });
          await Promise.all(tasks);
        },
        requestNamespace(namespace) {
          if (!namespace) return;
          this.requestedNamespaces.add(namespace);
          this.ensureLocaleBundle(this.locale, [namespace]);
          if (this.fallbackLocale !== this.locale) {
            this.ensureLocaleBundle(this.fallbackLocale, [namespace]);
          }
        },
        async ensureCurrencyConfig() {
          if (this.currencyConfig) return this.currencyConfig;
          try {
            const res = await fetch('./data/pricing/currencies.json', { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            this.currencyConfig = json && typeof json === 'object' ? json : null;
          } catch (err) {
            console.warn('[i18n] currency config load failed', err);
            this.currencyConfig = null;
          }
          return this.currencyConfig;
        },
        async ensureLocaleConfig() {
          if (this.localeConfigs) return this.localeConfigs;
          try {
            const res = await fetch('./data/locales/config.json', { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            this.localeConfigs = json && typeof json === 'object' ? json : {};
          } catch (err) {
            console.warn('[i18n] locale config load failed', err);
            this.localeConfigs = {};
          }
          return this.localeConfigs;
        },
        configFor(locale = this.locale) {
          const configs = this.localeConfigs || {};
          const base = configs.default || {};
          const specific = configs[locale] || {};
          const mergedBase = window.__fitI18n.deepMerge({}, base);
          return window.__fitI18n.deepMerge(mergedBase, specific);
        },
        resolveConfig(path, options = {}) {
          const opts = typeof options === 'object' ? options : {};
          const locale = opts.locale || this.locale;
          const fallback = opts.fallback;
          if (!this.localeConfigs) {
            this.ensureLocaleConfig();
          }
          if (!path) {
            return this.configFor(locale);
          }
          const parts = String(path).split('.');
          let cursor = this.configFor(locale);
          for (const part of parts) {
            if (cursor != null && Object.prototype.hasOwnProperty.call(cursor, part)) {
              cursor = cursor[part];
            } else {
              return fallback;
            }
          }
          return cursor === undefined ? fallback : cursor;
        },
        lookup(locale, key) {
          const bundle = this.bundles[locale];
          if (!bundle) return undefined;
          for (const ns of this.requestedNamespaces) {
            if (!bundle[ns]) continue;
            const value = window.__fitI18n.walkBundle(bundle[ns], key);
            if (value !== undefined) return value;
          }
          return undefined;
        },
        interpolate(template, params = {}) {
          if (typeof template !== 'string') return template;
          return template.replace(/\{(\w+)\}/g, (_, token) => (
            Object.prototype.hasOwnProperty.call(params, token) ? params[token] : `{${token}}`
          ));
        },
        t(key, fallbackText, params = {}) {
          if (!key) return fallbackText ?? '';
          const primary = this.lookup(this.locale, key);
          if (primary !== undefined) return this.interpolate(primary, params);
          const fallback = this.lookup(this.fallbackLocale, key);
          if (fallback !== undefined) {
            const text = this.interpolate(fallback, params);
            return this.showFallbackHint ? text + this.fallbackHint : text;
          }
          const fallbackValue = fallbackText != null ? fallbackText : key;
          const base = this.interpolate(fallbackValue, params);
          return this.showFallbackHint ? base + this.fallbackHint : base;
        },
        getCurrencyMeta(code) {
          const config = this.currencyConfig || {};
          const currencies = config.currencies || {};
          return currencies[code] || null;
        },
        convert(value, { fromCurrency, toCurrency } = {}) {
          const config = this.currencyConfig;
          const base = config?.baseCurrency || 'CZK';
          const from = fromCurrency || base;
          const to = toCurrency || this.currency;
          const numeric = Number(value);
          if (!Number.isFinite(numeric)) return 0;
          if (!config || from === to) return numeric;
          const currencies = config.currencies || {};
          const fromMeta = currencies[from];
          const toMeta = currencies[to];
          const fromRate = Number(fromMeta?.rate || (from === base ? 1 : 0));
          const toRate = Number(toMeta?.rate || (to === base ? 1 : 0));
          let baseValue = numeric;
          if (from !== base) {
            if (!fromRate) return numeric;
            baseValue = numeric / fromRate;
          }
          if (to === base) return baseValue;
          if (!toRate) return baseValue;
          return baseValue * toRate;
        },
        applyRounding(value, currencyMeta) {
          const rounding = Number(currencyMeta?.rounding || 0);
          if (rounding && rounding > 0) {
            const factor = 1 / rounding;
            return Math.round(value * factor) / factor;
          }
          const digits = Number.isInteger(currencyMeta?.minorUnits) ? currencyMeta.minorUnits : 2;
          const factor = Math.pow(10, Math.max(0, digits));
          return Math.round(value * factor) / factor;
        },
        formatCurrency(value, { currency, fromCurrency, locale } = {}) {
          const target = currency || this.currency;
          const meta = this.getCurrencyMeta(target);
          const converted = this.convert(value, { fromCurrency, toCurrency: target });
          const rounded = this.applyRounding(converted, meta);
          const resolvedLocale = locale || meta?.locale || this.locale || 'cs-CZ';
          try {
            const formatter = new Intl.NumberFormat(resolvedLocale, {
              style: 'currency',
              currency: target,
              maximumFractionDigits: meta?.minorUnits ?? 2,
              minimumFractionDigits: meta?.minorUnits ?? 0
            });
            return formatter.format(rounded);
          } catch (err) {
            console.warn('[i18n] currency format failed', err);
            const symbol = meta?.symbol || target;
            const formatted = rounded.toFixed(meta?.minorUnits ?? 2);
            return meta?.symbolPosition === 'before'
              ? `${symbol}\u00A0${formatted}`
              : `${formatted}\u00A0${symbol}`;
          }
        },
        async setLocale(code, options = {}) {
          const opts = typeof options === 'object' ? options : {};
          const persist = opts.persist !== false;
          const next = resolveLocale(code);
          if (this.locale === next) {
            if (persist) this.persist({ locale: true, currency: false });
            return;
          }
          await this.ensureLocaleConfig();
          await this.ensureLocaleBundle(next);
          if (this.fallbackLocale && this.fallbackLocale !== next) {
            await this.ensureLocaleBundle(this.fallbackLocale);
          }
          this.locale = next;
          const defaultCurrency = this.locales[next]?.currency;
          if (defaultCurrency) {
            this.setCurrency(defaultCurrency, { persist, forceEvent: true });
          } else if (persist) {
            this.persist({ locale: false, currency: true });
          }
          if (persist) this.persist({ locale: true, currency: false });
          const namespaces = Array.from(this.requestedNamespaces);
          this.ensureLocaleBundle(this.locale, namespaces);
          if (this.fallbackLocale !== this.locale) {
            this.ensureLocaleBundle(this.fallbackLocale, namespaces);
          }
          window.dispatchEvent(new CustomEvent('fit:locale-change', { detail: { locale: this.locale } }));
          if (!defaultCurrency) {
            window.dispatchEvent(new CustomEvent('fit:currency-change', { detail: { currency: this.currency } }));
          }
        },
        setCurrency(code, options = {}) {
          const opts = typeof options === 'object' ? options : {};
          const persist = opts.persist !== false;
          const forceEvent = !!opts.forceEvent;
          const normalized = String(code || '').trim();
          if (!normalized) return false;
          const changed = this.currency !== normalized;
          this.currency = normalized;
          if (persist) this.persist({ locale: false, currency: true });
          if (changed || forceEvent) {
            window.dispatchEvent(new CustomEvent('fit:currency-change', { detail: { currency: this.currency } }));
          }
          return changed;
        },
        persist({ locale = true, currency = true } = {}) {
          if (locale) configStore?.set?.('locale', this.locale);
          if (currency) configStore?.set?.('currency', this.currency);
        }
      };

      Alpine.store('i18n', store);
      store.init();

      if (typeof window !== 'undefined') {
    window.t = (key, fallback, params) => Alpine.store('i18n').t(key, fallback, params);
    window.fitLocaleStore = () => Alpine.store('i18n');
  }
    const getAlpine = () => {
      if (typeof globalThis !== 'undefined' && globalThis.Alpine) return globalThis.Alpine;
      if (typeof window !== 'undefined' && window.Alpine) return window.Alpine;
      return null;
    };

    const ensureI18nStore = () => {
      const AlpineRef = getAlpine();
      if (AlpineRef && typeof AlpineRef.store === 'function') {
        try { return AlpineRef.store('i18n'); }
        catch { return null; }
      }
      return null;
    };

    const fallbackFormat = (value, currency) => {
      const cur = currency || DEFAULT_CURRENCY;
      try {
        return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: cur, maximumFractionDigits: 0 }).format(Number(value || 0));
      } catch {
        return `${Number(value || 0)} ${cur}`;
      }
    };

    const moneyApi = {
      format(value, opts = {}) {
        const store = ensureI18nStore();
        const baseCurrency = (window.__fitI18n && window.__fitI18n.defaultCurrency) || DEFAULT_CURRENCY;
        const fromCurrency = opts.fromCurrency || baseCurrency;
        const targetCurrency = opts.currency || store?.currency || baseCurrency;
        let moneyTick;
        const AlpineRef = getAlpine();
        if (AlpineRef && typeof AlpineRef.store === 'function') {
          try { moneyTick = AlpineRef.store('money')?.tick; }
          catch { moneyTick = undefined; }
        }
        void moneyTick;
        if (store && typeof store.formatCurrency === 'function') {
          try {
            return store.formatCurrency(Number(value || 0), {
              fromCurrency,
              currency: targetCurrency,
              locale: opts.locale
            });
          } catch (e) {
            console.warn('[money] format failed', e);
          }
        }
        return fallbackFormat(value, targetCurrency);
      },
      convert(value, opts = {}) {
        const numeric = Number(value || 0);
        const store = ensureI18nStore();
        const baseCurrency = (window.__fitI18n && window.__fitI18n.defaultCurrency) || DEFAULT_CURRENCY;
        const fromCurrency = opts.fromCurrency || baseCurrency;
        const toCurrency = opts.toCurrency || opts.currency || store?.currency || baseCurrency;
        if (!store || typeof store.convert !== 'function') return numeric;
        try {
          return store.convert(numeric, { fromCurrency, toCurrency });
        } catch (e) {
          console.warn('[money] convert failed', e);
          return numeric;
        }
      },
      toBase(value, opts = {}) {
        const store = ensureI18nStore();
        const baseCurrency = (window.__fitI18n && window.__fitI18n.defaultCurrency) || DEFAULT_CURRENCY;
        const fromCurrency = opts.fromCurrency || store?.currency || baseCurrency;
        return this.convert(value, { fromCurrency, toCurrency: baseCurrency });
      }
    };

    const globalRoot = (typeof globalThis !== 'undefined') ? globalThis : (typeof window !== 'undefined' ? window : {});
    globalRoot.__fitMoney = moneyApi;
    globalRoot.formatCurrency = (value, opts) => moneyApi.format(value, opts);
    globalRoot.convertCurrency = (value, opts) => moneyApi.convert(value, opts);
    }

    if (!Alpine.store('contacts')) {
      const sanitizePhone = (raw) => {
        if (!raw) return '';
        const trimmed = String(raw).trim();
        const digits = trimmed.replace(/[^0-9+]/g, '');
        if (!digits) return '';
        return digits.startsWith('+') ? '+' + digits.replace(/^\++/, '') : digits;
      };

      const normalizeList = (payload, locale) => {
        if (!payload) return [];
        if (Array.isArray(payload)) {
          return payload
            .map((item, idx) => {
              const src = item && typeof item === 'object' ? item : {};
              const name = src.name != null ? String(src.name).trim() : '';
              const description = src.description != null ? String(src.description).trim() : '';
              const phone = src.phone != null ? String(src.phone).trim() : '';
              const email = src.email != null ? String(src.email).trim() : '';
              const route = src.route != null ? String(src.route).trim() : '';
              const icon = src.icon != null ? String(src.icon).trim() : '';
              return {
                id: src.id != null ? String(src.id).trim() : `contact-${idx}`,
                name,
                description,
                phone: phone || null,
                email: email || null,
                route: route || null,
                icon: icon || null,
                primary: !!src.primary
              };
            })
            .filter(item => item.name || item.phone || item.email || item.route);
        }
        if (typeof payload === 'object') {
          const keys = [
            locale,
            locale?.toLowerCase?.(),
            locale?.split?.('-')?.[0],
            locale?.split?.('-')?.[0]?.toLowerCase?.(),
            'default',
            'DEFAULT'
          ].filter(Boolean);
          for (const key of keys) {
            if (Object.prototype.hasOwnProperty.call(payload, key)) {
              const nested = payload[key];
              const normalized = normalizeList(nested, locale);
              if (normalized.length) return normalized;
            }
          }
        }
        return [];
      };

      const buildSources = (locale, includeDefault = true) => {
        const sources = [];
        const normalized = String(locale || '').trim();
        const lower = normalized.toLowerCase();
        const lang = normalized.split('-')[0];
        const langLower = lang ? lang.toLowerCase() : '';
        if (normalized) {
          sources.push(`./data/contacts.${normalized}.json`);
          sources.push(`./data/contacts-${normalized}.json`);
          sources.push(`./data/contacts/${normalized}.json`);
        }
        if (lower && lower !== normalized) {
          sources.push(`./data/contacts.${lower}.json`);
          sources.push(`./data/contacts-${lower}.json`);
          sources.push(`./data/contacts/${lower}.json`);
        }
        if (lang) {
          sources.push(`./data/contacts.${lang}.json`);
          sources.push(`./data/contacts-${lang}.json`);
          sources.push(`./data/contacts/${lang}.json`);
        }
        if (langLower && langLower !== lang) {
          sources.push(`./data/contacts.${langLower}.json`);
          sources.push(`./data/contacts-${langLower}.json`);
          sources.push(`./data/contacts/${langLower}.json`);
        }
        if (includeDefault) {
          sources.push('./data/contacts.json');
        }
        return Array.from(new Set(sources));
      };

      const resolvePrimary = (items) => {
        if (!Array.isArray(items) || !items.length) return null;
        const explicit = items.find(item => item.primary);
        if (explicit) return explicit;
        const both = items.find(item => item.phone && item.email);
        if (both) return both;
        const withPhone = items.find(item => item.phone);
        if (withPhone) return withPhone;
        const withEmail = items.find(item => item.email);
        if (withEmail) return withEmail;
        return items[0];
      };

      const toPhoneHref = (phone) => {
        const sanitized = sanitizePhone(phone);
        if (!sanitized) return null;
        const digitsOnly = sanitized.startsWith('+') ? sanitized : sanitized.replace(/[^0-9]/g, '');
        if (!digitsOnly) return null;
        return `tel:${digitsOnly}`;
      };

      const toEmailHref = (email) => {
        if (!email) return null;
        const trimmed = String(email).trim();
        if (!trimmed) return null;
        return `mailto:${trimmed}`;
      };

      const toRouteHref = (route) => {
        if (!route) return null;
        const trimmed = String(route).trim();
        if (!trimmed) return null;
        if (/^(https?:)?\/\//i.test(trimmed)) return trimmed;
        if (trimmed.startsWith('/')) return trimmed;
        if (trimmed.startsWith('#')) return trimmed;
        return `#/${trimmed.replace(/^#?\/?/, '')}`;
      };

      const store = {
        locale: null,
        items: [],
        primaryId: null,
        status: 'idle',
        error: null,
        source: null,
        open: false,
        _pending: null,
        get primary() {
          if (!this.primaryId) return resolvePrimary(this.items);
          return this.items.find(item => item.id === this.primaryId) || resolvePrimary(this.items);
        },
        get primaryPhone() {
          return this.primary?.phone || null;
        },
        get primaryPhoneHref() {
          return toPhoneHref(this.primary?.phone) || null;
        },
        get primaryEmail() {
          return this.primary?.email || null;
        },
        get primaryEmailHref() {
          return toEmailHref(this.primary?.email) || null;
        },
        async init() {
          const localeStore = Alpine.store('i18n');
          const initialLocale = localeStore?.locale || localeStore?.fallbackLocale || (window.__fitI18n && window.__fitI18n.defaultLocale) || 'cs-CZ';
          await this.load(initialLocale);
          window.addEventListener('fit:locale-change', (event) => {
            const next = event?.detail?.locale;
            if (!next) return;
            if (next === this.locale) return;
            this.load(next);
          });
        },
        async load(locale) {
          const target = String(locale || '').trim() || this.locale || (window.__fitI18n && window.__fitI18n.defaultLocale) || 'cs-CZ';
          if (this._pending && this.locale === target) return this._pending;
          this.locale = target;
          this.status = 'loading';
          this.error = null;
          const defaultSource = './data/contacts.json';
          const candidates = buildSources(target, false);
          const task = (async () => {
            let lastError = null;
            const trySource = async (url, { allowEmpty = true } = {}) => {
              try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) {
                  if (res.status === 404) return false;
                  throw new Error(`HTTP ${res.status}`);
                }
                const json = await res.json();
                const list = normalizeList(json, target);
                const arr = Array.isArray(list) ? list : [];
                if (!arr.length && !allowEmpty) return false;
                this.items = arr;
                this.primaryId = resolvePrimary(this.items)?.id || null;
                this.source = url;
                this.status = 'ready';
                this.error = null;
                if (!this.items.length) {
                  console.warn('[contacts] loaded empty contact list from', url);
                }
                return true;
              } catch (err) {
                lastError = err;
                return false;
              }
            };

            if (await trySource(defaultSource, { allowEmpty: false })) {
              return this.items;
            }

            for (const url of candidates) {
              if (url === defaultSource) continue;
              const loaded = await trySource(url, { allowEmpty: true });
              if (loaded) return this.items;
            }

            this.items = [];
            this.primaryId = null;
            this.source = null;
            this.status = 'error';
            this.error = lastError ? String(lastError.message || lastError) : 'Failed to load contacts';
            console.warn('[contacts] load failed', lastError);
            return [];
          })().finally(() => {
            this._pending = null;
          });
          this._pending = task;
          return task;
        },
        ensureLoaded() {
          if (this.status === 'idle' || this.status === 'error') {
            return this.load(this.locale);
          }
          return this._pending || Promise.resolve(this.items);
        },
        phoneHref(contact) {
          return toPhoneHref(contact?.phone);
        },
        emailHref(contact) {
          return toEmailHref(contact?.email);
        },
        routeHref(contact) {
          return toRouteHref(contact?.route);
        },
        openModal() {
          this.open = true;
        },
        closeModal() {
          this.open = false;
        },
        toggleModal() {
          this.open = !this.open;
        }
      };

      Alpine.store('contacts', store);
      store.init();
    }

    Alpine.data('localeSwitcher', () => ({
      get store() { return Alpine.store('i18n'); },
      init() {
        this.store?.requestNamespace?.('ui');
      },
      get availableLocales() {
        return this.store?.listLocales?.() || [];
      },
      get activeMeta() {
        return this.store?.getLocaleMeta?.(this.store?.locale) || null;
      },
      activeLabel() {
        const meta = this.activeMeta;
        const fallback = meta?.nativeName || meta?.englishName || meta?.code || '';
        if (meta?.code && typeof this.store?.t === 'function') {
          return this.store.t(`header.languageMenu.options.${meta.code}`, fallback);
        }
        return fallback;
      },
      optionLabel(code) {
        const meta = this.store?.getLocaleMeta?.(code);
        const fallback = meta?.nativeName || meta?.englishName || code;
        if (typeof this.store?.t === 'function') {
          return this.store.t(`header.languageMenu.options.${code}`, fallback);
        }
        return fallback;
      },
      optionIcon(code) {
        return this.store?.getLocaleMeta?.(code)?.icon || '';
      },
      isActive(code) {
        return (this.store?.locale || '') === code;
      },
      select(code) {
        this.store?.setLocale?.(code);
      }
    }));

    Alpine.data('contactQuickAction', () => ({
      get store() { return Alpine.store('contacts'); },
      get i18n() { return Alpine.store('i18n'); },
      init() {
        this.store?.ensureLoaded?.();
      },
      get phoneLabel() {
        return this.store?.primaryPhone || this.i18n?.resolveConfig?.('contact.phone.display') || '';
      },
      get contactName() {
        return this.store?.primary?.name || '';
      },
      get hasPhone() {
        return !!this.phoneLabel;
      },
      openModal() {
        const ensure = this.store?.ensureLoaded?.();
        if (ensure && typeof ensure.then === 'function') {
          ensure.finally(() => this.store?.openModal?.());
        } else {
          this.store?.openModal?.();
        }
      },
      closeModal() {
        this.store?.closeModal?.();
      },
      get isOpen() {
        return !!this.store?.open;
      }
    }));

    Alpine.data('quickSearchControl', (ctx) => ({
      ctx,
      expanded: false,
      get query() {
        const value = ctx && typeof ctx.search !== 'undefined' ? ctx.search : '';
        return value == null ? '' : String(value);
      },
      set query(value) {
        if (ctx && typeof ctx.search !== 'undefined') {
          ctx.search = value;
        }
      },
      get trimmed() {
        return this.query.trim();
      },
      hasQuery() {
        return this.trimmed.length > 0;
      },
      open() {
        if (this.expanded) return;
        this.expanded = true;
        this.$nextTick(() => this.$refs.input?.focus());
      },
      close(force = false) {
        if (!force && this.hasQuery()) return;
        this.expanded = false;
      },
      clear() {
        this.query = '';
        this.close(true);
      },
      init() {
        if (this.hasQuery()) this.expanded = true;
        this.$watch(() => this.query, (value) => {
          const trimmed = String(value || '').trim();
          const input = this.$refs?.input;
          if (trimmed.length) {
            this.expanded = true;
          } else if (!input || document.activeElement !== input) {
            this.expanded = false;
          }
        });
      }
    }));

    Alpine.data('drMaxWomanToast', () => ({
      dismissed: false,
      _onConfig: null,
      get configStore() {
        return Alpine.store('appConfig');
      },
      get isEnabled() {
        return !!this.configStore?.drMaxWomanPromo;
      },
      get isVisible() {
        return this.isEnabled && !this.dismissed;
      },
      init() {
        this._onConfig = (event) => {
          if (!event || event?.detail?.key !== 'drMaxWomanPromo') return;
          if (event.detail.value) {
            this.dismissed = false;
          }
        };
        window.addEventListener('fit:config-change', this._onConfig);
        if (this.$el) {
          this.$el.addEventListener('alpine:destroy', () => {
            if (this._onConfig) {
              window.removeEventListener('fit:config-change', this._onConfig);
              this._onConfig = null;
            }
          }, { once: true });
        }
      },
      close() {
        this.dismissed = true;
      }
    }));

    if (!Alpine.store('precart')) {
      Alpine.store('precart', {
        // state
        isOpen: false,
        product: null,
        catalog: [],
        quickAdded: new Set(),
  
        // api
        setCatalog(arr) { this.catalog = Array.isArray(arr) ? arr : []; },
        recommend(limit = 8) {
          const cur = String(this.product?.id ?? '');
          return (this.catalog || []).filter(p => String(p.id) !== cur).slice(0, limit);
        },
        open(product) {
          this.product = product || null;
          this.isOpen = !!this.product;
          this.quickAdded.clear();
        },
        close() {
          this.isOpen = false;
          this.product = null;
          this.quickAdded.clear();
        },
        markQuickAdded(id) { this.quickAdded.add(String(id)); },
        isQuickAdded(id)   { return this.quickAdded.has(String(id)); },
      });
    }

    if (!Alpine.store('saved')) {
      const savedStore = {
        key: 'fit:saved-products',
        items: [],
        load() {
          if (typeof localStorage === 'undefined') return this.items;
          try {
            const raw = localStorage.getItem(this.key);
            const parsed = raw ? JSON.parse(raw) : [];
            this.items = Array.isArray(parsed) ? parsed : [];
          } catch (e) {
            console.warn('saved store load failed', e);
            this.items = [];
          }
          return this.items;
        },
        persist() {
          if (typeof localStorage === 'undefined') return;
          try {
            localStorage.setItem(this.key, JSON.stringify(this.items));
          } catch (e) {
            console.warn('saved store persist failed', e);
          }
        },
        list() { return this.items.slice(); },
        normalize(product) {
          const src = product || {};
          const rawId = src.id ?? src.productId ?? null;
          if (rawId == null) return null;
          const pickFirst = arr => Array.isArray(arr) ? arr.find(Boolean) : null;
          const image = src.image || pickFirst(src.images) || pickFirst(src.photos) || '';
          const price = Number(src.price);
          const discounted = Number(src.discounted_price);
          const normalized = {
            id: String(rawId),
            name: src.name || '',
            image,
            price: Number.isFinite(price) ? price : null,
            discounted_price: Number.isFinite(discounted) ? discounted : null,
            brand: src.brand || '',
            perex: src.perex || '',
            savedAt: Date.now(),
          };
          if (src.url) normalized.url = src.url;
          if (src.slug) normalized.slug = src.slug;
          if (src.variantId != null) normalized.variantId = src.variantId;
          if (src.productId != null && src.productId !== rawId) normalized.productId = src.productId;
          return normalized;
        },
        isSaved(id) {
          const key = String(id ?? '');
          if (!key) return false;
          return this.items.some(item => String(item.id) === key);
        },
        save(product) {
          const normalized = this.normalize(product);
          if (!normalized) return false;
          this.items = [
            normalized,
            ...this.items.filter(item => String(item.id) !== normalized.id)
          ];
          this.persist();
          return true;
        },
        remove(id) {
          const key = String(id ?? '');
          if (!key) return false;
          const before = this.items.length;
          this.items = this.items.filter(item => String(item.id) !== key);
          if (this.items.length !== before) {
            this.persist();
            return true;
          }
          return false;
        },
        toggle(product) {
          const normalized = this.normalize(product);
          if (!normalized) return false;
          if (this.isSaved(normalized.id)) {
            this.remove(normalized.id);
            return false;
          }
          this.save(normalized);
          return true;
        },
        replace(list) {
          if (!Array.isArray(list)) return;
          this.items = list.slice();
          this.persist();
        }
      };
      Alpine.store('saved', savedStore);
      savedStore.load();
    } else {
      Alpine.store('saved').load?.();
    }

    if (!Alpine.store('activeOrder')) {
      const storageKey = 'fit:active-order';
      const underlineClass = 'underline underline-offset-4 decoration-4 decoration-max-blue-500';
      const fallbackFlowSteps = {
        home_delivery_pay_online: [
          'order_acceptation',
          'order_payment_online',
          'order_completion',
          'order_shipped',
          'order_delivered',
          'order_received'
        ],
        home_delivery_cash_on_delivery: [
          'order_acceptation',
          'order_completion',
          'order_shipped',
          'order_delivered',
          'order_payment_on_delivery',
          'order_received'
        ],
        pharmacy_reservation: [
          'order_acceptation',
          'order_completion',
          'order_prepared',
          'order_payment_pharmacy',
          'order_received'
        ]
      };

      const escapeHtml = (input) => {
        if (input == null) return '';
        return String(input)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };

      const capitalize = (value) => {
        const s = String(value || '');
        return s ? s.charAt(0).toUpperCase() + s.slice(1) : '';
      };

      const formatOrderNumber = (value) => {
        const digits = String(value || '').replace(/\D+/g, '');
        if (!digits) return '';
        return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      };

      const computePurchaseForms = (kind = 'order') => {
        if (kind === 'reservation') {
          return {
            nominative: 'Rezervace',
            nominativeLower: 'rezervace',
            accusativeLower: 'rezervaci',
            genitiveLower: 'rezervace'
          };
        }
        return {
          nominative: 'Objednávka',
          nominativeLower: 'objednávka',
          accusativeLower: 'objednávku',
          genitiveLower: 'objednávky'
        };
      };

      const detectFlowFromContext = (context = {}) => {
        if (context.flowId) return context.flowId;
        const delivery = context.deliveryMeta || {};
        const payment = context.paymentMeta || {};
        const deliveryType = String(delivery.type || '').toLowerCase();
        const deliveryName = String(delivery.name || '').toLowerCase();
        const mapType = String(delivery.mapType || '').toLowerCase();
        const paymentName = String(payment.name || '').toLowerCase();

        const isPharmacy =
          deliveryType === 'pickup' &&
          (mapType === 'pharmacy' || deliveryName.includes('lékárn'));
        if (isPharmacy) return 'pharmacy_reservation';

        const isCash = paymentName.includes('dobírk');
        if (isCash) return 'home_delivery_cash_on_delivery';

        return 'home_delivery_pay_online';
      };

      const detectPurchaseKind = (flowId = '') => {
        return flowId === 'pharmacy_reservation' ? 'reservation' : 'order';
      };

      const resolveDeliveryAddress = (deliveryMeta = {}, deliveryDetails = []) => {
        const pickupAddress = deliveryMeta?.pickup?.addressLine || '';
        const pickupName = deliveryMeta?.pickup?.name || '';
        if (pickupAddress) {
          return [pickupName, pickupAddress]
            .map(part => String(part || '').trim())
            .filter(Boolean)
            .join(', ');
        }
        const detail = (Array.isArray(deliveryDetails) ? deliveryDetails : []).find(item =>
          /adresa|adresu/i.test(String(item?.label || ''))
        );
        if (detail?.value) {
          return String(detail.value)
            .split('\n')
            .map(part => part.trim())
            .filter(Boolean)
            .join(', ');
        }
        return '';
      };

      const estimatePackages = (items = []) => {
        const totalQty = (Array.isArray(items) ? items : []).reduce((sum, item) => {
          const qty = Number(item?.qty || 0);
          return sum + (Number.isFinite(qty) ? qty : 0);
        }, 0);
        if (!totalQty) return 1;
        return Math.max(1, Math.ceil(totalQty / 4));
      };

      const estimateWeight = (items = []) => {
        const totalQty = (Array.isArray(items) ? items : []).reduce((sum, item) => {
          const qty = Number(item?.qty || 0);
          return sum + (Number.isFinite(qty) ? qty : 0);
        }, 0);
        const weight = totalQty * 0.35;
        const normalized = weight > 0 ? weight : 0.35;
        return normalized.toFixed(2);
      };

      const activeOrderStore = {
        key: storageKey,
        loading: false,
        error: null,
        flows: [],
        steps: {},
        order: null,
        cashModalOpen: false,
        _dataLoaded: false,

        async ensureData() {
          if (this._dataLoaded || this.loading) return;
          this.loading = true;
          this.error = null;
          try {
            const [flowRes, stepRes] = await Promise.all([
              fetch('./data/order-flow.json', { cache: 'no-store' }),
              fetch('./data/order-tracking.json', { cache: 'no-store' })
            ]);
            const flowJson = await flowRes.json();
            const stepJson = await stepRes.json();
            this.flows = Array.isArray(flowJson) ? flowJson : [];
            this.steps = Array.isArray(stepJson)
              ? stepJson.reduce((acc, item) => {
                  if (item?.id) acc[item.id] = item;
                  return acc;
                }, {})
              : {};
            this._dataLoaded = true;
          } catch (e) {
            console.warn('activeOrder: failed to load flow data', e);
            this.error = 'Nepodařilo se načíst data objednávky.';
            this._dataLoaded = false;
          } finally {
            this.loading = false;
          }
        },

        restore() {
          if (typeof localStorage === 'undefined') return;
          try {
            const raw = localStorage.getItem(this.key);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object' && parsed.order) {
              this.order = parsed.order;
              this.cashModalOpen = false;
              this.normalizeOrder();
            }
          } catch (e) {
            console.warn('activeOrder: restore failed', e);
          }
        },

        persist() {
          if (typeof localStorage === 'undefined') return;
          try {
            if (!this.order) {
              localStorage.removeItem(this.key);
              return;
            }
            const payload = {
              order: this.order,
              version: 1
            };
            localStorage.setItem(this.key, JSON.stringify(payload));
          } catch (e) {
            console.warn('activeOrder: persist failed', e);
          }
        },

        hasOrder() {
          return !!this.order;
        },

        orderLabel() {
          if (!this.order) return '';
          const forms = this.order.purchaseTypeForms || computePurchaseForms();
          const label = forms.nominative || capitalize(forms.nominativeLower || 'Objednávka');
          return `${label} #${this.order.number || ''}`.trim();
        },

        formattedOrderNumber() {
          if (!this.order) return '';
          return this.order.vars?.ORDER_NUMBER || formatOrderNumber(this.order.number);
        },

        flowById(id) {
          return this.flows.find(flow => flow?.id === id) || null;
        },

        flowSteps(id) {
          const flow = this.flowById(id);
          if (flow && Array.isArray(flow.steps)) return flow.steps.slice();
          const fallback = fallbackFlowSteps[id];
          return Array.isArray(fallback) ? fallback.slice() : [];
        },

        generateOrderNumber() {
          const base = Math.floor(Math.random() * 9_000_000_000) + 1_000_000_000;
          return String(base);
        },

        formatTimestamp(ts) {
          if (!ts) return '';
          const date = new Date(ts);
          if (Number.isNaN(date.getTime())) return '';
          try {
            return new Intl.DateTimeFormat('cs-CZ', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }).format(date);
          } catch {
            return date.toLocaleString('cs-CZ');
          }
        },

        normalizeOrder() {
          if (!this.order) return;
          const steps = this.flowSteps(this.order.flowId);
          if (!steps.length) return;
          const meta = this.order.stepMeta && typeof this.order.stepMeta === 'object'
            ? { ...this.order.stepMeta }
            : {};
          const current = steps.includes(this.order.currentStepId) ? this.order.currentStepId : steps[0];
          steps.forEach(stepId => {
            if (!meta[stepId]) {
              meta[stepId] = { state: 'future', timestamp: null };
            }
          });
          this.order.currentStepId = current;
          this.order.stepMeta = meta;
          if (!this.order.purchaseTypeForms) {
            const kind = detectPurchaseKind(this.order.flowId);
            this.order.purchaseTypeForms = computePurchaseForms(kind);
          }
          if (this.order.vars && !this.order.vars.PURCHASE_TYPE_FORMS) {
            this.order.vars.PURCHASE_TYPE_FORMS = this.order.purchaseTypeForms;
          }
        },

        detectFlow(context = {}) {
          return detectFlowFromContext(context);
        },

        buildVars(context, forms, orderNumber, flowId) {
          const review = context.review || {};
          const deliveryMeta = context.deliveryMeta || {};
          const paymentMeta = context.paymentMeta || {};
          const cartSummary = review.cart || context.cartSummary || {};
          const items = cartSummary.items || [];
          const flowPaymentFallback = {
            home_delivery_pay_online: 'Kartou online',
            home_delivery_cash_on_delivery: 'Na dobírku',
            pharmacy_reservation: 'V lékárně'
          };
          const flowDeliveryFallback = {
            home_delivery_pay_online: 'Kurýr',
            home_delivery_cash_on_delivery: 'Kurýr',
            pharmacy_reservation: 'Lékárna Dr. Max'
          };

          const vars = {
            ORDER_NUMBER: formatOrderNumber(orderNumber),
            PAYMENT_METHOD: paymentMeta.name || flowPaymentFallback[flowId] || '',
            DELIVERY_METHOD: deliveryMeta.name || flowDeliveryFallback[flowId] || '',
            DELIVERY_ADDRESS: resolveDeliveryAddress(deliveryMeta, review.deliveryDetails),
            PACKAGES_COUNT: String(estimatePackages(items)),
            TOTAL_WEIGHT: estimateWeight(items),
            PURCHASE_TYPE_FORMS: forms
          };
          return vars;
        },

        resolvePurchaseType(full, offset, matchLength, forms) {
          const accLower = forms.accusativeLower || forms.nominativeLower || '';
          const genLower = forms.genitiveLower || accLower;
          const nomLower = forms.nominativeLower || accLower;
          const nom = forms.nominative || capitalize(nomLower);

          const prefix = full.slice(0, offset);
          const suffix = full.slice(offset + matchLength);
          const trimmedPrefix = prefix.trimEnd();
          const prevWord = trimmedPrefix.split(/\s+/).pop()?.toLowerCase() || '';
          const atSentenceStart = trimmedPrefix === '' || /[.!?]\s*$/.test(trimmedPrefix);
          const nextWord = suffix.trimStart().split(/[\s,.;?!]/).shift()?.toLowerCase() || '';
          const nominativeTriggers = ['je', 'má', 'bude', 'zůstává', 'čeká'];

          if (prevWord === 'vaší') return genLower;
          if (prevWord === 'vaši') return accLower;

          if (nominativeTriggers.includes(nextWord)) {
            return atSentenceStart ? nom : nomLower;
          }

          if (!accLower) return atSentenceStart ? capitalize(nomLower) : nomLower;
          return atSentenceStart ? capitalize(accLower) : accLower;
        },

        fillTemplate(template, vars = {}) {
          if (!template) return '';
          const str = String(template);
          const forms = vars.PURCHASE_TYPE_FORMS || this.order?.purchaseTypeForms || computePurchaseForms();
          return str.replace(/{{\s*([A-Z0-9_]+)\s*}}/g, (match, key, offset, full) => {
            if (key === 'PURCHASE_TYPE') {
              return this.resolvePurchaseType(full, offset, match.length, forms);
            }
            const value = vars[key];
            return value == null ? '' : String(value);
          });
        },

        plainText(template, vars = {}) {
          const filled = this.fillTemplate(template, vars);
          if (!filled) return '';
          return filled.replace(/<\/?u>/g, '').replace(/\s{2,}/g, ' ').trim();
        },

        richText(template, vars = {}) {
          const filled = this.fillTemplate(template, vars);
          if (!filled) return '';
          const placeholders = [];
          let withTokens = filled.replace(/<u>(.*?)<\/u>/g, (_, inner) => {
            const idx = placeholders.length;
            placeholders.push(escapeHtml(inner));
            return `__UNDERLINE_${idx}__`;
          });
          withTokens = escapeHtml(withTokens).replace(/\n/g, '<br>');
          placeholders.forEach((content, idx) => {
            withTokens = withTokens.replace(
              `__UNDERLINE_${idx}__`,
              `<span class="${underlineClass}">${content}</span>`
            );
          });
          return withTokens;
        },

        templateForState(template, state, field) {
          if (!template) return '';
          const key = `${state}_${field}`;
          return template[key] ?? '';
        },

        timeline() {
          if (!this.order) return [];
          this.normalizeOrder();
          const steps = this.flowSteps(this.order.flowId);
          if (!steps.length) return [];
          const vars = { ...(this.order.vars || {}) };
          vars.PURCHASE_TYPE_FORMS = this.order.purchaseTypeForms || vars.PURCHASE_TYPE_FORMS || computePurchaseForms();
          return steps.map(stepId => {
            const template = this.steps[stepId] || {};
            const meta = this.order.stepMeta?.[stepId] || { state: 'future', timestamp: null };
            const state = meta.state || (stepId === this.order.currentStepId ? 'now' : 'future');
            const headlineTpl = this.templateForState(template, state, 'headline')
              || this.templateForState(template, 'past', 'headline')
              || this.templateForState(template, 'now', 'headline')
              || this.templateForState(template, 'future', 'headline');
            const descriptionTpl = this.templateForState(template, state, 'description')
              || '';
            return {
              id: stepId,
              state,
              headline: this.plainText(headlineTpl, vars),
              description: this.richText(descriptionTpl, vars),
              timestamp: this.formatTimestamp(meta.timestamp)
            };
          });
        },

        stepOptions() {
          if (!this.order) return [];
          this.normalizeOrder();
          const steps = this.flowSteps(this.order.flowId);
          const vars = { ...(this.order.vars || {}) };
          vars.PURCHASE_TYPE_FORMS = this.order.purchaseTypeForms || vars.PURCHASE_TYPE_FORMS || computePurchaseForms();
          return steps.map((stepId, index) => {
            const template = this.steps[stepId] || {};
            const headlineTpl = template.now_headline
              || template.past_headline
              || template.future_headline
              || `Krok ${index + 1}`;
            const label = this.plainText(headlineTpl, vars) || `Krok ${index + 1}`;
            return { id: stepId, label };
          });
        },

        setCurrentStep(stepId) {
          if (!this.order || !stepId) return;
          const steps = this.flowSteps(this.order.flowId);
          const targetIndex = steps.indexOf(stepId);
          if (targetIndex === -1) return;
          this.normalizeOrder();
          const now = Date.now();
          steps.forEach((id, idx) => {
            const meta = this.order.stepMeta[id] || { state: 'future', timestamp: null };
            if (idx < targetIndex) {
              meta.state = 'past';
              if (!meta.timestamp) {
                const offset = (targetIndex - idx) * 45 * 60 * 1000;
                meta.timestamp = new Date(now - offset).toISOString();
              }
            } else if (idx === targetIndex) {
              meta.state = 'now';
              meta.timestamp = new Date(now).toISOString();
            } else {
              meta.state = 'future';
              meta.timestamp = null;
            }
            this.order.stepMeta[id] = meta;
          });
          this.order.currentStepId = stepId;
          if (this.order.flowId === 'home_delivery_cash_on_delivery' && this.order.cashModalShown !== true) {
            this.order.cashModalShown = true;
          }
          this.persist();
        },

        clearOrder() {
          this.order = null;
          this.cashModalOpen = false;
          this.persist();
        },

        createFromCheckout(context = {}) {
          const flowId = this.detectFlow(context);
          const steps = this.flowSteps(flowId);
          if (!steps.length) return;
          const kind = detectPurchaseKind(flowId);
          const forms = computePurchaseForms(kind);
          const number = context.orderNumber || this.generateOrderNumber();
          const targetStep = steps.includes('order_completion') ? 'order_completion' : steps[steps.length - 1];
          const targetIndex = Math.max(0, steps.indexOf(targetStep));
          const now = Date.now();
          const stepMeta = {};
          steps.forEach((id, idx) => {
            let state = 'future';
            if (idx < targetIndex) state = 'past';
            else if (idx === targetIndex) state = 'now';
            let timestamp = null;
            if (state !== 'future') {
              const offset = (targetIndex - idx) * 45 * 60 * 1000;
              timestamp = new Date(now - offset).toISOString();
            }
            stepMeta[id] = { state, timestamp };
          });

          const vars = this.buildVars(context, forms, number, flowId);

          this.order = {
            number,
            flowId,
            currentStepId: steps[targetIndex],
            createdAt: new Date(now).toISOString(),
            vars,
            stepMeta,
            purchaseTypeForms: forms,
            cashModalShown: flowId === 'home_delivery_cash_on_delivery' ? false : true
          };
          this.normalizeOrder();
          this.persist();
          this.openCashModalIfNeeded();
        },

        openCashModalIfNeeded() {
          if (!this.order) {
            this.cashModalOpen = false;
            return;
          }
          if (this.order.flowId === 'home_delivery_cash_on_delivery' && this.order.cashModalShown !== true) {
            this.cashModalOpen = true;
          } else {
            this.cashModalOpen = false;
          }
        },

        acknowledgeCashModal() {
          if (this.order && this.order.flowId === 'home_delivery_cash_on_delivery') {
            this.order.cashModalShown = true;
            this.persist();
          }
          this.cashModalOpen = false;
          location.hash = '/order-tracking';
        }
      };

  Alpine.store('activeOrder', activeOrderStore);
  activeOrderStore.restore();
} else {
  Alpine.store('activeOrder').restore?.();
}

    window.addEventListener('fit:currency-change', () => {
      try {
        Alpine.store('money')?.bump?.();
      } catch (e) {
        console.warn('money tick bump failed', e);
      }
    });
  });

  window.addEventListener('fit:locale-change', () => {
    Alpine.store('menu')?.refreshForLocale?.();
  });
  </script>
</head>

<body class="bg-base-200 overflow-x-hidden" x-data="storeApp()">
  <!-- TOP-BAR LOGO + SEARCH -->
<div class="navbar md:p-6 p-2 pt-4 pb-2 bg-base-100 overflow-visible">
  <!-- left: menu + logo + (desktop) search -->
  <div class="flex flex-1 items-start gap-3 md:gap-4 min-w-0">
    <button class="btn btn-primary w-[46px] h-[46px] btn-lg btn-square inline-flex md:hidden shrink-0 self-start"
            :class="maxGradientClass()"
            aria-label="Otevřít menu"
            :aria-label="t('header.actions.menu.aria', 'Otevřít menu')"
            title="Menu"
            :title="t('header.actions.menu.label', 'Menu')"
            @click="$store.menu.openAt()">
      <img
        alt="Menu"
        :alt="t('header.actions.menu.label', 'Menu')"
        class="relative h-[26px] w-[27px]"
        src="./icons/Bars.svg"
      />
    </button>

    <a href="/" @click.prevent="go('home')" class="flex flex-col items-center justify-center leading-none">
        <svg viewBox="0 0 137 46" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-[46px] md:h-[56px] shrink-0">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M23.2836 45.2917C10.8401 45.2917 0.716797 35.2915 0.716797 23C0.716797 10.7082 10.8401 0.708008 23.2836 0.708008H113.716C126.16 0.708008 136.283 10.7082 136.283 23C136.283 35.2915 126.16 45.2917 113.716 45.2917H23.2836Z" fill="white"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M113.716 0H23.284C10.4451 0 0 10.3177 0 22.9999C0 35.682 10.4451 46 23.284 46H113.716C126.555 46 137 35.682 137 22.9999C137 10.3177 126.555 0 113.716 0M113.716 1.41634C125.765 1.41634 135.566 11.0987 135.566 22.9999C135.566 34.901 125.765 44.5837 113.716 44.5837H23.284C11.2357 44.5837 1.43382 34.901 1.43382 22.9999C1.43382 11.0987 11.2357 1.41634 23.284 1.41634H113.716" fill="#A7A8AA"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M120.794 11.6358H117.464V8.34591C117.464 7.1797 116.503 6.23047 115.322 6.23047C114.141 6.23047 113.18 7.1797 113.18 8.34591V11.6358H109.85C108.669 11.6358 107.708 12.5847 107.708 13.7512C107.708 14.9177 108.669 15.8669 109.85 15.8669H113.18V19.1565C113.18 20.3233 114.141 21.2722 115.322 21.2722C116.503 21.2722 117.464 20.3233 117.464 19.1565V15.8669H120.794C121.975 15.8669 122.936 14.9177 122.936 13.7512C122.936 12.5847 121.975 11.6358 120.794 11.6358Z" fill="#78BE20"/>
          <path d="M85.4546 17.7158C89.5262 17.7158 93.0472 19.4528 93.0474 24.2979V33.2529C93.0473 33.6425 92.7276 33.9578 92.3335 33.958H88.9282C88.5144 33.958 88.1792 33.6269 88.1792 33.2188V31.46H88.1177C86.8629 33.4403 85.3324 34.3242 83.0669 34.3242C79.9134 34.3242 77.0962 32.7696 77.0962 29.3262C77.0964 24.4812 82.3933 23.9023 85.3325 23.9023C86.2199 23.9024 87.1996 23.9932 87.9038 24.1152C87.873 21.9519 86.2503 21.373 84.2603 21.373C82.6326 21.3731 81.0676 21.6288 79.6284 22.333C79.4478 22.4213 79.1721 22.2252 79.1675 22.0264L79.0972 19.2578C79.0909 19.0095 79.2418 18.7797 79.4771 18.6924C81.3186 18.0086 83.2532 17.7158 85.4546 17.7158ZM47.1782 29.4854C48.4415 29.4856 49.4653 30.5441 49.4653 31.8486C49.4653 33.1535 48.4415 34.2117 47.1782 34.2119C45.9147 34.2119 44.8901 33.1536 44.8901 31.8486C44.8901 30.5439 45.9148 29.4854 47.1782 29.4854ZM24.3267 12.6641C30.8944 12.6641 35.4896 14.9892 35.4897 23.2168C35.4897 31.1702 30.7595 33.9433 24.3267 33.9434H18.2173C17.8497 33.9434 17.5513 33.6068 17.5513 33.1924V13.415C17.5513 13.0003 17.8497 12.6641 18.2173 12.6641H24.3267ZM41.9097 20.1387C43.7154 17.3021 46.6765 17.5948 48.2319 18.1738C48.4727 18.2637 48.6008 18.5224 48.519 18.7637L47.5317 21.6865C47.4225 22.0103 47.0734 22.18 46.7407 22.0879C44.3565 21.4305 41.9097 22.7076 41.9097 26.7285V33.1924C41.9097 33.6067 41.6122 33.9433 41.2446 33.9434H37.8833C37.5157 33.9433 37.2173 33.6068 37.2173 33.1924V18.8701C37.2175 18.4559 37.5158 18.1201 37.8833 18.1201H41.2446C41.6121 18.1202 41.9095 18.4559 41.9097 18.8701V20.1387ZM59.356 12.6787C59.7235 12.6787 60.1161 13.0144 60.2329 13.4287L63.772 26.0264L67.312 13.4287C67.4286 13.0145 67.8214 12.6787 68.189 12.6787H73.1606C73.528 12.679 73.8571 13.0146 73.896 13.4287L75.731 33.2949C75.7694 33.7095 75.5027 33.9432 75.1353 33.9434H71.5171C71.1493 33.9432 70.8204 33.7095 70.7817 33.2949L69.5894 20.3486L65.98 33.2949C65.8851 33.6328 65.7294 33.9432 65.3315 33.9434H62.2134C61.8363 33.9434 61.6599 33.6329 61.5649 33.2949L57.9556 20.3486L56.5542 33.2949C56.5158 33.7095 56.1873 33.9432 55.8198 33.9434H52.4097C52.0421 33.9433 51.7753 33.7096 51.814 33.2949L53.6489 13.4287C53.6875 13.0145 54.0165 12.6788 54.3843 12.6787H59.356ZM98.8892 18.1201C99.3107 18.1199 99.5588 18.18 99.8657 18.5938L102.433 22.0898L105 18.5938C105.307 18.1798 105.555 18.1198 105.977 18.1201H109.941C110.362 18.1206 110.513 18.4106 110.303 18.7119L105.075 25.8076L110.512 33.1992C110.777 33.5263 110.627 33.9432 110.218 33.9434H106.217C105.799 33.9414 105.523 33.7421 105.278 33.4072L102.433 29.5254L99.5884 33.4072C99.343 33.7422 99.0674 33.9413 98.6489 33.9434H94.6479C94.2389 33.9433 94.0884 33.5263 94.353 33.1992L99.7915 25.8076L94.563 18.7119C94.3531 18.4106 94.5034 18.1205 94.9253 18.1201H98.8892ZM85.5776 26.8271C83.7099 26.8271 82.2397 27.407 82.2397 28.9307C82.24 30.0275 83.22 30.667 84.5054 30.667C86.5872 30.667 87.9038 28.7777 87.9038 26.9189C87.1997 26.8886 86.4039 26.8272 85.5776 26.8271ZM22.7231 16.8789V29.7383H24.4341C28.9445 29.7383 30.1958 27.5444 30.1958 23.3086C30.1958 19.0729 28.9804 16.8789 24.4341 16.8789H22.7231Z" fill="#E72234"/>
        </svg>
        <img
          x-show="isDrMaxWomanEnabled()"
          x-cloak
          src="./images/drmax-woman.png"
          alt="Dr. Max Woman"
          class="h-[18px] md:h-[22px] -mt-3 object-contain"
        />
    </a>

    <!-- DESKTOP TOPBAR SEARCH -->
    <div class="relative hidden md:block w-full">
        <div
        x-data="searchBox({
          getProducts:   () => products,
          getCategories: () => navCategories,
          getLinks:      () => infoLinks,
          goTo: (id) => go(`product/${id}`)
        })"
        @keydown="onKeydown($event)"
        @click.outside="open = false"
        @resize.window="onWindowResize()"
        @scroll.window.passive="onWindowResize()"
        class="w-full"
      >
        <label
          x-ref="anchor"
          class="input p-4 input-bordered rounded-full max-w-2xl items-center gap-2 w-full h-[46px] md:h-[56px] max-input-gradient"
          aria-label="Vyhledávání"
          :aria-label="t('header.search.ariaLabel', 'Vyhledávání')"
        >
          <i class="fa-classic fa-xl fa-regular fa-search text-max-gray-600"></i>
    
          <input
            x-ref="input"
            type="search"
            class="grow text-lg min-w-0"
            placeholder="Hledej dle názvu"
            :placeholder="t('header.search.placeholder', 'Hledej dle názvu')"
            x-model.debounce.150ms="q"
            @focus="onFocus()"
            @input="onInput()"
            role="combobox"
            aria-autocomplete="list"
            :aria-expanded="open"
            :aria-controls="listId"
            :aria-activedescendant="activeDesc()"
          />
        </label>
    
        <!-- Dropdown  -->
        <div
        x-show="open"
        x-transition.opacity
        class="fixed z-[33]"
        :style="dropdownStyle"
      >
        <div class="bg-base-100 rounded-2xl shadow-xl border border-base-200 w-full box-border">
          <!-- RECENT -->
          <template x-if="q.trim().length < minChars">
            <ul
              class="p-2 max-h-80 overflow-y-auto w-full flex flex-col space-y-0"
              :id="listId" role="listbox"
            >
              <template x-if="recentItems().length">
                <li
                  class="px-2 py-1 text-xs font-semibold text-base-content/60"
                  x-text="t('header.search.recent', 'Naposledy hledané')"
                >
                  Naposledy hledané
                </li>
              </template>

              <template x-if="!recentItems().length">
                <li
                  class="w-full px-2 py-3 text-base text-center text-max-gray-400"
                  x-text="t('header.search.startTyping', 'Začněte psát váš dotaz…')"
                >
                  Začněte psát váš dotaz…
                </li>
              </template>

              <template x-for="(item, i) in recentItems()" :key="`${item.t}-${item.k ?? i}`">
                <li
                  :id="itemId(i)"
                  class="w-full"
                  role="option"
                  @mouseenter="highlighted = i"
                >
                <a :href="item.href || '#'"
                  @click.prevent="onSelect(item)" 
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
              
                    <!-- thumb for product/category -->
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-14 h-14 object-contain rounded bg-base-200/40" />
                    </template>
              
                    <!-- FA icon bubble for info -->
                    <template x-if="!item.img">
                      <span class="w-14 h-14 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
              
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
              
                    <!-- small type badge (optional) -->
                    <span
                      class="badge badge-ghost badge-sm shrink-0"
                      x-text="item.t === 'product'
                        ? t('header.search.badges.product', 'Produkt')
                        : (item.t==='category'
                          ? t('header.search.badges.category', 'Kategorie')
                          : t('header.search.badges.info', 'Info'))"
                    ></span>
                  </a>
                </li>
              </template>
            </ul>
          </template>
    
            <!-- SUGGESTIONS -->
            <template x-if="q.trim().length >= minChars">
              <ul
                class="p-2 max-h-80 overflow-y-auto w-full flex flex-col space-y-1"
                :id="listId" role="listbox"
              >
                <template x-if="!suggestions().length">
                  <li
                    class="w-full px-2 py-3 text-base text-center text-max-gray-400"
                    x-text="t('header.search.noResults', 'Žádné výsledky')"
                  >
                    Žádné výsledky
                  </li>
                </template>

                <template x-for="(item, i) in suggestions()" :key="`${item.t}-${item.k ?? i}`">
                  <li
                    :id="itemId(i)"
                    class="w-full"
                    role="option"
                    @mouseenter="highlighted = i"
                  >
                    <a :href="item.href || '#'"
                       @click.prevent="onSelect(item)" 
                       class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                       :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                
                      <!-- thumb for product/category -->
                      <template x-if="item.img">
                        <img :src="item.img" alt="" class="w-14 h-14 object-contain rounded bg-base-200/40" />
                      </template>
                
                      <!-- FA icon bubble for info -->
                      <template x-if="!item.img">
                        <span class="w-14 h-14 rounded-full bg-base-200 grid place-items-center">
                          <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                        </span>
                      </template>
                
                      <div class="min-w-0 flex-1">
                        <div class="font-medium text-base truncate" x-text="item.name"></div>
                        <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                      </div>
                
                      <!-- small type badge (optional) -->
                      <span
                        class="badge badge-ghost badge-sm shrink-0"
                        x-text="item.t === 'product'
                          ? t('header.search.badges.product', 'Produkt')
                          : (item.t==='category'
                            ? t('header.search.badges.category', 'Kategorie')
                            : t('header.search.badges.info', 'Info'))"
                      ></span>
                    </a>
                  </li>
                </template>
              </ul>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOP-BAR QUICK ACTIONS (desktop only) -->
  <div class="hidden md:flex md:px-4 relative">
    <button
      type="button"
      class="btn btn-link hidden lg:flex items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline"
      aria-label="Mapa lékáren a boxů"
      :aria-label="t('header.links.map', 'Mapa lékáren a boxů')"
      @click="location.hash='/map'"
    >
      <i class="fa-classic fa-xl fa-solid fa-map-location-dot"></i>
      <span
        class="hidden xl:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary"
        x-text="t('header.links.map', 'Mapa lékáren a boxů')"
      >
        Mapa lékáren a boxů
      </span>
    </button>

    <div class="dropdown dropdown-start relative" x-data="localeSwitcher()">
      <button
        type="button"
        class="btn btn-link hidden md:flex items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline"
        :aria-label="t('header.languageMenu.label', 'Jazyk')"
      >
        <img
          class="relative h-[26px] w-[27px]"
          :alt="activeLabel() || 'Language'"
          :src="activeMeta?.icon || './icons/languages/En.svg'"
          src="./icons/languages/En.svg"
        />
        <span
          class="hidden 2xl:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary"
          x-text="activeLabel()"
        >
          English
        </span>
        <i class="fa-classic fa-md fa-solid fa-chevron-down"></i>
      </button>
      <ul tabindex="0" class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52">
        <template x-for="locale in availableLocales" :key="locale.code">
          <li>
            <button
              type="button"
              class="flex items-center w-full gap-3 px-3 py-2 rounded-lg transition hover:bg-base-200 focus-visible:outline-none focus-visible:ring focus-visible:ring-primary/40 text-left"
              @click="select(locale.code)"
            >
              <img
                class="h-5 w-5 rounded-full object-contain"
                :src="optionIcon(locale.code) || './icons/languages/En.svg'"
                :alt="optionLabel(locale.code)"
              />
              <span class="flex-1" x-text="optionLabel(locale.code)">
                English
              </span>
              <i
                class="fa-classic fa-md fa-solid"
                :class="isActive(locale.code) ? 'fa-check text-primary' : 'fa-empty text-base-content/40'"
              ></i>
            </button>
          </li>
        </template>
      </ul>
    </div>

    <div class="hidden md:flex" x-data="contactQuickAction()">
      <div
        class="tooltip tooltip-bottom"
        data-tip="Show more"
        :data-tip="t('header.actions.phone.tooltip', 'Show more')"
      >
        <button
          type="button"
          class="btn btn-link items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline"
          @click="openModal()"
          aria-label="Zobrazit kontaktní možnosti"
          :aria-label="t('header.actions.phone.aria', 'Zobrazit kontaktní možnosti')"
          aria-haspopup="dialog"
          aria-expanded="false"
          :aria-expanded="isOpen ? 'true' : 'false'"
        >
          <i class="fa-classic fa-xl fa-solid fa-phone"></i>
          <span
            class="hidden lg:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary"
            x-text="phoneLabel || t('header.actions.phone.fallback', 'Kontakty')"
          >
            Kontakty
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- TOP-BAR BUTTONS + CART (mobile + desktop) -->
  <div class="flex gap-2 flex-none">
    <button class="btn btn-primary w-12 h-12 btn-lg btn-square max-gradient-gray hidden md:block"
    aria-label="Otevřít aktivní objednávku" title="Aktivní objednávka"
    :aria-label="t('header.actions.activeOrder.aria', 'Otevřít aktivní objednávku')"
    :title="t('header.actions.activeOrder.label', 'Aktivní objednávka')"
    @click="location.hash='/active-order'"
    >
      <i class="fa-classic fa-xl fa-regular fa-truck-fast text-gray-700 max-embos-v-gray"></i>
    </button>

    <button class="btn btn-primary w-12 h-12 btn-lg btn-square"
    :class="maxGradientClass()" 
    aria-label="Otevřít moje uložené" title="Moje uložené"
    :aria-label="t('header.actions.saved.aria', 'Otevřít moje uložené')"
    :title="t('header.actions.saved.label', 'Moje uložené')"
    @click="location.hash='/my-saved'"
    >
      <i class="fa-classic fa-xl fa-regular fa-heart text-white max-embos-v"></i>
    </button>

    <div class="relative flex items-center justify-center">
      <button class="btn btn-primary w-12 h-12 btn-lg btn-square"
      data-auth-account-button
      :class="maxGradientClass()"
      :aria-label="$store.auth?.isAuthenticated ? t('header.actions.account.loggedAria', 'Přejít do mého účtu') : t('header.actions.account.aria', 'Otevřít můj účet')"
      :title="$store.auth?.isAuthenticated ? t('header.actions.account.loggedLabel', 'Můj účet') : t('header.actions.account.label', 'Můj účet')"
      @click="$store.auth?.handleAccountClick()"
      > 
        <template x-if="!$store.auth?.isAuthenticated">
          <i class="fa-classic fa-xl text-white max-embos-v"
             :class="$store.auth?.isAuthenticated ? 'fa-solid fa-user-check' : 'fa-regular fa-user-circle'"></i>
        </template>
        <template x-if="$store.auth?.isAuthenticated">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-black/10 text-white font-semibold uppercase tracking-wide select-none"
                x-text="$store.auth?.initials()"
                aria-hidden="true"></span>
        </template>
      </button>
      <div
        class="pointer-events-none absolute left-1/2 top-full mt-3 -translate-x-1/2 z-40"
        x-cloak
        x-show="$store.auth?.accountTooltip?.visible"
        x-transition.opacity.duration.150ms
        x-transition.scale.origin-top.duration.150ms
        role="status"
        aria-live="polite">
        <div class="relative">
          <div class="rounded-xl border border-base-300 bg-base-100/95 px-3 py-1.5 text-xs font-semibold text-base-content shadow-lg animate-bounce">
            <span x-text="$store.auth?.accountTooltip?.message || 'Váš účet'"></span>
          </div>
          <span class="absolute left-1/2 -top-1.5 h-3 w-3 -translate-x-1/2 rotate-45 border border-base-300 border-b-transparent border-r-transparent bg-base-100/95"></span>
        </div>
      </div>
    </div>

    <button
    class="btn btn-primary btn-squish w-12 h-12 btn-lg btn-square indicator overflow-hidden md:overflow-visible"
    :class="maxGradientClass()"
    aria-label="Otevřít košík" title="Košík"
    :aria-label="t('header.actions.cart.aria', 'Otevřít košík')"
    :title="t('header.actions.cart.label', 'Košík')"
    @click="location.hash='/cart'"
    @pointerdown="$el.classList.add('is-squishing')"
    @animationend="requestAnimationFrame(()=> $el.classList.remove('is-squishing'))"
    x-data
  >
    <i class="fa-classic fa-xl fa-regular fa-basket-shopping text-white max-embos-v"></i>
  
    <!-- Badge (distinct items). Empty badge if 1 item, show number if >1 -->
    <template x-if="$store.cart.distinctCount() > 0">
      <span
        class="badge badge-error badge-sm indicator-item"
        :class="{ 'scale-110': $store.cart._badgePulse }"
        x-text="$store.cart.distinctCount() > 1 ? $store.cart.distinctCount() : ''"
        x-transition.scale.origin-center
      ></span>
    </template>
  </button>
  </div>
</div>

<!-- MOBILE TOPBAR SEARCH (trigger only) -->
<div class="navbar md:hidden h-12 p-2 pt-0 bg-white mb-6 text-base-content relative" x-data>
    <button
    type="button"
    class="input input-lg px-4 input-bordered rounded-full max-w-2xl items-center gap-2 w-full text-left max-input-gradient"
    aria-label="Vyhledávání"
    :aria-label="t('header.search.ariaLabel', 'Vyhledávání')"
    @pointerdown="
      window.__msGhost = $refs.msGhost;                // stash a reference
      $refs.msGhost && $refs.msGhost.focus({ preventScroll:true }); // pop keyboard
      $dispatch('open-mobile-search', { from: 'tap' }) // open overlay in same gesture
    "
  >
    <i class="fa-classic fa-regular fa-search text-max-gray-600"></i>
    <span
      class="grow min-w-0 text-base-content/60"
      x-text="t('header.search.placeholder', 'Hledej dle názvu')"
    >
      Hledej dle názvu
    </span>
  </button>

  <!-- Invisible but focusable 'ghost' input to trigger the keyboard -->
  <input
    x-ref="msGhost"
    type="text"
    autocomplete="off"
    autocapitalize="none"
    spellcheck="false"
    inputmode="search"
    style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; z-index:1;"
  />
</div>

<!-- NAVBAR PRODUCT NAVIGATION -->
  <div
    class="hidden md:flex w-full items-stretch bg-primary text-primary-content md:h-12 lg:h-16 px-2 lg:px-4"
    :class="maxGradientVClass()"
    x-data="topNav()"
    x-init="init()"
    x-ref="navRoot"
    x-cloak
  >
    <div class="flex w-full items-stretch gap-2">
      <div class="flex items-stretch gap-1 flex-1 overflow-hidden" x-ref="leftWrap">
        <template x-if="showDrawer">
          <button
            type="button"
            data-left-item
            data-sticky="true"
            data-index="-1"
            class="flex items-center gap-2 h-full px-3 lg:px-4 text-sm lg:text-base font-semibold transition-colors duration-150 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40 cursor-pointer"
            @click="handleDrawerClick()"
          >
            <i class="fa-solid fa-bars"></i>
            <span
              class="whitespace-nowrap"
              x-text="drawerItem?.translationKey
                ? t(drawerItem.translationKey, drawerItem?.label || 'Procházet kategorie')
                : (drawerItem?.label || t('header.nav.browseCategories', 'Procházet kategorie'))"
            ></span>
          </button>
        </template>

        <template x-if="showDrawer && highlightItems.length">
          <div class="w-px self-stretch bg-white/30 mx-1 my-2 lg:my-4"></div>
        </template>

        <template x-for="(item, idx) in highlightItems" :key="item.key">
          <button
            type="button"
            data-left-item
            :data-index="idx"
            class="flex items-center h-full px-3 lg:px-4 text-sm lg:text-base font-medium whitespace-nowrap transition-colors duration-150 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40"
            :class="isLeftHidden(idx) ? 'hidden' : ''"
            @click="handleItemClick(item)"
          >
            <span x-text="item.label"></span>
          </button>
        </template>
      </div>

      <div class="flex items-stretch gap-1" x-show="promoItems.length" x-transition.opacity>
        <div class="flex items-stretch gap-1 px-2 lg:px-3 max-gradient-v-red h-full">
          <template x-for="item in promoItems" :key="item.key">
            <button
              type="button"
              class="flex items-center h-full px-2 lg:px-3 text-sm lg:text-base font-semibold whitespace-nowrap transition-colors duration-150 hover:bg-black/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40"
              @click="handlePromoClick(item)"
            >
              <span x-text="item.label"></span>
            </button>
          </template>
        </div>
      </div>
    </div>
  </div>




<!-- ROUTER SHELL -->
<div id="app">

<!-- ROUTE == HOMEPAGE -->
<template x-if="is('home')">
  <div class="sm:w-11/12 lg:w-10/12 mx-auto p-4 pb-12 pt-1 md:pt-6">
    <div
      x-data="drMaxWomanToast()"
      x-cloak
      x-show="isVisible"
      x-transition.opacity.duration.200ms
      class="mb-4"
    >
      <div
        class="flex items-center gap-3 rounded-xl border border-white/10 bg-max-gray-850 px-3 py-2 text-white/90 shadow-sm"
        role="region"
        aria-label="Dr. Max Woman nabídka"
      >
        <span
          class="inline-flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-white/15 text-white"
        >
          <i class="fa-solid fa-tag fa-lg" aria-hidden="true"></i>
        </span>
        <p class="flex-1 min-w-0 text-sm font-medium leading-snug sm:text-base">
          Objevte novou Dr. Max Woman kolekci a získejte 20&nbsp;% slevu na produkty pro každodenní péči.
        </p>
        <a
          href="/kampan/drmax-woman"
          class="inline-flex shrink-0 items-center rounded-full border border-white/25 bg-white/5 px-3 py-1 text-xs font-medium tracking-wide transition hover:bg-white/15 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white sm:text-sm"
        >
          Otevřít akci
        </a>
        <button
          type="button"
          class="ml-2 shrink-0 rounded-full p-1 text-base font-semibold text-white/70 transition hover:bg-white/10 hover:text-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white sm:text-lg"
          @click="close()"
          aria-label="Zavřít oznámení Dr. Max Woman"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>

<!-- Billboard Carousel -->
<section x-data="homeCarousel()" class="mt-0 lg:mt-4">
  <div class="group relative rounded-2xl overflow-hidden shadow-md select-none h-100"
       tabindex="0" x-ref="viewport" style="touch-action: pan-y;">

    <!-- track -->
    <div x-ref="track"
         class="flex h-full banner-track will-change-transform transform-gpu" 
         :style="trackStyle()">

      <template x-for="(slide,i) in slides" :key="slide.id || i">
        <a :href="ctaHref(slide)"
           class="shrink-0 min-w-full block h-full overflow-hidden" 
           @click="onSlideClick($event)">

          <!-- FIXED HEIGHT slide container -->
          <div class="relative bg-base-200 h-100 banner-slide transform-gpu"
               :class="cls(slide,'wrapper')"
               :style="style(slide,'background_color')">

            <!-- background -->
            <img :src="slide.background || './images/banners/default-bg.jpg'"
                 :alt="slide.title"
                 class="absolute inset-0 w-full h-full object-cover z-0"
                 :class="cls(slide,'background')">

            <!-- texts & CTA -->
            <h2 class="absolute" :class="cls(slide,'title')" x-text="slide.title"></h2>

            <p class="absolute opacity-90" :class="cls(slide,'text')" x-text="txt(slide)"></p>

            <span class="btn absolute btn-squish"
                  @pointerdown="$el.classList.add('is-squishing')"
                  @animationend="requestAnimationFrame(()=> $el.classList.remove('is-squishing'))"
                  :class="cls(slide,'cta')">
              <span x-text="ctaLabel(slide)"></span>
              <i :class="ctaIcon(slide)" class="ml-2"></i>
            </span>

            <button type="button"
                    class="btn btn-link btn-sm absolute"
                    :class="cls(slide,'legal_link')"
                    @click.stop.prevent="openModal(slide)">
              <span x-text="slide.legal?.linkLabel || t('banners.legalLink', 'Podmínky akce')"></span>
            </button>

            <!-- layers -->
            <template x-for="n in 6" :key="`layer-${i}-${n}-${isActive(i)?animNonce:'off'}`">
              <img :src="slide[`layer_${n}_src`] || slide[`layer_${n}`] || (slide.layers?.[n]?.src)"
                   x-show="slide[`layer_${n}`] || slide[`layer_${n}_src`] || (slide.layers && slide.layers[n])"
                   class="absolute pointer-events-none"
                   :class="[cls(slide, `layer_${n}`), anim(slide, `layer_${n}`, i)].filter(Boolean).join(' ')">
            </template>

          </div>
        </a>
      </template>
    </div>

    <!-- chevrons (hover-only, as before) -->
    <button
      class="hidden md:flex absolute left-2 top-1/2 -translate-y-1/2
             h-10 w-10 items-center justify-center rounded-full
             bg-white/70 shadow-sm backdrop-blur leading-none
             transition duration-200
             opacity-0 group-hover:opacity-100
             pointer-events-none group-hover:pointer-events-auto
             outline-none focus:outline-none focus:ring-0"
      @click.stop.prevent="prev()" aria-label="Předchozí banner">
      <i class="fa-solid fa-chevron-left"></i>
    </button>

    <button
      class="hidden md:flex absolute right-2 top-1/2 -translate-y-1/2
             h-10 w-10 items-center justify-center rounded-full
             bg-white/70 shadow-sm backdrop-blur leading-none
             transition duration-200
             opacity-0 group-hover:opacity-100
             pointer-events-none group-hover:pointer-events-auto
             outline-none focus:outline-none focus:ring-0"
      @click.stop.prevent="next()" aria-label="Další banner">
      <i class="fa-solid fa-chevron-right"></i>
    </button>
 
    
    
    

  </div>

  <!-- dots outside -->
  <div class="mt-3 flex items-center justify-center gap-2">
    <template x-for="(s,i) in slides" :key="s.id || i">
      <button class="btn btn-circle border-none w-3 h-3 min-h-0 p-0"
              :class="isActive(i) ? 'btn-primary h-4 w-4' : 'bg-base-300'"
              @click="go(i)"
              :aria-label="`Slide ${i+1}`"></button>
    </template>
  </div>

  <!-- per-slide legal modals -->
  <template x-for="(slide,i) in slides" :key="'m'+(slide.id||i)">
    <dialog :id="modalId(slide)" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Zavřít">✕</button>
        </form>
        <h3 class="text-lg font-bold" x-text="slide.legal?.title || slide.title"></h3>
        <p class="py-4 whitespace-pre-line" x-text="slide.legal?.text || ''"></p>
      </div>
    </dialog>
  </template>
</section>

<!-- Top categories grid -->
<section class="mt-1" x-cloak x-show="categoriesGrid.length">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold">Top kategorie</h3>
  </div>
  <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-7 xl:grid-cols-10 gap-4 gap-y-4">
    <template x-for="tile in categoriesGrid" :key="tile.slug || `${tile.label}-${tile.image}`">
      <a :href="link('products')"
         class="group flex flex-col items-center gap-3 text-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 transition-transform duration-200">
        <div class="w-full max-w-[200px] aspect-square rounded-2xl flex items-center justify-center transition-all duration-200 transform group-hover:-translate-y-1 group-hover:shadow-md"
             :class="tile.background">
          <img :src="tile.image"
               :alt="tile.label"
               class="max-w-[90%] object-cover transition-transform duration-200 group-hover:scale-105"
               @error="$event.target.style.opacity=0.3">
        </div>
        <span class="text-sm font-medium text-base-content/80 transition-colors duration-200 group-hover:text-base-content"
              x-text="tile.label"></span>
      </a>
    </template>
  </div>
</section>


 <!-- hits of the week -->
 <section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Hity týdne</h3>
  </div>

  <div class="relative group">
    <!-- indicators (use the same key) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile affordance -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['hits']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller: call registerTopStrip with the same key, use $el not $refs -->
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'hits')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-5">
        <template x-for="(p, idx) in topProductsShuffledFor('hits', 12)" :key="'hits-' + (p?.id ?? idx)">
          <article class="snap-start shrink-0 w-48 sm:w-56 card bg-white hover:shadow-md transition relative">
            <span x-show="discountPct(p) !== null"
                  class="absolute left-2 top-2 badge badge-error text-white font-semibold">
              <span x-text="`-${discountPct(p)}%`"></span>
            </span>
            <figure class="p-3 h-40">
              <a :href="link('product',{id:p.id})" class="block h-full">
                <img :src="p.image || './images/placeholder.webp'" :alt="p.name"
                     class="w-full h-full object-cover">
              </a>
            </figure>
            <div class="card-body pt-0 flex flex-col gap-2">
              <a :href="link('product',{id:p.id})"
                 class="text-sm font-medium line-clamp-2 leading-snug min-h-[2.45rem] max-h-[2.45rem] hover:underline"
                 x-text="p.name"></a>
              <div class="mt-auto">
                <div class="text-base font-semibold">
                  <span x-text="formatPrice(currentPrice(p))"></span>
                  <span class="ml-2 line-through text-xs opacity-60"
                        x-show="crossedPrice(p) !== null"
                        x-text="formatPrice(crossedPrice(p))"></span>
                </div>
              </div>
              <div class="mt-3">
                <template x-if="!$store.cart.inCart(p.id)">
                  <button class="btn btn-primary btn-md w-full font-semibold" @click="$store.cart.add(p)">
                    <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                  </button>
                </template>
                <template x-if="$store.cart.inCart(p.id)">
                  <div class="join w-full justify-center">
                    <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.decrement(p.id)"
                            :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                    <input type="text" inputmode="numeric" pattern="[0-9]*"
                           class="input input-bordered input-md w-12 text-center join-item tabular-nums"
                           :value="$store.cart.qty(p.id)"
                           @input="$store.cart.setQty(p.id, $event.target.value.replace(/[^0-9]/g,''))"
                           @keydown.enter.prevent
                           :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />
                    <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.increment(p.id)"
                            :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                  </div>
                </template>
              </div>
            </div>
          </article>
        </template>
      </div>
    </div>
  </div>
</section>




<!-- Top brands -->
<section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Top značky</h3>
  </div>

  <div class="relative group">
    <!-- indicators (left/right) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['brands']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['brands']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile scroll affordance (fades after first scroll) -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['brands']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller -->
    <div class="overflow-x-auto scrollbar-thin pb-3"
         x-init="registerTopStrip($el, 'brands')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-2">
        <template x-for="b in brandsShuffledFor('brands', 18)" :key="b.name">
          <a :href="brandHref(b)"
             class="snap-start shrink-0
                    w-36 sm:w-40 md:w-44 lg:w-48 xl:w-52
                    aspect-square rounded-xl bg-white p-3 hover:shadow-md transition
                    focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40
                    relative grid place-items-center">
            <!-- logo -->
            <img :src="b.logo" :alt="b.name" class="object-contain max-w-full max-h-full">

            <!-- badge (optional) -->
            <template x-if="badgeText(b)">
              <span class="absolute right-1.5 top-1.5 badge"
                    :class="badgeClass(b)" x-text="badgeText(b)"></span>
            </template>
          </a>
        </template>
      </div>
    </div>
  </div>
</section>




<!-- Magazine blog -->
<section class="mt-8" x-cloak x-show="Array.isArray(blogPosts) && blogPosts.length">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Blog</h3>
  </div>
  <div class="relative group">
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-base-200 to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['blog']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-base-200 to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['blog']?.right ? 'opacity-100' : 'opacity-0'"></div>
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['blog']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-200 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'blog')">
      <div class="flex gap-3 md:gap-4 snap-x snap-mandatory px-0 pb-5">
        <template x-for="post in blogFeatured(6)" :key="post.id || post.title">
          <article class="snap-start shrink-0 w-[calc(100%-2.5rem)] sm:w-[calc(75%-2rem)] md:w-[340px] lg:w-[360px] xl:w-[380px]">
            <div class="card h-full bg-base-100 shadow rounded-xl overflow-hidden">
              <figure class="h-48 overflow-hidden">
                <a :href="blogLink(post)" class="block w-full h-full">
                  <img :src="post.image" :alt="post.title" class="w-full h-full object-cover" loading="lazy">
                </a>
              </figure>
              <div class="card-body min-w-0 flex flex-col gap-2 md:gap-3">
                <h2 class="text-xl font-semibold leading-snug line-clamp-2 min-h-[3.75rem]">
                  <a :href="blogLink(post)" class="hover:underline" x-text="post.title"></a>
                </h2>
                <div class="text-sm">
                  <span class="text-success font-bold" x-text="readingTimeLabel(post)"></span>
                  <span class="mx-1 opacity-40">•</span>
                  <span class="opacity-70" x-text="post.category"></span>
                </div>
                <p class="text-base line-clamp-4" x-text="blogExcerpt(post)"></p>
                <div class="mt-4 flex items-center opacity-70">
                  <a :href="blogLink(post)" class="btn btn-sm btn-outline">Číst dál</a>
                  <div class="ml-auto flex items-center gap-1">
                    <i class="fa-regular fa-thumbs-up fa-lg"></i>
                    <span x-text="post.likes ?? 0"></span>
                  </div>
                </div>
              </div>
            </div>
          </article>
        </template>
      </div>
    </div>
  </div>
</section>

<!-- Reasons to buy -->
<section class="mt-8" x-data="rtbStrip()" x-init="init()">
  <h3 class="text-lg font-semibold mb-3">Proč nakoupit u Dr. Max</h3>
  <div class="relative">
    <div
      x-ref="rail"
      @scroll.passive="handleScroll($event)"
      class="flex gap-2 overflow-x-auto snap-x snap-mandatory pb-5
             md:overflow-visible md:grid md:grid-cols-4 md:gap-3 md:snap-none md:pb-0"
    >
      <template x-for="(item, idx) in items" :key="`${item.img || idx}`">
        <div class="shrink-0 w-[calc(50%-0.75rem)] snap-start md:w-auto md:shrink md:col-span-1 md:contents">
          <a href="#" @click.prevent
             class="block h-full rounded-xl bg-white p-3 hover:shadow-md transition
                    focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40">
            <div class="flex h-full flex-col gap-3 xl:flex-row xl:items-center xl:gap-4">
              <div class="rounded-xl overflow-hidden grid place-items-center xl:w-32 xl:h-32 xl:shrink-0">
                <img :src="item.img" :alt="item.alt || ''" class="w-auto object-contain">
              </div>
              <span class="text-base font-medium text-center xl:text-left [&_b]:text-max-green-600" x-html="item.label"></span>
            </div>
          </a>
        </div>
      </template>
    </div>

    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none"><i class="fa-solid fa-chevron-right fa-lg"></i></div>
    </div>
  </div>
</section>


 <!-- favorites in sale -->
 <section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Vaše uložené</h3>
  </div>

  <div class="relative group">
    <!-- indicators (use the same key) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['saved']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['saved']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile affordance -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['saved']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller: call registerTopStrip with the same key, use $el not $refs -->
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'saved')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-5">
        <template x-for="(p, idx) in topProductsShuffledFor('saved', 12)" :key="'saved-' + (p?.id ?? idx)">
          <article class="snap-start shrink-0 w-48 sm:w-56 card bg-white hover:shadow-md transition relative">
            <span x-show="discountPct(p) !== null"
                  class="absolute left-2 top-2 badge badge-error text-white font-semibold">
              <span x-text="`-${discountPct(p)}%`"></span>
            </span>
            <figure class="p-3 h-40">
              <a :href="link('product',{id:p.id})" class="block h-full">
                <img :src="p.image || './images/placeholder.webp'" :alt="p.name"
                     class="w-full h-full object-cover">
              </a>
            </figure>
            <div class="card-body pt-0 flex flex-col gap-2">
              <a :href="link('product',{id:p.id})"
                 class="text-sm font-medium line-clamp-2 leading-snug min-h-[2.45rem] max-h-[2.45rem] hover:underline"
                 x-text="p.name"></a>
              <div class="mt-auto">
                <div class="text-base font-semibold">
                  <span x-text="formatPrice(currentPrice(p))"></span>
                  <span class="ml-2 line-through text-xs opacity-60"
                        x-show="crossedPrice(p) !== null"
                        x-text="formatPrice(crossedPrice(p))"></span>
                </div>
              </div>
              <div class="mt-3">
                <template x-if="!$store.cart.inCart(p.id)">
                  <button class="btn btn-primary btn-md w-full font-semibold" @click="$store.cart.add(p)">
                    <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                  </button>
                </template>
                <template x-if="$store.cart.inCart(p.id)">
                  <div class="join w-full justify-center">
                    <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.decrement(p.id)"
                            :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                    <input type="text" inputmode="numeric" pattern="[0-9]*"
                           class="input input-bordered input-md w-12 text-center join-item tabular-nums"
                           :value="$store.cart.qty(p.id)"
                           @input="$store.cart.setQty(p.id, $event.target.value.replace(/[^0-9]/g,''))"
                           @keydown.enter.prevent
                           :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />
                    <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.increment(p.id)"
                            :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                  </div>
                </template>
              </div>
            </div>
          </article>
        </template>
      </div>
    </div>
  </div>
</section>

  </div>
</template>



<!-- ROUTE == PRODUCTS -->
<section x-show="is('products')" x-cloak>


<!-- FILTERS -->
<section aria-labelledby="filters-heading"
         class="w-12/12 md:w-11/12 mx-auto px-4 pt-0 md:pt-8"
         x-data="{ mobileFiltersOpen: false }"
         @keydown.escape.window="mobileFiltersOpen = false">

  <div class="xl:grid xl:grid-cols-[minmax(260px,320px)_1fr] xl:gap-6 relative">
    <div x-cloak
         x-show="mobileFiltersOpen"
         x-transition.opacity
         class="fixed inset-0 z-40 bg-base-200/70 backdrop-blur-sm xl:hidden"
         @click.self="mobileFiltersOpen = false"></div>

    <aside class="fixed inset-y-0 left-0 w-full max-w-full bg-base-100 shadow-xl transform -translate-x-full transition-transform duration-300 ease-out overflow-hidden z-50 xl:relative xl:inset-auto xl:w-full xl:max-w-none xl:bg-transparent xl:shadow-none xl:p-0 xl:pb-12 xl:translate-x-0 xl:transform-none xl:overflow-visible"
           :class="mobileFiltersOpen ? 'translate-x-0' : '-translate-x-full xl:translate-x-0'">
      <div class="h-full flex flex-col">
        <div class="xl:hidden flex items-center justify-between p-6 pb-4">
        <h3 class="text-lg font-semibold" x-text="t('routes.products.filters.drawerTitle', 'Filtry')"></h3>
        <button type="button" class="btn btn-md btn-ghost" @click="mobileFiltersOpen = false">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

        <div class="flex-1 overflow-y-auto px-6 py-6 xl:px-0 xl:pb-8 xl:pt-2">
        <div class="xl:hidden space-y-3 mb-8" x-data>
        <h4 class="text-base font-semibold text-base-content"
            x-text="t('routes.products.quickFilters.title', 'Rychlé filtry')"></h4>
        <div class="flex flex-wrap gap-2">
          <button type="button"
                  class="btn btn-md rounded-full transition-colors"
                  :class="onlyInStock ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                  :aria-pressed="onlyInStock"
                  @click="onlyInStock = !onlyInStock">
            <span class="flex items-center gap-2">
              <span x-text="t('routes.products.quickFilters.inStock', 'Pouze skladem')"></span>
              <i class="fa-solid fa-xmark text-xs" x-show="onlyInStock" x-cloak></i>
            </span>
          </button>
          <button type="button"
                  class="btn btn-md rounded-full transition-colors"
                  :class="benefitOnly ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                  :aria-pressed="benefitOnly"
                  @click="benefitOnly = !benefitOnly">
            <span class="flex items-center gap-2">
              <span x-text="t('routes.products.quickFilters.benefit', 'Lze platit benefity')"></span>
              <i class="fa-solid fa-xmark text-xs" x-show="benefitOnly" x-cloak></i>
            </span>
          </button>
          <button type="button"
                  class="btn btn-md rounded-full transition-colors"
                  :class="onlyDiscounted ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                  :aria-pressed="onlyDiscounted"
                  @click="onlyDiscounted = !onlyDiscounted">
            <span class="flex items-center gap-2">
              <span x-text="t('routes.products.quickFilters.discounted', 'Produkty v akci')"></span>
              <i class="fa-solid fa-xmark text-xs" x-show="onlyDiscounted" x-cloak></i>
            </span>
          </button>
          <template x-if="selectedCategory">
            <button type="button"
                    class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                    @click="selectedCategory = ''">
              <span class="flex items-center gap-2">
                <span x-text="selectedCategory"></span>
                <i class="fa-solid fa-xmark text-xs"></i>
              </span>
            </button>
          </template>
          <template x-if="selectedForm">
            <button type="button"
                    class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                    @click="selectedForm = ''">
              <span class="flex items-center gap-2">
                <span x-text="selectedForm"></span>
                <i class="fa-solid fa-xmark text-xs"></i>
              </span>
            </button>
          </template>
          <template x-for="cons in selectedConsumers" :key="'cons-chip-mobile-'+cons">
            <button type="button"
                    class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                    @click="toggleConsumer(cons)">
              <span class="flex items-center gap-2">
                <span x-text="cons"></span>
                <i class="fa-solid fa-xmark text-xs"></i>
              </span>
            </button>
          </template>
          <template x-if="_priceRangeActive()">
            <button type="button"
                    class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                    @click="resetPriceFilter()">
              <span class="flex items-center gap-2">
                <span x-text="priceFilterChipLabel()"></span>
                <i class="fa-solid fa-xmark text-xs"></i>
              </span>
            </button>
          </template>
          <template x-if="activeFiltersCount() >= 3">
            <button type="button"
                    class="btn btn-md rounded-full btn-outline btn-error text-error"
                    @click="clearFilters()">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-rotate-left"></i>
                <span x-text="t('routes.products.actions.resetAll', 'Zrušit vše')"></span>
              </span>
            </button>
          </template>
        </div>
      </div>
        <div class="space-y-6 xl:pr-12">


        <div class="space-y-3" x-data="{ showAllCategories: false, limit: 6 }">
          <h3 class="font-semibold text-base"
              x-text="t('routes.products.filters.sections.categories.title', 'Kategorie')"></h3>
          <div class="space-y-2">
            <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
              <input type="radio" name="cat" class="radio radio-sm radio-secondary" value="" x-model="selectedCategory">
              <span x-text="t('routes.products.filters.sections.categories.all', 'Všechny kategorie')"></span>
            </label>
            <template x-for="c in categories.slice(0, limit)" :key="'cat-'+c">
              <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                <input type="radio" name="cat" class="radio radio-sm radio-secondary" :value="c" x-model="selectedCategory">
                <span x-text="c"></span>
              </label>
            </template>
            <div x-show="showAllCategories"
                 class="overflow-hidden"
                 x-transition:enter="transition-all ease-out duration-200"
                 x-transition:enter-start="max-h-0 opacity-0"
                 x-transition:enter-end="max-h-96 opacity-100"
                 x-transition:leave="transition-all ease-in duration-150"
                 x-transition:leave-start="max-h-96 opacity-100"
                 x-transition:leave-end="max-h-0 opacity-0">
              <template x-for="c in categories.slice(limit)" :key="'cat-more-'+c">
                <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                  <input type="radio" name="cat" class="radio radio-sm radio-secondary" :value="c" x-model="selectedCategory">
                  <span x-text="c"></span>
                </label>
              </template>
            </div>
          </div>
          <div class="pt-1">
            <button type="button"
                    class="btn btn-ghost btn-xs px-0"
                    x-show="categories.length > limit"
                    @click="showAllCategories = !showAllCategories">
              <span x-text="showAllCategories ? t('routes.products.filters.expand.less', 'Méně') : t('routes.products.filters.expand.more', 'Více')"></span>
              <i class="fa-solid fa-chevron-down ml-1 transition-transform"
                 :class="showAllCategories ? 'rotate-180' : ''"></i>
            </button>
          </div>
        </div>

        <div class="space-y-3" x-data="{ showAllForms: false, limit: 6 }">
          <h3 class="font-semibold text-base"
              x-text="t('routes.products.filters.sections.forms.title', 'Forma')"></h3>
          <div class="space-y-2">
            <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
              <input type="radio" name="form" class="radio radio-sm radio-secondary" value="" x-model="selectedForm">
              <span x-text="t('routes.products.filters.sections.forms.all', 'Všechny typy')"></span>
            </label>
            <template x-for="f in forms.slice(0, limit)" :key="'form-'+f">
              <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                <input type="radio" name="form" class="radio radio-sm radio-secondary" :value="f" x-model="selectedForm">
                <span x-text="f"></span>
              </label>
            </template>
            <div x-show="showAllForms"
                 class="overflow-hidden"
                 x-transition:enter="transition-all ease-out duration-200"
                 x-transition:enter-start="max-h-0 opacity-0"
                 x-transition:enter-end="max-h-96 opacity-100"
                 x-transition:leave="transition-all ease-in duration-150"
                 x-transition:leave-start="max-h-96 opacity-100"
                 x-transition:leave-end="max-h-0 opacity-0">
              <template x-for="f in forms.slice(limit)" :key="'form-more-'+f">
                <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                  <input type="radio" name="form" class="radio radio-sm radio-secondary" :value="f" x-model="selectedForm">
                  <span x-text="f"></span>
                </label>
              </template>
            </div>
          </div>
          <div class="pt-1" x-show="forms.length > limit" x-cloak>
            <button type="button"
                    class="btn btn-ghost btn-xs px-0"
                    @click="showAllForms = !showAllForms">
              <span x-text="showAllForms ? t('routes.products.filters.expand.less', 'Méně') : t('routes.products.filters.expand.more', 'Více')"></span>
              <i class="fa-solid fa-chevron-down ml-1 transition-transform"
                 :class="showAllForms ? 'rotate-180' : ''"></i>
            </button>
          </div>
        </div>

        <div class="space-y-3" x-data="{ showAllConsumers: false, limit: 8 }">
          <h3 class="font-semibold text-base"
              x-text="t('routes.products.filters.sections.consumers.title', 'Vhodné pro')"></h3>
          <div class="space-y-2">
            <template x-for="opt in consumersList.slice(0, limit)" :key="'cons-'+opt">
              <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                <input type="checkbox"
                       class="checkbox checkbox-sm checkbox-secondary rounded-[4px]"
                       :value="opt"
                       :checked="selectedConsumers.includes(opt)"
                       @change="toggleConsumer(opt)" />
                <span x-text="opt"></span>
              </label>
            </template>
            <div x-show="showAllConsumers"
                 class="overflow-hidden"
                 x-transition:enter="transition-all ease-out duration-200"
                 x-transition:enter-start="max-h-0 opacity-0"
                 x-transition:enter-end="max-h-96 opacity-100"
                 x-transition:leave="transition-all ease-in duration-150"
                 x-transition:leave-start="max-h-96 opacity-100"
                 x-transition:leave-end="max-h-0 opacity-0">
              <template x-for="opt in consumersList.slice(limit)" :key="'cons-more-'+opt">
                <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                  <input type="checkbox"
                         class="checkbox checkbox-sm checkbox-secondary rounded-[4px]"
                         :value="opt"
                         :checked="selectedConsumers.includes(opt)"
                         @change="toggleConsumer(opt)" />
                  <span x-text="opt"></span>
                </label>
              </template>
            </div>
          </div>
          <div class="pt-1" x-show="consumersList.length > limit" x-cloak>
            <button type="button"
                    class="btn btn-ghost btn-xs px-0"
                    @click="showAllConsumers = !showAllConsumers">
              <span x-text="showAllConsumers ? t('routes.products.filters.expand.less', 'Méně') : t('routes.products.filters.expand.more', 'Více')"></span>
              <i class="fa-solid fa-chevron-down ml-1 transition-transform"
                 :class="showAllConsumers ? 'rotate-180' : ''"></i>
            </button>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-base"
                x-text="t('routes.products.filters.sections.price.title', 'Cena')"></h3>
            <button type="button" class="btn btn-xs btn-ghost"
                    x-show="_priceRangeActive()" x-cloak
                    @click="resetPriceFilter()">
              <span x-text="t('routes.products.filters.sections.price.reset', 'Reset')"></span>
            </button>
          </div>
          <div class="space-y-4" x-show="priceBounds.max > priceBounds.min" x-cloak>
            <input type="range"
                   class="range range-secondary range-xs"
                   :min="priceBounds.min"
                   :max="priceBounds.max"
                   step="10"
                   :value="priceMax ?? priceBounds.max"
                   @input="clampPrice($event.target.value, 'max')">
            <div class="flex justify-between text-xs text-base-content/60 px-1">
              <span x-text="formatPrice(priceMin ?? priceBounds.min)"></span>
              <span x-text="formatPrice(priceMax ?? priceBounds.max)"></span>
            </div>
            <div class="space-y-2">
              <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                <input type="radio"
                       name="priceQuick"
                       class="radio radio-sm radio-secondary"
                       :checked="activePriceRangeIndex === null"
                       @change="resetPriceFilter()">
                <span x-text="t('routes.products.filters.sections.price.any', 'Libovolná cena')"></span>
              </label>
              <template x-for="(maxValue, idx) in priceQuickRanges" :key="`pr-${idx}`">
                <label class="label cursor-pointer justify-start gap-2 text-max-gray-800 w-full touch-target-md">
                  <input type="radio"
                         name="priceQuick"
                         class="radio radio-sm radio-secondary"
                         :value="idx"
                         :checked="activePriceRangeIndex === idx"
                         @change="applyPriceQuickRange(idx)">
                  <span x-text="priceUpToLabel(maxValue)"></span>
                </label>
              </template>
            </div>
          </div>
          <div class="text-sm text-base-content/60" x-show="priceBounds.max <= priceBounds.min"
               x-text="t('routes.products.filters.sections.price.unavailable', 'Ceny nejsou k dispozici.')">
          </div>
        </div>

      </div>
        </div>
      <div class="hidden lg:flex justify-end">
        <button type="button"
                class="btn btn-outline btn-secondary"
                @click="clearFilters()"
                x-show="hasActiveFilters()"
                x-cloak
                x-transition.opacity>
          <span x-text="t('routes.products.actions.clearFilters', 'Vymazat filtry')"></span>
        </button>
      </div>

        <div class="lg:hidden px-6 pb-6 pt-4 bg-base-100 border-t border-base-200">
          <button type="button"
                  class="btn btn-primary w-full"
                  @click="mobileFiltersOpen = false">
            <span x-text="t('routes.products.actions.showResults', 'Zobrazit {count} výsledků', { count: filteredCount() })"></span>
          </button>
        </div>
      </div>
    </aside>
    <div class="space-y-1 md:space-y-4">
      <div class="space-y-3">
        <nav class="breadcrumbs hidden md:block text-sm" aria-label="drobečková navigace">
          <ul>
            <li x-text="t('routes.products.breadcrumbs.home', 'Domů')"></li>
            <li><a href="#/products" x-text="t('routes.products.breadcrumbs.current', 'Zdraví a léky')"></a></li>
          </ul>
        </nav>
        <h1 class="text-3xl font-semibold">
          <span x-text="t('routes.products.title', 'Zdraví a léky')"></span>
          <span class="text-max-gray-400 font-normal">(<span x-text="filteredCount()"></span>)</span>
        </h1>
      </div>
      <div class="sticky top-0 z-30 bg-base-200 border-b border-base-200 py-3 space-y-3">
        <div class="flex items-center gap-2 lg:hidden">
          <div class="relative flex">
            <button type="button"
                    class="btn btn-md rounded-full btn-secondary"
                    @click="mobileFiltersOpen = true">
              <i class="fa-solid fa-filter"></i>
              <span x-text="t('routes.products.actions.toggleFilters', 'Filtry')"></span>
              </button>
            <span class="absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-error"
                  x-show="hasActiveFilters()"
                  x-cloak
                  aria-hidden="true"></span>
          </div>
          <div class="flex-1 flex flex-wrap items-center gap-2 justify-end">
            <div x-data="quickSearchControl($data)" class="flex-shrink-0" @click.outside="close()">
              <div
                class="group btn btn-md rounded-full transition-all duration-200 ease-out flex items-center gap-2 overflow-hidden cursor-pointer"
                :class="expanded ? 'max-w-[9rem] btn-secondary text-white pl-4 pr-3 justify-start' : 'w-12 btn-outline btn-secondary justify-center'"
                role="button"
                tabindex="0"
                @click="expanded ? null : open()"
                @keydown.enter.prevent="expanded ? null : open()"
                @keydown.space="expanded ? null : ($event.preventDefault(), open())"
              >
                <span class="sr-only" x-text="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"></span>
                <i class="fa-solid fa-search transition-colors duration-150"
                   :class="expanded ? 'text-white' : 'text-secondary group-hover:text-white group-focus-visible:text-white'"></i>
                <input
                  x-ref="input"
                  x-show="expanded"
                  x-transition.opacity.duration.150ms
                  type="text"
                  inputmode="search"
                  class="bg-transparent border-0 focus:outline-none text-sm placeholder-white/80 flex-1 min-w-0"
                  :placeholder="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"
                  x-model.debounce.300ms="query"
                @keydown.escape.stop.prevent="close(true)"
                @blur="close()"
                  :aria-label="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"
                />
                <button
                  type="button"
                  x-show="expanded && trimmed.length"
                  x-transition.opacity.duration.150ms
                  class="btn btn-xs btn-circle btn-ghost text-white/80 hover:text-white hover:bg-white/20 flex-shrink-0"
                  @click.stop="clear()"
                  :aria-label="t('routes.products.quickSearch.close', 'Zavřít vyhledávání')"
                >
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>
            <div class="dropdown dropdown-end flex-shrink-0" x-data="{ open: false }" @click.outside="open = false" @keydown.escape.window="open = false">
              <div class="relative">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors flex items-center gap-2"
                        :class="sortOrder ? 'btn-secondary text-white pr-10' : 'btn-outline btn-secondary pr-4'"
                        @click="open = !open"
                        :aria-expanded="open"
                        aria-haspopup="listbox">
                  <i class="fa-solid fa-arrow-down-arrow-up"></i>
                  <span class="whitespace-nowrap hidden sm:inline" x-text="sortButtonLabel()"></span>
                  <i class="fa-solid fa-chevron-down text-xs opacity-70 transition-transform ml-1"
                     :class="open ? 'rotate-180' : ''"
                     x-show="!sortOrder"
                     aria-hidden="true"></i>
                </button>
                <button type="button"
                        x-show="sortOrder"
                        x-cloak
                        class="absolute right-1.5 top-1/2 -translate-y-1/2 btn btn-xs btn-circle btn-ghost text-white/80 hover:text-white hover:bg-white/20 focus-visible:outline-none focus-visible:ring focus-visible:ring-white/40"
                        @click.stop="sortOrder = ''; open = false"
                        aria-label="Zrušit řazení">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <ul x-cloak
                  x-show="open"
                  x-transition.opacity.duration.150ms
                  class="menu menu-compact dropdown-content mt-3 p-2 shadow-lg bg-base-100 rounded-box min-w-[14rem]">
                <li class="px-3 py-2 text-xs uppercase tracking-wide text-base-content/60 cursor-default select-none"
                    x-text="t('routes.products.sorting.label', 'Řadit dle')">
                </li>
                <template x-for="opt in sortOptions()" :key="opt.value">
                  <li>
                    <button type="button"
                            class="flex w-full items-center justify-between gap-3 rounded-lg px-3 py-2 text-sm transition focus-visible:outline-none focus-visible:ring focus-visible:ring-primary/40"
                            :class="sortOrder === opt.value ? 'bg-secondary text-white' : 'hover:bg-base-200'"
                            @click="sortOrder = opt.value; open = false">
                      <span x-text="opt.label"></span>
                      <i class="fa-solid fa-check text-white"
                         x-show="sortOrder === opt.value"
                         aria-hidden="true"></i>
                    </button>
                  </li>
                </template>
              </ul>
            </div>
          </div>
        </div>
        <div class="hidden lg:grid grid-cols-[minmax(0,1fr)_auto] gap-3 items-start">
          <div class="flex flex-wrap items-center gap-2">
            <div class="relative flex xl:hidden">
              <button type="button"
                      class="btn btn-md rounded-full btn-secondary"
                      @click="mobileFiltersOpen = true">
                <i class="fa-solid fa-filter"></i>
                <span x-text="t('routes.products.actions.toggleFilters', 'Filtry')"></span>
              </button>
              <span class="absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-error"
                    x-show="hasActiveFilters()"
                    x-cloak
                    aria-hidden="true"></span>
            </div>

            <div class="hidden lg:flex flex-wrap items-center gap-2">
              <button type="button"
                      class="btn btn-md rounded-full transition-colors"
                      :class="onlyInStock ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                      :aria-pressed="onlyInStock"
                      @click="onlyInStock = !onlyInStock">
                <span class="flex items-center gap-2">
                  <span x-text="t('routes.products.quickFilters.inStock', 'Pouze skladem')"></span>
                  <i class="fa-solid fa-xmark text-xs" x-show="onlyInStock" x-cloak></i>
                </span>
              </button>
              <button type="button"
                      class="btn btn-md rounded-full transition-colors"
                      :class="benefitOnly ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                      :aria-pressed="benefitOnly"
                      @click="benefitOnly = !benefitOnly">
                <span class="flex items-center gap-2">
                  <span x-text="t('routes.products.quickFilters.benefit', 'Lze platit benefity')"></span>
                  <i class="fa-solid fa-xmark text-xs" x-show="benefitOnly" x-cloak></i>
                </span>
              </button>
              <button type="button"
                      class="btn btn-md rounded-full transition-colors"
                      :class="onlyDiscounted ? 'btn-secondary text-white' : 'btn-outline btn-secondary'"
                      :aria-pressed="onlyDiscounted"
                      @click="onlyDiscounted = !onlyDiscounted">
                <span class="flex items-center gap-2">
                  <span x-text="t('routes.products.quickFilters.discounted', 'Produkty v akci')"></span>
                  <i class="fa-solid fa-xmark text-xs" x-show="onlyDiscounted" x-cloak></i>
                </span>
              </button>
              <template x-if="selectedCategory">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                        @click="selectedCategory = ''">
                  <span class="flex items-center gap-2">
                    <span x-text="selectedCategory"></span>
                    <i class="fa-solid fa-xmark text-xs"></i>
                  </span>
                </button>
              </template>
              <template x-if="selectedForm">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                        @click="selectedForm = ''">
                  <span class="flex items-center gap-2">
                    <span x-text="selectedForm"></span>
                    <i class="fa-solid fa-xmark text-xs"></i>
                  </span>
                </button>
              </template>
              <template x-for="cons in selectedConsumers" :key="'cons-chip-'+cons">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                        @click="toggleConsumer(cons)">
                  <span class="flex items-center gap-2">
                    <span x-text="cons"></span>
                    <i class="fa-solid fa-xmark text-xs"></i>
                  </span>
                </button>
              </template>
              <template x-if="_priceRangeActive()">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors btn-secondary text-white"
                        @click="resetPriceFilter()">
                  <span class="flex items-center gap-2">
                    <span x-text="priceFilterChipLabel()"></span>
                    <i class="fa-solid fa-xmark text-xs"></i>
                  </span>
                </button>
              </template>
              <template x-if="activeFiltersCount() >= 3">
                <button type="button"
                        class="btn btn-md rounded-full btn-outline btn-error text-error"
                        @click="clearFilters()">
                  <span class="flex items-center gap-2">
                    <i class="fa-solid fa-rotate-left"></i>
                    <span x-text="t('routes.products.actions.resetAll', 'Zrušit vše')"></span>
                  </span>
                </button>
              </template>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0 justify-self-end">
            <div x-data="quickSearchControl($data)" class="flex-shrink-0" @click.outside="close()">
              <div
                class="group btn btn-md rounded-full transition-all duration-200 ease-out flex items-center gap-2 overflow-hidden cursor-pointer"
                :class="expanded ? 'w-44 btn-secondary text-white pl-4 pr-3 justify-start' : 'w-12 btn-outline btn-secondary justify-center'"
                role="button"
                tabindex="0"
                @click="expanded ? null : open()"
                @keydown.enter.prevent="expanded ? null : open()"
                @keydown.space="expanded ? null : ($event.preventDefault(), open())"
              >
                <span class="sr-only" x-text="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"></span>
                <i class="fa-solid fa-search" :class="expanded ? 'text-white' : 'text-secondary'"></i>
                <input
                  x-ref="input"
                  x-show="expanded"
                  x-transition.opacity.duration.150ms
                  type="text"
                  inputmode="search"
                  class="bg-transparent border-0 focus:outline-none text-sm placeholder-white/80 flex-1 min-w-0"
                  :placeholder="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"
                  x-model.debounce.300ms="query"
                @keydown.escape.stop.prevent="close(true)"
                @blur="close()"
                  :aria-label="t('routes.products.filters.search.placeholder', 'Filtruj dle názvu')"
                />
                <button
                  type="button"
                  x-show="expanded && trimmed.length"
                  x-transition.opacity.duration.150ms
                  class="btn btn-xs btn-circle btn-ghost text-white hover:text-white hover:bg-white/20 flex-shrink-0"
                  @click.stop="clear()"
                  :aria-label="t('routes.products.quickSearch.close', 'Zavřít vyhledávání')"
                >
                  <i class="fa-solid fa-xmark text-xs"></i>
                </button>
              </div>
            </div>
            <div class="dropdown dropdown-end flex-shrink-0" x-data="{ open: false }" @click.outside="open = false" @keydown.escape.window="open = false">
              <div class="relative">
                <button type="button"
                        class="btn btn-md rounded-full transition-colors flex items-center gap-2"
                        :class="sortOrder ? 'btn-secondary text-white pr-10' : 'btn-outline btn-secondary pr-4'"
                        @click="open = !open"
                        :aria-expanded="open"
                        aria-haspopup="listbox">
                  <i class="fa-solid fa-arrow-down-arrow-up"></i>
                  <span class="whitespace-nowrap hidden sm:inline" x-text="sortButtonLabel()"></span>
                  <i class="fa-solid fa-chevron-down text-xs opacity-70 transition-transform ml-1"
                     :class="open ? 'rotate-180' : ''"
                     x-show="!sortOrder"
                     aria-hidden="true"></i>
                </button>
                <button type="button"
                        x-show="sortOrder"
                        x-cloak
                        class="absolute right-1.5 top-1/2 -translate-y-1/2 btn btn-xs btn-circle btn-ghost text-white hover:text-white hover:bg-white/20 focus-visible:outline-none focus-visible:ring focus-visible:ring-white/40"
                        @click.stop="sortOrder = ''; open = false"
                        aria-label="Zrušit řazení">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <ul x-cloak
                  x-show="open"
                  x-transition.opacity.duration.150ms
                  class="menu menu-compact dropdown-content mt-3 p-2 shadow-lg bg-base-100 rounded-box min-w-[14rem]">
                <li class="px-3 py-2 text-xs uppercase tracking-wide text-base-content/60 cursor-default select-none"
                    x-text="t('routes.products.sorting.label', 'Řadit dle')">
                </li>
                <template x-for="opt in sortOptions()" :key="opt.value">
                  <li>
                    <button type="button"
                            class="flex w-full items-center justify-between gap-3 rounded-lg px-3 py-2 text-sm transition focus-visible:outline-none focus-visible:ring focus-visible:ring-primary/40"
                            :class="sortOrder === opt.value ? 'bg-secondary text-white' : 'hover:bg-base-200'"
                            @click="sortOrder = opt.value; open = false">
                      <span x-text="opt.label"></span>
                      <i class="fa-solid fa-check text-white"
                         x-show="sortOrder === opt.value"
                         aria-hidden="true"></i>
                    </button>
                  </li>
                </template>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div x-show="isLoading"
           x-transition.opacity.duration.150ms
           class="py-4"
           aria-live="polite"
           aria-busy="true">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 animate-pulse">
          <template x-for="n in skeletonPlaceholderCount()" :key="`skeleton-${n}`">
            <div class="card h-full bg-base-100 border-max-gray-400">
              <div class="h-50"></div>
              <div class="card-body space-y-3">
                <div class="h-4 bg-base-200 rounded w-3/4"></div>
                <div class="h-3 bg-base-200 rounded w-full"></div>
                <div class="h-3 bg-base-200 rounded w-5/6"></div>
                <div class="mt-4 flex items-center justify-between">
                  <div class="h-6 bg-base-200 rounded w-20"></div>
                  <div class="h-9 bg-base-200 rounded w-24"></div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <div x-show="!isLoading"
           x-transition.opacity.duration.200ms
           x-cloak
           class="py-1 px-px grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
        <template x-for="(product, idx) in pagedProducts()" :key="product?.id ? `${product.id}-${idx}` : idx">
          <article class="h-full">
            <div class="card h-full bg-base-100 shadow relative">
              <div x-show="product.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
                <template x-for="(b,i) in (product?.badges || [])" :key="i">
                  <span class="badge badge-error badge-sm font-semibold" x-text="b"></span>
                </template>
              </div>
              <figure class="h-48 flex items-center justify-center overflow-hidden">
                <a :href="link('product', { id: product.id })"
                   @click="_saveScroll('products')"
                   class="block w-full h-full">
                  <img :src="product.image" class="object-contain max-h-full w-full h-full" :alt="product.name" />
                </a>
              </figure>
              <div class="card-body min-w-0 flex flex-col">
                <h2 class="card-title">
                  <a :href="link('product', { id: product.id })"
                     @click="_saveScroll('products')"
                     class="hover:underline focus:outline-none focus:ring-2 focus:ring-primary/50"
                     x-text="product.name"></a>
                </h2>
                <p class="clamp-2" x-text="product.description"></p>
                <div class="card-actions mt-auto justify-between items-center">
                  <div class="tooltip tooltip-right md:tooltip-top cursor-help"
                       x-init="$store.legal.init()"
                       x-data="{ paras: $store.legal.paragraphsFor(product) }">
                    <div class="tooltip-content lg:p-3 max-w-64 md:max-w-auto">
                      <template x-for="(p, idx) in paras" :key="idx">
                        <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                      </template>
                    </div>
                    <div class="flex flex-col leading-tight">
                      <span x-show="product.discounted_price && product.discounted_price < product.price"
                            class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                            x-text="formatPrice(product.discounted_price)"></span>
                      <span x-show="product.discounted_price && product.discounted_price < product.price"
                            class="text-sm line-through text-base-content/60 -mt-0.5"
                            x-text="formatPrice(product.price)"></span>
                      <span x-show="!product.discounted_price || !(product.discounted_price < product.price)"
                            class="font-bold text-lg underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                            x-text="formatPrice(product.price)"></span>
                    </div>
                  </div>
                  <template x-if="!$store.cart.inCart(product.id)">
                    <button class="btn btn-primary btn-md font-semibold" @click="$store.cart.add(product)">
                      <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                    </button>
                  </template>
                  <template x-if="$store.cart.inCart(product.id)">
                    <div class="join">
                      <button class="btn btn-square btn-md join-item"
                              @click="$store.cart.decrement(product.id)"
                              :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                      <input type="text" inputmode="numeric" pattern="[0-9]*"
                             class="input input-bordered input-md w-10 text-center join-item"
                             :value="$store.cart.qty(product.id)"
                             @input="$store.cart.setQty(product.id, $event.target.value)"
                             @keydown.enter.prevent
                             :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />
                      <button class="btn btn-square btn-md join-item"
                              @click="$store.cart.increment(product.id)"
                              :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                    </div>
                  </template>
                </div>
                <div class="mt-2 text-sm">
                  <span class="text-success font-bold" x-text="product.stock"></span>
                  <span class="mx-1 opacity-40">•</span>
                  <span class="opacity-70" x-text="product.category"></span>
                </div>
              </div>
            </div>
          </article>
        </template>
      </div>

      <div x-show="!isLoading && filteredProducts().length === 0"
           class="py-16 text-center opacity-70"
           x-text="t('routes.products.results.empty', 'Nic jsme nenašli pro zadané filtrování.')">
      </div>

      <div x-show="!isLoading && (totalPages() > 1 || canLoadMoreFirstPage())"
           class="mt-4 flex flex-col gap-3 py-4 w-full sm:flex-row sm:items-center sm:justify-between">
        <div class="w-full sm:w-auto">
          <div class="flex flex-wrap items-center gap-2 w-full">
            <button class="btn btn-md"
                    :class="{'btn-disabled': page === 1}"
                    @click="page = Math.max(1, page - 1)"
                    aria-label="Předchozí stránka">«</button>
            <template x-for="(n, idx) in pagesToShow()" :key="`p-${idx}-${n}-${page}`">
              <button class="btn btn-md font-medium"
                      :class="{'btn-active': n === page, 'btn-disabled': n === '…'}"
                      @click="if(n !== '…') page = n"
                      x-text="n === '…' ? '…' : n"
                      :aria-current="n === page ? 'page' : null"></button>
            </template>
            <button class="btn btn-md"
                    :class="{'btn-disabled': page === totalPages()}"
                    @click="page = Math.min(totalPages(), page + 1)"
                    aria-label="Další stránka">»</button>
          </div>
        </div>
        <button x-show="canLoadMoreFirstPage()"
                class="btn btn-secondary btn-md w-full sm:w-auto sm:ml-auto"
                @click="loadMore()"
                :disabled="isLoading">
          <span x-text="loadMoreLabel()"></span>
        </button>
      </div>
      <!-- CATEGORIES GRID -->
      <div x-data="categoriesList" x-cloak class="w-full mx-auto pt-14">
        <h2 class="font-semibold mb-4">Inspirace</h2>
        <div class="grid gap-2 md:gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">    
          <template x-for="cat in categories" :key="cat.name">
            <a class="card card-side items-center shadow-sm hover:shadow-md bg-white transition cursor-pointer h-14 md:h-auto"
              :href="hrefFor(cat)"
              @click="handleClick(cat, $event)">
              <figure class="p-2 shrink-0">
                <div class="h-10 md:h-16 w-10 md:w-16 rounded overflow-hidden grid place-content-center"
                    :class="squareClass(cat)"
                    :style="squareStyle(cat)">
                  <template x-if="isIconTile(cat)">
                    <i :class="iconClass(cat)"
                      :style="iconStyle(cat)"></i>
                  </template>
                  <template x-if="!isIconTile(cat)">
                    <img
                      :src="imageUrl(cat)"
                      :alt="cat.name"
                      class="h-full w-full object-contain"
                      @error="$event.target.src = fallback"
                    />
                  </template>
                </div>
              </figure>

              <div class="card-body min-w-0 pl-1">
                <h2 class="card-title block truncate max-w-full text-base font-medium"
                    :title="cat.name"
                    x-text="cat.name"></h2>
              </div>
            </a>
          </template>
        </div>
      </div>

      <div class="py-4 mb-10">
        <h2 class="font-semibold mb-4">Zdraví a léky</h2>
        <span class="text-sm leading-relaxed"></span>V kategorii Zdraví a léky naleznete volně prodejné léčivé přípravky, které pomáhají při různých obtížích. Jsou to například léky proti bolesti, při rýmě či kašli, na zvýšenou teplotu nebo při chřipce a nachlazení. Léčbu těmito přípravky zvládnete sami doma. V případě opakujících se nebo déle přetrvávajících obtíží je vždy na místě vyhledat pomoc lékaře. O vhodném léku se nejprve poraďte s lékárníkem.</span>
      </div>
    </div>
  </div>
</section>



</section>

<!-- ROUTE == PRODUCT DETAIL -->
<section x-show="is('product')" x-cloak>
  <template x-if="is('product')">
      <!-- BREADCRUMBS -->

    <div
      x-data="productDetail({ fetchUrl: `data/product-details/${params.id}.json` })"
      x-effect="load(`data/product-details/${params.id}.json`)"
      class="mx-auto w-auto md:w-11/12 lg:w-8/12 p-4 py-6"
    >
    <div class="breadcrumbs hidden md:block text-sm mx-auto py-4">
      <ul>
        <li>Domů</li>
        <li><a href="#/products">Zdraví a léky</a></li>
      </ul>
    </div>
    <!-- gallery -->
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <section class="relative">
        <div x-show="product?.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
          <template x-for="(b,i) in (product?.badges || [])" :key="i">
            <span class="badge badge-accent border-0 bg-max-red-500 badge-md font-semibold" x-text="b"></span>
          </template>
        </div>

        <div class="absolute right-4 top-4 z-10 flex flex-col gap-2">
          <button type="button" class="tooltip tooltip-left btn btn-circle btn-md shadow-lg border border-base-200 bg-base-100 hover:bg-base-200" :class="isSavedCurrent() ? 'text-error' : ''" data-tip="Uložit"
                  @click.prevent="toggleSave()">
            <i :class="isSavedCurrent() ? 'fa-solid fa-lg fa-heart' : 'fa-regular fa-lg fa-heart'"></i>
          </button>
          <button type="button" class="tooltip tooltip-left btn btn-circle btn-md shadow-lg border border-base-200 bg-base-100 hover:bg-base-200" data-tip="Sdílet"
                  @click.prevent="openShareModal()">
            <i class="fa-regular fa-lg fa-arrow-up-from-square"></i>
          </button>
          <button type="button" class="tooltip tooltip-left btn btn-circle btn-md shadow-lg border border-base-200 bg-base-100 hover:bg-base-200" data-tip="Zeptat se"
                  @click.prevent="openAskModal()">
            <i class="fa-regular fa-lg fa-comment-question"></i>
          </button>
        </div>
        <div class="aspect-square bg-base-200 rounded-xl flex items-center justify-center overflow-hidden">
          <img class="object-contain w-full h-full"
               :src="images[currentImage] || ''"
               :alt="`${product?.name || ''} – obrázek ${currentImage+1}`">
        </div>
        <div class="mt-3 flex gap-2 overflow-x-auto">
          <template x-for="(img, idx) in images" :key="idx">
            <button type="button" class="shrink-0 rounded-md border p-1 w-16 h-16 bg-base-100"
                    :class="idx === currentImage ? 'ring ring-primary' : 'border-base-300'"
                    @click="currentImage = idx">
              <img :src="img" class="object-contain w-full h-full" :alt="`Náhled ${idx+1}`">
            </button>
          </template>
        </div>
      </section>
  
      <!-- buy box (variants + price + add to cart) -->
      <section class="space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold" x-text="selectedVariant?.name || product?.name || '…'"></h1>

        <!-- user rating -->
        <div x-data="ratingLine()" x-init="$watch('product.reviews', v => v && set(v))" class="flex items-center gap-2 text-sm" x-show="hasRating()" x-cloak>
          <span class="flex items-center gap-0 text-lg leading-none">
            <template x-for="(s,i) in stars()" :key="i">
              <i
                :class="s === 'full'
                  ? 'fa-solid fa-star text-yellow-400'
                  : (s === 'half'
                      ? 'fa-solid fa-star-half-stroke text-yellow-400'
                      : 'fa-regular fa-star text-base-content/30')">
              </i>
            </template>
          </span>
        
          <span class="font-bold" x-text="fmtAvg()"></span>
          <span class="text-base-content/60">(<span x-text="count"></span> recenzí)</span>
        </div>
        
        <div x-text="product?.perex || ''"></div>   

        <section>
          <div>
            <template x-if="product?.brand">
              <span>
                Brand:
                <a href=""
                   class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold"
                   x-text="product.brand"></a>
              </span>
            </template>
            <template x-if="product?.brand && product?.productLine">
              <span class="mx-1">/</span>
            </template>
            <template x-if="product?.productLine">
              <a href=""
                 class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold"
                 x-text="product.productLine"></a>
            </template>
          </div>
        </section>
        <div x-show="Array.isArray(variants) && variants.length > 1" class="space-y-2" x-cloak>
          <div class="textmd font-semibold">Varianty</div>
          <div class="flex flex-wrap gap-2">
            <template x-for="v in variants" :key="v.id">
              <button
                type="button"
                class="btn btn-md rounded-lg"
                :class="selectedVariant?.id === v.id ? 'btn-secondary' : 'btn-outline'"
                @click="selectVariant(v.id)"
                x-text="v.label || v.name"
              ></button>
            </template>
          </div>
        </div>
  

        <!-- PRODUCT DETAIL: PRICE + LEGAL TOOLTIP -->
        <div
          class="tooltip cursor-help z-[30]"
          x-init="$store.legal.init()"
          x-data="{
            // Build a pseudo 'product' for the legal helper based on your local API
            get paras () {
              const pseudo = {
                price: priceOriginal(),                               
                discounted_price: hasDiscount() ? priceNow() : null  
              };
              return $store.legal.paragraphsFor(pseudo);
            }
          }"
        >
          <!-- Tooltip content (auto paragraphs; same separators as in grid) -->
          <div class="tooltip-content lg:p-3">
            <template x-for="(p, idx) in paras" :key="idx">
              <p
                :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''"
                x-text="p"
              ></p>
            </template>
          </div>

          <!-- Your original price area (unchanged design) -->
          <div class="flex items-end gap-3">
            <div class="flex flex-col">
              <span x-show="hasDiscount()" class="text-2xl font-extrabold text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400" x-text="formatPrice(priceNow())"></span>
              <span x-show="hasDiscount()" class="text-sm line-through text-base-content/60 -mt-0.5" x-text="formatPrice(priceOriginal())"></span>
              <span x-show="!hasDiscount()" class="text-2xl font-extrabold underline decoration-dotted underline-offset-4 decoration-max-gray-400" x-text="formatPrice(priceOriginal())"></span>
            </div>
            <span x-show="hasDiscount()" class="badge badge-error badge-sm">-<span x-text="discountPercent()"></span>%</span>
          </div>
        </div>

  
            <div class="text-sm mt-1 gap-1 grid">
              <div class="text-success font-semibold text-xl" x-text="product?.stock || 'Skladem'"></div>

              <div class="text-base"><i class="fa-classic fa-md fa-regular fa-truck-fast"></i> Odešleme ještě dnes, předpokládané doručení 1.10.</div>
              <div class="text-base"><i class="fa-classic fa-md fa-regular fa-shop"></i> Dostupné také v 347 lékárnách</div>
             
            </div>
  
            <div class="pt-2">
              <!-- ADD / STEPPER -->
              <template x-if="!$store.cart.inCart(product.id)">
                <button class="btn btn-primary btn-lg font-medium" @click="$store.cart.add(product)">
                  <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                </button>
              </template>

              <template x-if="$store.cart.inCart(product.id)">
                <div class="flex items-center gap-4" x-data="qtyBlinker(product.id)">
                  <div class="join">
                    <button class="btn btn-square btn-lg join-item"
                            @click="$store.cart.decrement(product.id)"
                            :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>

                    <input type="text" inputmode="numeric" pattern="[0-9]*"
                          class="input input-bordered input-lg w-12 text-center join-item"
                          :value="$store.cart.qty(product.id)"
                          @input="$store.cart.setQty(product.id, $event.target.value)"
                          @keydown.enter.prevent
                          :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />

                    <button class="btn btn-square btn-lg join-item"
                            @click="$store.cart.increment(product.id)"
                            :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                  </div>

                  <div class="flex items-center gap-2">
                    <span>ks v košíku</span>
                    <i class="fa-classic fa-md fa-solid fa-check-circle text-success transition-opacity duration-200"
                    :style="`opacity:${alpha}`"
                    aria-hidden="true"></i>
                  </div>
                </div>
              </template>
            </div>

      </section>
    </div>
    
      <!-- ACCORIDONS -->
       <section class="space-y-2 py-6">

        <div class="collapse bg-base-100 collapse-arrow border-yellow-300 border p-2">
          <input type="checkbox" />
          <div class="collapse-title font-medium text-lg text-max-gray-600 inline-flex gap-3 items-center"><i class="fa-classic fa-md fa-solid fa-truck-fast"></i>Jak získat dopravu zdrama?</div>
          <div class="collapse-content text-md flex gap-3 items-center">
            <span>Doprava zdarma při nákupu nad <span x-text="formatPrice(1500)"></span>. Limit pro přihlášené je <span x-text="formatPrice(399)"></span></span>
            <button class="btn btn-secondary btn-md">Přihlásit se</button>
          </div>
        </div>
        <div class="collapse bg-yellow-50 collapse-arrow border-yellow-300 border p-2">
          <input type="checkbox" />
          <div class="collapse-title font-medium text-lg text-max-gray-600 inline-flex gap-3 items-center"><i class="fa-classic fa-md fa-solid fa-badge-percent"></i>Máte možnost získat slevu 13%</div>
          <div class="collapse-content text-md flex gap-3 items-center">
            <span>Staňte se členem věrnostního programu Dr. Max a získejte produkt za <span x-text="formatPrice(108)"></span> (sleva 13%)</span>
            <button class="btn btn-secondary btn-md">Přihlásit se</button>
          </div>
        </div>


      <div class="collapse collapse-open bg-base-100 collapse-arrow border-base-300 border p-3">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">O produktu </div>
        
        <div class="collapse-content text-md">

          <div x-text="product?.name" class="uppercase text-max-gray-600"></div>
          <div class="pb-4 text-max-gray-600">SKU: <span x-text="product?.SKU" class="uppercase"></span></div>
          <div x-html="product?.description || ''"></div>

        </div>
      </div>
      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">Parametry</div>
        <div class="collapse-content">

            <div class="overflow-x-auto">
              <table class="table table-zebra text-sm md:text-base">
                <tbody>
                  <template x-for="(row,i) in product?.parameters || []" :key="i">
                    <tr>
                      <td class="w-auto md:w-1/3 font-semibold" x-text="row.name"></td>
                      <td x-text="row.value"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          
        </div>
      </div>
      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">Skladem v lékárnách <span class="opacity-50 text-sm">(347)</span></div>
        <div class="collapse-content text-sm">
          <iframe src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d81853.65539237593!2d14.427750211155628!3d50.1250929885876!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1sDr.%20Max!5e0!3m2!1sen!2scz!4v1758902085984!5m2!1sen!2scz" width="100%" height="450" style="border:0;"  allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
 
      <template x-if="product?.comparison_id">
        <div x-data="comparisonSection({ url: 'data/comparison.json', id: product.comparison_id })"
             class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
      
          <input type="checkbox" />
      
          <!-- Heading: N podobných produktů k porovnání -->
          <div class="collapse-title font-medium text-lg text-max-gray-600">
            <span x-show="loading">Načítám porovnání…</span>
            <span x-show="!loading" x-text="`Podobné produkty k porovnání`"></span> <span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
          </div>
      
          <div class="collapse-content text-md">
            <!-- Error -->
            <div x-show="!loading && error" class="alert alert-error my-2">
              <span x-text="error"></span>
            </div>
      
            <!-- Empty -->
            <div x-show="!loading && !error && !count()" class="alert my-2">
              <span>Pro tento produkt zatím nemáme srovnatelné položky.</span>
            </div>
      
            <!-- Table -->
            <div x-show="!loading && !error && count()" class="overflow-x-auto">
              <table class="table table-zebra min-w-[900px]">
                <thead>
                  <tr>
                    <!-- attribute column heading -->
                    <th class="w-36 md:w-60"></th>
      
                    <!-- product columns -->
                    <template x-for="(p, i) in items" :key="i">
                      <th class="align-top">
                        <img :src="p.image" :alt="p.name" class="h-20 object-contain mb-2">
                        <div class="font-medium text-sm leading-snug line-clamp-2" x-text="p.name"></div>
                      </th>
                    </template>
                  </tr>
                </thead>
      
                <tbody>
                  <!-- Kategorie -->
                  <tr>
                    <th>Kategorie</th>
                    <template x-for="(p, i) in items" :key="'cat-'+i">
                      <td x-text="p.category || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Forma -->
                  <tr>
                    <th>Forma</th>
                    <template x-for="(p, i) in items" :key="'form-'+i">
                      <td x-text="p.form || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Účinná látka -->
                  <tr>
                    <th>Účinná látka</th>
                    <template x-for="(p, i) in items" :key="'subst-'+i">
                      <td x-text="p.medicinal_substance || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Objem -->
                  <tr>
                    <th>Objem</th>
                    <template x-for="(p, i) in items" :key="'vol-'+i">
                      <td x-text="p.volume ? `${p.volume} ${p.unit || ''}` : '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Cena (zohlední slevu) -->
                  <tr>
                    <th>Cena</th>
                    <template x-for="(p, i) in items" :key="'price-'+i">
                      <td class="align-middle">
                        <div x-show="(Number(p.discounted_price||0) > 0) && (Number(p.discounted_price) < Number(p.price||0))" class="space-y-0.5">
                          <div class="font-semibold text-error" x-text="fmtPrice(priceNow(p))"></div>
                          <div class="text-sm line-through text-base-content/60" x-text="fmtPrice(priceOriginal(p))"></div>
                        </div>
                        <div x-show="!(Number(p.discounted_price||0) > 0 && Number(p.discounted_price) < Number(p.price||0))">
                          <span class="font-semibold" x-text="fmtPrice(priceOriginal(p))"></span>
                        </div>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Cena za jednotku -->
                  <tr>
                    <th>Cena za jednotku</th>
                    <template x-for="(p, i) in items" :key="'ppu-'+i">
                      <td x-text="unitPriceText(p)"></td>
                    </template>
                  </tr>
      
                  <!-- Dostupnost -->
                  <tr>
                    <th>Dostupnost</th>
                    <template x-for="(p, i) in items" :key="'stock-'+i">
                      <td>
                        <span :class="(p.stock||'').toLowerCase().includes('sklad') ? 'text-success font-medium' : ''"
                              x-text="p.stock || '—'"></span>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Štítky -->
                  <tr>
                    <th>Štítky</th>
                    <template x-for="(p, i) in items" :key="'badges-'+i">
                      <td>
                        <div class="flex flex-wrap gap-1">
                          <template x-for="(b, bi) in (p.badges || [])" :key="bi">
                            <span class="badge badge-accent badge-xs" x-text="b"></span>
                          </template>
                          <span x-show="!(p.badges && p.badges.length)">—</span>
                        </div>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Popis (krátký) -->
                  <tr>
                    <th>Popis</th>
                    <template x-for="(p, i) in items" :key="'desc-'+i">
                      <td x-text="shortDesc(p.description)"></td>
                    </template>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </template>


      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">
          Dokumenty, návody, letáky
          <span class="opacity-50 text-sm">(1)</span>
        </div>
        <div class="collapse-content text-sm">
          <a class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold">PDF</a>
        </div>
      </div>

      <div x-data="benefitsSection({ url: 'data/benefits.json' })"
      class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
 
   <input type="checkbox" />
   <div class="collapse-title font-medium text-lg text-max-gray-600 flex items-center gap-2">
     Lze platit vybranými benefity<span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
   </div>
 
   <div class="collapse-content text-sm">
     <!-- Loading -->
     <div x-show="loading" class="flex gap-2 items-center">
       <div class="skeleton h-5 w-24"></div>
       <div class="skeleton h-5 w-40"></div>
     </div>
 
     <!-- Error -->
     <div x-show="!loading && error" class="alert alert-error my-2">
       <span x-text="error"></span>
     </div>
 
     <!-- Table -->
     <div x-show="!loading && !error" class="overflow-x-auto">
       <table class="table table-zebra text-sm md:text-base">
         <thead>
           <tr>
            <th class="font-medium w-auto md:w-1/3">Název benefitu</th>
            <th class="w-14 text-center font-medium">V e-shopu</th>
            <th class="w-14 text-center font-medium">V lékárně</th>
            <th class="hidden md:block w-auto"></th>
           </tr>
         </thead>
         <tbody>
           <template x-for="(b, i) in items" :key="i">
             <tr>
              <td class="font-medium" x-text="b.name"></td>
              <td class="text-center">
                 <i :class="b.eshop_payment
                           ? 'fa-solid fa-circle-check text-success fa-lg'
                           : 'fa-solid fa-circle-xmark text-error fa-lg'"></i>
               </td>               
               <td class="text-center">
                <i :class="b.pharmacy_payment
                          ? 'fa-solid fa-circle-check text-success fa-lg'
                          : 'fa-solid fa-circle-xmark text-error fa-lg'"></i>
              </td>
              <td class="hidden md:block w-auto"></td>
             </tr>
           </template>
         </tbody>
       </table>
     </div>
 
     <!-- Empty state -->
     <div x-show="!loading && !error && !count()" class="alert mt-3">
       <span>Pro tento produkt nejsou k dispozici žádné benefity.</span>
     </div>
   </div>
 </div>
      
      <!-- User reviews -->
      <div x-data="reviewsSection({ url: 'data/reviews.json' })"
      class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
 
   <input type="checkbox" />
 
   <!-- Title: N recenzí + avg stars (only when loaded) -->
   <div class="collapse-title font-medium text-lg text-max-gray-600 block md:flex items-center justify-between gap-3">
     <span>
       Recenze zákazníků <span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
     </span>
 
     <!-- Average stars summary using your ratingLine component -->
     <template x-if="count()">
       <div x-data="ratingLine({ average: average(), count: count() })"
            class="flex items-center gap-2 text-sm pt-2 md:pt-0">
         <span class="flex items-center gap-0 text-lg leading-none">
           <template x-for="(s,i) in stars()" :key="i">
             <i :class="s === 'full'
                         ? 'fa-solid fa-star text-yellow-400'
                         : (s === 'half'
                             ? 'fa-solid fa-star-half-stroke text-yellow-400'
                             : 'fa-regular fa-star text-base-content/30')"></i>
           </template>
         </span>
         <span class="font-bold" x-text="fmtAvg()"></span>

       </div>
     </template>
   </div>
 
   <div class="collapse-content text-md">
     <!-- Loading / error -->
     <div x-show="loading" class="flex gap-2 items-center">
       <div class="skeleton h-5 w-24"></div>
       <div class="skeleton h-5 w-40"></div>
     </div>
     <div x-show="!loading && error" class="alert alert-error my-2">
       <span x-text="error"></span>
     </div>
 
     <!-- Reviews list -->
     <div x-show="!loading && !error" class="space-y-3 pt-3">
       <template x-for="(r, i) in items" :key="i">
         <article class="border border-base-300 rounded-lg p-3 md:p-4 space-y-1">
           <header class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm">
             <!-- Stars per review -->
             <span class="flex items-center gap-0.5">
               <template x-for="(s, si) in starsFor(r.score)" :key="si">
                 <i :class="s === 'full'
                             ? 'fa-solid fa-star text-yellow-400'
                             : (s === 'half'
                                 ? 'fa-solid fa-star-half-stroke text-yellow-400'
                                 : 'fa-regular fa-star text-base-content/30')"></i>
               </template>
             </span>
             <span class="font-medium" x-text="Number(r.score).toFixed(1)"></span>
             <span class="opacity-50">•</span>
             <span class="opacity-70" x-text="r.source"></span>
             <span class="opacity-50">•</span>
             <span class="opacity-70" x-text="r.date"></span>
           </header>
 
           <div class="text-sm opacity-70">
             <span class="font-semibold" x-text="r.author"></span>
           </div>
 
           <p class="mt-1 leading-relaxed" x-text="r.review"></p>
         </article>
       </template>
 
       <!-- Empty state -->
       <div x-show="!count()" class="alert">
         <span>Zatím zde nejsou žádné recenze.</span>
       </div>
     </div>
   </div>
 </div> 
      
    </section>
  
    <a href="#/products"
    class="font-medium text-max-blue-600 group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded my-8">
   <i class="fa-solid fa-arrow-left fa-sm" aria-hidden="true"></i>
   <span class="group-hover:underline group-focus-visible:underline underline-offset-2">
    Zpět na výpis produktů
   </span>
  </a>
   
    <!-- Mobile sticky CTA bar -->
    <div
      class="fixed inset-x-0 bottom-0 z-50 md:hidden
            transition-all duration-200
            ease-out pb-[env(safe-area-inset-bottom)]" 
      :class="ctaVisible ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0 pointer-events-none'">

      <div class="bg-base-100 border-t border-base-200 shadow-2xl
                  px-4 py-3
                  pb-[calc(env(safe-area-inset-bottom,0px)+0.75rem)]">
        <div class="flex items-center justify-between gap-3">
          <!-- price -->
          <div class="flex flex-col leading-tight">
            <!-- discounted -->
            <span x-show="hasDiscount()" class="text-lg font-extrabold text-error"
                  x-text="formatPrice(priceNow())"></span>
            <span x-show="hasDiscount()" class="text-xs line-through text-base-content/60 -mt-0.5"
                  x-text="formatPrice(priceOriginal())"></span>

            <!-- regular -->
            <span x-show="!hasDiscount()" class="text-lg font-extrabold"
                  x-text="formatPrice(priceOriginal())"></span>
          </div>

          <!-- CTA -->
          <div class="pt-2">
            <!-- ADD / STEPPER -->
            <template x-if="!$store.cart.inCart(product.id)">
                  <button class="btn btn-primary btn-md font-medium" @click="$store.cart.add(product)">
                    <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                  </button>
            </template>

            <template x-if="$store.cart.inCart(product.id)">
              <div class="flex items-center gap-4" x-data="qtyBlinker(product.id)">
                <div class="join">
                    <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.decrement(product.id)"
                            :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>

                  <input type="text" inputmode="numeric" pattern="[0-9]*"
                        class="input input-bordered input-md w-12 text-center join-item"
                        :value="$store.cart.qty(product.id)"
                        @input="$store.cart.setQty(product.id, $event.target.value)"
                          @keydown.enter.prevent
                          :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />

                  <button class="btn btn-square btn-md join-item"
                            @click="$store.cart.increment(product.id)"
                            :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                </div>

              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Share modal -->
    <div x-cloak x-show="shareModal.open" x-transition.opacity
         class="fixed inset-0 z-[70] flex items-center justify-center px-4"
         @keydown.escape.window="closeShareModal()">
      <div class="absolute inset-0 bg-base-200/10 backdrop-blur-sm transition-all duration-500 ease-out" @click="closeShareModal()"></div>
      <div class="relative z-[71] w-full max-w-lg bg-base-100 border border-base-200 rounded-2xl shadow-2xl p-6 space-y-5">
        <button type="button"
                class="btn btn-circle btn-ghost absolute right-3 top-3"
                aria-label="Zavřít sdílení"
                @click="closeShareModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <header class="space-y-1 pr-10">
          <h2 class="text-xl font-semibold">Sdílet produkt</h2>
          <p class="text-sm text-base-content/70" x-text="product?.name"></p>
        </header>

        <div class="grid gap-2">
          <button type="button"
                  class="btn btn-outline justify-start"
                  @click.prevent="shareNative()">
            <i class="fa-solid fa-share-nodes"></i>
            <span>Sdílet přes systémové menu</span>
          </button>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <a :href="`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl())}`"
               class="btn btn-outline justify-start"
               target="_blank" rel="noopener">
              <i class="fa-brands fa-facebook"></i>
              <span>Facebook</span>
            </a>
            <a :href="`https://api.whatsapp.com/send?text=${encodeURIComponent((product?.name ? product.name + ' – ' : '') + shareUrl())}`"
               class="btn btn-outline justify-start"
               target="_blank" rel="noopener">
              <i class="fa-brands fa-whatsapp"></i>
              <span>WhatsApp</span>
            </a>
            <a :href="`https://twitter.com/intent/tweet?text=${encodeURIComponent(product?.name || 'Skvělý tip')}&url=${encodeURIComponent(shareUrl())}`"
               class="btn btn-outline justify-start"
               target="_blank" rel="noopener">
              <i class="fa-brands fa-x-twitter"></i>
              <span>Twitter</span>
            </a>
            <a :href="`mailto:?subject=${encodeURIComponent(product?.name || 'Doporučuji produkt')}&body=${encodeURIComponent(shareUrl())}`"
               class="btn btn-outline justify-start">
              <i class="fa-regular fa-envelope"></i>
              <span>E-mail</span>
            </a>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-base-content/70">Odkaz na produkt</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <input type="text"
                   class="input input-bordered w-full text-sm"
                   :value="shareUrl()"
                   readonly
                   @focus="$event.target.select()">
            <button type="button"
                    class="btn sm:w-auto"
                    @click.prevent="copyShareLink()"
                    :class="shareModal.copied ? 'btn-success' : 'btn-primary'">
              <span x-show="!shareModal.copied">Kopírovat</span>
              <span x-show="shareModal.copied">
                <i class="fa-solid fa-check mr-1"></i>
                Zkopírováno
              </span>
            </button>
          </div>
          <p class="text-sm text-success" x-show="shareModal.copied">Odkaz máte ve schránce.</p>
        </div>
      </div>
    </div>

    <!-- Ask modal -->
    <div x-cloak x-show="askModal.open" x-transition.opacity
         class="fixed inset-0 z-[80] flex items-center justify-center px-4"
         @keydown.escape.window="closeAskModal()">
      <div class="absolute inset-0 bg-base-200/10 backdrop-blur-sm transition-all duration-500 ease-out" @click="closeAskModal()"></div>
      <div class="relative z-[81] w-full max-w-xl bg-base-100 border border-base-200 rounded-2xl shadow-2xl p-6 space-y-5">
        <button type="button"
                class="btn btn-circle btn-ghost absolute right-3 top-3"
                aria-label="Zavřít dotaz"
                @click="closeAskModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <header class="space-y-1 pr-10">
          <h2 class="text-xl font-semibold">Zeptat se na produkt</h2>
          <p class="text-sm text-base-content/70">Odpověď posíláme do 48 hodin na e-mail.</p>
        </header>

        <form class="space-y-4" @submit.prevent="submitAsk()">
          <label class="form-control">
            <span class="label-text font-medium">Váš dotaz</span>
            <textarea class="textarea textarea-bordered h-32"
                      placeholder="Co vás zajímá?"
                      x-model="askModal.message"
                      required></textarea>
          </label>

          <label class="form-control">
            <span class="label-text font-medium">E-mail</span>
            <input type="email"
                   class="input input-bordered"
                   placeholder="jmeno@domena.cz"
                   x-model="askModal.email"
                   required>
          </label>

          <div class="text-sm text-base-content/70">
            Na dotazy reagujeme nejpozději do 48&nbsp;hodin. Odpověď dorazí do vaší e-mailové schránky.
          </div>

          <p class="text-sm text-error" x-show="askModal.error" x-text="askModal.error"></p>

          <div class="flex flex-col sm:flex-row sm:justify-end gap-2">
            <button type="button" class="btn btn-ghost sm:w-auto w-full" @click="closeAskModal()">Zrušit</button>
            <button type="submit"
                    class="btn btn-primary sm:w-auto w-full"
                    :disabled="askModal.submitting">
              <span x-show="!askModal.submitting">Odeslat dotaz</span>
              <span x-show="askModal.submitting">Odesílám…</span>
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
  </template>
</section>

<!-- ROUTE == CART -->
<section x-show="is('cart')" x-cloak>


    <section x-data="cartPage()" class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
      <h1 class="text-3xl mx-auto mb-6">Nákupní košík</h1>
  <!-- EMPTY STATE -->
  <template x-if="$store.cart.distinctCount() === 0">
    <div class="grid place-items-center py-16">
      <dotlottie-wc src="https://lottie.host/eb88511c-2fed-471c-8171-78a57701e4ef/z9tvJoPVCp.lottie" style="width: 160px;height: 160px" autoplay loop></dotlottie-wc>
      <p class="mt-4 font-medium">Váš košík je prázdný. Pojďme to napravit!</p>
      <button class="btn btn-outline mt-6" @click="location.hash='/products'">Pokračovat v nákupu</button>
    </div>
  </template>

  <!-- CART TABLE -->
  <template x-if="$store.cart.distinctCount() > 0">
    <div class="space-y-2">

      <!-- CART LIST: MOBILE TILES (no horizontal scroll) -->
      <div class="md:hidden space-y-3">
        <template x-for="it in $store.cart.list()" :key="it.id + '-' + it.image">
          <article class="card bg-white border border-base-200 shadow-sm">
            <div class="card-body p-3">
              <!-- Header: image + title + price -->
              <div class="flex gap-3 items-center">
                <div class="h-18 w-18 rounded bg-base-200 overflow-hidden shrink-0 grid place-content-center">
                  <img
                    :src="it.image"
                    :alt="it.name"
                    class="h-full w-full object-contain"
                    loading="lazy"
                    @error="$event.target.closest('.grid')?.classList.add('opacity-50')"
                  >
                </div>

                <div class="min-w-0 flex-1">
                  <h3 class="font-medium text-base" :title="it.name" x-text="it.name"></h3>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <template x-for="b in (it.badges || [])">
                      <span class="badge badge-ghost badge-sm" x-text="b"></span>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Controls: stepper + subtotal + remove -->
              <div class="mt-3 flex items-center justify-between gap-3">
                <div class="join">
                  <button class="btn btn-square btn-md join-item" @click="$store.cart.decrement(it.id)" :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                  <input
                  type="text" inputmode="numeric" pattern="[0-9]*"
                  class="input input-bordered input-md w-12 text-center join-item px-0 tabular-nums"
                  :value="$store.cart.qty(it.id)"
                  @input="$store.cart.setQty(it.id, $event.target.value.replace(/[^0-9]/g,''))"
                  @keydown.enter.prevent
                  />
                  <button class="btn btn-square btn-md join-item" @click="$store.cart.increment(it.id)" :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                </div>

                <div class="text-right">
                  <template x-if="it.priceBefore && it.priceBefore > it.price">
                    <span class="block text-sm line-through text-base-content/50" x-text="koruny(it.priceBefore)"></span>
                  </template>

                  <div class="flex items-center justify-end gap-1 text-sm">
                    <!-- CART: MOBILE PRICE + LEGAL TOOLTIP (wrap only the price, leave '/ ks' outside) -->
                    <span
                      class="tooltip tooltip-left cursor-help inline-flex"
                      x-init="$store.legal.init()"
                      x-data="{
                        get paras () {
                          const hasDisc = !!(it.priceBefore && it.priceBefore > it.price);
                          const original = hasDisc ? it.priceBefore : it.price;
                          const discounted_price = hasDisc ? it.price : null;
                          return $store.legal.paragraphsFor({ price: original, discounted_price });
                        }
                      }"
                    >
                      <div class="tooltip-content lg:p-3 max-w-64 md:max-w-auto">
                        <template x-for="(p, idx) in paras" :key="idx">
                          <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                        </template>
                      </div>

                      <span class="font-medium text-sm underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                            x-text="koruny(it.price)"></span>
                    </span>
                    <span class="text-sm"> / ks</span>
                  </div>

                  <div class="font-medium text-base mt-1" x-text="koruny($store.cart.linePrice(it))"></div>
                </div>
              </div>

            </div>
          </article>
        </template>
      </div>

<!-- CART TABLE: DESKTOP/MD+ -->
<div class="hidden md:block overflow-x-auto rounded-xl border border-base-200 bg-white p-10">
  <table class="table text-base">
    <thead>
      <tr>
        <th class="font-medium">Produkt</th>
        <th class="text-center font-medium">Cena za kus</th>
        <th class="text-center font-medium">Množství</th>
        <th class="text-right font-medium">Mezisoučet</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="it in $store.cart.list()" :key="it.id + '-' + it.image">
        <tr>
          <td>
            <div class="flex gap-3 items-center">
              <div class="h-20 w-20 rounded bg-base-200 overflow-hidden grid place-content-center mr-2 flex-shrink-0">
                <img
                :src="it.image"
                :alt="it.name"
                class="h-full w-full object-contain"
                loading="lazy"
                @error="$event.target.closest('.grid')?.classList.add('opacity-50')"
              >
              </div>
              <div class="min-w-0">
                <div class="font-medium" :title="it.name" x-text="it.name"></div>
                <div class="flex gap-1 mt-1">
                  <template x-for="b in (it.badges || [])">
                    <span class="badge badge-ghost badge-sm" x-text="b"></span>
                  </template>
                </div>
              </div>
            </div>
          </td>

          <td class="text-center align-center">
            <div>
            <!-- CART: DESKTOP PRICE + LEGAL TOOLTIP (priceBefore-aware) -->
            <div
              class="tooltip cursor-help"
              x-init="$store.legal.init()"
              x-data="{
                get paras () {
                  const hasDisc = !!(it.priceBefore && it.priceBefore > it.price);
                  const original = hasDisc ? it.priceBefore : it.price;      // pre-discount for legal
                  const discounted_price = hasDisc ? it.price : null;        // discount only when present
                  return $store.legal.paragraphsFor({ price: original, discounted_price });
                }
              }"
            >
              <div class="tooltip-content lg:p-3">
                <template x-for="(p, idx) in paras" :key="idx">
                  <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                </template>
              </div>

              <template x-if="it.priceBefore && it.priceBefore > it.price">
                <div class="text-sm line-through text-base-content/50" x-text="koruny(it.priceBefore)"></div>
              </template>
              <!-- Your original desktop price element (unchanged look) -->
              <div class="font-medium underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                  x-text="koruny(it.price)"></div>
              </div>



            </div>
          </td>

          <td class="text-center">
            <div class="join justify-end">
              <button class="btn btn-square btn-md join-item" @click="$store.cart.decrement(it.id)">−</button>
              <input
              type="text" inputmode="numeric" pattern="[0-9]*"
              class="input input-bordered input-md w-12 text-center join-item px-0 tabular-nums"
              :value="$store.cart.qty(it.id)"
              @input="$store.cart.setQty(it.id, $event.target.value.replace(/[^0-9]/g,''))"
              @keydown.enter.prevent
              />
              <button class="btn btn-square btn-md join-item" @click="$store.cart.increment(it.id)">+</button>
            </div>
          </td>

          <td class="text-right align-center">
            <div class="font-medium" x-text="koruny($store.cart.linePrice(it))"></div>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</div>




      <!-- Totals -->
      <div class="grid md:grid-cols-2 gap-4">
        
    <!-- Free shipping bar -->
    <div class="rounded-xl border border-base-200 bg-white p-4 md:p-10 free-ship-bar select-none">
      <div class="flex items-center justify-between mb-2">
        <span class="font-medium">Doprava zdarma</span>

        <span class="text-sm text-base-content/70" x-show="$store.cart.totalToPay() < $store.cart.freeShipThreshold">
          Chybí <strong x-text="koruny($store.cart.freeShipMissing())"></strong> do
          <strong x-text="koruny($store.cart.freeShipThreshold)"></strong>
        </span>

        <span class="text-sm text-success" x-show="$store.cart.totalToPay() >= $store.cart.freeShipThreshold">
          Splněno <i class="fa-solid fa-check"></i>
        </span>
      </div>

      <!-- Track -->
      <div class="relative h-6 rounded-full bg-base-200 overflow-hidden"
          role="progressbar"
          :aria-valuemin="0" :aria-valuemax="100"
          :aria-valuenow="$store.cart.freeShipProgress()">

        <!-- Fill -->
        <div class="fill h-full rounded-full transition-[width] duration-500"
            :class="{
              'bg-success' : $store.cart.hasFreeShipping(),
              'bg-primary/80 shimmer' : !$store.cart.hasFreeShipping()
            }"
            :style="`width: ${$store.cart.freeShipProgress()}%`">
        </div>
      </div>

      
<!-- COUPONS / GIFTCARDS ACTIONS (inline buttons) -->
<div class="flex flex-wrap gap-3 items-stretch mt-12">
  <!-- Coupon button + modal -->
  <div x-data="{ open:false, code:'', error:'' }" class="indicator">
    <button
      class="btn btn-outline btn-md px-4 indicator"
      @click="open = true"
      type="button"
    >
      Slevový kupón
      <!-- indicator with count -->
      <template x-if="$store.cart.couponCount() > 0">
        <span class="badge badge-error badge-sm indicator-item"
              x-text="$store.cart.couponCount()"></span>
      </template>
    </button>

    <!-- DaisyUI modal -->
    <dialog class="modal" :open="open" @close="open=false">
      <div class="modal-box lg:px-8 lg:py-10">
        <form method="dialog">
          <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"><i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i></button>
        </form>
        
        <h3 class="font-semibold text-xl">Slevové kupóny</h3>

        <!-- Input row -->
        <div class="mt-4 flex gap-2">
          <input class="input input-bordered w-full"
                 placeholder="Zadejte kód (např. SLEVA10)"
                 x-model="code"
                 @keydown.enter.prevent="$refs.apply.click()">
                 <button class="btn btn-primary" x-ref="apply" @click="
                 error='';
                 const r = $store.cart.applyCoupon(code);
                 if (!r.ok) { error = r.message }
                 else {
                   code='';
                   $store.toast.push('Kupón uplatněn', 'success');
                   $fx.confetti('coupon', $el)
                 }
               ">Uplatnit</button>
        </div>
        <p class="text-error text-sm mt-2" x-text="error" x-show="error"></p>

        <!-- Applied list -->
        <div class="mt-4">
          <div class="flex flex-wrap gap-2">
            <template x-if="$store.cart.couponCount() === 0">
              <div class="text-sm mb-2 text-base-content/70">Zatím žádné uplatněné kupóny</div>
            </template>
            <template x-for="c in $store.cart.listCoupons()" :key="c.code">
              <div class="gap-2">
                <div class="text-sm mb-2 w-auto text-base-content/70">Uplatněné kupóny</div>             
                <span class="badge badge-lg badge-outline badge-success pr-1 gap-1">
                  <span class="font-mono" x-text="c.code"></span>
                  <button class="btn btn-link no-underline hover:!no-underline btn-xs px-1"
                          type="button"
                          aria-label="Zrušit"
                          @click="$store.cart.removeCoupon(c.code)">
                      <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
                  </button>
                </span>
              </div>
            </template>
          </div>
        </div>

      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
  </div>

    <!-- Gift card button + modal -->
    <div x-data="{ open:false, code:'', error:'' }" class="indicator">
      <button
        class="btn btn-outline btn-md px-4 indicator"
        @click="open = true"
        type="button"
      >
        Dárková karta
        <!-- indicator with count -->
        <template x-if="$store.cart.giftCardCount() > 0">
          <span class="badge badge-error badge-sm indicator-item"
                x-text="$store.cart.giftCardCount()"></span>
        </template>
      </button>

      <!-- DaisyUI modal -->
      <dialog class="modal" :open="open" @close="open=false">
        <div class="modal-box  lg:px-8 lg:py-10">
          <form method="dialog">
            <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"><i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i></button>
          </form>
          <h3 class="font-semibold text-xl">Dárkové karty</h3>

          <!-- Input row -->
          <div class="mt-4 flex gap-2">
            <input class="input input-bordered w-full"
                  placeholder="Zadejte kód (např. DAR100)"
                  x-model="code"
                  @keydown.enter.prevent="$refs.apply2.click()">
            <button class="btn btn-primary" x-ref="apply2" @click="
              error='';
              const r = $store.cart.applyGiftCard(code);
              if (!r.ok) { error = r.message; }
              else {
                code='';
                $store.toast.push('Dárková karta uplatněna', 'success');
                $fx.confetti('coupon', $el)
              }
            ">Vložit</button>
          </div>
          <p class="text-error text-sm mt-2" x-text="error" x-show="error"></p>

          <!-- Applied list -->
          <div class="mt-4">
            <div class="flex flex-wrap gap-2">
              <template x-if="$store.cart.giftCardCount() === 0">
                <span class="text-sm text-base-content/70">Zatím žádné uplatňené karty</span>
              </template>
              <template x-for="g in $store.cart.listGiftCards()" :key="g.code">
                  <div class="gap-2">
                    <div class="text-sm mb-2 w-auto text-base-content/70">Uplatněné karty</div>
                  <span class="badge badge-lg badge-outline badge-success pr-1 gap-1">
                    <span class="font-mono" x-text="g.code"></span>
                    <button class="btn btn-link no-underline hover:!no-underline btn-xs px-1"
                            type="button"
                            aria-label="Zrušit"
                            @click="$store.cart.removeGiftCard(g.code)">
                        <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
                    </button>
                  </span>
                </div>
              </template>
            </div>
          </div>

        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    </div>

    </div>
      </div>
        
        
        <div class="p-4 md:p-10 rounded-xl border border-base-200 bg-white">
          <div class="flex flex-col gap-2">
            <div class="flex justify-between">
              <span>Mezisoučet (bez kupónů)</span>
              <span x-text="koruny($store.cart.subtotal())"></span>
            </div>

            <div class="flex justify-between text-success" x-show="$store.cart.totalDiscountsRaw() > 0">
              <span>Slevy z produktů</span>
              <span>− <span x-text="koruny($store.cart.totalDiscountsRaw())"></span></span>
            </div>

            <template x-if="$store.cart.coupon">
              <div class="flex justify-between text-success">
                <span>Slevový kupón <span class="font-mono" x-text="$store.cart.coupon.code"></span></span>
                <span>− <span x-text="koruny(calcCouponValue($store.cart))"></span></span>
              </div>
            </template>

            <template x-if="$store.cart.giftCard">
              <div class="flex justify-between text-success">
                <span>Dárková karta <span class="font-mono" x-text="$store.cart.giftCard.code"></span></span>
                <span>− <span x-text="koruny(calcGiftCardValue($store.cart))"></span></span>
              </div>
            </template>

            <div class="divider my-2"></div>

            <div class="flex justify-between text-lg font-semibold">
              <span>Celkem k úhradě</span>
              <span x-text="koruny($store.cart.totalToPay())"></span>
            </div>
          </div>
        </div>
      </div>

      <section class="mt-10" x-cloak x-show="topProductsShuffledFor('cartUpsell', 12).length">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Nezapomněli jste náhodou na něco?</h3>
        </div>

        <div class="relative group">
          <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                      transition-opacity duration-200 z-10"
               :class="tpStates['cartUpsell']?.left ? 'opacity-100' : 'opacity-0'"></div>
          <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                      transition-opacity duration-200 z-10"
               :class="tpStates['cartUpsell']?.right ? 'opacity-100' : 'opacity-0'"></div>

          <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
               :class="tpStates['cartUpsell']?.scrolled ? 'opacity-0' : 'opacity-100'">
            <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
            <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
              <i class="fa-solid fa-chevron-right fa-lg"></i>
            </div>
          </div>

          <div class="overflow-x-auto scrollbar-thin"
               x-init="registerTopStrip($el, 'cartUpsell')">
            <div class="flex gap-3 snap-x snap-mandatory px-0 pb-5">
              <template x-for="(p, idx) in topProductsShuffledFor('cartUpsell', 12)" :key="'cart-upsell-' + (p?.id ?? idx)">
                <article class="snap-start shrink-0 w-48 sm:w-56 card bg-white hover:shadow-md transition relative">
                  <span x-show="discountPct(p) !== null"
                        class="absolute left-2 top-2 badge badge-error text-white font-semibold">
                    <span x-text="`-${discountPct(p)}%`"></span>
                  </span>
                  <figure class="p-3 h-40">
                    <a :href="link('product',{id:p.id})" class="block h-full">
                      <img :src="p.image || './images/placeholder.webp'" :alt="p.name"
                           class="w-full h-full object-cover">
                    </a>
                  </figure>
                  <div class="card-body pt-0 flex flex-col gap-2">
                    <a :href="link('product',{id:p.id})"
                       class="text-sm font-medium line-clamp-2 leading-snug min-h-[2.45rem] max-h-[2.45rem] hover:underline"
                       x-text="p.name"></a>
                    <div class="mt-auto">
                      <div class="text-base font-semibold">
                        <span x-text="formatPrice(currentPrice(p))"></span>
                        <span class="ml-2 line-through text-xs opacity-60"
                              x-show="crossedPrice(p) !== null"
                              x-text="formatPrice(crossedPrice(p))"></span>
                      </div>
                    </div>
                    <div class="mt-3">
                      <template x-if="!$store.cart.inCart(p.id)">
                        <button class="btn btn-primary btn-md w-full font-semibold" @click="$store.cart.add(p)">
                          <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                        </button>
                      </template>
                      <template x-if="$store.cart.inCart(p.id)">
                        <div class="join w-full justify-center">
                          <button class="btn btn-square btn-md join-item"
                                  @click="$store.cart.decrement(p.id)"
                                  :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                          <input type="text" inputmode="numeric" pattern="[0-9]*"
                                 class="input input-bordered input-md w-12 text-center join-item tabular-nums"
                                 :value="$store.cart.qty(p.id)"
                                 @input="$store.cart.setQty(p.id, $event.target.value.replace(/[^0-9]/g,''))"
                                 @keydown.enter.prevent
                                 :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />
                          <button class="btn btn-square btn-md join-item"
                                  @click="$store.cart.increment(p.id)"
                                  :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                        </div>
                      </template>
                    </div>
                  </div>
                </article>
              </template>
            </div>
          </div>
        </div>
      </section>
    </div>
  </template>

  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/products'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0"
        @click="location.hash='/delivery-payment'">
        Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</section>

<script>
  // Helpers for the cart page only
  function cartPage() {
    return {
      koruny(v) {
        return window.__fitMoney.format(v, { fromCurrency: 'CZK' });
      },
      calcCouponValue(store) {
        const sub = store.subtotal();
        if (!store.coupon) return 0;
        return store.coupon.type === 'percent'
          ? Math.floor(sub * (store.coupon.value / 100))
          : store.coupon.value;
      },
      calcGiftCardValue(store) {
        if (!store.giftCard) return 0;
        return store.giftCard.value;
      }
    }
  }
</script>
<script>
  // Simple singleton for pharmacies search
  const PharmacyIndex = (() => {
    let _data = null; // cached array
    let _loading = null;
  
    const load = async () => {
      if (_data) return _data;
      if (_loading) return _loading;
      _loading = fetch('./data/map-points.json')
        .then(r => r.json())
        .then(arr => {
          _data = arr.map(p => ({
            ...p,
            // normalize + index
            id: p.id,
            name: p.name,
            type: p.type, // 'pharmacy' | 'box'
            address: p.address || {},
            coords: { lat: +p.coords.lat, lng: +p.coords.lng },
            searchIndex: [
              p.name,
              p.type,
              p.address?.street,
              p.address?.city,
              p.address?.district,
              p.address?.zip
            ].filter(Boolean).join(' ').toLowerCase()
          }));
          return _data;
        })
        .finally(() => { _loading = null; });
      return _loading;
    };
  
    const search = async (q) => {
      const list = await load();
      if (!q) return [];
      const s = q.toLowerCase().trim();
      return list
        .filter(p => p.searchIndex.includes(s))
        .slice(0, 10) // cap like other sections
        .map(p => ({
          kind: 'pharmacy', // tag for rendering
          id: p.id,
          title: p.name,
          subtitle: `${p.address.street || ''} • ${p.address.city || ''}`.trim(),
          icon: p.type === 'box' ? 'fa-box' : 'fa-location-dot',
          raw: p // keep the full record for click
        }));
    };
  
    return { load, search };
  })();
  </script>
</section>

<!-- ROUTE == DELIVERY AND PAYMENt -->
<section x-show="is('delivery-payment')" x-cloak>


    <section x-data="" class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
<!-- DELIVERY/PAYMENT: Cart Avatars (from localStorage 'cart.v1') -->
<div x-data="cartAvatars({ key: 'cart.v1', max: 4 })" x-init="init()" class="flex items-center gap-4 pb-4">
  <h1 class="text-3xl">Nákup</h1>

  <!-- Only render the group after items are ready -->
  <template x-if="items.length">
    <div class="avatar-group -space-x-6 overflow-visible" aria-label="Produkty v košíku">
      <template x-for="it in visible()" :key="it.id + '-' + it.img">
        <div class="avatar" :title="it.name">
          <div class="w-14 xl:w-18">
            <img
              :src="it.img"
              :alt="it.name || 'Produkt v košíku'"
              loading="lazy"
              @load="$event.target.style.opacity = 1"
              @error="$event.target.style.opacity = 0.3"
            />
          </div>
        </div>
      </template>

      <div class="avatar avatar-placeholder" x-show="overflow() > 0">
        <div class="bg-neutral text-neutral-content w-12">
          <span x-text="'+' + overflow()"></span>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('cartAvatars', (opts = {}) => ({
    items: [],
    key: opts.key ?? 'cart.v1',
    max: opts.max ?? 4,

    _bc: null,
    _onCartChange: null,
    _onStorage: null,

    init() {
      this.refresh();

      // 1) Same-tab: Alpine store reactivity
      if (this.$store?.cart) {
        this.$watch(() => this.$store.cart._version, () => this.refreshFromStore());
      }

      // 2) Same-tab: custom event from cart store
      this._onCartChange = () => this.refresh();
      window.addEventListener('cart:change', this._onCartChange);

      // 3) Cross-tab: storage fallback
      this._onStorage = (e) => { if (!e.key || e.key === this.key) this.refresh(); };
      window.addEventListener('storage', this._onStorage);

      // 4) Cross-tab: BroadcastChannel (if supported)
      try {
        this._bc = ('BroadcastChannel' in window) ? new BroadcastChannel('cart') : null;
        if (this._bc) this._bc.onmessage = (ev) => {
          if (ev?.data?.type === 'cart:change') this.refresh();
        };
      } catch(_) { this._bc = null; }
    },

    // Prefer live Alpine store (instant same-tab)
    refreshFromStore() {
      const storeItems = this.$store?.cart?.items;
      if (storeItems && typeof storeItems === 'object') {
        this.items = this.normalizeFromObject(storeItems);
        return true;
      }
      return false;
    },

    refresh() {
      if (this.refreshFromStore()) return; // same-tab path

      // Fallback to localStorage
      try {
        const raw = localStorage.getItem(this.key);
        if (!raw) { this.items = []; return; }
        const data = JSON.parse(raw);
        this.items = this.normalizeFromObject(data?.items || {});
      } catch { this.items = []; }
    },

    normalizeFromObject(obj) {
      const list = Object.values(obj || {}).map(e => e?.product).filter(Boolean);
      return list.map(p => ({
        id: p.id,
        name: p.name || 'Produkt v košíku',
        img: this.primaryImage(p),
      }))
      .filter(it => !!it.img)
      .filter((v, i, self) => self.findIndex(x => x.id === v.id && x.img === v.img) === i);
    },

    // Pick the first usable image across multiple shapes
    primaryImage(p) {
      const candidates = [];

      // Strings
      if (typeof p?.image === 'string') candidates.push(p.image);
      if (Array.isArray(p?.images) && p.images.length) {
        const first = p.images[0];
        if (typeof first === 'string') candidates.push(first);
        else if (first && typeof first === 'object') {
          if (typeof first.url === 'string') candidates.push(first.url);
          if (typeof first.src === 'string') candidates.push(first.src);
        }
      }

      // Other possible fields, just in case
      ['thumbnail','img','photo','picture'].forEach(k => {
        if (typeof p?.[k] === 'string') candidates.push(p[k]);
      });

      const chosen = candidates.find(v => typeof v === 'string' && v.trim().length > 0);
      return chosen ? new URL(chosen, window.location.href).href : '';
    },

    visible() { return this.items.slice(0, this.max); },
    overflow() { return Math.max(0, this.items.length - this.max); },
  }));
});
</script>

  


<!-- Delivery & Payment (Alpine component) -->
<div x-data="deliveryPaymentUI()" x-init="init()" class="grid grid-cols-1 lg:grid-cols-2 gap-12">

  <!-- DOPRAVA -->
  <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
    <h2 class="text-xl font-medium mb-4 ml-3">Doprava</h2>

    <template x-if="loading">
      <div class="p-3 text-sm text-base-content/70">Načítám možnosti…</div>
    </template>

    <template x-for="opt in delivery" :key="opt.id">
      <!-- Only select after confirm if followup exists, else select immediately -->
      <label :class="rowClasses('delivery', opt)"
             class="block mb-2 last:mb-0"
             @click="handleDeliveryClick(opt, $event)">
        <div class="flex items-center gap-3 min-w-0">
          <!-- Radio reflects state (we set it in JS) -->
          <input type="radio"
                 name="shipping"
                 class="radio radio-secondary shrink-0"
                 :checked="selectedDeliveryId === opt.id"
                 tabindex="-1" />
          <img :src="opt.icon" :alt="opt.name"
               class="size-7 rounded bg-base-200 object-contain shrink-0"
               @error="$event.target.style.opacity=0.3" />
          <div class="min-w-0">
              <div class="font-medium leading-tight">
              <!-- keep text truncation on the text only, not the container -->
              <div class="flex items-center gap-1 min-w-0">
                <template x-if="opt.tooltip">
                  <span
                    x-data="{ open:false }"
                    class="tooltip tooltip-left md:tooltip-top cursor-help inline-flex max-w-full truncate"
                    :class="{ 'tooltip-open': open }"
                    :data-tip="opt.tooltip"
                    tabindex="0"
                    @keydown.escape.window="open=false"
                    @blur="open=false"
                    @click="open = !open"
                  >
                    <span class="underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                          x-text="opt.name"></span>
                  </span>
                </template>
                <template x-if="!opt.tooltip">
                  <span class="truncate max-w-full" x-text="opt.name"></span>
                </template>
              </div>
            </div>
        <template x-if="opt.description">
          <p class="text-sm font-medium text-base-content/70 leading-snug line-clamp-2" x-text="opt.description"></p>
        </template>
        <template x-if="timeslotInfo(opt.id) && selectedDeliveryId === opt.id">
          <p class="mt-2 text-sm text-base-content/80 flex flex-wrap items-center gap-2">
            <span x-text="timeslotInfo(opt.id).label"></span>
            <button type="button"
                    class="link link-primary text-sm"
                    @click.stop="changeTimeslot(opt)">
              Změnit
            </button>
          </p>
        </template>
        <template x-if="pickupInfo(opt.id) && selectedDeliveryId === opt.id">
          <p class="mt-1 text-sm text-base-content/80 flex flex-wrap items-center gap-2">
            <span class="text-base-content/60" x-text="pickupInfo(opt.id).addressLine"></span>
            <button type="button"
                    class="link link-primary text-sm"
                    @click.stop="changePickup(opt)">
              Změnit
            </button>
          </p>
        </template>
      </div>
    </div>

        <!-- Price (free shipping overrides everything in this column) -->
        <div class="text-right shrink-0">
          <template x-if="freeShippingActive || opt.price === 0">
            <div class="font-semibold">Zdarma</div>
          </template>
          <template x-if="!freeShippingActive && opt.price > 0">
            <div>
              <div class="text-xs tracking-wide font-medium text-base-content/60"
                   x-show="opt.price_from && timeslotPrice(opt.id) === null">
                Od
              </div>
              <div class="font-semibold"
                   x-text="formatCZK(timeslotPrice(opt.id) !== null ? timeslotPrice(opt.id) : opt.price)"></div>
            </div>
          </template>
        </div>
      </label>
    </template>
  </fieldset>

  <!-- PLATBA -->
  <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
    <h2 class="text-xl font-medium mb-4 ml-3">Platba</h2>

    <template x-if="loading">
      <div class="p-3 text-sm text-base-content/70">Načítám možnosti…</div>
    </template>

    <template x-for="opt in payment" :key="opt.id">
      <label :class="rowClasses('payment', opt)"
             class="block mb-2 last:mb-0"
             :aria-disabled="isPaymentDisabled(opt.id)"
             @click="handlePaymentClick(opt, $event)">
        <div class="flex items-center gap-3 min-w-0 mb-1">
          <input type="radio"
                 name="payment"
                 class="radio radio-secondary shrink-0"
                 :checked="selectedPaymentId === opt.id"
                 :disabled="isPaymentDisabled(opt.id)"
                 tabindex="-1" />
          <img :src="opt.icon" :alt="opt.name"
               class="size-7 rounded bg-base-200 object-contain shrink-0"
               @error="$event.target.style.opacity=0.3" />
          <div class="min-w-0">
            <div class="font-medium leading-tight">
              <template x-if="opt.tooltip">
                <span
                  x-data="{ open:false }"
                  class="tooltip tooltip-left md:tooltip-top cursor-help inline-flex"
                  :class="{ 'tooltip-open': open }"
                  :data-tip="opt.tooltip"
                  tabindex="0"
                  @keydown.escape.window="open=false"
                  @blur="open=false"
                  @click="open=!open"
                >
                  <span class="underline decoration-dotted underline-offset-4 decoration-max-gray-400" x-text="opt.name"></span>
                </span>
              </template>
              <template x-if="!opt.tooltip">
                <span x-text="opt.name"></span>
              </template>
            </div>
            <template x-if="opt.description">
              <p class="text-sm font-medium text-base-content/70 leading-snug" x-text="opt.description"></p>
            </template>
            <template x-if="benefitInfo(opt.id) && selectedPaymentId === opt.id">
              <p class="mt-1 text-sm text-base-content/80 flex items-center gap-2">

                <i class="fa-solid fa-gift" x-show="!benefitInfo(opt.id)?.image"></i>
                <span x-text="benefitInfo(opt.id).name"></span>
                <button type="button"
                        class="link link-primary text-sm"
                        @click.stop="changeBenefit(opt)">
                  Změnit
                </button>
              </p>
            </template>
          </div>
        </div>

        <!-- Price area -->
        <div class="text-right shrink-0">
          <!-- When disabled by the selected delivery, show “Neumožňuje” with tooltip -->
          <template x-if="isPaymentDisabled(opt.id)">
            <div class="tooltip tooltip-left" :data-tip="disabledReason()">
              <div class="tracking-wide font-semibold">Nelze</div>
            </div>
          </template>

          <template x-if="!isPaymentDisabled(opt.id)">
            <template x-if="opt.price === 0">
              <div class="font-semibold">Zdarma</div>
            </template>
            <template x-if="opt.price > 0">
              <div>
                <div class="text-xs tracking-wide font-medium text-base-content/60"
                     x-show="opt.price_from && timeslotPrice(opt.id) === null">
                  Od
                </div>
                <div class="font-semibold"
                     x-text="formatCZK(timeslotPrice(opt.id) !== null ? timeslotPrice(opt.id) : opt.price)"></div>
              </div>
            </template>
          </template>
        </div>
      </label>
    </template>
  </fieldset>



  <!-- Follow-up modal -->
  <dialog x-ref="modal" class="modal" @cancel.prevent="cancelFollowup()">
    <div class="modal-box w-11/12 max-w-4xl">
      <button type="button" class="btn btn-xl btn-circle btn-ghost absolute right-3 top-3" @click="cancelFollowup()">✕</button>

      <template x-if="currentFollowup?.type === 'timeslot'">
        <div class="space-y-6">
          <template x-if="timeslotModal.step === 'zip'">
            <form class="grid gap-4 py-6" @submit.prevent="submitZip()">
              <label class="text-sm font-medium text-base-content/70 text-center">Zadejte PSČ doručení</label>
              <input type="text"
                     class="input input-bordered input-lg text-center text-xl mx-auto tracking-[0.3em]"
                     maxlength="5"
                     autocomplete="postal-code"
                     inputmode="numeric"
                     pattern="[0-9]{5}"
                     placeholder="00000"
                     x-model="timeslotModal.zip"
                     @input="timeslotModal.message = ''"
              >
              <p class="text-sm text-error text-center min-h-[1.25rem]" x-text="timeslotModal.message"></p>
              <div class="flex justify-center gap-2">
                <button type="submit" class="btn btn-primary">Pokračovat</button>
              </div>
            </form>
          </template>

      <template x-if="currentFollowup?.type === 'map'">
        <div class="space-y-4">
          <h3 class="text-lg font-semibold">Vyberte výdejní místo</h3>
          <p class="text-sm text-base-content/70">Otevřeli jsme mapu s výdejními místy. Vyberte prosím preferovaný bod a potvrďte jej.</p>
          <div class="modal-action">
            <button class="btn btn-ghost" type="button" @click="cancelFollowup()">Zavřít</button>
          </div>
        </div>
      </template>

          <template x-if="timeslotModal.step === 'loading'">
            <div class="py-16 flex flex-col items-center gap-3">
              <span class="loading loading-spinner loading-lg text-secondary"></span>
              <p class="text-sm text-base-content/60">Ověřujeme dostupnost…</p>
            </div>
          </template>

          <template x-if="timeslotModal.step === 'slots'">
            <div class="flex flex-col max-h-128">
              <div class="flex-1 overflow-y-auto space-y-6 pr-1 lg:hidden">
                <template x-for="day in timeslotModal.days" :key="day.key">
                  <div>
                    <div class="flex items-center gap-2 mb-3">
                      <h4 class="text-base font-semibold" x-text="day.display"></h4>
                      <span class="badge badge-success badge-sm" x-show="day.isTomorrow">Zítra</span>
                    </div>
                    <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                      <template x-for="slot in day.slots" :key="slot.key">
                        <label :class="slotClass(slot.key, slot.disabled)" class="flex items-center gap-3">
                          <input type="radio"
                                 class="radio radio-secondary"
                                 name="timeslot"
                                 :value="slot.key"
                                 :disabled="slot.disabled"
                                 :checked="timeslotModal.selectedSlotKey === slot.key"
                                 @change="selectTimeslot(slot.key)"
                          >
                          <span class="font-medium" x-text="slot.label"></span>
                          <span class="text-sm text-base-content/70" x-show="!slot.disabled" x-text="formatCZK(slot.price)"></span>
                          <span x-show="slot.disabled" class="text-sm text-base-content/40">
                            <span class="tooltip tooltip-left" data-tip="Není k dispozici">
                              <i class="fa-regular fa-circle-info"></i>
                            </span>
                          </span>
                        </label>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
              <div class="hidden lg:flex lg:flex-col lg:h-full">
                <div class="flex overflow-x-auto">
                  <template x-for="day in timeslotModal.days" :key="`tab-${day.key}`">
                    <button type="button"
                            class="relative whitespace-nowrap pr-7 pb-3 pt-2 text-lg font-semibold transition-colors"
                            :class="timeslotModal.activeDayKey === day.key ? 'text-secondary' : 'text-base-content hover:text-base-content/90'"
                            @click="setTimeslotDay(day.key)">
                      <span x-text="day.label"></span>
                      <span class="text-success text-sm font-medium ml-2" x-show="day.isTomorrow">Zítra</span>
                      <span class="absolute left-0 right-6 -bottom-[1px] h-1 rounded-full bg-secondary"
                            x-show="timeslotModal.activeDayKey === day.key"></span>
                    </button>
                  </template>
                </div>
                <div class="mt-4 space-y-4 overflow-y-auto pr-1"
                     x-data="{
                       get activeDay() { return activeTimeslotDay(); },
                       get slots() { return this.activeDay ? this.activeDay.slots : []; }
                     }"
                     x-show="activeDay">
                  <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-3">
                    <template x-for="slot in slots" :key="`desk-${slot.key}`">
                      <label :class="slotClass(slot.key, slot.disabled)" class="flex items-center gap-3">
                        <input type="radio"
                               class="radio radio-secondary"
                               name="timeslot"
                               :value="slot.key"
                               :disabled="slot.disabled"
                               :checked="timeslotModal.selectedSlotKey === slot.key"
                               @change="selectTimeslot(slot.key)"
                        >
                        <span class="font-medium" x-text="slot.label"></span>
                        <span class="text-sm text-base-content/70" x-show="!slot.disabled" x-text="formatCZK(slot.price)"></span>
                        <span x-show="slot.disabled" class="text-sm text-base-content/40">
                          <span class="tooltip tooltip-left" data-tip="Není k dispozici">
                            <i class="fa-regular fa-circle-info"></i>
                          </span>
                        </span>
                      </label>
                    </template>
                  </div>
                </div>
              </div>

              <div class="mt-4 pt-3 flex flex-wrap items-center justify-between gap-3 bg-base-100">
                <button class="btn btn-outline btn-md"
                        type="button"
                        @click="timeslotModal.step = 'zip'; timeslotModal.message = ''; timeslotModal.days = []; timeslotModal.lookup = {}; timeslotModal.selectedSlotKey = ''; timeslotModal.activeDayKey = '';">
                  Změnit PSČ
                </button>
                <div class="flex gap-2">
                  <button class="btn btn-primary" type="button" @click="confirmTimeslot()" :disabled="!timeslotModal.selectedSlotKey">Potvrdit termín</button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>

     <template x-if="currentFollowup?.type === 'benefits'">
       <div class="space-y-6">
         <h3 class="text-lg font-semibold">Vyberte benefitní program</h3>
         <template x-if="benefitPrograms.length">
           <div class="grid gap-3 sm:grid-cols-2">
              <template x-for="program in benefitPrograms" :key="program.id">
                <label class="flex items-center gap-3 rounded-xl border border-base-300 p-3 hover:border-secondary cursor-pointer transition"
                       :class="benefitModal.selectedId === program.id ? 'border-2 border-secondary bg-secondary/10' : ''">
                  <input type="radio"
                         class="radio radio-secondary"
                         name="benefitProgram"
                         :value="program.id"
                         :checked="benefitModal.selectedId === program.id"
                         @change="benefitModal.selectedId = program.id">
                  <template x-if="program.image">
                    <img :src="program.image"
                         alt=""
                         class="w-10 h-10 object-contain rounded bg-base-200"
                         @error="$event.target.style.opacity=0.3">
                  </template>
                  <div class="min-w-0 flex-1">
                    <span class="font-medium" x-text="program.name"></span>
                  </div>
                </label>
              </template>
            </div>
         </template>
         <template x-if="!benefitPrograms.length">
           <p class="text-sm text-base-content/60">Žádné benefitní programy nejsou aktuálně dostupné.</p>
         </template>
         <div class="modal-action">
           <button class="btn btn-primary" type="button" @click="confirmBenefit()" :disabled="!benefitModal.selectedId">Potvrdit</button>
         </div>
       </div>
     </template>

      <template x-if="currentFollowup?.type === 'map'">
        <div class="space-y-4">
          <h3 class="text-lg font-semibold">Vyberte výdejní místo</h3>
          <p class="text-sm text-base-content/70">Otevřeli jsme mapu s výdejními místy. Vyberte prosím preferovaný bod a potvrďte jej.</p>
          <div class="modal-action">
            <button class="btn btn-ghost" type="button" @click="cancelFollowup()">Zavřít</button>
          </div>
        </div>
      </template>

      <template x-if="currentFollowup?.type && !['timeslot','benefits'].includes(currentFollowup.type)">
        <div>
          <div class="py-3 text-base-content/70">
            <p>Akce není dostupná.</p>
          </div>
          <div class="modal-action">
            <button class="btn btn-ghost" @click="cancelFollowup()">Zavřít</button>
          </div>
        </div>
      </template>
    </div>
    <form method="dialog" class="modal-backdrop" @click="cancelFollowup()">
      <button type="button">close</button>
    </form>
  </dialog>

</div>

<p class="mt-18 text-sm space-y-3 sm:space-y-0 sm:flex sm:flex-wrap sm:items-center sm:gap-x-6 sm:gap-y-2">
  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Všeobecné obchodní podmínky
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Rezervační podmínky
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Ochrana osobních údajů v e-shopu
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Co je rezervace, co objednávka a jak to funguje?
  </a>
</p>


<script>
function deliveryPaymentUI() {
  return {
    loading: true,
    items: [],
    delivery: [],
    payment: [],

    // current selections
    selectedDeliveryId: null,
    selectedPaymentId: null,

    // follow-up handling
    currentFollowup: null,   // { type: 'map'|'timeslot'|'benefits', option, kind }
    pending: null,           // { kind: 'delivery'|'payment', id, opt }
    freeShippingActive: false,
    timeslotModal: {
      step: 'zip',
      zip: '',
      days: [],
      lookup: {},
      selectedSlotKey: '',
      activeDayKey: '',
      message: ''
    },
    timeslotModalTimer: null,
    timeslotSelections: {},
    pickupSelections: {},
    benefitPrograms: [],
    benefitSelections: {},
    benefitModal: { selectedId: '' },

    async init() {
      try {
        const res = await fetch('./data/delivery-payment.json', { cache: 'no-store' });
        this.items = await res.json();

        // split groups
        this.delivery = this.items.filter(i => i.type === 'delivery' || i.type === 'pickup');
        this.payment  = this.items.filter(i => i.type === 'payment');

        // restore selections
        const sd = Number(localStorage.getItem('selectedDeliveryId')) || null;
        const sp = Number(localStorage.getItem('selectedPaymentId')) || null;
        if (sd && this.delivery.some(d => d.id === sd)) {
          this.selectedDeliveryId = sd;
        }
        if (sp && this.payment.some(p => p.id === sp)) {
          this.selectedPaymentId = sp;
        }

        // validate existing combination after restore
        if (this.selectedPaymentId && this.isPaymentDisabled(this.selectedPaymentId)) {
          this.clearPaymentSelection();
        }

        this.loadTimeslotSelections();
        this.loadPickupSelections();
        if (this.selectedDeliveryId) {
          this.persistDeliveryMeta(this.selectedDeliveryId);
        }
        this.loadBenefitSelections();
        if (this.selectedPaymentId) {
          this.persistPaymentMeta(this.selectedPaymentId);
        }
        await this.loadBenefitPrograms();
        this._onPickupSelected = (e) => {
          const detail = e.detail || {};
          const deliveryId = Number(detail.deliveryId || detail.id || 0);
          if (!deliveryId) return;
          const point = detail.point || {};
          const record = {
            id: point.id,
            mapType: detail.mapType || point.type || '',
            name: point.name || '',
            address: point.address || {},
            addressLine: this.formatPickupAddress(point.address),
            phone: point.phone || '',
            note: point.note || '',
            coords: point.coords || null
          };
          this.pickupSelections = {
            ...this.pickupSelections,
            [deliveryId]: record
          };
          this.persistPickupSelections();
          this.applyDeliverySelection(deliveryId);
        };
        window.addEventListener('pickup:selected', this._onPickupSelected);
        window.addEventListener('beforeunload', () => {
          if (this._onPickupSelected) {
            window.removeEventListener('pickup:selected', this._onPickupSelected);
          }
        }, { once: true });
      } catch (e) {
        console.error('Failed to load delivery-payment.json', e);
      } finally {
        this.loading = false;
      }

      this.freeShippingActive = this.computeFreeShipping();
      this.$watch(() => Alpine.store('cart')?.totalToPay?.(), () => {
        this.freeShippingActive = this.computeFreeShipping();
      });
      this.$watch(() => Alpine.store('cart')?.freeShipThreshold, () => {
        this.freeShippingActive = this.computeFreeShipping();
      });
    },

    // ---------- helpers ----------
    computeFreeShipping() {
      const cart = Alpine.store('cart');
      if (!cart) return false;
      if (typeof cart.hasFreeShipping === 'function') return !!cart.hasFreeShipping();
      const t = Number(cart.freeShipThreshold || 0);
      if (t <= 0) return true;
      return cart.totalToPay() >= t;
    },
    getSelectedDelivery() {
      return this.delivery.find(d => d.id === this.selectedDeliveryId) || null;
    },
    isPaymentDisabled(paymentId) {
      if (!paymentId) return false;
      const d = this.getSelectedDelivery();
      if (!d) return false;
      return Array.isArray(d.disables_id) && d.disables_id.includes(paymentId);
    },
    disabledReason() {
      const d = this.getSelectedDelivery();
      return d ? `„${d.name}“ tuto platbu neumožňuje.` : 'Tato platba není dostupná pro vybranou dopravu.';
    },
    formatCZK(value) {
      return window.__fitMoney.format(value, { fromCurrency: 'CZK' });
    },
    formatPickupAddress(addr) {
      if (!addr) return '';
      const parts = [addr.street, addr.city, addr.zip].filter(Boolean);
      return parts.join(', ');
    },

    timeslotInfo(id) {
      if (!id) return null;
      return this.timeslotSelections?.[id] || null;
    },

    timeslotPrice(id) {
      const info = this.timeslotInfo(id);
      if (!info || typeof info.price !== 'number') return null;
      return info.price;
    },

    ensureActiveTimeslotDay() {
      const days = Array.isArray(this.timeslotModal?.days) ? this.timeslotModal.days : [];
      if (!days.length) {
        this.timeslotModal.activeDayKey = '';
        return;
      }
      const selectedKey = this.timeslotModal.selectedSlotKey;
      if (selectedKey && this.timeslotModal.lookup?.[selectedKey]) {
        const info = this.timeslotModal.lookup[selectedKey];
        const dayKey = info?.day?.key || info?.day?.iso || '';
        if (dayKey && days.some(d => d.key === dayKey)) {
          this.timeslotModal.activeDayKey = dayKey;
          return;
        }
      }
      if (!this.timeslotModal.activeDayKey || !days.some(d => d.key === this.timeslotModal.activeDayKey)) {
        this.timeslotModal.activeDayKey = days[0].key;
      }
    },

    setTimeslotDay(key) {
      if (!key || this.timeslotModal.activeDayKey === key) return;
      const exists = (this.timeslotModal.days || []).some(d => d.key === key);
      if (!exists) return;
      this.timeslotModal.activeDayKey = key;
    },

    activeTimeslotDay() {
      const days = this.timeslotModal.days || [];
      if (!days.length) return null;
      const key = this.timeslotModal.activeDayKey;
      if (key) {
        const found = days.find(d => d.key === key);
        if (found) return found;
      }
      return days[0] || null;
    },

    persistDeliveryMeta(id) {
      const opt = this.delivery.find(d => d.id === id);
      if (!opt) return;
      const basePrice = Number(opt.price);
      const computedFinal = this.timeslotPrice(id);
      const meta = {
        id: opt.id,
        name: opt.name,
        type: opt.type || '',
        mapType: opt.map_type || null,
        tooltip: opt.tooltip || null,
        description: opt.description || null,
        price: Number.isFinite(basePrice) ? basePrice : 0,
        priceFrom: !!opt.price_from,
        followup: opt.followup || null,
        icon: opt.icon || null,
        finalPrice: Number.isFinite(computedFinal) ? computedFinal : (Number.isFinite(basePrice) ? basePrice : 0),
        timeslot: this.timeslotInfo(id),
        pickup: this.pickupInfo(id)
      };
      try { localStorage.setItem('checkout.delivery', JSON.stringify(meta)); }
      catch (e) { console.warn('Failed to persist delivery meta', e); }
    },

    persistPaymentMeta(id) {
      const opt = this.payment.find(p => p.id === id);
      if (!opt) return;
      const benefit = this.benefitInfo(id);
      const basePrice = Number(opt.price);
      const meta = {
        id: opt.id,
        name: opt.name,
        tooltip: opt.tooltip || null,
        description: opt.description || null,
        price: Number.isFinite(basePrice) ? basePrice : 0,
        finalPrice: Number.isFinite(basePrice) ? basePrice : 0,
        priceFrom: !!opt.price_from,
        followup: opt.followup || null,
        icon: opt.icon || null,
        benefit: benefit ? { id: benefit.id, name: benefit.name, image: benefit.image || null } : null
      };
      try { localStorage.setItem('checkout.payment', JSON.stringify(meta)); }
      catch (e) { console.warn('Failed to persist payment meta', e); }
    },

    pickupInfo(id) {
      if (!id) return null;
      return this.pickupSelections?.[id] || null;
    },

    benefitInfo(id) {
      if (!id) return null;
      return this.benefitSelections?.[id] || null;
    },

    openTimeslotModal(opt, isChange = false) {
      if (!opt) return;
      this.pending = { kind: 'delivery', id: opt.id, opt };
      this.currentFollowup = { type: 'timeslot', option: opt, kind: 'delivery', isChange };
      this.prepareTimeslotModal(opt.id);
      this.$refs.modal?.showModal();
    },

    async openBenefitModal(opt, isChange = false) {
      if (!opt) return;
      if (!this.benefitPrograms.length) {
        await this.loadBenefitPrograms();
      }
      const existing = this.benefitInfo(opt.id);
      this.pending = { kind: 'payment', id: opt.id, opt };
      this.currentFollowup = { type: 'benefits', option: opt, kind: 'payment', isChange };
      this.benefitModal.selectedId = existing?.id || '';
      this.$refs.modal?.showModal();
    },

    prepareTimeslotModal(id) {
      const existing = this.timeslotInfo(id);
      this.resetTimeslotModal();
      if (existing) {
        this.timeslotModal.zip = existing.zip || '';
        this.timeslotModal.selectedSlotKey = existing.slotKey || '';
        this.timeslotModal.step = this.timeslotModal.zip ? 'slots' : 'zip';
      }
      if (this.timeslotModal.step === 'slots') {
        const { days, lookup } = this.generateTimeslotDays(this.timeslotModal.selectedSlotKey);
        this.timeslotModal.days = days;
        this.timeslotModal.lookup = lookup;
        this.ensureActiveTimeslotDay();
      }
    },

    submitZip() {
      const value = (this.timeslotModal.zip || '').trim();
      if (!value) {
        this.timeslotModal.message = 'Zadejte platné PSČ.';
        return;
      }
      this.timeslotModal.zip = value;
      this.timeslotModal.message = '';
      this.timeslotModal.step = 'loading';
      if (this.timeslotModalTimer) clearTimeout(this.timeslotModalTimer);
      this.timeslotModalTimer = setTimeout(() => {
        const { days, lookup } = this.generateTimeslotDays(this.timeslotModal.selectedSlotKey);
        this.timeslotModal.days = days;
        this.timeslotModal.lookup = lookup;
        if (!lookup[this.timeslotModal.selectedSlotKey]) {
          this.timeslotModal.selectedSlotKey = '';
        }
        this.ensureActiveTimeslotDay();
        this.timeslotModal.step = 'slots';
        this.timeslotModalTimer = null;
      }, 1000);
    },

    selectTimeslot(key) {
      if (!key || !this.timeslotModal.lookup[key]) return;
      const info = this.timeslotModal.lookup[key];
      if (info.slot.disabled) return;
      const dayKey = info?.day?.key || info?.day?.iso || '';
      if (dayKey) this.timeslotModal.activeDayKey = dayKey;
      this.timeslotModal.selectedSlotKey = key;
      this.ensureActiveTimeslotDay();
    },

    slotClass(key, disabled) {
      if (disabled) {
        return 'border border-base-300 rounded-lg p-3 opacity-60 cursor-not-allowed bg-base-200/70 transition-colors';
      }
      if (this.timeslotModal.selectedSlotKey === key) {
        return 'border-2 border-secondary rounded-lg p-3 bg-secondary/10 cursor-pointer transition-colors';
      }
      return 'border border-base-300 rounded-lg p-3 hover:border-secondary/60 cursor-pointer transition-colors';
    },

    confirmTimeslot() {
      if (!this.pending || this.pending.kind !== 'delivery') return;
      const key = this.timeslotModal.selectedSlotKey;
      const info = key ? this.timeslotModal.lookup[key] : null;
      if (!info || info.slot.disabled) return;

      const selection = {
        id: this.pending.id,
        zip: this.timeslotModal.zip,
        slotKey: key,
        dayIso: info.day.iso,
        dayLabel: info.day.decorated,
        slotLabel: info.slot.label,
        price: info.slot.price,
        startISO: info.slot.startISO,
        endISO: info.slot.endISO,
        label: `${info.day.decorated} · ${info.slot.label}`
      };

      this.timeslotSelections = {
        ...this.timeslotSelections,
        [selection.id]: selection
      };
      this.persistTimeslotSelections();

      const deliveryId = this.pending.id;
      this.pending = null;
      this.currentFollowup = null;
      this.applyDeliverySelection(deliveryId);
      this.resetTimeslotModal();
      this.$refs.modal?.close();
    },

    confirmBenefit() {
      if (!this.pending || this.pending.kind !== 'payment') return;
      const id = this.benefitModal.selectedId;
      const program = this.benefitPrograms.find(p => p.id === id);
      if (!program) return;
      this.benefitSelections = {
        ...this.benefitSelections,
        [this.pending.id]: { ...program }
      };
      this.persistBenefitSelections();
      const paymentId = this.pending.id;
      this.pending = null;
      this.currentFollowup = null;
      this.resetBenefitModal();
      this.applyPaymentSelection(paymentId);
      this.$refs.modal?.close();
    },

    generateTimeslotDays(selectedKey = '') {
      const days = [];
      const lookup = {};
      const now = new Date();

      for (let i = 1; i <= 4; i++) {
        const date = new Date(now);
        date.setDate(date.getDate() + i);
        const isoDate = date.toISOString().split('T')[0];
        const display = this.formatTimeslotDayFull(date);
        const shortLabel = this.formatTimeslotDayShort(date);
        const decorated = i === 1 ? 'Zítra' : display;
        const isTomorrow = i === 1;

        const dayMeta = {
          key: isoDate,
          iso: isoDate,
          display,
          label: shortLabel,
          decorated,
          isTomorrow
        };

        const slots = [];
        for (let j = 0; j < 6; j++) {
          const startHour = 8 + j * 2;
          const endHour = startHour + 2;
          const key = `${isoDate}|${startHour}`;
          const price = startHour >= 16 ? 99 : 79;
          const disabled = this.isSlotDisabled(i, j);

          const slot = {
            key,
            label: `${this.pad(startHour)}:00–${this.pad(endHour)}:00`,
            price,
            disabled,
            startISO: this.buildSlotISO(date, startHour),
            endISO: this.buildSlotISO(date, endHour)
          };
          slots.push(slot);
          lookup[key] = { day: dayMeta, slot };
        }

        days.push({ ...dayMeta, slots });
      }

      return { days, lookup };
    },

    isSlotDisabled(dayIndex, slotIndex) {
      return (dayIndex === 2 && slotIndex === 4) || (dayIndex === 3 && slotIndex === 1) || (dayIndex === 4 && slotIndex === 5);
    },

    buildSlotISO(date, hour) {
      const d = new Date(date);
      d.setHours(hour, 0, 0, 0);
      return d.toISOString();
    },

    formatTimeslotDayShort(date) {
      const str = date.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' });
      return str.charAt(0).toUpperCase() + str.slice(1);
    },

    formatTimeslotDayFull(date) {
      const str = date.toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'numeric' });
      return str.charAt(0).toUpperCase() + str.slice(1);
    },

    pad(num) {
      return String(num).padStart(2, '0');
    },

    changeTimeslot(opt) {
      this.openTimeslotModal(opt, true);
    },

    changePickup(opt) {
      this.preparePickupContext(opt, true);
    },

    changeBenefit(opt) {
      this.openBenefitModal(opt, true);
    },

    mapTypeForOption(opt) {
      const explicit = String(opt?.map_type || '').toLowerCase();
      if (explicit) return explicit;
      const name = String(opt?.name || '').toLowerCase();
      if (name.includes('zásilkov')) return 'z-box';
      if (name.includes('box')) return 'box';
      if (name.includes('lékár')) return 'pharmacy';
      return 'all';
    },

    preparePickupContext(opt, isChange = false) {
      if (!opt) return;
      const type = this.mapTypeForOption(opt);
      const existing = this.pickupInfo(opt.id) || {};
      const ctx = {
        deliveryId: opt.id,
        mapType: type,
        selectedId: existing.id || null,
        mode: isChange ? 'change' : 'new'
      };
      try { localStorage.setItem('pickupSelectionContext', JSON.stringify(ctx)); } catch (e) { console.warn('Failed to persist pickup context', e); }
      const query = type && type !== 'all' ? `?type=${encodeURIComponent(type)}` : '';
      location.hash = `#/map${query}`;
    },

    openPickupMap(opt) {
      this.preparePickupContext(opt, false);
    },

    persistTimeslotSelections() {
      try {
        localStorage.setItem('deliveryTimeslots', JSON.stringify(this.timeslotSelections));
      } catch (e) {
        console.warn('Failed to persist timeslot selections', e);
      }
    },

    loadTimeslotSelections() {
      try {
        const raw = localStorage.getItem('deliveryTimeslots');
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          this.timeslotSelections = parsed;
        }
      } catch (e) {
        console.warn('Failed to load timeslot selections', e);
      }
    },

    persistPickupSelections() {
      try {
        localStorage.setItem('deliveryPickupSelections', JSON.stringify(this.pickupSelections));
      } catch (e) {
        console.warn('Failed to persist pickup selections', e);
      }
    },

    loadPickupSelections() {
      try {
        const raw = localStorage.getItem('deliveryPickupSelections');
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          const normalized = {};
          for (const [key, value] of Object.entries(parsed)) {
            if (value && typeof value === 'object') {
              normalized[key] = {
                ...value,
                addressLine: value.addressLine || this.formatPickupAddress(value.address)
              };
            }
          }
          this.pickupSelections = normalized;
        }
      } catch (e) {
        console.warn('Failed to load pickup selections', e);
      }
    },

    persistBenefitSelections() {
      try {
        localStorage.setItem('deliveryBenefitSelections', JSON.stringify(this.benefitSelections));
      } catch (e) {
        console.warn('Failed to persist benefit selections', e);
      }
    },

    loadBenefitSelections() {
      try {
        const raw = localStorage.getItem('deliveryBenefitSelections');
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          this.benefitSelections = parsed;
        }
      } catch (e) {
        console.warn('Failed to load benefit selections', e);
      }
    },

    async loadBenefitPrograms() {
      try {
        const res = await fetch('./data/benefits.json', { cache: 'no-store' });
        const arr = await res.json();
        this.benefitPrograms = Array.isArray(arr)
          ? arr.filter(p => p?.eshop_payment).map(p => {
              const img = p.image ? String(p.image) : '';
              const normalizedImage = img
                ? (img.startsWith('./') || img.startsWith('http') ? img : `./images/benefits/${img}`)
                : '';
              return {
                id: p.name,
                name: p.name,
                image: normalizedImage
              };
            })
          : [];
      } catch (e) {
        console.warn('Failed to load benefits.json', e);
        this.benefitPrograms = [];
      }
    },

    resetTimeslotModal() {
      if (this.timeslotModalTimer) {
        clearTimeout(this.timeslotModalTimer);
        this.timeslotModalTimer = null;
      }
      this.timeslotModal = {
        step: 'zip',
        zip: '',
        days: [],
        lookup: {},
        selectedSlotKey: '',
        activeDayKey: '',
        message: ''
      };
    },

    resetBenefitModal() {
      this.benefitModal.selectedId = '';
    },

    rowClasses(kind, opt) {
      const selected = (kind === 'delivery' ? this.selectedDeliveryId : this.selectedPaymentId) === opt.id;
      const disabled = (kind === 'payment') && this.isPaymentDisabled(opt.id);
      const classes = [
        'flex items-center justify-between gap-4 p-3 rounded-lg transition select-none',
      ];
      if (disabled) {
        classes.push('cursor-not-allowed bg-base-200/80 text-base-content/60');
      } else {
        classes.push('cursor-pointer hover:bg-base-100');
      }
      if (selected) {
        classes.push('border-2 border-secondary bg-max-blue-25');
      }
      return classes.join(' ');
    },

    // ---------- click handlers (Ask #5 behavior) ----------
    handleDeliveryClick(opt, event) {
      if (opt.followup === 'timeslot') {
        event?.preventDefault();
        event?.stopPropagation();
        this.openTimeslotModal(opt);
        return;
      }
      if (opt.followup === 'map') {
        event?.preventDefault();
        event?.stopPropagation();
        this.openPickupMap(opt);
        return;
      }
      // If followup is required, show modal first and set pending, not the selection
      if (opt.followup) {
        event?.preventDefault();
        event?.stopPropagation();
        this.pending = { kind: 'delivery', id: opt.id, opt };
        this.currentFollowup = { type: opt.followup, option: opt, kind: 'delivery' };
        this.$refs.modal?.showModal();
        return;
      }
      // Immediate select when no follow-up
      this.applyDeliverySelection(opt.id);
    },

    handlePaymentClick(opt, event) {
      if (this.isPaymentDisabled(opt.id)) {
        event?.preventDefault();
        event?.stopPropagation();
        // do nothing, and the tooltip on price explains why
        return;
      }
      if (opt.followup === 'benefits') {
        event?.preventDefault();
        event?.stopPropagation();
        this.openBenefitModal(opt);
        return;
      }
      if (opt.followup) {
        event?.preventDefault();
        event?.stopPropagation();
        this.pending = { kind: 'payment', id: opt.id, opt };
        this.currentFollowup = { type: opt.followup, option: opt, kind: 'payment' };
        this.$refs.modal?.showModal();
        return;
      }
      this.applyPaymentSelection(opt.id);
    },

    confirmFollowup() {
      if (!this.pending) return this.$refs.modal?.close();
      if (this.pending.kind === 'delivery') this.applyDeliverySelection(this.pending.id);
      if (this.pending.kind === 'payment') this.applyPaymentSelection(this.pending.id);
      this.pending = null;
      this.currentFollowup = null;
      this.$refs.modal?.close();
    },
    cancelFollowup() {
      if (this.pending?.kind === 'delivery') {
        this.clearDeliverySelection(this.pending.id);
      }
      if (this.pending?.kind === 'payment') {
        this.clearPaymentSelection(this.pending.id);
      }
      this.pending = null;
      this.currentFollowup = null;
      this.resetTimeslotModal();
      this.resetBenefitModal();
      if (this.$refs.modal?.open) {
        this.$refs.modal.close();
      }
    },

    // ---------- selection application ----------
    applyDeliverySelection(id) {
      const prev = this.selectedDeliveryId;
      this.selectedDeliveryId = id;
      localStorage.setItem('selectedDeliveryId', String(id));
      this.persistDeliveryMeta(id);

      // Ask #1: if existing payment is now invalid, clear it
      if (this.selectedPaymentId && this.isPaymentDisabled(this.selectedPaymentId)) {
        this.clearPaymentSelection();
      }

      // If the delivery actually changed and has its own followup, we already handled via confirm
      // (nothing else needed here).
    },
    applyPaymentSelection(id) {
      this.selectedPaymentId = id;
      localStorage.setItem('selectedPaymentId', String(id));
      this.persistPaymentMeta(id);
    },
    clearPaymentSelection(id = null) {
      const target = id ?? this.selectedPaymentId;
      if (!target) return;
      if (this.selectedPaymentId === target) {
        this.selectedPaymentId = null;
        localStorage.removeItem('selectedPaymentId');
        try { localStorage.removeItem('checkout.payment'); } catch (_) {}
      }
      if (this.benefitSelections?.[target]) {
        delete this.benefitSelections[target];
        this.persistBenefitSelections();
      }
    },

    clearDeliverySelection(id = null) {
      const target = id ?? this.selectedDeliveryId;
      if (!target) return;
      if (this.selectedDeliveryId === target) {
        this.selectedDeliveryId = null;
        localStorage.removeItem('selectedDeliveryId');
        try { localStorage.removeItem('checkout.delivery'); } catch (_) {}
      }
      if (this.timeslotSelections?.[target]) {
        delete this.timeslotSelections[target];
        this.persistTimeslotSelections();
      }
      if (this.pickupSelections?.[target]) {
        delete this.pickupSelections[target];
        this.persistPickupSelections();
      }
    },

    // ---------- follow-up labels ----------
    followupTitle() {
      switch (this.currentFollowup?.type) {
        case 'map': return 'Výběr výdejního místa';
        case 'benefits': return 'Výběr benefitní platby';
        default: return 'Akce';
      }
    },
  };
}
</script>


      <!-- Sticky bottom bar -->
      <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
        <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
          <button class="btn btn-outline btn-lg" @click="location.hash='/cart'">
            Zpět</button>

          <button class="btn btn-primary btn-lg"
            :disabled="$store.cart.distinctCount() === 0"
            @click="location.hash='/addresses'">
            Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
          </button>
        </div>
      </div>
</section>

</section>

<!-- ROUTE == ADDRESSES -->
<section x-show="is('addresses')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32" x-init="ensureAddressForm()">
    <h1 class="text-3xl mx-auto mb-6">Adresy</h1>

    <template x-if="addressFormLoading">
      <div class="border border-base-300 rounded-xl bg-white shadow-sm p-6 text-base-content/70">
        Načítám formulář…
      </div>
    </template>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12" x-show="addressFormLoaded">
      <template x-for="section in contactFormSections" :key="section.name">
        <fieldset x-show="shouldShowSection(section.name)"
                  class="border border-base-300 rounded-xl bg-white shadow-sm p-6 md:px-16 md:py-10 grid grid-cols-1 gap-y-4 place-content-start">
          <h2 class="text-xl font-medium leading-tight mt-0 mb-4" x-text="section.name"></h2>

          <template x-for="field in section.fields" :key="field.key">
            <div x-show="isFieldVisible(field)" class="space-y-2">
              <template x-if="field.isToggle">
                <div class="py-1">
                  <label class="flex items-center gap-3 text-base text-base-content/80">
                    <input type="checkbox"
                           class="checkbox checkbox-secondary"
                           x-model="contactFormValues[field.key]"
                           @change="handleGroupToggle(field.key)">
                    <span class="leading-tight" x-text="field.label"></span>
                  </label>
                  <p class="text-sm text-base-content/70" x-show="field.note" x-text="field.note"></p>
                </div>
              </template>

              <template x-if="!field.isToggle">
                <fieldset class="fieldset">
                  <legend class="fieldset-legend text-sm text-max-gray-600" x-text="field.label"></legend>

                  <template x-if="field.type === 'textarea'">
                    <textarea class="textarea textarea-bordered h-28 w-full text-lg"
                              x-bind:placeholder="field.placeholder ?? undefined"
                              x-model="contactFormValues[field.key]"
                              @input="handleFieldInput(field.key)"
                              @blur="handleFieldBlur(field.key)"
                              :class="contactFormErrors[field.key].length ? 'textarea-error' : ''"></textarea>
                  </template>

                  <template x-if="field.type === 'address'">
                    <div x-data="addressAutocomplete(field.key)" x-init="init()" class="space-y-3">
                      <div class="relative">
                        <input type="text"
                               class="input input-lg w-full pr-12"
                               :class="contactFormErrors[field.key].length ? 'input-error' : ''"
                               x-model="query"
                               x-ref="input"
                               x-bind:placeholder="field.placeholder ?? 'Zadejte adresu'"
                               @input="onInput($event)"
                               @focus="openSuggestions()"
                               @blur="onBlur()"
                               @keydown.arrow-down.prevent="highlightNext()"
                               @keydown.arrow-up.prevent="highlightPrev()"
                               @keydown.enter.prevent="selectHighlighted()"
                               @keydown.escape="closeSuggestions()" />
                        <button type="button"
                                class="btn btn-ghost btn-sm absolute right-2 top-1/2 -translate-y-1/2"
                                x-show="hasValue"
                                @mousedown.prevent
                                @click="clearSelection()">
                          <span class="sr-only">Vymazat adresu</span>
                          ×
                        </button>

                        <div class="absolute left-0 right-0 z-20 mt-1 rounded-lg border border-base-300 bg-white shadow-lg"
                             x-cloak
                             x-show="open && filteredOptions.length">
                          <ul class="max-h-60 overflow-y-auto">
                            <template x-for="(opt, idx) in filteredOptions" :key="opt.id">
                              <li>
                                <button type="button"
                                        class="w-full text-left px-4 py-2 hover:bg-base-200 focus:bg-base-200"
                                        :class="idx === highlighted ? 'bg-base-200' : ''"
                                        @mousedown.prevent="selectOption(opt)"
                                        @mouseenter="highlighted = idx">
                                  <div class="font-medium" x-text="opt.label"></div>
                                  <div class="text-sm text-base-content/70" x-text="opt.cityLine"></div>
                                </button>
                              </li>
                            </template>
                          </ul>
                        </div>
                      </div>

                      <template x-if="hasValue">
                        <div class="rounded-lg border border-dashed border-base-300 bg-base-100 p-4 text-sm leading-snug">
                          <div class="font-semibold text-base-content">Vybraná adresa</div>
                          <div class="text-base-content/80 whitespace-pre-line" x-text="summaryBody"></div>
                        </div>
                      </template>
                    </div>
                  </template>

                  <template x-if="isPhoneField(field)">
                    <label class="input input-lg w-full" :class="contactFormErrors[field.key].length ? 'input-error' : ''">
                      <span class="label" x-show="field.prefix" x-text="field.prefix"></span>
                      <div class="relative grow min-w-0">
                        <input :type="field.type === 'tel' ? 'tel' : 'text'"
                               class="grow bg-transparent focus:outline-none tabular-nums"
                               :style="contactFormValues[field.key] ? 'color: transparent; caret-color: var(--fallback-bc, currentColor);' : ''"
                               x-bind:placeholder="field.placeholder ?? undefined"
                               x-model="contactFormValues[field.key]"
                               @input="handleFieldInput(field.key)"
                               @blur="handleFieldBlur(field.key)" />
                        <span class="pointer-events-none select-none absolute inset-0 flex items-center justify-start text-base-content truncate w-full tabular-nums"
                              :class="contactFormValues[field.key] ? 'opacity-100' : 'opacity-0'"
                              aria-hidden="true"
                              x-text="formatPhoneDisplay(contactFormValues[field.key])"></span>
                      </div>
                    </label>
                  </template>

                  <template x-if="['text','email'].includes(field.type) && !isPhoneField(field)">
                    <label class="input input-lg w-full" :class="contactFormErrors[field.key].length ? 'input-error' : ''">
                      <span class="label" x-show="field.prefix" x-text="field.prefix"></span>
                      <input :type="field.type === 'email' ? 'email' : 'text'"
                             class="grow"
                             x-bind:placeholder="field.placeholder ?? undefined"
                             x-model="contactFormValues[field.key]"
                             @input="handleFieldInput(field.key)"
                             @blur="handleFieldBlur(field.key)" />
                    </label>
                  </template>

                  <p class="text-sm text-base-content/70" x-show="field.note" x-text="field.note"></p>
                  <template x-if="contactFormErrors[field.key].length">
                    <p class="text-sm text-error" x-text="contactFormErrors[field.key][0]"></p>
                  </template>
                </fieldset>
              </template>
            </div>
          </template>
        </fieldset>
      </template>

      <template x-if="isPickupDelivery()">
        <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-6 md:px-16 md:py-10 grid grid-cols-1 gap-y-4 place-content-start">
          <h2 class="text-xl font-medium leading-tight mt-0 mb-2">Výdejní místo</h2>
          <template x-if="checkoutDeliveryMeta?.pickup">
            <div class="space-y-2">
              <div class="text-base font-semibold" x-text="checkoutDeliveryMeta.pickup.name || 'Vybrané místo'"></div>
              <p class="text-sm text-base-content/80 whitespace-pre-line" x-text="checkoutDeliveryMeta.pickup.addressLine || ''"></p>
              <p class="text-sm text-base-content/80" x-show="checkoutDeliveryMeta.pickup.phone">
                Kontakt: <span class="font-medium" x-text="checkoutDeliveryMeta.pickup.phone"></span>
              </p>
            </div>
          </template>
          <template x-if="!checkoutDeliveryMeta?.pickup">
            <p class="text-sm text-base-content/70">
              Výdejní místo je nastaveno v předchozím kroku.
            </p>
          </template>
        </fieldset>
      </template>
    </div>

    <p class="mt-6 text-sm text-error" x-show="addressFormMessage" x-text="addressFormMessage"></p>
  </section>

  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/delivery-payment'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0 || addressFormLoading"
        @click="submitAddressForm()">
        Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</section>

<!-- ROUTE == PURCHASE REVIEW -->
<section x-show="is('purchase-review')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Kontrola nákupu</h1>

    <template x-if="!checkoutReview">
      <div class="border border-base-300 rounded-xl bg-white shadow-sm p-6 text-base-content/70">
        Načítám rekapitulaci…
      </div>
    </template>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-10" x-show="checkoutReview">
      <div class="xl:col-span-2 space-y-6">
        <article class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-medium">Kontaktní údaje</h2>
            <button class="btn btn-xs btn-link text-secondary" type="button" @click="location.hash='/addresses'">
              Upravit
            </button>
          </div>
          <template x-if="checkoutReview?.contact?.length">
            <dl class="grid gap-3">
              <template x-for="item in checkoutReview.contact" :key="item.label">
                <div>
                  <dt class="text-sm text-base-content/60" x-text="item.label"></dt>
                  <dd class="font-medium whitespace-pre-line" x-text="item.value"></dd>
                </div>
              </template>
            </dl>
          </template>
          <p class="text-sm text-base-content/70" x-show="!(checkoutReview?.contact?.length)">
            Žádné kontaktní údaje zatím nejsou vyplněné.
          </p>
        </article>

        <article class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-medium">Doručení</h2>
            <button class="btn btn-xs btn-link text-secondary" type="button" @click="location.hash='/delivery-payment'">
              Změnit
            </button>
          </div>
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-semibold" x-text="checkoutReview?.delivery?.name || 'Doprava nevybrána'"></div>
              <p class="text-sm text-base-content/70" x-show="checkoutReview?.delivery?.description" x-text="checkoutReview?.delivery?.description"></p>
              <p class="text-sm text-base-content/80" x-show="checkoutReview?.delivery?.timeslot?.label">
                Termín: <span class="font-medium" x-text="checkoutReview?.delivery?.timeslot?.label"></span>
              </p>
            </div>
            <div class="text-lg font-semibold">
              <template x-if="(checkoutReview?.delivery?.finalPrice || 0) === 0">
                <span>Zdarma</span>
              </template>
              <template x-if="(checkoutReview?.delivery?.finalPrice || 0) > 0">
                <span x-text="formatCZK(checkoutReview?.delivery?.finalPrice || 0)"></span>
              </template>
            </div>
          </div>
          <template x-if="checkoutReview?.delivery?.pickup">
            <div class="border border-dashed border-base-300 rounded-lg p-4 space-y-1">
              <div class="text-sm text-base-content/60 uppercase tracking-wide">Výdejní místo</div>
              <div class="font-medium" x-text="checkoutReview?.delivery?.pickup?.name || ''"></div>
              <p class="text-sm text-base-content/80 whitespace-pre-line" x-text="checkoutReview?.delivery?.pickup?.addressLine || ''"></p>
            </div>
          </template>
          <template x-if="checkoutReview?.deliveryDetails?.length">
            <dl class="grid gap-2">
              <template x-for="item in checkoutReview.deliveryDetails" :key="item.label">
                <div>
                  <dt class="text-sm text-base-content/60" x-text="item.label"></dt>
                  <dd class="text-sm font-medium whitespace-pre-line" x-text="item.value"></dd>
                </div>
              </template>
            </dl>
          </template>
          <template x-if="checkoutReview?.companyDetails?.length">
            <div class="pt-3 border-t border-base-200">
              <div class="text-sm text-base-content/60 uppercase tracking-wide mb-2">Firemní údaje</div>
              <dl class="grid gap-2 text-sm">
                <template x-for="item in checkoutReview.companyDetails" :key="item.label">
                  <div>
                    <dt class="text-base-content/60" x-text="item.label"></dt>
                    <dd class="font-medium whitespace-pre-line" x-text="item.value"></dd>
                  </div>
                </template>
              </dl>
            </div>
          </template>
        </article>

        <article class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-medium">Platba</h2>
            <button class="btn btn-xs btn-link text-secondary" type="button" @click="location.hash='/delivery-payment'">
              Upravit
            </button>
          </div>
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-semibold" x-text="checkoutReview?.payment?.name || 'Platba nevybrána'"></div>
              <p class="text-sm text-base-content/70" x-show="checkoutReview?.payment?.description" x-text="checkoutReview?.payment?.description"></p>
              <p class="text-sm text-base-content/80" x-show="checkoutReview?.payment?.benefit?.name">
                Benefit: <span class="font-medium" x-text="checkoutReview?.payment?.benefit?.name"></span>
              </p>
            </div>
            <div class="text-lg font-semibold">
              <template x-if="(checkoutReview?.payment?.finalPrice || 0) === 0">
                <span>Zdarma</span>
              </template>
              <template x-if="(checkoutReview?.payment?.finalPrice || 0) > 0">
                <span x-text="formatCZK(checkoutReview?.payment?.finalPrice || 0)"></span>
              </template>
            </div>
          </div>
        </article>

        <article class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-4">
          <h2 class="text-xl font-medium">Obsah košíku</h2>
          <template x-if="checkoutReview?.cart?.items?.length">
            <div class="divide-y divide-base-200">
              <template x-for="item in checkoutReview.cart.items" :key="item.id">
                <div class="flex items-start justify-between gap-4 py-3">
                  <div class="flex items-start gap-3">
                    <img :src="item.image || './images/placeholder.png'"
                         alt=""
                         class="size-12 rounded bg-base-200 object-cover shrink-0" />
                    <div>
                      <div class="font-medium" x-text="item.name"></div>
                      <div class="text-sm text-base-content/60">Ks: <span class="font-semibold" x-text="item.qty"></span></div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-sm text-base-content/70" x-text="formatCZK(item.unitPrice)"></div>
                    <div class="text-base font-semibold" x-text="formatCZK(item.price)"></div>
                  </div>
                </div>
              </template>
            </div>
          </template>
          <p class="text-sm text-base-content/70" x-show="!(checkoutReview?.cart?.items?.length)">
            Košík je prázdný.
          </p>
        </article>
      </div>

      <aside class="space-y-6">
        <div class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-3">
          <h2 class="text-lg font-semibold">Souhrn ceny</h2>
          <dl class="space-y-2 text-sm">
            <div class="flex items-center justify-between">
              <dt>Mezisoučet</dt>
              <dd class="font-medium" x-text="formatCZK(checkoutReview?.cart?.totals?.subtotal || 0)"></dd>
            </div>
            <template x-if="(checkoutReview?.cart?.totals?.discounts || 0) > 0">
              <div class="flex items-center justify-between text-success">
                <dt>Slevy</dt>
                <dd class="font-medium" x-text="'− ' + formatCZK(checkoutReview?.cart?.totals?.discounts || 0)"></dd>
              </div>
            </template>
            <div class="flex items-center justify-between">
              <dt>Doprava</dt>
              <dd class="font-medium"
                  x-text="(checkoutReview?.delivery?.finalPrice || 0) === 0 ? 'Zdarma' : formatCZK(checkoutReview?.delivery?.finalPrice || 0)">
              </dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Platba</dt>
              <dd class="font-medium"
                  x-text="(checkoutReview?.payment?.finalPrice || 0) === 0 ? 'Zdarma' : formatCZK(checkoutReview?.payment?.finalPrice || 0)">
              </dd>
            </div>
            <hr class="border-base-200">
            <div class="flex items-center justify-between text-base font-semibold">
              <dt>Celkem k úhradě</dt>
              <dd x-text="formatCZK((checkoutReview?.cart?.totals?.toPay || 0) + (checkoutReview?.delivery?.finalPrice || 0) + (checkoutReview?.payment?.finalPrice || 0))"></dd>
            </div>
          </dl>
        </div>

        <div class="border border-base-300 rounded-xl bg-white shadow-sm p-6 space-y-3">
          <h2 class="text-lg font-semibold">Souhlasy</h2>
          <label class="flex items-start gap-3 text-sm text-base-content/80">
            <input type="checkbox" class="checkbox checkbox-secondary mt-1"
                   x-model="checkoutConsents.terms"
                   @change="reviewValidationErrors = []">
            <span>Souhlasím s <a href="#" class="link link-primary">obchodními podmínkami</a>.</span>
          </label>
          <label class="flex items-start gap-3 text-sm text-base-content/80">
            <input type="checkbox" class="checkbox checkbox-secondary mt-1"
                   x-model="checkoutConsents.privacy"
                   @change="reviewValidationErrors = []">
            <span>Souhlasím se zpracováním osobních údajů dle <a href="#" class="link link-primary">zásad ochrany soukromí</a>.</span>
          </label>
          <label class="flex items-start gap-3 text-sm text-base-content/70">
            <input type="checkbox" class="checkbox checkbox-secondary mt-1"
                   x-model="checkoutConsents.marketing">
            <span>Chci dostávat novinky a personalizované nabídky (volitelné).</span>
          </label>
          <template x-if="reviewValidationErrors.length">
            <p class="text-sm text-error" x-text="reviewValidationErrors[0]"></p>
          </template>
        </div>
      </aside>
    </div>
  </section>

  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/addresses'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0 || !checkoutReview"
        @click="submitPurchaseReview()">
        Dokončit objednávku <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</section>

<!-- Paygate simulation modal -->
<dialog
  x-ref="paygate"
  class="modal"
  @cancel.prevent="paygateManualCancel()">
  <div class="modal-box w-11/12 max-w-md relative">
    <button type="button"
            class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3"
            @click="paygateManualCancel()"
            x-show="paygateModal.step === 'intro'">✕</button>

    <template x-if="paygateModal.step === 'intro'">
      <div class="space-y-5">
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">Online platba</h3>
          <p class="text-sm text-base-content/70">
            Platba probíhá pouze jako simulace pro potřeby testování použitelnosti. Žádné peníze nebudou stržené.
          </p>
        </div>
        <button type="button"
                class="btn btn-primary btn-block"
                @click="startPaygateProcessing()">
          Zaplatit <span x-text="formatCZK(paygateModal.amount || paygateTotal())"></span>
        </button>
        <button type="button"
                class="btn btn-ghost btn-block"
                @click="paygateManualCancel()">Zrušit a vrátit se</button>
      </div>
    </template>

    <template x-if="paygateModal.step === 'processing'">
      <div class="py-10 flex flex-col items-center gap-4">
        <span class="loading loading-spinner loading-lg text-secondary"></span>
        <p class="text-sm text-base-content/70">Zpracováváme platbu…</p>
      </div>
    </template>

    <template x-if="paygateModal.step === 'success'">
      <div class="py-10 flex flex-col items-center gap-4 text-center">
        <span class="text-4xl text-success">
          <i class="fa-solid fa-circle-check"></i>
        </span>
        <h3 class="text-lg font-semibold">Platba dokončena</h3>
        <p class="text-sm text-base-content/70">Pokračujeme k potvrzení objednávky…</p>
      </div>
    </template>
  </div>
  <form method="dialog"
        class="modal-backdrop"
        @click.prevent="paygateModal.step === 'intro' ? paygateManualCancel() : null">
    <button type="button">close</button>
  </form>
</dialog>

<!-- ROUTE == ACTIVE ORDER -->
<section x-show="is('active-order')" x-cloak x-data="activeOrderPage()">
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32 space-y-8">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl mb-2">Aktivní objednávka</h1>
        <template x-if="$store.activeOrder.hasOrder()">
          <p class="text-base text-base-content/70">
            Číslo objednávky:
            <span class="underline underline-offset-4 decoration-4 decoration-max-blue-500"
                  x-text="$store.activeOrder.formattedOrderNumber()"></span>
          </p>
        </template>
        <template x-if="!$store.activeOrder.hasOrder()">
          <p class="text-base text-base-content/70">
            Dokončete nákup a přehled jeho průběhu se zobrazí právě zde.
          </p>
        </template>
      </div>
    </div>

    <template x-if="$store.activeOrder.hasOrder()">
      <ul class="timeline timeline-snap-icon timeline-compact timeline-vertical no-start col-span-3"
          x-data="{
            steps: [],
            connector(state) { return state === 'past' ? 'bg-primary' : 'bg-max-gray-200'; }
          }"
          x-effect="steps = $store.activeOrder.timeline()">
        <template x-for="(item, index) in steps" :key="item.id">
          <li>
            <template x-if="index !== 0">
              <hr :class="connector(steps[index - 1]?.state || 'future')">
            </template>
            <div class="timeline-middle">
              <template x-if="item.state === 'past'">
                <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center text-primary-content shadow">
                  <i class="fa-solid fa-check"></i>
                </div>
              </template>
              <template x-if="item.state === 'now'">
                <div class="relative">
                  <div class="absolute w-10 h-10 m-1 rounded-full bg-primary/30 animate-ping opacity-60"></div>
                  <div class="relative w-10 h-10 m-1 rounded-full border-2 border-primary bg-white flex items-center justify-center shadow">
                    <i class="fa-solid fa-box-isometric-tape text-primary"></i>
                  </div>
                </div>
              </template>
              <template x-if="item.state === 'future'">
                <div class="w-10 h-10 m-1 rounded-full border-2 border-max-gray-200 bg-white"></div>
              </template>
            </div>
            <div class="timeline-end text-base space-y-0 !ml-4">
              <time class="font-medium text-sm text-primary block mt-4"
                    x-show="item.timestamp"
                    x-text="item.timestamp"></time>
              <div class="text-lg font-medium mt-2" x-text="item.headline"></div>
              <div class="text-base text-base-content/80 leading-relaxed"
                   x-show="item.description"
                   x-html="item.description"></div>
            </div>
            <template x-if="index !== steps.length - 1">
              <hr :class="connector(item.state)">
            </template>
          </li>
        </template>
      </ul>
    </template>

    <template x-if="!$store.activeOrder.hasOrder()">
      <div class="rounded-2xl border border-dashed border-base-300 bg-base-100/80 p-8 text-center text-base-content/70">
        Nemáte žádnou aktivní objednávku. Jakmile dokončíte nákup, ukážeme tady její průběh krok za krokem.
      </div>
    </template>
  </section>

  <div class="modal"
       x-cloak
       :class="{ 'modal-open': $store.activeOrder.cashModalOpen }"
       x-show="$store.activeOrder.cashModalOpen">
    <div class="modal-box max-w-md space-y-4">
      <h3 class="text-xl font-semibold">Zaplatíte při převzetí</h3>
      <p class="text-base text-base-content/70">
        <span class="font-semibold" x-text="$store.activeOrder.orderLabel()"></span> uhradíte kurýrovi při doručení.
        Pokračujte na detailní sledování a mějte přehled, kdy máte platbu připravenou.
      </p>
      <div class="modal-action justify-end">
        <button type="button" class="btn btn-primary"
                @click="$store.activeOrder.acknowledgeCashModal()">
          Přejít na sledování
        </button>
      </div>
    </div>
  </div>
</section>

<!-- ROUTE == CONFIG -->
<section x-show="is('config')" x-cloak x-data="configPage()">
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <div class="max-w-3xl space-y-6">
      <header class="space-y-2">
        <h1 class="text-3xl font-semibold">Konfigurace</h1>
        <p class="text-base-content/70">Nastavení se ukládá lokálně do prohlížeče pod klíčem <code>fit:app-config</code>.</p>
      </header>

      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">Breakpoint badge</h2>
            <p class="text-sm text-base-content/70">
              Zobrazí v levém dolním rohu aktivní Tailwind breakpoint a šířku okna.
            </p>
          </div>
          <label class="flex items-center gap-3">
            <input type="checkbox"
                   class="toggle toggle-primary"
                   :checked="showBadge"
                   @change="setBadge($event.target.checked)">
            <span class="text-sm font-semibold" x-text="showBadge ? 'Zobrazeno' : 'Skryto'"></span>
          </label>
        </div>
      </div>
      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">Dr. Max Woman kampaň</h2>
            <p class="text-sm text-base-content/70">
              Aktivuje speciální banner, upraví CTA barvy a přepne logo v horní liště.
            </p>
          </div>
          <label class="flex items-center gap-3">
            <input type="checkbox"
                   class="toggle toggle-secondary"
                   :checked="drMaxWomanEnabled"
                   @change="setDrMaxWoman($event.target.checked)">
            <span class="text-sm font-semibold" x-text="drMaxWomanEnabled ? 'Zapnuto' : 'Vypnuto'"></span>
          </label>
        </div>
      </div>
      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">Indikátor chybějících překladů</h2>
            <p class="text-sm text-base-content/70">
              Přidá tečku k textům, které používají fallback překlad nebo řetězec.
            </p>
          </div>
          <label class="flex items-center gap-3">
            <input type="checkbox"
                   class="toggle toggle-accent"
                   :checked="translationHintsEnabled"
                   @change="setTranslationHints($event.target.checked)">
            <span class="text-sm font-semibold" x-text="translationHintsEnabled ? 'Zobrazeno' : 'Skryto'"></span>
          </label>
        </div>
      </div>
      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-4">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div class="max-w-xl">
            <h2 class="text-lg font-semibold">Výchozí jazyk a měna</h2>
            <p class="text-sm text-base-content/70">
              Určuje, v jaké lokalizaci a měně se prototyp otevře. Změna se ihned uloží do <code>fit:app-config</code>.
            </p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
            <label class="flex flex-col gap-2 w-full sm:w-52">
              <span class="text-xs font-semibold uppercase tracking-wide text-base-content/50">Výchozí jazyk</span>
              <select
                class="select select-bordered w-full"
                :value="localeCode"
                @change="changeLocale($event.target.value)"
              >
                <template x-for="option in localeOptions" :key="option.code">
                  <option :value="option.code" x-text="localeLabel(option)"></option>
                </template>
              </select>
            </label>
            <label class="flex flex-col gap-2 w-full sm:w-40">
              <span class="text-xs font-semibold uppercase tracking-wide text-base-content/50">Výchozí měna</span>
              <select
                class="select select-bordered w-full"
                :value="currencyCode"
                @change="changeCurrency($event.target.value)"
              >
                <template x-for="option in currencyOptions" :key="option.code">
                  <option :value="option.code" x-text="currencyLabel(option)"></option>
                </template>
              </select>
            </label>
          </div>
        </div>
      </div>
      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-5">
        <div class="space-y-1">
          <h2 class="text-lg font-semibold">Přihlášení a testovací účet</h2>
          <p class="text-sm text-base-content/70">
            Spravujte aktuální stav přihlášení a výchozí testovací data uložená v <code>fit:auth</code>.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <span class="badge"
                :class="$store.auth?.isAuthenticated ? 'badge-success badge-outline' : 'badge-ghost border-base-300 text-base-content/70'">
            <span x-text="$store.auth?.isAuthenticated ? 'Přihlášený uživatel' : 'Anonymní uživatel'"></span>
          </span>
          <template x-if="$store.auth?.account?.email">
            <span class="text-base-content/70">
              E-mail: <span class="font-medium" x-text="$store.auth.account.email"></span>
            </span>
          </template>
          <template x-if="!$store.auth?.account?.email && !$store.auth?.isAuthenticated">
            <span class="text-base-content/60">Nikdo není přihlášen.</span>
          </template>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
          <button type="button"
                  class="btn btn-primary flex-1 sm:flex-none"
                  @click="$store.auth?.loginWithFallback()">
            Přihlásit testovací účet
          </button>
          <button type="button"
                  class="btn btn-ghost flex-1 sm:flex-none"
                  :disabled="!$store.auth?.isAuthenticated"
                  @click="$store.auth?.logout()">
            Odhlásit
          </button>
          <button type="button"
                  class="btn btn-ghost flex-1 sm:flex-none"
                  @click="$store.auth?.reset()">
            Resetovat vše
          </button>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-base-content/50">Prodleva simulace (ms)</span>
            <div class="flex items-center gap-2">
              <input type="number"
                     class="input input-bordered w-full"
                     x-model.number="authThrottleDraft"
                     min="0"
                     step="100">
              <button type="button"
                      class="btn btn-ghost"
                      @click="applyThrottle()">
                Uložit
              </button>
            </div>
          </label>
          <div class="md:col-span-2 flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-base-content/50">
              Výchozí testovací uživatel (JSON)
            </span>
            <textarea class="textarea textarea-bordered font-mono text-xs leading-5 min-h-[140px]"
                      x-model="authFallbackDraft"
                      spellcheck="false"></textarea>
            <p class="text-xs text-error min-h-[1.2rem]" x-text="authFallbackError"></p>
            <div class="flex justify-end gap-2">
              <button type="button"
                      class="btn btn-ghost btn-sm"
                      @click="resetFallbackDraft()">
                Obnovit návrh
              </button>
              <button type="button"
                      class="btn btn-primary btn-sm"
                      @click="applyFallbackDraft()">
                Uložit JSON
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="rounded-2xl border border-base-300 bg-white shadow-sm p-6 space-y-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">
              Změna stavu aktivní objednávky
              <template x-if="hasActiveOrder">
                <span class="block text-sm font-normal text-base-content/70">
                  Aktuálně sledujeme
                  <span class="font-semibold" x-text="$store.activeOrder.orderLabel()"></span>
                </span>
              </template>
            </h2>
            <p class="text-sm text-base-content/70">
              Umožní přesunout aktivní objednávku do libovolného stavu dle <code>./data/order-flow.json</code>
            </p>
            <template x-if="!hasActiveOrder">
              <p class="text-xs text-base-content/60 mt-1">
                Zatím zde žádná objednávka není. Jakmile ji vytvoříte, objeví se možnosti pro ladění stavu.
              </p>
            </template>
          </div>
          <label class="flex items-center gap-3">
            <select class="select select-bordered min-w-[220px]"
                    :disabled="!hasActiveOrder"
                    x-model="selectedStep"
                    @change="changeOrderStep($event.target.value)">
              <option value="" disabled>Vyberte stav</option>
              <template x-for="option in $store.activeOrder.stepOptions()" :key="option.id">
                <option :value="option.id" x-text="option.label"></option>
              </template>
            </select>
          </label>
        </div>
        <button type="button"
                class="btn btn-ghost btn-sm"
                :disabled="!hasActiveOrder"
                @click="cancelOrder()">
          <i class="fa-solid fa-trash-can mr-2"></i>
          Zrušit objednávku
        </button>
      </div>      

      <div class="rounded-2xl border border-dashed border-base-300 bg-base-100/80 p-4">
        <h2 class="text-sm font-semibold text-base-content/70 mb-2">Aktuální konfigurace</h2>
        <pre class="text-xs whitespace-pre-wrap font-mono text-base-content/70" x-text="snapshot"></pre>
      </div>
      <p class="text-xs text-base-content/60">
        <button type="button" class="btn btn-ghost btn-sm" @click="resetAll()">
          Resetovat vše
        </button>
      </p>
    </div>
  </section>
</section>

<!-- ROUTE == MY ACCOUNT ORDER HISTORY -->
<section x-show="is('my-account')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Vaše objednávky</h1>
  

<div class="grid grid-cols-4 gap-8">
<div class="flex flex-col gap-y-2">
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>
</div> 


  

</div>  
  </section>
</section>

<!-- ROUTE == MY SAVED FAVORITES -->
<section x-show="is('my-saved')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32 space-y-6">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-3xl font-semibold">Moje uložené</h1>
      <span class="text-sm text-base-content/60" x-text="`${$store.saved.items.length} položek`" x-cloak></span>
    </header>

    <template x-if="!$store.saved.items.length">
      <div class="bg-white border border-base-200 rounded-2xl p-8 text-center space-y-4">
        <p class="text-base text-base-content/70">Zatím nemáte uložené žádné produkty.</p>
        <button type="button" class="btn btn-primary" @click="location.hash='/products'">Zpět na nabídku</button>
      </div>
    </template>

    <template x-if="$store.saved.items.length">
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        <template x-for="saved in $store.saved.items" :key="saved.id">
          <article class="card bg-white border border-base-200 shadow-sm relative h-full"
                   x-data="{ product: products.find(p => String(p.id) === String(saved.id)) || null }">
            <button type="button"
                    class="btn btn-circle btn-ghost btn-sm absolute right-3 top-3"
                    aria-label="Odebrat z uložených"
                    @click.stop="
                      $store.saved.remove(saved.id);
                      $store.toast?.push?.('Produkt odebrán z uložených', 'warning');
                    ">
              <i class="fa-solid fa-xmark"></i>
            </button>
            <a :href="link('product',{ id: saved.id })" class="block h-full">
              <figure class="p-4 h-44 flex items-center justify-center">
                <img :src="product?.image || (Array.isArray(product?.images) ? product.images[0] : '') || saved.image || './images/placeholder.webp'"
                     :alt="product?.name || saved.name || 'Uložený produkt'"
                     class="object-contain w-full h-full">
              </figure>
              <div class="card-body pt-0">
                <h3 class="text-base font-semibold min-h-[3.25rem]" x-text="product?.name || saved.name || 'Produkt bez názvu'"></h3>
                <p class="text-sm text-base-content/70 min-h-[2.5rem]" x-text="product?.perex || saved.perex || ''"></p>
                <div class="mt-4 space-y-1">
                  <div class="text-lg font-semibold"
                       x-text="formatPrice((product?.discounted_price ?? product?.price ?? saved.discounted_price ?? saved.price) || 0)"></div>
                  <div class="text-xs line-through text-base-content/60"
                       x-show="(product?.discounted_price ?? saved.discounted_price) != null && (product?.price ?? saved.price)"
                       x-text="formatPrice((product?.price ?? saved.price) || 0)"></div>
                </div>
              </div>
            </a>
          </article>
        </template>
      </div>
    </template>
  </section>
</section>

<!-- ROUTE == MAP -->
<template x-if="is('map')">
  <section x-cloak
           x-data="pickupMapUI({
             jsonUrl: ($store.i18n.resolveConfig('map.points', { fallback: 'data/map-points.json' }) || 'data/map-points.json'),
             enableClustering: true,
             defaultCenter: (Alpine.store('i18n')?.resolveConfig('map.center') || [50.0755, 14.4378]),
             defaultZoom: Number(Alpine.store('i18n')?.resolveConfig('map.zoom') || 12)
           })"
           x-init="init()"
           class="fixed inset-0 z-[80] flex flex-col bg-base-200/95 backdrop-blur-sm"
           @keydown.escape.window="closeModal()"
           @click.self="closeModal()">
    <button type="button"
            class="absolute top-24 right-6 md:top-10 md:right-8 z-[90] btn btn-circle btn-ghost bg-base-100 border-base-300 border-2 hover:bg-base-200/60  btn-md md:btn-lg"
            aria-label="Zavřít mapu"
            @click.stop="closeModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>

    <div class="relative flex-1 overflow-hidden pointer-events-none">
      <div class="absolute inset-0 px-4 pt-8 pb-4 md:pt-6 md:pb-6 pointer-events-auto flex flex-col gap-4">
        <div class="md:hidden flex-shrink-0" x-show="!selected || isLg">
          <div class="join w-full">
            <input class="join-item btn btn-block flex-1"
                   type="radio" name="maplist" aria-label="Mapa"
                   :checked="mode==='map'" @click="mode='map'"/>
            <input class="join-item btn btn-block flex-1"
                   type="radio" name="maplist" aria-label="Výpis"
                   :checked="mode==='list'" @click="mode='list'"/>
          </div>
        </div>

        <div class="grid flex-1 min-h-0 grid-cols-1 md:grid-cols-12 gap-4 items-stretch">

        <!-- LEFT COLUMN (hidden on <lg unless 'list' tab is selected on mobile) -->
          <aside class="min-h-0 col-span-12 lg:col-span-3 flex flex-col"
          x-show="isLg || mode==='list'">
          <div class="bg-white border border-base-300 rounded-xl xl:p-8 p-4 flex-1 flex flex-col overflow-hidden">
            <h1 class="text-3xl mt-2 md:mt-4 pb-4">Lékárny a boxy</h1>

            <!-- Search -->
            <div class="pb-4">
              <label class="input input-bordered items-center gap-2 w-full"
                     aria-label="Vyhledávání">
                <i class="fa-solid fa-magnifying-glass text-max-gray-600"></i>
                <input type="search" placeholder="Filtruj dle adresy"
                       x-model.debounce.250ms="search"
                       @input="applyFilters($event.target.value)" />
              </label>
            </div>

            <div class="flex-1 min-h-0 overflow-y-auto space-y-3 pr-1">
              <!-- “Městská část” (simple chips) -->
              <div class="items-center mt-1 gap-2 flex flex-wrap">

                <!-- Vše (show all) -->
                <button type="button"
                        class="btn btn-sm"
                        :class="district==='' ? 'btn-primary' : 'btn-outline'"
                        @click="district=''; applyFilters()">
                  Vše
                </button>

                <!-- District chips -->
                <template x-for="d in districts" :key="d">
                  <button type="button"
                          class="btn btn-sm"
                          :class="district===d ? 'btn-primary' : 'btn-outline'"
                          @click="district = (district===d ? '' : d); applyFilters()"
                          x-text="d">
                  </button>
                </template>
              </div>

              <!-- Filter summary -->
              <p class="text-sm opacity-70"
                 x-text="`Zobrazuji ${filtered.length} z ${all.length}`"></p>

              <!-- List -->
              <div class="overflow-y-auto pe-1">
                <table class="table w-full">
                  <tbody>
                    <template x-for="p in filtered" :key="p.id">
                      <tr class="cursor-pointer"
                          :class="selected && selected.id===p.id ? 'bg-max-blue-50' : 'hover:bg-max-gray-50'"
                          :data-pickup-id="p.id"
                          @click="selectFromList(p)">
                        <td>
                          <div class="flex items-center gap-3">
                            <div class="h-20 w-20 rounded bg-base-200 overflow-hidden mr-2 shrink-0">
                              <img :src="p.photo || placeholderImg" alt=""
                                   class="h-full w-full object-cover object-center" loading="lazy">
                            </div>
                            <div class="min-w-0">
                              <div class="font-medium text-base truncate" x-text="p.name"></div>
                              <div class="text-base opacity-70 truncate"
                                   x-text="`${p.address.street} • ${p.address.city}`"></div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </template>
                    <template x-if="!filtered.length">
                      <tr><td class="py-8 text-center text-sm opacity-70">Žádné výsledky.</td></tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
            
          </div>
        </aside>

        <!-- RIGHT: MAP -->
        <main class="min-h-0 col-span-12 lg:col-span-9 flex flex-col" x-data="mapPane()" x-init="boot()" x-effect="onVisibilityChange(isLg || mode==='map')" x-show="isLg || mode==='map'">
  
          <div x-ref="wrap" class="relative flex-1 rounded-xl border border-base-300 min-h-0 md:min-h-[600px] overflow-hidden">

            <!-- Overlay (desktop / tablet) -->
            <div x-show="selected"
                 x-data="{ tab: 'overview', currentId: null }"
                 x-effect="if (!selected || currentId !== (selected?.id ?? null)) { tab = 'overview'; currentId = selected?.id ?? null; }"
                 class="absolute inset-0 md:top-4 md:left-4 md:right-auto md:bottom-auto m-0 md:m-4 w-full md:w-80 lg:w-96 h-full md:h-auto bg-white rounded-none md:rounded-xl border border-transparent md:border-base-300 shadow-none md:shadow-xl z-[110] flex flex-col overflow-y-auto md:overflow-visible">

              <div class="h-50 w-full rounded-none md:rounded-t-xl bg-base-200 overflow-hidden mr-2 shrink-0">
                <img :src="(selected && selected.photo) || placeholderImg" alt=""
                      class="h-full w-full object-cover object-center" loading="lazy">
              </div>

              <button class="btn btn-md btn-circle btn-ghost bg-base-100 absolute right-2 top-2"
                      @click="closeDetail()">
                <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
              </button>

             <div class="px-4 py-6 lg:px-8 flex-1">
              <div>
                <div class="font-medium text-base" x-text="selected?.name"></div>
                <div class="text-base opacity-70"
                     x-text="`${selected?.address?.street} • ${selected?.address?.city}`"></div>
              </div>

              <div class="mt-4 flex overflow-x-auto border-b border-base-200">
                <button type="button"
                        class="relative whitespace-nowrap pr-7 pb-3 pt-2 text-base font-semibold transition-colors"
                        :class="tab === 'overview' ? 'text-secondary' : 'text-base-content hover:text-base-content/90'"
                        @click="tab = 'overview'">
                  <span>Přehled</span>
                  <span class="absolute left-0 right-6 -bottom-[1px] h-1 rounded-full bg-secondary"
                        x-show="tab === 'overview'"></span>
                </button>
                <button type="button"
                        class="relative whitespace-nowrap pr-7 pb-3 pt-2 text-base font-semibold transition-colors"
                        :class="tab === 'details' ? 'text-secondary' : 'text-base-content hover:text-base-content/90'"
                        @click="tab = 'details'">
                  <span>Podrobnosti</span>
                  <span class="absolute left-0 right-6 -bottom-[1px] h-1 rounded-full bg-secondary"
                        x-show="tab === 'details'"></span>
                </button>
              </div>

              <div class="mt-4 space-y-4" x-show="tab === 'overview'" x-transition.opacity>
                <div class="overflow-y-auto max-h-[55vh] lg:max-h-max">
                  <table class="table table-zebra">
                    <tbody>
                      <template x-if="selected && selected.opening_hours">
                        <template x-for="(val, day) in selected.opening_hours" :key="day">
                          <tr>
                            <th x-text="dayCZ(day)"></th>
                            <td x-text="val"></td>
                          </tr>
                        </template>
                      </template>
                      <template x-if="selected && !selected.opening_hours">
                        <tr><td class="py-3 text-sm opacity-70">Bez zveřejněné provozní doby.</td></tr>
                      </template>
                    </tbody>
                  </table>
                </div>

                <button class="btn btn-active btn-primary w-full"
                        @click="confirmSelection()">Potvrdit výběr</button>

                <p class="text-sm" x-text="selected?.note" x-show="selected?.note"></p>

              </div>

              <div class="mt-4" x-show="tab === 'details'" x-transition.opacity>
                <address class="not-italic mb-4" x-show="selected?.phone" x-cloak>
                  <p class="flex flex-wrap items-center gap-y-2 gap-x-6">
                    <a :href="selected?.phone ? `tel:${selected.phone}` : '#'"
                       class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded">
                      <i class="fa-solid fa-phone fa-sm" aria-hidden="true"></i>
                      <span class="group-hover:underline group-focus-visible:underline underline-offset-2"
                            x-text="selected?.phone"></span>
                    </a>
                  </p>
                </address>
                <template x-if="selected?.tags && selected.tags.length">
                  <div class="flex flex-wrap gap-1">
                    <template x-for="t in selected.tags" :key="t">
                      <div class="badge badge-soft badge-neutral" x-text="t"></div>
                    </template>
                  </div>
                </template>
                <template x-if="!selected?.tags || !selected.tags.length">
                  <p class="text-sm text-base-content/70">Další informace připravujeme.</p>
                </template>
              </div>
            </div>
            </div>

            <!-- The map element -->
            <div x-ref="mapEl" id="map" class="w-full h-full z-0"></div>

          </div>
        </main>

      </div>
    </div>
  </div>

  <!-- Type filter FAB -->
  <div class="absolute bottom-12 right-8 sm:bottom-28 sm:right-6 md:bottom-14 md:right-10 z-[95]"
       x-show="typeOptions.length"
       x-cloak
       @keydown.escape.window="fabOpen=false"
       @click.outside="fabOpen=false">
    <div class="flex flex-col items-end gap-3">
      <div class="w-max flex flex-col items-end gap-2"
           x-show="fabOpen"
           x-transition:enter="transition ease-out duration-150"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           x-transition:leave="transition ease-in duration-100"
           x-transition:leave-start="opacity-100 translate-y-0"
           x-transition:leave-end="opacity-0 translate-y-2">
        <template x-for="option in typeOptions" :key="option.value">
          <button type="button"
                  class="flex items-center gap-3 rounded-full px-4 py-2 text-base font-medium shadow-lg backdrop-blur border-2 hover:border-base-300 transition"
                  :class="typeFilter === option.value ? 'bg-white text-base-content border-max-blue-300' : 'bg-white/90 text-base-content border-base-200'"
                  @click="setTypeFilter(option.value)">
            <i :class="typeFilter === option.value ? 'fa-solid fa-check-circle text-max-blue-500' : 'fa-regular fa-circle opacity-40'"></i>
            <span x-text="option.label"></span>
          </button>
        </template>
      </div>

      <button type="button"
              class="relative flex items-center justify-center w-14 h-14 rounded-full bg-primary text-primary-content shadow-xl transition transform hover:scale-105 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary/60 focus-visible:ring-offset-base-200"
              aria-label="Filtrovat výdejní místa podle typu"
              @click="fabOpen = !fabOpen">
        <i class="fa-solid fa-bars-filter fa-lg"></i>
        <span class="absolute top-0 right-0" x-show="typeFilter !== defaultType">
          <span class="relative flex h-4 w-4">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-max-red-500 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-4 w-4 bg-max-red-500"></span>
          </span>
        </span>
      </button>
    </div>
  </div>
</section>
</template>


<!-- FOOTER -->
<div class="block bg-gray-200" x-data="pageFooter()" x-init="init()">
<footer class="w-11/12 lg:w-10/12 mx-auto hidden lg:block py-12 px-4" x-show="columns.length" x-cloak>
  <div class="grid gap-8" :class="gridClass()">
    <template x-for="col in columns" :key="col.key">
      <nav>
        <template x-for="section in col.sections" :key="section.key">
          <div class="mb-6">
            <template x-if="section.title">
              <h6 class="footer-title" x-text="section.title"></h6>
            </template>
            <template x-for="item in section.items" :key="item.key">
              <a
                class="link link-hover block text-sm"
                :class="{'mt-4': true}"
                href="#"
                @click.prevent="handleItemClick(item)"
                x-text="item.label"
              ></a>
            </template>
          </div>
        </template>
      </nav>
    </template>
  </div>
</footer>
  <footer class="footer footer-horizontal p-4 pb-6 lg:pb-6 pt-10 lg:pt-4 mx-auto w-11/12 lg:w-10/12 text-base-content">
    <aside class="w-full">
      <p class="text-sm opacity-70">© 2025 Dr. Max — All rights reserved</p>
  
      <!-- contact row -->
      <address class="not-italic mt-2" x-init="$store.contacts.ensureLoaded?.()">
        <p class="flex flex-wrap items-center gap-y-2 gap-x-6">
          <a
            href="tel:516770100"
            :href="$store.contacts.primaryPhoneHref || $store.i18n.resolveConfig('contact.phone.href') || 'tel:516770100'"
            @click="!($store.contacts.primaryPhoneHref || $store.i18n.resolveConfig('contact.phone.href')) && $event.preventDefault()"
            class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded"
            :aria-disabled="!($store.contacts.primaryPhoneHref || $store.i18n.resolveConfig('contact.phone.href'))"
            aria-disabled="false"
          >
            <i class="fa-solid fa-phone fa-sm" aria-hidden="true"></i>
            <span
              class="group-hover:underline group-focus-visible:underline underline-offset-2"
              x-text="$store.contacts.primaryPhone || $store.i18n.resolveConfig('contact.phone.display') || '516 770 100'"
            >
              516 770 100
            </span>
          </a>

          <a
            href="mailto:info@drmax.cz"
            :href="$store.contacts.primaryEmailHref || ($store.contacts.primaryEmail ? `mailto:${$store.contacts.primaryEmail}` : 'mailto:info@drmax.cz')"
            @click="!($store.contacts.primaryEmail || $store.contacts.primaryEmailHref) && $event.preventDefault()"
            class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded"
            :aria-disabled="!($store.contacts.primaryEmail || $store.contacts.primaryEmailHref)"
            aria-disabled="false"
          >
            <i class="fa-solid fa-envelope fa-sm" aria-hidden="true"></i>
            <span
              class="group-hover:underline group-focus-visible:underline underline-offset-2"
              x-text="$store.contacts.primaryEmail || 'info@drmax.cz'"
            >
              info@drmax.cz
            </span>
          </a>
        </p>
      </address>
    </aside>
  </footer>
</div>


  <script>
    document.addEventListener('alpine:init', () => {
    //MOBILE "GOOGLE" SEARCH
    Alpine.data('mobileSearchOverlayShell', () => ({
    isOpen: false,
    viewportH: window.visualViewport ? window.visualViewport.height : window.innerHeight,
    pushedState: false,

    get panelStyle(){ return `height:${this.viewportH}px;max-height:${this.viewportH}px;`; },

    openOverlay(){
  if (this.isOpen) return;
  this.isOpen = true;
  this.lockPageScroll(true);
  this.attachViewportListener();

  // history stuff unchanged...
  history.pushState({ mobileSearch: true }, '');
  this.pushedState = true;
  this._onPop = () => { if (this.isOpen) this.closeOverlay({ fromPop:true }); };
  window.addEventListener('popstate', this._onPop);

  const focusRealInput = () => {
  const el = this.$root.querySelector('[data-mobile-search-input]');
  if (!el) return;

  el.focus({ preventScroll: true });
  try {
    const n = el.value?.length ?? 0;
    el.setSelectionRange(n, n); // place caret; helps iOS show cursor
  } catch {}

  // now blur the ghost (after the real input owns focus)
  try { if (window.__msGhost) window.__msGhost.blur(); } catch {}
  window.__msGhost = null;

  // If something stole focus, retry once
  setTimeout(() => {
    if (document.activeElement !== el) {
      el.focus({ preventScroll: true });
      try {
        const n2 = el.value?.length ?? 0;
        el.setSelectionRange(n2, n2);
      } catch {}
    }
  }, 50);
};

this.$nextTick(() => requestAnimationFrame(focusRealInput));

},

    // Pass an optional reason: 'ui' | 'navigate' | 'pop'
    closeOverlay({fromPop=false, reason='ui'} = {}){
      if (!this.isOpen) return;
      this.isOpen = false;
      this.detachViewportListener();
      this.lockPageScroll(false);

      if (this._onPop) {
        window.removeEventListener('popstate', this._onPop);
        this._onPop = null;
      }

      // Only "go back" when user is closing without navigating.
      if (this.pushedState && !fromPop && reason !== 'navigate') {
        this.pushedState = false;
        history.back();
      } else {
        this.pushedState = false;
      }
    },

    // Fixed-body scroll lock (keeps focus/caret stable on iOS)
    lockPageScroll(lock){
      const body = document.body;
      if (lock){
        this._scrollY = window.scrollY || window.pageYOffset;
        body.style.position = 'fixed';
        body.style.top = `-${this._scrollY}px`;
        body.style.left = '0';
        body.style.right = '0';
        body.style.width = '100%';
      } else {
        const y = this._scrollY || 0;
        body.style.position = '';
        body.style.top = '';
        body.style.left = '';
        body.style.right = '';
        body.style.width = '';
        window.scrollTo(0, y);
      }
    },

    attachViewportListener(){
      if (window.visualViewport){
        this._vv = () => { this.viewportH = window.visualViewport.height; };
        window.visualViewport.addEventListener('resize', this._vv);
      } else {
        this._wr = () => { this.viewportH = window.innerHeight; };
        window.addEventListener('resize', this._wr);
      }
    },
    detachViewportListener(){
      if (this._vv && window.visualViewport) window.visualViewport.removeEventListener('resize', this._vv);
      if (this._wr) window.removeEventListener('resize', this._wr);
      this._vv = this._wr = null;
    },
  }));


      //MAP  
    Alpine.data('mapPane', () => ({

    resizeObserver: null,

    boot() {
      this.$nextTick(() => {
        this._afterTransitionInvalidate();

        // Keep it healthy on container resizes
        const wrap = this.$refs.wrap || this.$refs.mapEl;
        if (wrap && !this.resizeObserver) {
          this.resizeObserver = new ResizeObserver(() => this._invalidate());
          this.resizeObserver.observe(wrap);
        }

        // Orientation
        window.addEventListener('orientationchange', () => this._afterTransitionInvalidate());
      });
    },

    onVisibilityChange(visible) {
      if (visible) this._afterTransitionInvalidate();
    },

    _invalidate() {
      window.dispatchEvent(new CustomEvent('map:invalidate'));
    },

    _afterTransitionInvalidate() {
      // Wait for x-show + Tailwind transition (~200ms)
      requestAnimationFrame(() => {
        setTimeout(() => this._invalidate(), 220);
      });
    }
  }));
  
      // CART
      Alpine.store('cart', {
  // --- state ---
  items: {},                 // { [id]: { qty, product } }
  _version: 0,               // bumped to notify UIs
  _bc: null,                 // BroadcastChannel for cross-tab (optional)

  // legacy single fields (kept for compatibility with existing UI)
  coupon: null,              // { code, type:'percent'|'amount', value }
  giftCard: null,            // { code, type:'amount', value }

  // new multi support
  coupons: [],               // [{ code, type, value }, ...]
  giftCards: [],             // [{ code, type, value }, ...]

  freeShipThreshold: 600, // Kč
  _badgePulse: false,
  

  // --- lifecycle / persistence ---
  init() {
    try {
      const raw = localStorage.getItem('cart.v1');
      if (raw) {
        const parsed = JSON.parse(raw) || {};
        this.items     = parsed.items     || {};
        this.coupon    = parsed.coupon    || null;
        this.giftCard  = parsed.giftCard  || null;
        this.coupons   = Array.isArray(parsed.coupons)   ? parsed.coupons   : [];
        this.giftCards = Array.isArray(parsed.giftCards) ? parsed.giftCards : [];

        // migrate legacy single fields into arrays if needed
        if (this.coupon && !this.coupons.find(c => c.code === this.coupon.code)) {
          this.coupons.push(this.coupon);
        }
        if (this.giftCard && !this.giftCards.find(g => g.code === this.giftCard.code)) {
          this.giftCards.push(this.giftCard);
        }
      }
    } catch (e) {
      console.warn('cart load failed', e);
    }

    // Optional cross-tab instant notifications
    try { this._bc = ('BroadcastChannel' in window) ? new BroadcastChannel('cart') : null; } catch (_) { this._bc = null; }

    // Persist normalized state for consistency
    this._persist();
  },

  _persist() {
    try {
      localStorage.setItem('cart.v1', JSON.stringify({
        items: this.items,
        // keep legacy mirrors for old UI bits
        coupon: this.coupon,
        giftCard: this.giftCard,
        // store new arrays
        coupons: this.coupons,
        giftCards: this.giftCards
      }));
    } catch (e) {
      console.warn('cart persist failed', e);
    }
  },

  _notifyChange(reason = '') {
    // 1) reactive watchers in same tab
    this._version = Date.now();

    // 2) event listeners in same tab (widgets like avatars listen to this)
    window.dispatchEvent(new CustomEvent('cart:change', { detail: { version: this._version, reason }}));

    // 3) other tabs (near-instant; storage event also works but is less direct)
    if (this._bc) this._bc.postMessage({ type: 'cart:change', version: this._version, reason });
  },

  _persistAndNotify(reason = '') {
    this._persist();
    this._notifyChange(reason);
  },

  _pingBadge() {
    this._badgePulse = false;
    requestAnimationFrame(() => { this._badgePulse = true; });
    setTimeout(() => { this._badgePulse = false; }, 200);
  },

  // --- queries / helpers ---
  inCart(id) { id = String(id); return Object.prototype.hasOwnProperty.call(this.items, id); },
  qty(id)    { id = String(id); return this.items[id]?.qty ?? 0; },
  distinctCount() { return Object.keys(this.items).length; },
  countAll() { return Object.values(this.items).reduce((s, it) => s + (it?.qty || 0), 0); },

  imgFor(p = {}) {
    const candidates = [];

    // simple string field
    if (typeof p.image === 'string') candidates.push(p.image);

    // array of strings or objects
    if (Array.isArray(p.images) && p.images.length) {
      const first = p.images[0];
      if (typeof first === 'string') candidates.push(first);
      else if (first && typeof first === 'object') {
        if (typeof first.url === 'string') candidates.push(first.url);
        if (typeof first.src === 'string') candidates.push(first.src);
      }
    }

    // other common fallbacks
    ['thumbnail', 'img', 'photo', 'picture'].forEach(k => {
      if (typeof p[k] === 'string') candidates.push(p[k]);
    });

    const chosen = candidates.find(v => typeof v === 'string' && v.trim().length > 0);
    return chosen ? new URL(chosen, window.location.href).href : '';
  },

  list() {
    // normalize a flat view for table: { id, qty, product, price, priceBefore, image, name, badges }
    return Object.entries(this.items).map(([id, rec]) => {
      const p = rec.product || {};
      const price = Number(p.discounted_price ?? p.price ?? 0);
      const priceBefore = Number(p.price ?? price);

      return {
        id,
        qty: rec.qty,
        product: p,
        name: p.name || p.title || `Produkt #${id}`,
        image: this.imgFor(p),                 // normalized primary image
        badges: p.badges || p.labels || p.tags || [],
        price,
        priceBefore
      };
    });
  },

  // public wrappers used by templates
  linePrice(itOrId) {
    let it = itOrId;
    if (typeof itOrId !== 'object') {
      const id = String(itOrId);
      it = this.list().find(x => String(x.id) === id);
    }
    return it ? this._linePrice(it) : 0;
  },
  lineBefore(itOrId) {
    let it = itOrId;
    if (typeof itOrId !== 'object') {
      const id = String(itOrId);
      it = this.list().find(x => String(x.id) === id);
    }
    return it ? this._lineBefore(it) : 0;
  },

  _addCore(product) {
  const id = String(product.id);
  if (this.inCart(id)) { this.increment(id); return false; }
  this.items = { ...this.items, [id]: { qty: 1, product } };
  this._persistAndNotify('add');
  this._pingBadge();
  return true; // indicates a fresh add (wasn't in cart)
  },
  // --- mutations (now with persist + notify) ---
  add(product) {
    // normal CTA: add and open precart modal (no toast)
    const fresh = this._addCore(product);
    if (fresh) {
      // open pre-basket modal
      Alpine.store('precart')?.open(product);
    }
  },
  silentAdd(product) {
    // impulse add: add 1 pc quietly (no toast, no modal)
    this._addCore(product);
  },

  increment(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    this.items[id].qty++;
    this._persistAndNotify('increment');
    this._pingBadge();
  },

  decrement(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    const next = this.items[id].qty - 1;
    if (next <= 0) {
      const removedName = this.items[id].product?.name || `Produkt #${id}`;
      const copy = { ...this.items };
      delete copy[id];
      this.items = copy;
      Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
    } else {
      this.items[id].qty = next;
    }
    this._persistAndNotify('decrement');
    this._pingBadge();
  },

  setQty(id, raw) {
    id = String(id);
    let n = parseInt(raw, 10);
    if (!Number.isFinite(n) || n <= 0) {
      if (!this.inCart(id)) return;
      const removedName = this.items[id].product?.name || `Produkt #${id}`;
      const copy = { ...this.items };
      delete copy[id];
      this.items = copy;
      this._persistAndNotify('setQty/remove');
      this._pingBadge();
      Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
      return;
    }
    if (!this.inCart(id)) return;
    this.items[id].qty = n;
    this._persistAndNotify('setQty');
    this._pingBadge();
  },

  remove(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    const removedName = this.items[id].product?.name || `Produkt #${id}`;
    const copy = { ...this.items };
    delete copy[id];
    this.items = copy;
    this._persistAndNotify('remove');
    this._pingBadge();
    Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
  },

  clear() {
    this.items = {};
    this.coupon = null;
    this.giftCard = null;
    this.coupons = [];
    this.giftCards = [];
    this._persistAndNotify('clear');
    this._pingBadge();
  },

  // --- line & totals (Kč numbers, no formatting) ---
  _linePrice(it) { return Math.max(0, Number(it.price) * it.qty); },
  _lineBefore(it) { return Math.max(0, Number(it.priceBefore ?? it.price) * it.qty); },
  linePriceById(id) {
    const rec = this.list().find(x => String(x.id) === String(id));
    return rec ? this._linePrice(rec) : 0;
  },
  subtotal() {
    return this.list().reduce((s, it) => s + this._linePrice(it), 0);
  },
  totalBefore() {
    return this.list().reduce((s, it) => s + this._lineBefore(it), 0);
  },
  lineDiscount(it) {
    const per = Math.max(0, (it.priceBefore ?? it.price) - it.price);
    return per * it.qty;
  },
  totalDiscountsRaw() {
    return this.list().reduce((s, it) => s + this.lineDiscount(it), 0);
  },

  // --- promos (multi + legacy mirrors; capped at subtotal) ---
  applyCoupon(code) {
    const c = String(code || '').trim().toUpperCase();
    if (!c) return { ok:false, message:'Zadejte kód.' };

    // Demo catalog
    const catalog = {
      'SLEVA10': { code:'SLEVA10', type:'percent', value:10 },
      'SLEVA50': { code:'SLEVA50', type:'amount',  value:50 }
    };
    const found = catalog[c];
    if (!found) return { ok:false, message:'Neplatný kód kupónu.' };
    if (this.coupons.find(x => x.code === c)) return { ok:false, message:'Kupón již uplatněn.' };

    this.coupons = [...this.coupons, found];
    this.coupon = found; // legacy mirror (last applied)
    this._persistAndNotify('applyCoupon');
    return { ok:true };
  },

  // remove by code; if no code passed, clear all (keeps old templates happy)
  removeCoupon(code) {
    if (typeof code === 'string' && code.trim()) {
      const c = code.trim().toUpperCase();
      this.coupons = this.coupons.filter(x => x.code !== c);
    } else {
      this.coupons = [];
    }
    this.coupon = this.coupons[this.coupons.length - 1] || null; // mirror
    this._persistAndNotify('removeCoupon');
  },

  applyGiftCard(code) {
    const c = String(code || '').trim().toUpperCase();
    if (!c) return { ok:false, message:'Zadejte kód.' };

    const catalog = {
      'DAR100': { code:'DAR100', type:'amount', value:100 }
    };
    const found = catalog[c];
    if (!found) return { ok:false, message:'Neplatná dárková karta.' };
    if (this.giftCards.find(x => x.code === c)) return { ok:false, message:'Karta již uplatněna.' };

    this.giftCards = [...this.giftCards, found];
    this.giftCard = found; // legacy mirror
    this._persistAndNotify('applyGiftCard');
    return { ok:true };
  },

  removeGiftCard(code) {
    if (typeof code === 'string' && code.trim()) {
      const c = code.trim().toUpperCase();
      this.giftCards = this.giftCards.filter(x => x.code !== c);
    } else {
      this.giftCards = [];
    }
    this.giftCard = this.giftCards[this.giftCards.length - 1] || null; // mirror
    this._persistAndNotify('removeGiftCard');
  },

  // counts/lists for UI indicators & modals
  couponCount() { return this.coupons.length; },
  giftCardCount() { return this.giftCards.length; },
  listCoupons() { return this.coupons.slice(); },
  listGiftCards() { return this.giftCards.slice(); },

  promoDiscount() {
    const sub = this.subtotal();
    let d = 0;

    // coupons: percent + amount
    for (const c of (this.coupons || [])) {
      if (c.type === 'percent') d += Math.floor(sub * (c.value / 100));
      else if (c.type === 'amount') d += c.value;
    }
    // gift cards: amount
    for (const g of (this.giftCards || [])) {
      if (g.type === 'amount') d += g.value;
    }
    return Math.min(d, sub);
  },
  totalToPay() {
    return Math.max(0, this.subtotal() - this.promoDiscount());
  },

  // --- free shipping helpers ---
  freeShipProgress() {
    const t = Number(this.freeShipThreshold || 0);
    if (t <= 0) return 100;
    return Math.max(0, Math.min(100, Math.round((this.totalToPay() / t) * 100)));
  },
  freeShipMissing() {
    const missing = Number(this.freeShipThreshold || 0) - this.totalToPay();
    return Math.max(0, Math.ceil(missing));
  },
  hasFreeShipping() {
    const t = Number(this.freeShipThreshold || 0);
    if (t <= 0) return true;
    return this.totalToPay() >= t; // threshold reached?
  }
});



      // TOASTS
      Alpine.store('toast', {
    items: [],
    push(text, type = 'success', life = 3000) {
      const id = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)) + Date.now();
      const item = { id, text, type, show: true };
      this.items.push(item);
      // auto-hide after `life` ms
      item._lifeTimer = setTimeout(() => this.hide(id), life);
    },
    hide(id) {
      const t = this.items.find(i => i.id === id);
      if (!t || !t.show) return;
      t.show = false; // triggers leave transition
      // remove after transition finishes (keep in sync with duration-300)
      clearTimeout(t._removeTimer);
      t._removeTimer = setTimeout(() => this.remove(id), 320);
    },
    remove(id) {
      this.items = this.items.filter(t => t.id !== id);
    }
  });
    // PRODUCT DETAIL
  Alpine.data('productDetail', (opts = {}) => ({
    // ---- inputs ----
    id: opts.id ?? null,
    fetchUrl: opts.fetchUrl ?? null,      // e.g. `data/product-details/${params.id}.json`
    initialProduct: opts.product ?? null, // optional preloaded data

    // ---- state ----
    product: { badges: [], description: '', parameters: [] },
    images: [],
    variants: [],
    selectedVariant: null,
    currentImage: 0,
    ctaVisible: false,
    shareModal: { open: false, copied: false },
    askModal: { open: false, message: '', email: '', error: '', submitting: false },

    // ---- internal fetch guards ----
    _currentUrl: null,
    _abort: null,

    // ================================
    // Lifecycle
    // ================================
    async init() {
      this._ensureSavedStoreLoaded();
      this.$watch(() => this.product?.id, () => {
        this.shareModal.open = false;
        this.shareModal.copied = false;
        this.askModal.open = false;
        this.askModal.message = '';
        this.askModal.error = '';
        this.askModal.submitting = false;
      });

      // initial load
      if (this.fetchUrl) await this.load(this.fetchUrl);

      // simple sticky CTA visibility on scroll
      this._onScrollBound = () => { this.ctaVisible = (window.scrollY || 0) > 240; };
      window.addEventListener('scroll', this._onScrollBound, { passive: true });
    },

    // ================================
    // Data loading (re-usable)
    // ================================
    async load(url) {
      if (!url) return;
      if (url === this._currentUrl && !this.initialProduct) return; // nothing to do
      this._currentUrl = url;

      // cancel previous request if any
      if (this._abort) try { this._abort.abort(); } catch {}

      try {
        let data;
        if (this.initialProduct) {
          data = this.initialProduct;
        } else {
          const ctrl = new AbortController();
          this._abort = ctrl;
          const res = await fetch(url, { signal: ctrl.signal });
          if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
          data = await res.json();
        }

        this._applyData(data);
      } catch (e) {
        console.error('productDetail.load error:', e);
      } finally {
        this._abort = null;
      }
    },

    _applyData(data) {
      const d = data || {};
      this.product = d;

      // images: prefer array; fallback to single image
      const imgs = Array.isArray(d.images) ? d.images.slice() : (d.image ? [d.image] : []);
      this.images = imgs;
      this.currentImage = 0;

      // variants + default selection
      this.variants = Array.isArray(d.variants) ? d.variants.slice() : [];
      const def = this.variants.find(v => v.default) || this.variants[0] || null;
      this.selectedVariant = def;
    },

    // ================================
    // Price helpers (use selected variant if any)
    // ================================
    _n(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; },

    _activeItem() {
      // what the UI considers the "current purchasable item"
      return this.selectedVariant || this.product || {};
    },

    priceOriginal(item = null) {
      const it = item || this._activeItem();
      return this._n(it.price ?? this.product.price);
    },

    priceNow(item = null) {
      const it = item || this._activeItem();
      const d = this._n(it.discounted_price ?? this.product.discounted_price);
      const p = this.priceOriginal(it);
      return (d > 0 && d < p) ? d : p;
    },

    hasDiscount(item = null) {
      const it = item || this._activeItem();
      const p = this.priceOriginal(it);
      const d = this._n(it.discounted_price ?? this.product.discounted_price);
      return d > 0 && d < p;
    },

    discountPercent(item = null) {
      const it = item || this._activeItem();
      const p = this.priceOriginal(it);
      const n = this.priceNow(it);
      if (!p) return 0;
      return Math.round(100 - (n / p) * 100);
    },

    formatPrice(v) {
      return window.__fitMoney.format(v, { fromCurrency: 'CZK' });
    },

    // ================================
    // Variants / gallery
    // ================================
    selectVariant(id) {
      const v = this.variants.find(x => String(x.id) === String(id));
      this.selectedVariant = v || null;
    },

    // ================================
    // Cart CTA
    // ================================
    addToCartClick() {
      // Build a cart item compatible with your grid/cart store
      let item = { ...this.product };

      if (this.selectedVariant) {
        item = {
          ...item,
          // give variants unique ids to allow multiple variants in cart (string ids are fine)
          id: `${this.product.id}:${this.selectedVariant.id}`,
          name: `${this.product.name} – ${this.selectedVariant.name}`,
          price: this.priceOriginal(),
          discounted_price: this.hasDiscount() ? this.priceNow() : null
        };
      } else {
        // ensure prices are consistent even if product.json lacks them
        item.price = this.priceOriginal();
        item.discounted_price = this.hasDiscount() ? this.priceNow() : null;
      }

      try {
        if (this.$store?.cart?.add) this.$store.cart.add(item);
      } catch (e) {
        console.warn('Cart add failed (no $store.cart?)', e);
      }
    },

    // ================================
    // Saved products & customer actions
    // ================================
    _ensureSavedStoreLoaded() {
      try {
        this.$store?.saved?.load?.();
      } catch (e) {
        console.warn('Saved store unavailable', e);
      }
    },
    savedStore() {
      return this.$store?.saved || null;
    },
    buildSavedPayload() {
      const product = this.product || {};
      const variant = this.selectedVariant || null;
      const baseName = String(product.name || '').trim();
      const variantName = String(variant?.name || '').trim();
      const name = variant ? [baseName, variantName].filter(Boolean).join(' – ') : baseName;
      const galleryImage = Array.isArray(this.images)
        ? (this.images[this.currentImage] || this.images.find(Boolean))
        : null;
      const image = product.image || galleryImage || '';
      const payload = {
        id: product.id ?? null,
        name,
        image,
        price: this.priceOriginal(),
        discounted_price: this.hasDiscount() ? this.priceNow() : null,
        brand: product.brand || '',
        perex: product.perex || '',
      };
      if (variant?.id != null) payload.variantId = variant.id;
      if (product.slug) payload.slug = product.slug;
      if (product.url) payload.url = product.url;
      if (!payload.url) payload.url = this.shareUrl();
      return payload;
    },
    toggleSave() {
      const store = this.savedStore();
      const payload = this.buildSavedPayload();
      if (!store || !payload?.id) return;
      const saved = store.toggle(payload);
      const name = payload.name || 'Produkt';
      const toast = this.$store?.toast;
      if (saved) {
        toast?.push?.(`Uloženo: ${name}`, 'success');
      } else {
        toast?.push?.(`Odebráno z uložených: ${name}`, 'warning');
      }
    },
    isSavedCurrent() {
      const store = this.savedStore();
      return !!(store && store.isSaved(this.product?.id));
    },
    shareUrl() {
      const productId = this.product?.id;
      try {
        if (!productId) return window.location.href;
        const { origin, pathname } = window.location;
        return `${origin}${pathname}#/product/${productId}`;
      } catch {
        if (productId) return `#/product/${productId}`;
        return (typeof window !== 'undefined' && window.location?.href) || '#';
      }
    },
    openShareModal() {
      this.shareModal.open = true;
      this.shareModal.copied = false;
    },
    closeShareModal() {
      this.shareModal.open = false;
    },
    async copyShareLink() {
      const link = this.shareUrl();
      try {
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(link);
        } else {
          this._fallbackCopy(link);
        }
        this.shareModal.copied = true;
        this.$store?.toast?.push?.('Odkaz zkopírován do schránky.', 'success');
      } catch (e) {
        console.warn('Share copy failed', e);
        this.shareModal.copied = false;
        this.$store?.toast?.push?.('Nepodařilo se zkopírovat odkaz.', 'warning');
      }
    },
    async shareNative() {
      const link = this.shareUrl();
      if (navigator?.share) {
        try {
          await navigator.share({
            title: this.product?.name || 'Sdílení produktu',
            url: link
          });
          this.$store?.toast?.push?.('Sdílení bylo odesláno.', 'success');
          this.closeShareModal();
          return;
        } catch (e) {
          console.warn('Native share cancelled', e);
        }
      }
      await this.copyShareLink();
    },
    _fallbackCopy(text) {
      const area = document.createElement('textarea');
      area.value = text;
      area.setAttribute('readonly', '');
      area.style.position = 'absolute';
      area.style.left = '-9999px';
      document.body.appendChild(area);
      area.select();
      document.execCommand('copy');
      document.body.removeChild(area);
    },
    openAskModal() {
      this.askModal.open = true;
      this.askModal.error = '';
      this.askModal.submitting = false;
    },
    closeAskModal() {
      this.askModal.open = false;
      this.askModal.submitting = false;
    },
    async submitAsk() {
      const message = this.askModal.message?.trim();
      const email = this.askModal.email?.trim();

      if (!message) {
        this.askModal.error = 'Napište, prosím, váš dotaz.';
        return;
      }
      if (!this._isValidEmail(email)) {
        this.askModal.error = 'Zadejte platnou e-mailovou adresu.';
        return;
      }

      this.askModal.submitting = true;
      try {
        await new Promise(resolve => setTimeout(resolve, 350));
        this.$store?.toast?.push?.('Dotaz jsme přijali. Odpovíme e-mailem do 48 hodin.', 'success');
        this.askModal.message = '';
        this.askModal.error = '';
        this.askModal.open = false;
      } finally {
        this.askModal.submitting = false;
      }
    },
    _isValidEmail(email) {
      if (!email) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
  })); 

    // USER REVIEWS LIS
    Alpine.data('reviewsSection', (opts = {}) => ({
    url: opts.url ?? 'data/reviews.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        this.items = await res.json();
      } catch (e) {
        console.error('reviews load failed', e);
        this.error = 'Nepodařilo se načíst recenze.';
      } finally {
        this.loading = false;
      }
    },

    count() {
      return Array.isArray(this.items) ? this.items.length : 0;
    },
    average() {
      if (!this.count()) return 0;
      const sum = this.items.reduce((s, r) => s + Number(r.score || 0), 0);
      return +(sum / this.count()).toFixed(1);
    },

    // Build 5 icons for a given score (full/half/empty)
    starsFor(val) {
      const v = Math.max(0, Math.min(5, Math.round(Number(val) * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    }
  })),    
    //BENEFIT PAYMENTS
    Alpine.data('benefitsSection', (opts = {}) => ({
    url: opts.url ?? 'data/benefits.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // sort: available first, then name
        this.items = (Array.isArray(data) ? data : [])
          .sort((a,b) => (b.available - a.available) || String(a.name).localeCompare(String(b.name), 'cs'));
      } catch (e) {
        console.error('benefits load failed', e);
        this.error = 'Nepodařilo se načíst seznam benefitních karet.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; }
  })),

  // SEARCH AUTOCOMPLETE
  Alpine.data('searchBox', (opts = {}) => ({
  // --- config ---
  maxResults: 7,
  minChars: 2,
  storageKey: 'recentAny',   // stores typed recents

  // --- state ---
  q: '',
  open: false,
  highlighted: -1,
  recent: [],
  listId: `ac-${Math.random().toString(36).slice(2)}`,
  dropdownStyle: '',

  results: { products: [], categories: [], links: [], pharmacies: [] },
  isLoading: false,
  pharmacies: [], // preloaded for fast suggestions

  // --- lifecycle ---
  init() {
    this.loadRecent();
    this.$watch('open', v => { if (v) this.$nextTick(() => this.reposition()); });
    this.$watch('q',    () => { this.$nextTick(() => this.reposition()); });
    // preload pharmacies (uses your PharmacyIndex singleton)
    PharmacyIndex.load().then(data => { this.pharmacies = data || []; });
  },

  // --- positioning (desktop) ---
  reposition() {
    const a = this.$refs.anchor; if (!a) return;
    const r = a.getBoundingClientRect();
    const left  = Math.round(r.left), top = Math.round(r.bottom) + 8, width = Math.round(r.width);
    this.dropdownStyle =
      `position:fixed;left:${left}px;top:${top}px;` +
      `width:${width}px;min-width:${width}px;max-width:${width}px;box-sizing:border-box`;
  },
  onWindowResize() { if (this.open) this.reposition(); },
  onFocus() { this.open = true; this.reposition(); },
  onInput() { this.open = true; this.highlighted = -1; this.reposition(); },

  // --- recent (typed) ---
  loadRecent() {
    try { this.recent = JSON.parse(localStorage.getItem(this.storageKey) || '[]'); }
    catch { this.recent = []; }
  },
  saveRecent(item) {
    const key = JSON.stringify({ t: item.t, k: item.k }); // type + key
    const arr = [key, ...this.recent.filter(x => x !== key)].slice(0, 5);
    this.recent = arr;
    localStorage.setItem(this.storageKey, JSON.stringify(arr));
  },
  recentItems() {
    const resolve = (rk) => {
      let obj; try { obj = JSON.parse(rk); } catch { return null; }
      if (!obj || !obj.t) return null;
      if (obj.t === 'product') {
        const p = this.products.find(p => String(p.id) === String(obj.k));
        return p ? this.asProduct(p) : null;
      }
      if (obj.t === 'category') {
        const c = this.categories.find(c => (c.name || '').toLowerCase() === String(obj.k).toLowerCase());
        return c ? this.asCategory(c) : null;
      }
      if (obj.t === 'info') {
        const l = this.links.find(l => (l.name || '').toLowerCase() === String(obj.k).toLowerCase());
        return l ? this.asInfo(l) : null;
      }
      if (obj.t === 'pharmacy') {
        const p = this.pharmacies.find(x => String(x.id) === String(obj.k));
        return p ? this.asPharmacy(p) : null;
      }
      return null;
    };
    return this.recent.map(resolve).filter(Boolean).slice(0, 3);
  },

  // --- getters from opts (unchanged pattern) ---
  get products()   { return (opts.getProducts && opts.getProducts())   || []; },
  get categories() { return (opts.getCategories && opts.getCategories()) || []; },
  get links()      { return (opts.getLinks && opts.getLinks())         || []; },

  // --- normalization to a single row shape ---
  asProduct(p) {
    return {
      t: 'product',
      k: String(p.id),
      id: p.id,
      name: p.name,
      sub: `${p.stock || ''}${p.category ? ` • ${p.category}` : ''}`,
      img: p.image || null,
      icon: null,
      href: `#/product/${p.id}`,
      raw: p
    };
  },
  asCategory(c) {
    return {
      t:'category', k:String(c.name || ''), id:null,
      name:c.name, sub:`Kategorie • ${c.products ?? 0} produktů`,
      img:c.image || null, icon:null, raw:c
    };
  },
  asInfo(l) {
    const set = (l.iconSet || 'fa-regular').trim();
    const name = (l.icon || 'circle-info').trim();
    return {
      t:'info', k:String(l.name || ''), id:null,
      name:l.name, sub:l.description || '',
      img:null, icon:`${set} fa-${name}`, raw:l
    };
  },
  asPharmacy(p) {
    return {
      t: 'pharmacy',
      k: String(p.id),
      id: p.id,
      name: p.name,
      sub: `${p.address?.street || ''}${p.address?.city ? ` • ${p.address.city}` : ''}`,
      img: null,
      icon: p.type === 'box' ? 'fa-solid fa-box' : 'fa-solid fa-location-dot',
      href: '#/map',
      raw: p
    };
  },

  // --- scoring & suggestions (sync, includes pharmacies) ---
  suggestions() {
    const s = this.q.trim().toLowerCase();
    if (s.length < this.minChars) return [];

    const scoreText = (txt) => {
      const t = (txt || '').toLowerCase();
      if (!t) return 0;
      if (t.startsWith(s)) return 100;
      if (t.includes(s))  return 60;
      return 0;
    };

    // products
    const prod = this.products.map(p => {
      const a = this.asProduct(p);
      let sc = scoreText(p.name);
      sc += Math.min(20, scoreText(p.category));
      return { a, sc };
    });

    // categories
    const cats = this.categories.map(c => {
      const base = scoreText(c.name);
      const sc = base ? base + 10 : 0;
      return { a: this.asCategory(c), sc };
    });

    // info links
    const inf = this.links.map(l => {
      const a = this.asInfo(l);
      const sc = Math.max(scoreText(l.name), Math.floor(scoreText(l.description) / 2));
      return { a, sc };
    });

    // pharmacies (name + address bits)
    const ph = (this.pharmacies || []).map(p => {
      const a = this.asPharmacy(p);
      let sc = scoreText(p.name);
      sc = Math.max(sc, scoreText(p.address?.street));
      sc = Math.max(sc, scoreText(p.address?.city));
      sc = Math.max(sc, scoreText(p.address?.district));
      sc = Math.max(sc, scoreText(p.address?.zip));
      if (sc) sc += 5; // tiny boost to surface alongside others
      return { a, sc };
    });

    return [...prod, ...cats, ...inf, ...ph]
      .filter(x => x.sc > 0)
      .sort((x, y) => y.sc - x.sc || String(x.a.name).localeCompare(String(y.a.name), 'cs'))
      .map(x => x.a)
      .slice(0, this.maxResults);
  },

  visibleItems() {
    return (this.q.trim().length >= this.minChars) ? this.suggestions() : this.recentItems();
  },

  // --- actions ---
  selectByIndex(i) { const it = this.visibleItems()[i]; if (it) this.onSelect(it); },
  onSelect(item) {
    this.saveRecent(item);
    this.open = false;
    this.highlighted = -1;

    if (item.t === 'product' && item.id != null) {
      if (opts.goTo) opts.goTo(item.id);
      else location.hash = `#/product/${item.id}`;
      return;
    }

    if (item.t === 'pharmacy' && item.id != null) {
      location.hash = '#/map';
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('pharmacy:open', { detail: { id: item.id } }));
      }, 0);
      return;
    }

    // categories/info: wire routes if/when needed
  },

  clear() { this.q = ''; this.highlighted = -1; },

  // --- keyboard ---
  onKeydown(e) {
    if (!this.open && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) this.open = true;
    const items = this.visibleItems();
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault(); if (!items.length) return;
        this.highlighted = (this.highlighted + 1) % items.length;
        this.$nextTick(() => document.getElementById(this.itemId(this.highlighted))?.scrollIntoView({ block:'nearest' }));
        break;
      case 'ArrowUp':
        e.preventDefault(); if (!items.length) return;
        this.highlighted = (this.highlighted <= 0 ? items.length - 1 : this.highlighted - 1);
        this.$nextTick(() => document.getElementById(this.itemId(this.highlighted))?.scrollIntoView({ block:'nearest' }));
        break;
      case 'Enter':
        if (this.open) { e.preventDefault(); if (items.length) this.selectByIndex(this.highlighted >= 0 ? this.highlighted : 0); }
        break;
      case 'Escape':
        this.open = false; this.highlighted = -1; break;
    }
  },

  // --- ARIA ---
  itemId(i){ return `${this.listId}-opt-${i}`; },
  activeDesc(){ return this.highlighted >= 0 ? this.itemId(this.highlighted) : null; },
})),


    //PRODUCT COMPARISON
    Alpine.data('comparisonSection', (opts = {}) => ({
    url: opts.url ?? 'data/comparison.json',
    id:  opts.id ?? null,

    loading: true,
    error: null,
    items: [],   // products to compare (columns)

    async init() {
      if (!this.id) { this.loading = false; return; }
      await this.load(this.id);
    },

    async load(groupId) {
      this.loading = true; this.error = null;
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const groups = await res.json();
        const found = Array.isArray(groups) ? groups.find(g => Number(g.id) === Number(groupId)) : null;
        this.items = found?.product_comparison || [];
      } catch (e) {
        console.error('comparison load failed', e);
        this.error = 'Nepodařilo se načíst porovnání.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; },

    priceNow(p){
      const price = Number(p?.price ?? 0);
      const disc  = Number(p?.discounted_price ?? 0);
      // use discounted only if it exists and is lower than regular
      return (disc > 0 && disc < price) ? disc : price;
    },
    priceOriginal(p){ return Number(p?.price ?? 0); },

    unitLabel(p){
      const u = (p?.unit || '').trim();
      return u || 'jedn.';
    },

    pricePerUnit(p){
      const v = Number(p?.volume ?? 0);
      if (!v) return null;
      return this.priceNow(p) / v;
    },

    unitPriceText(p){
  const v = Number(p?.volume ?? 0);
  if (!v) return '—';
  const perUnitBase = this.pricePerUnit(p);
  const formatted = window.__fitMoney.format(perUnitBase, { fromCurrency: 'CZK' });
  return `${formatted} / ${this.unitLabel(p)}`;
    },

    fmtPrice(v){
      return window.__fitMoney.format(v, { fromCurrency: 'CZK' });
    },

    shortDesc(txt, n = 120){
      if (!txt) return '—';
      const t = String(txt).trim();
      return t.length > n ? t.slice(0, n - 1) + '…' : t;
    }
  })),

    // STORE CORE + ROUTER
    Alpine.data('storeApp', () => ({

// persisted prefs
locale: Alpine.$persist('cs-CZ').as('locale'),

// state
products: [],
categories: [],
forms: [],
consumersList: [],
navCategories: [],   
infoLinks: [],       
categoriesGrid: [],

search: '',
selectedCategory: '',
selectedForm: '',
selectedConsumers: [],            // multi
onlyInStock: false,
benefitOnly: false,
onlyDiscounted: false,
priceBounds: { min: 0, max: 0 },
priceMin: null,
priceMax: null,
priceQuickRanges: [],
activePriceRangeIndex: null,

sortOrder: '',
isLoading: true,
_filterTimer: null,
page: 1,
pageSize: 8,
showCount: 8,
skeletonBaseCount: 8,
_initialDataLoaded: false,

// router
route: 'products',
params: {},
topCats: [],
topBrands: [],
benefits: [],

// product detail state
detail: null,
brands: [],
blogPosts: [],

// checkout form state
contactFormSchema: [],
contactFormSections: [],
contactFormFieldMap: {},
contactFormValues: {},
contactFormErrors: {},
contactFormTouched: {},
contactFormGroups: {},
contactFormGroupToggles: {},
contactFormGroupMembers: {},
addressAutocompleteOptions: [],
addressAutocompleteLoaded: false,
addressFormLoaded: false,
addressFormLoading: false,
addressFormSubmitAttempted: false,
addressFormMessage: '',
checkoutFormData: null,
checkoutDeliveryMeta: null,
checkoutPaymentMeta: null,
checkoutReview: null,
checkoutConsents: {
  terms: false,
  privacy: false,
  marketing: false
},
reviewValidationErrors: [],
suppressCartRedirect: false,
paygateModal: {
  open: false,
  step: 'intro',
  amount: 0,
  timer: null
},



// ---- lifecycle ----
init() {
  // 1) Router: support BOTH hash routes & path (no-hash) homepage
  window.addEventListener('hashchange', () => this._onRoute());
  window.addEventListener('popstate',   () => this._onRoute()); // for back/forward when at "/"
  this._onRoute();

  // 2) Watchers -> reset paging + loader delay when anything changes
  const trigger = () => {
    this.page = 1;
    this.showCount = this.pageSize;
    this.scheduleDisplayDelay();
  };
  this.$watch('search', trigger);
  this.$watch('selectedCategory', trigger);
  this.$watch('selectedForm', trigger);
  this.$watch('selectedConsumers', trigger);
  this.$watch('onlyInStock', trigger);
  this.$watch('benefitOnly', trigger);
  this.$watch('onlyDiscounted', trigger);
  this.$watch('sortOrder', trigger);
  this.$watch('priceMin', trigger);
  this.$watch('priceMax', trigger);

  // keep page in range if results shrink
  this.$watch(() => this.filteredProducts().length, () => {
    this.page = Math.min(this.page, this.totalPages());
  });

  this.$watch(() => Alpine.store('cart')?.distinctCount?.(), (count) => {
    const hasItems = Number(count) > 0;
    if (!this.suppressCartRedirect && !hasItems && ['delivery-payment', 'addresses', 'purchase-review'].includes(this.route)) {
      this.redirectToCartIfEmpty();
    }
  });

  this._onLocaleChange = () => {
    this.reloadLocalizedContent();
  };
  window.addEventListener('fit:locale-change', this._onLocaleChange);
  this._onResize = () => this.updateResponsivePagination();
  window.addEventListener('resize', this._onResize);
  this.updateResponsivePagination(true);
  if (this.$el) {
    this.$el.addEventListener('alpine:destroy', () => {
      if (this._onLocaleChange) {
        window.removeEventListener('fit:locale-change', this._onLocaleChange);
        this._onLocaleChange = null;
      }
      if (this._onResize) {
        window.removeEventListener('resize', this._onResize);
        this._onResize = null;
      }
    });
  }

  // 3) Load data
  this.loadData().then(() => {
    // set initial catalog once data exists
    Alpine.store('precart').setCatalog(this.pagedProducts());
  });

  Alpine.store('cart').init?.();
  Alpine.store('legal').init();

  const refreshCatalog = () => Alpine.store('precart').setCatalog(this.pagedProducts());
  this.$watch('page', refreshCatalog);
  this.$watch('showCount', refreshCatalog);
  this.$watch(() => this.filteredProducts().length, refreshCatalog);
  this.$watch('search', refreshCatalog);
  this.$watch('selectedCategory', refreshCatalog);
  this.$watch('selectedForm', refreshCatalog);
  this.$watch('selectedConsumers', refreshCatalog);
  this.$watch('onlyInStock', refreshCatalog);
  this.$watch('benefitOnly', refreshCatalog);
  this.$watch('onlyDiscounted', refreshCatalog);
  this.$watch('sortOrder', refreshCatalog);
  this.$watch('priceMin', refreshCatalog);
  this.$watch('priceMax', refreshCatalog);

},
// Load brands.json (call from loadData or once on home)
async loadBrands() {
  try {
    const r = await fetch('data/brands.json');
    const arr = await r.json();
    this.brands = Array.isArray(arr) ? arr.filter(b => b?.name && b?.logo) : [];
  } catch (e) {
    console.warn('brands.json failed', e);
    this.brands = [];
  }
},

slugify(str = '') {
  return String(str || '')
    .normalize('NFKD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '') || '';
},
normalizeGridTile(tile = {}) {
  const label = String(tile.label || '').trim();
  const slug = String(tile.slug || '').trim() || this.slugify(label || tile.image || '');
  return {
    image: String(tile.image || '').trim(),
    label,
    background: String(tile.background || 'bg-base-200').trim(),
    slug
  };
},
setCategoriesGridFrom(source) {
  if (!Array.isArray(source)) {
    this.categoriesGrid = [];
    return;
  }
  const slugCount = new Map();
  this.categoriesGrid = source
    .map(tile => this.normalizeGridTile(tile))
    .filter(item => item.image && item.label)
    .map(item => {
      let slug = item.slug || this.slugify(item.label || item.image);
      if (!slug) slug = Math.random().toString(36).slice(2, 8);
      if (slugCount.has(slug)) {
        const next = slugCount.get(slug) + 1;
        slugCount.set(slug, next);
        slug = `${slug}-${next}`;
      } else {
        slugCount.set(slug, 1);
      }
      return { ...item, slug };
    });
},
async reloadLocalizedContent() {
  try {
    const [categoriesData, linksData, gridData] = await Promise.all([
      window.__fitI18n.loadData('data/categories.json'),
      window.__fitI18n.loadData('data/links.json'),
      window.__fitI18n.loadData('data/categories-grid.json')
    ]);
    this.navCategories = Array.isArray(categoriesData) ? categoriesData : [];
    this.infoLinks = Array.isArray(linksData) ? linksData : [];
    this.setCategoriesGridFrom(Array.isArray(gridData) ? gridData : []);
  } catch (err) {
    console.warn('reloadLocalizedContent failed', err);
  }
  await this.loadBlog();
},

async loadBlog() {
  try {
    const arr = await window.__fitI18n.loadData('data/blog.json');
    this.blogPosts = Array.isArray(arr)
      ? arr.filter(post => post?.title && post?.image)
      : [];
  } catch (e) {
    console.warn('blog.json failed', e);
    this.blogPosts = [];
  }
  return this.blogPosts;
},

blogFeatured(count = 6) {
  return Array.isArray(this.blogPosts) ? this.blogPosts.slice(0, count) : [];
},
blogLink(post) {
  const url = String(post?.link || '').trim();
  return url || '#';
},
readingTimeLabel(post) {
  const minutes = Number(post?.minutes_to_read);
  if (!Number.isFinite(minutes) || minutes <= 0) return 'Čtení';
  const abs = Math.round(minutes);
  const forms = ['minuta', 'minuty', 'minut'];
  const form = abs === 1 ? forms[0] : (abs >= 2 && abs <= 4 ? forms[1] : forms[2]);
  return `${abs} ${form} čtení`;
},
blogExcerpt(post, limit = 220) {
  const text = String(post?.perex || '').trim();
  if (!text) return '';
  return text.length > limit ? `${text.slice(0, limit - 1)}…` : text;
},

// Optional: call in loadData() after products/aux files load:
/// await this.loadBrands();

// Brand link (adapt later if you add brand filtering in router)
brandHref(b) { return this.link('products'); },

// Badge helpers (supports e.g. "Až -31%" or "3za2")
badgeText(b) {
  const t = String(b?.badge || '').trim();
  if (!t) return '';
  if (t.toLowerCase() === '3za2') return '3 za 2';
  return t;
},
badgeClass(b) {
  const t = String(b?.badge || '').toLowerCase();
  if (t === '3za2') return 'badge-warning';
  // default discount style
  return 'badge-error text-white';
},

// Per-key shuffle cache for brands
_brandCacheMap: {},   // { [key]: shuffledArray }
brandsShuffledFor(key, count = 18) {
  if (!key) return [];
  if (!Array.isArray(this._brandCacheMap[key])) {
    const src = Array.isArray(this.brands) ? this.brands : [];
    if (src.length === 0) return [];
    const arr = src.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    this._brandCacheMap[key] = arr;
  }
  return this._brandCacheMap[key].slice(0, count);
},
async loadData() {
  try {
    const res = await fetch('data/products.json');
    this.products = await res.json();

    // facets (unchanged)
    this.categories = [...new Set(this.products.map(p => p.category).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'cs'));
    this.forms = [...new Set(this.products.map(p => (p.form || '').trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'cs'));
    const cons = new Set();
    this.products.forEach(p => (Array.isArray(p.consumers) ? p.consumers : []).forEach(c => cons.add(c)));
    this.consumersList = [...cons].sort((a,b)=>a.localeCompare(b,'cs'));

    const priceValues = this.products
      .map(p => Number(p.discounted_price ?? p.price ?? 0))
      .filter(v => Number.isFinite(v) && v >= 0);
    if (priceValues.length) {
      const rawMin = Math.min(...priceValues);
      const rawMax = Math.max(...priceValues);
      const normalizedMax = Math.ceil(rawMax / 10) * 10;
      this.priceBounds = { min: 0, max: normalizedMax };
      this.priceMin = 0;
      this.priceMax = normalizedMax;
      this.priceQuickRanges = this.buildPriceQuickRanges(rawMin, rawMax, normalizedMax);
    } else {
      this.priceBounds = { min: 0, max: 0 };
      this.priceMin = 0;
      this.priceMax = 0;
      this.priceQuickRanges = [];
    }

    // 👉 optional data
    const categoriesJson = await window.__fitI18n.loadData('data/categories.json');
    this.navCategories = Array.isArray(categoriesJson) ? categoriesJson : [];
    const [linksData, gridData] = await Promise.all([
      window.__fitI18n.loadData('data/links.json'),
      window.__fitI18n.loadData('data/categories-grid.json')
    ]);
    this.infoLinks = Array.isArray(linksData) ? linksData : [];
    this.setCategoriesGridFrom(Array.isArray(gridData) ? gridData : []);

    // ---- HOMEPAGE derived data (lightweight heuristics) ----
    // pick top categories by product count
    const counts = {};
    this.products.forEach(p => { if (p.category) counts[p.category] = (counts[p.category] || 0) + 1; });
    this.topCats = Object.entries(counts)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 6)
      .map(([name]) => ({ name, image: this.categoryImage(name) }));

    // Top brands (from product.brand if present)
    const brandSet = new Set(this.products.map(p => (p.brand || '').trim()).filter(Boolean));
    this.topBrands = Array.from(brandSet).slice(0, 10).map(name => ({ name, logo: this.brandLogo(name) }));
    await this.loadBrands();
    await this.loadBlog();

  } catch (e) {
    console.error('Failed to load products.json', e);
    try {
      const categoriesJson = await window.__fitI18n.loadData('data/categories.json');
      this.navCategories = Array.isArray(categoriesJson) ? categoriesJson : [];
      const [linksData, gridData] = await Promise.all([
        window.__fitI18n.loadData('data/links.json'),
        window.__fitI18n.loadData('data/categories-grid.json')
      ]);
      this.infoLinks = Array.isArray(linksData) ? linksData : [];
      this.setCategoriesGridFrom(Array.isArray(gridData) ? gridData : []);
      await this.loadBlog();
    } catch {}
  } finally {
    this._initialDataLoaded = true;
    this.isLoading = false;
  }
},

updateResponsivePagination(force = false) {
  const nextSize = this._responsivePageSize();
  const prevSize = this.pageSize;
  if (!force && nextSize === prevSize) return;
  this.pageSize = nextSize;
  this.skeletonBaseCount = nextSize;
  if (force || this.page === 1) {
    this.showCount = nextSize;
  } else if (this.showCount < nextSize) {
    this.showCount = nextSize;
  } else if (prevSize !== nextSize && prevSize > 0) {
    const pagesCovered = Math.ceil(this.showCount / prevSize);
    this.showCount = pagesCovered * nextSize;
  }
},
_responsivePageSize() {
  const width = window.innerWidth || document.documentElement.clientWidth || 0;
  if (width >= 1536) return 10;      // 5 cols * 2 rows
  if (width >= 1280) return 8;       // 4 cols * 2 rows
  if (width >= 1024) return 6;       // 3 cols * 2 rows
  if (width >= 640)  return 4;       // 2 cols * 2 rows
  return 10;                         // mobile: show 10 items per page
},
skeletonPlaceholderCount() {
  return Math.max(this.skeletonBaseCount || this.pageSize || 4, 4);
},
_isCompactPagination() {
  if (typeof window === 'undefined') return false;
  const width = window.innerWidth || document.documentElement.clientWidth || 0;
  return width < 640;
},

// ---- scroll manager ----
_scrollStore: { home: 0, products: 0 },
_saveScroll(key = this.route) {
  this._scrollStore[key] = window.scrollY || window.pageYOffset || 0;
},
_restoreScroll(key = this.route) {
  const y = this._scrollStore[key] ?? 0;
  const restore = () => {
    if (this.isLoading) { requestAnimationFrame(restore); return; }
    setTimeout(() => { window.scrollTo({ top: y, left: 0, behavior: 'auto' }); }, 0);
  };
  requestAnimationFrame(restore);
},
_scrollToTopSoon() {
  requestAnimationFrame(() => window.scrollTo({ top: 0, left: 0, behavior: 'auto' }));
},

// ---- misc helpers ----
isDrMaxWomanEnabled() {
  const configStore = Alpine.store('appConfig');
  return !!configStore?.drMaxWomanPromo;
},
maxGradientClass() {
  return this.isDrMaxWomanEnabled()
    ? 'max-gradient max-gradient-woman'
    : 'max-gradient';
},
maxGradientVClass() {
  return this.isDrMaxWomanEnabled()
    ? 'max-gradient-v max-gradient-v-woman'
    : 'max-gradient-v';
},
truncate(str, max = 34) {
  const s = String(str || '');
  return s.length > max ? s.slice(0, max - 1) + '…' : s;
},
consumersLabel() {
  if (!this.selectedConsumers.length) {
    return window.t('routes.products.filters.sections.consumers.title', 'Vhodné pro');
  }
  return this.truncate(this.selectedConsumers.join(', '));
},
optionsLabel() {
  const on = [];
  if (this.onlyInStock)     on.push(window.t('routes.products.quickFilters.inStock', 'Pouze skladem'));
  if (this.benefitOnly)     on.push(window.t('routes.products.quickFilters.benefit', 'Lze platit benefity'));
  if (this.onlyDiscounted)  on.push(window.t('routes.products.quickFilters.discounted', 'Produkty v akci'));
  if (!on.length) {
    return window.t('routes.products.quickFilters.summary.default', 'Možnosti');
  }
  return this.truncate(on.join(', '));
},
buildPriceQuickRanges(_rawMin, rawMax, normalizedMax) {
  const maxBound = Math.ceil(Number(normalizedMax) || 0);
  if (!Number.isFinite(maxBound) || maxBound <= 0) return [];
  const segments = 4;
  const step = Math.max(10, Math.ceil(maxBound / segments / 10) * 10);
  const values = [];
  for (let i = 1; i <= segments; i++) {
    const candidate = Math.min(maxBound, step * i);
    if (!Number.isFinite(candidate) || candidate <= 0) continue;
    if (!values.includes(candidate)) values.push(candidate);
    if (candidate >= maxBound) break;
  }
  return values;
},
_formatPriceRangeLabel(minValue, maxValue) {
  if (!this.priceBounds) return '';
  const minBound = Number(this.priceBounds.min ?? 0);
  const maxBound = Number(this.priceBounds.max ?? 0);
  if (!Number.isFinite(minBound) || !Number.isFinite(maxBound)) return '';
  const min = Number.isFinite(Number(minValue)) ? Number(minValue) : minBound;
  const max = Number.isFinite(Number(maxValue)) ? Number(maxValue) : maxBound;
  const fmt = v => this._formatCurrencyValue(Math.max(0, v));
  const hasMin = min > minBound;
  const hasMax = max < maxBound;
  if (hasMin && hasMax) {
    return window.t('routes.products.filters.sections.price.range.between', '{min} – {max}', {
      min: fmt(min),
      max: fmt(max)
    });
  }
  if (hasMin) {
    return window.t('routes.products.filters.sections.price.range.from', 'Od {value}', {
      value: fmt(min)
    });
  }
  if (hasMax) {
    return window.t('routes.products.filters.sections.price.range.to', 'Do {value}', {
      value: fmt(max)
    });
  }
  return window.t('routes.products.filters.sections.price.range.full', '{min} – {max}', {
    min: fmt(minBound),
    max: fmt(maxBound)
  });
},
priceUpToLabel(maxValue) {
  if (!Number.isFinite(Number(maxValue))) return '';
  return window.t('routes.products.filters.sections.price.range.to', 'Do {value}', {
    value: this._formatCurrencyValue(Math.max(0, Number(maxValue)))
  });
},
priceFilterChipLabel() {
  if (this.activePriceRangeIndex !== null) {
    const maxVal = this.priceQuickRanges?.[this.activePriceRangeIndex];
    if (Number.isFinite(Number(maxVal))) return this.priceUpToLabel(maxVal);
  }
  if (!this._priceRangeActive()) return '';
  return this._formatPriceRangeLabel(this.priceMin, this.priceMax);
},
_formatCurrencyValue(value) {
  const num = Number(value ?? 0);
  return window.__fitMoney.format(num, { fromCurrency: 'CZK' });
},

// ---- homepage helpers (images/logos; adapt paths as needed) ----
categoryImage(name) {
  // prefer categories.json image if present
  const c = (this.navCategories || []).find(c => (c.name || c.title) === name);
  return c?.image || `./images/categories/${encodeURIComponent(name)}.webp`;
},
brandLogo(name) {
  // try local logo by brand name
  return `./images/brands/${encodeURIComponent(name)}.svg`;
},

// ---- product picks for home ----
topProducts(limit = 12) {
  // naive "featured": in stock & discounted first
  const list = [...this.products];
  list.sort((a,b)=>{
    const ad = (b.discount || 0) - (a.discount || 0);
    if (ad !== 0) return ad;
    return (b.inStock ? 1:0) - (a.inStock ? 1:0);
  });
  return list.slice(0, limit);
},
productsByCategory(cat, limit = 10) {
  return this.products.filter(p => p.category === cat).slice(0, limit);
},

// link helper router
link(name, params = {}) {
  if (name === 'home')    return '/';
  if (name === 'product') return `#/product/${params.id}${params.tab ? '/' + params.tab : ''}`;
  if (name === 'cart')    return '#/cart';
  if (name === 'config')  return '#/config';
  if (name === 'delivery-payment') return '#/delivery-payment';
  if (name === 'addresses') return '#/addresses';
  if (name === 'purchase-review') return '#/purchase-review';
  if (name === 'active-order') return '#/active-order';
  if (name === 'map')     return '#/map';
  if (name === 'my-account')     return '#/my-account';
  if (name === 'my-saved')     return '#/my-saved';
  return '#/products';
},

// --- Scroll indicators (no nested x-data) ---
tpShowLeft: false,
tpShowRight: false,
tpScrolled: false,
initStripe(el, leftKey = 'tpShowLeft', rightKey = 'tpShowRight') {
  const update = () => {
    if (!el) return;
    const { scrollLeft, scrollWidth, clientWidth } = el;
    this[leftKey]  = scrollLeft > 4;
    this[rightKey] = scrollLeft + clientWidth < scrollWidth - 4;
  };
  this.$nextTick(() => {
    update();
    el?.addEventListener('scroll', update, { passive: true });
    const ro = new ResizeObserver(update);
    el && ro.observe(el);
    window.addEventListener('orientationchange', update, { passive: true });
    window.addEventListener('resize', update, { passive: true });
  });
},

// --- Pricing helpers (supports discounted_price from your feed) ---
formatPrice(v) {
  return window.__fitMoney.format(v, { fromCurrency: 'CZK' });
},
currentPrice(p) {
  return (p?.discounted_price != null) ? Number(p.discounted_price) : Number(p?.price || 0);
},
crossedPrice(p) {
  if (p?.discounted_price != null) return Number(p?.price || 0);
  if (p?.oldPrice != null) return Number(p.oldPrice);
  return null;
},
discountPct(p) {
  const now = this.currentPrice(p);
  const was = this.crossedPrice(p);
  if (!was || !now || !(was > now)) return null;
  return Math.round(100 - (now / was) * 100);
},
isInStock(p) {
  // your schema: p.stock like "Skladem"
  return String(p?.stock || '').toLowerCase().includes('sklad');
},

// --- One-time shuffle per page load ---
_topProdCache: null,
// Source + per-key shuffle (unchanged logic, accepts any key)
_topSource() {
  const hasTopProducts = typeof this.topProducts === 'function';
  const hasTopPorudcts = typeof this.topPorudcts === 'function';
  if (hasTopProducts)  return this.topProducts(200);
  if (hasTopPorudcts)  return this.topPorudcts(200);
  return Array.isArray(this.products) ? this.products : [];
},
topProductsShuffledFor(key, count = 12) {
  if (!key) return [];
  if (!Array.isArray(this._topProdCacheMap[key])) {
    const src = this._topSource();
    if (!Array.isArray(src) || src.length === 0) return [];
    const arr = src.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    this._topProdCacheMap[key] = arr;
  }
  return this._topProdCacheMap[key].slice(0, count);
},
// ---- per-strip state (reactive) ----
_tpId: 0,
tpStates: {},            // { [key]: {left,right,scrolled} }
_topProdCacheMap: {},    // { [key]: shuffledArray }

// Register scroller with an explicit key (string) or auto-assigned if missing
registerTopStrip(el, key = null) {
  if (!el) return;
  const id = key || el.dataset.tpId || ('tp' + (++this._tpId));
  el.dataset.tpId = id;

  if (!this.tpStates[id]) this.tpStates[id] = { left: false, right: false, scrolled: false };

  const update = () => {
    const { scrollLeft, scrollWidth, clientWidth } = el;
    const st = this.tpStates[id];
    st.left  = scrollLeft > 4;
    st.right = scrollLeft + clientWidth < scrollWidth - 4;
    if (!st.scrolled && scrollLeft > 2) st.scrolled = true;
  };

  this.$nextTick(() => {
    update();
    el.addEventListener('scroll', update, { passive: true });
    const ro = new ResizeObserver(update);
    ro.observe(el);
    window.addEventListener('orientationchange', update, { passive: true });
    window.addEventListener('resize', update, { passive: true });
  });
},


go(to) {
  // special case: go to homepage WITHOUT hash
  if (to === 'home' || to === '/' || to === '') {
    // save scroll position of leaving route
    if (this.route === 'products') this._saveScroll('products');
    if (this.route !== 'home') this._saveScroll(this.route);
    window.history.pushState({}, '', window.location.pathname); // no hash
    this._onRoute(); // manually trigger since no 'hashchange'
    return;
  }

  const newHash = to.startsWith('#') ? to : ('#' + to.replace(/^#/, ''));
  if (location.hash === newHash) { this._onRoute(); return; }
  location.hash = newHash;
},

is(nameOrArr) {
  return Array.isArray(nameOrArr)
    ? nameOrArr.includes(this.route)
    : this.route === nameOrArr;
},

// ---- router ----
_onRoute() {
  const prevRoute = this.route;
  if (this.paygateModal?.open) {
    this.closePaygate(false);
  }

  // if there's no hash (or just "#") -> HOME
  const emptyOrHome = !location.hash || location.hash === '#';

  // Keep existing hash router when present
  const raw = emptyOrHome ? '' : (location.hash).replace(/^#\/?/, '');
  const [pathPart] = (raw || '').split('?');
  const seg = (pathPart || '').split('/').map(s => decodeURIComponent(s || ''));
  const [path, id, sub] = seg;

  if (emptyOrHome || path === '') {
    // default + fallback = HOME
    if (prevRoute === 'products') this._saveScroll('products');
    this.route = 'home';
    this.params = {};
    this._restoreScroll('home');
    return;
  }

  switch (path) {
    case 'products':
      this.route = 'products';
      this.params = {};
      this._restoreScroll('products');
      break;

    case 'cart':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'cart';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'config':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'config';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'delivery-payment':
      if (this.redirectToCartIfEmpty()) return;
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'delivery-payment';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'addresses':
      if (this.redirectToCartIfEmpty()) return;
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'addresses';
      this.params = {};
      this._scrollToTopSoon();
      this.loadCheckoutMeta();
      if (this.addressFormLoaded) {
        this.hydrateAddressFormValues();
      } else {
        Promise.resolve(this.ensureAddressForm()).then(() => this.hydrateAddressFormValues());
      }
      break;

    case 'purchase-review':
      if (this.redirectToCartIfEmpty()) return;
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'purchase-review';
      this.params = {};
      this._scrollToTopSoon();
      this.loadCheckoutMeta();
      this.loadCheckoutReviewFromStorage();
      const ensure = this.addressFormLoaded ? Promise.resolve() : this.ensureAddressForm();
      ensure.then(() => this.refreshCheckoutReview());
      this.resetCheckoutConsents();
      break;

    case 'active-order':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'active-order';
      this.params = {};
      this._scrollToTopSoon();
      this.closePaygate(false);
      const cartStore = Alpine.store('cart');
      if (cartStore?.distinctCount?.() > 0) {
        this.suppressCartRedirect = true;
        cartStore.clear();
      }
      this.checkoutReview = null;
      try { localStorage.removeItem('checkout.review'); } catch (_) {}
      this.suppressCartRedirect = false;
      break;
      
      case 'my-account':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'my-account';
      this.params = {};
      this._scrollToTopSoon();
      break;

      case 'my-saved':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'my-saved';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'map':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'map';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'product':
      if (prevRoute === 'products') this._saveScroll('products');
      if (id) {
        this.route = 'product';
        this.params = { id, tab: sub || 'desc' };
        this._scrollToTopSoon();
        this.loadDetail(id);
      } else {
        this.route = 'product';
        this.params = {};
        this._scrollToTopSoon();
      }
      break;

    default:
      // 🌟 Fallback to HOME (no hash)
      if (prevRoute === 'products') this._saveScroll('products');
      window.history.replaceState({}, '', window.location.pathname);
      this.route = 'home';
      this.params = {};
      this._restoreScroll('home');
  }
},


// ---- detail loading with single source of truth for price ----
async getDetailById(id) {
  const res = await fetch(`data/product-details/${id}.json`);
  if (!res.ok) throw new Error(`detail ${id} ${res.status}`);
  return await res.json();
},

_mergeDetailPrice(detailObj, id) {
  const gridItem = this.products.find(p => String(p.id) === String(id));
  if (gridItem) {
    detailObj.price = gridItem.price ?? detailObj.price;
    detailObj.discounted_price = gridItem.discounted_price ?? detailObj.discounted_price;
    // keep variant price aligned with grid, if single default variant
    if (Array.isArray(detailObj.variants) && detailObj.variants.length) {
      detailObj.variants = detailObj.variants.map(v => ({
        ...v,
        price: gridItem.price ?? v.price,
        discounted_price: gridItem.discounted_price ?? v.discounted_price
      }));
    }
  }
  return detailObj;
},

// add near your state
_detailReq: 0,           // request counter
currentDetailId: null,    // last successfully shown id

async loadDetail(id) {
  const myReq = ++this._detailReq;        // mark this request as the latest
  try {
    console.log('loadDetail ->', id);
    const d = await this.getDetailById(id);

    // if a newer request started meanwhile, ignore this response
    if (myReq !== this._detailReq) return;

    this.detail = this._mergeDetailPrice(d, id);
    this.currentDetailId = id;
  } catch (e) {
    if (myReq === this._detailReq) this.detail = null;
    console.error('Failed to load product detail', id, e);
  }
},

// ---- filter helpers ----
_priceRangeActive() {
  if (this.activePriceRangeIndex !== null) return true;
  if (!this.priceBounds) return false;
  const minBound = Number(this.priceBounds.min ?? 0);
  const maxBound = Number(this.priceBounds.max ?? 0);
  if (!Number.isFinite(minBound) || !Number.isFinite(maxBound)) return false;
  const currentMin = Number(this.priceMin ?? minBound);
  const currentMax = Number(this.priceMax ?? maxBound);
  return (Number.isFinite(currentMin) && currentMin > minBound) ||
         (Number.isFinite(currentMax) && currentMax < maxBound);
},
clampPrice(value, which = 'min') {
  if (!this.priceBounds) return;
  const minBound = Number(this.priceBounds.min ?? 0);
  const maxBound = Number(this.priceBounds.max ?? 0);
  if (!Number.isFinite(minBound) || !Number.isFinite(maxBound)) return;
  let num = Number(value);
  if (!Number.isFinite(num)) num = which === 'min' ? minBound : maxBound;
  this.activePriceRangeIndex = null;
  if (which === 'min') {
    const currentMax = Number(this.priceMax);
    const upper = Number.isFinite(currentMax) ? currentMax : maxBound;
    const next = Math.min(Math.max(num, minBound), upper);
    if (next !== this.priceMin) this.priceMin = next;
  } else {
    const lower = minBound;
    const next = Math.max(Math.min(num, maxBound), lower);
    if (next !== this.priceMax) this.priceMax = next;
    if (this.priceMin !== lower) this.priceMin = lower;
  }
},
resetPriceFilter() {
  this.activePriceRangeIndex = null;
  if (!this.priceBounds) return;
  const minBound = Number(this.priceBounds.min ?? 0);
  const maxBound = Number(this.priceBounds.max ?? minBound);
  if (Number.isFinite(minBound)) this.priceMin = minBound;
  if (Number.isFinite(maxBound)) this.priceMax = maxBound;
},
filteredCount() { return this.filteredProducts().length; },

sortOptions() {
  const label = (key, fallback) => window.t(`routes.products.sorting.options.${key}`, fallback);
  return [
    { value: 'priceAsc', label: label('priceAsc', 'Od nejlevnějšího') },
    { value: 'priceDesc', label: label('priceDesc', 'Od nejdražšího') },
    { value: 'alphaAsc', label: label('alphaAsc', 'Abecedně A–Z') },
    { value: 'alphaDesc', label: label('alphaDesc', 'Abecedně Z–A') }
  ];
},
sortOptionLabel(value) {
  const entry = this.sortOptions().find(opt => opt.value === value);
  return entry ? entry.label : window.t('routes.products.sorting.label', 'Řadit dle');
},
sortButtonLabel() {
  return this.sortOrder
    ? this.sortOptionLabel(this.sortOrder)
    : window.t('routes.products.sorting.label', 'Řadit dle');
},
sortLabel() {
  const base = window.t('routes.products.sorting.label', 'Řadit dle');
  return this.sortOrder
    ? `${base}: ${this.sortOptionLabel(this.sortOrder)}`
    : `${base}: ${window.t('routes.products.sorting.options.default', 'Doporučeno')}`;
},
toggleConsumer(val) {
  const i = this.selectedConsumers.indexOf(val);
  if (i >= 0) this.selectedConsumers.splice(i, 1);
  else this.selectedConsumers.push(val);
  this.selectedConsumers = [...this.selectedConsumers]; // normalize
},
applyPriceQuickRange(idx) {
  if (idx === null || typeof idx === 'undefined') {
    this.resetPriceFilter();
    return;
  }
  const index = Number(idx);
  if (!Number.isFinite(index) || index < 0) {
    this.resetPriceFilter();
    return;
  }
  const maxVal = Number(this.priceQuickRanges?.[index]);
  if (!Number.isFinite(maxVal) || !this.priceBounds) {
    this.resetPriceFilter();
    return;
  }
  const minBound = Number(this.priceBounds.min ?? 0);
  const maxBound = Number(this.priceBounds.max ?? maxVal);
  this.activePriceRangeIndex = index;
  this.priceMin = Number.isFinite(minBound) ? minBound : 0;
  this.priceMax = Math.min(maxVal, Number.isFinite(maxBound) ? maxBound : maxVal);
},

hasActiveFilters() {
  return !!(
    this.search ||
    this.selectedCategory ||
    this.selectedForm ||
    this.selectedConsumers.length ||
    this.onlyInStock ||
    this.benefitOnly ||
    this.onlyDiscounted ||
    this._priceRangeActive()
  );
},
activeFiltersCount() {
  let n = 0;
  if (this.search) n++;
  if (this.selectedCategory) n++;
  if (this.selectedForm) n++;
  n += this.selectedConsumers.length;
  if (this.onlyInStock) n++;
  if (this.benefitOnly) n++;
  if (this.onlyDiscounted) n++;
  if (this._priceRangeActive()) n++;
  return n;
},
clearFilters() {
  this.search = '';
  this.selectedCategory = '';
  this.selectedForm = '';
  this.selectedConsumers = [];
  this.onlyInStock = false;
  this.benefitOnly = false;
  this.onlyDiscounted = false;
  this.sortOrder = '';
  this.resetPriceFilter();
},

// ---- loader delay ----
scheduleDisplayDelay() {
  clearTimeout(this._filterTimer);
  this.isLoading = true;
  const delay = this._initialDataLoaded ? 1000 : 1000;
  this._filterTimer = setTimeout(() => {
    this.isLoading = false;
  }, delay);
},

// ---- filtering/sorting ----
filteredProducts() {
  let items = this.products;

  if (this.search) {
    const s = this.search.toLowerCase();
    items = items.filter(p =>
      (p.name || '').toLowerCase().includes(s) ||
      (p.description || '').toLowerCase().includes(s)
    );
  }
  if (this.selectedCategory) {
    items = items.filter(p => p.category === this.selectedCategory);
  }
  if (this.selectedForm) {
    items = items.filter(p => (p.form || '').trim() === this.selectedForm);
  }
  if (this.selectedConsumers.length) {
    items = items.filter(p => {
      const arr = Array.isArray(p.consumers) ? p.consumers : [];
      return this.selectedConsumers.some(c => arr.includes(c)); // ANY match
    });
  }
  if (this.onlyInStock) {
    items = items.filter(p => String(p.stock || '').toLowerCase().includes('sklad'));
  }
  if (this.benefitOnly) {
    items = items.filter(p => !!p.benefitPayment);
  }
  if (this.onlyDiscounted) {
    items = items.filter(p => {
      const d = Number(p.discounted_price || 0);
      const pr = Number(p.price || 0);
      return d > 0 && d < pr;
    });
  }
  if (this.priceBounds) {
    const minBound = Number(this.priceBounds.min ?? 0);
    const maxBound = Number(this.priceBounds.max ?? 0);
    const min = Number.isFinite(Number(this.priceMin)) ? Number(this.priceMin) : minBound;
    const max = Number.isFinite(Number(this.priceMax)) ? Number(this.priceMax) : maxBound;
    items = items.filter(p => {
      const price = Number(p.discounted_price ?? p.price ?? 0);
      if (!Number.isFinite(price)) return false;
      return price >= min && price <= max;
    });
  }

  if (this.sortOrder === 'priceAsc') {
    items = items.slice().sort((a, b) => (a.price ?? 0) - (b.price ?? 0));
  } else if (this.sortOrder === 'priceDesc') {
    items = items.slice().sort((a, b) => (b.price ?? 0) - (a.price ?? 0));
  } else if (this.sortOrder === 'alphaAsc') {
    items = items.slice().sort((a, b) => String(a.name).localeCompare(String(b.name), 'cs', {sensitivity:'base'}));
  } else if (this.sortOrder === 'alphaDesc') {
    items = items.slice().sort((a, b) => String(b.name).localeCompare(String(a.name), 'cs', {sensitivity:'base'}));
  }

  return items;
},

// ---- pagination (unchanged) ----
canLoadMoreFirstPage() {
  return this.page === 1 && this.showCount < this.filteredProducts().length;
},
loadMore() {
  const total = this.filteredProducts().length;
  this.showCount = Math.min(this.showCount + this.pageSize, total);
},
loadMoreLabel() {
  const remaining = this.filteredProducts().length - this.showCount;
  const n = Math.min(this.pageSize, Math.max(0, remaining));
  return n
    ? window.t('routes.products.results.loadMore', 'Načíst dalších {count} produktů', { count: n })
    : window.t('routes.products.results.loaded', 'Vše načteno');
},
totalPages() {
  const total = this.filteredProducts().length;
  if (total <= this.showCount) return 1;
  return 1 + Math.ceil((total - this.showCount) / this.pageSize);
},
pagedProducts() {
  const items = this.filteredProducts();
  if (this.page === 1) return items.slice(0, this.showCount);
  const start = this.showCount + (this.page - 2) * this.pageSize;
  return items.slice(start, start + this.pageSize);
},
pagesToShow() {
  const p = this.page, t = this.totalPages();
  if (this._isCompactPagination()) {
    if (t <= 5) return Array.from({ length: t }, (_, i) => i + 1);
    if (p <= 3) return [1, 2, 3, '…', t];
    if (p >= t - 2) return [1, '…', t - 2, t - 1, t];
    return [1, '…', p - 1, p, p + 1, '…', t];
  }
  if (t <= 7) return Array.from({ length: t }, (_, i) => i + 1);
  if (p <= 4) return [1, 2, 3, 4, 5, '…', t];
  if (p >= t - 3) return [1, '…', t - 4, t - 3, t - 2, t - 1, t];
  return [1, '…', p - 1, p, p + 1, '…', t];
},
// ---- checkout form helpers ----
async ensureAddressForm() {
  if (this.addressFormLoaded || this.addressFormLoading) return;
  this.addressFormLoading = true;
  try {
    const res = await fetch('data/forms/contacts-delivery.json', { cache: 'no-store' });
    const schema = await res.json();
    this.contactFormSchema = Array.isArray(schema) ? schema : [];
    this.initAddressForm(this.contactFormSchema);
  } catch (e) {
    console.warn('contacts-delivery.json load failed', e);
    this.contactFormSchema = [];
    this.initAddressForm([]);
  } finally {
    this.addressFormLoading = false;
  }
},

async loadAddressSuggestions() {
  if (this.addressAutocompleteLoaded) return this.addressAutocompleteOptions;
  try {
    const res = await fetch('data/addresses/prague.json', { cache: 'no-store' });
    const list = await res.json();
    const normalized = Array.isArray(list) ? list : [];
    this.addressAutocompleteOptions = normalized.map((item) => {
      const street = String(item.street ?? '').trim();
      const extra = String(item.extra ?? '').trim();
      const city = String(item.city ?? '').trim();
      const zip = String(item.zip ?? '').replace(/\s+/g, '');
      const label = String(item.label ?? `${street}, ${city}`).trim();
      const cityLine = [zip, city].filter(Boolean).join(' ');
      const district = String(item.district ?? '').trim();
      const search = [label, street, extra, city, zip, district].filter(Boolean).join(' ').toLowerCase();
      const fallbackId = `${street || 'addr'}-${zip || Math.random().toString(36).slice(2)}`;
      return {
        id: String(item.id ?? fallbackId),
        label: label || street,
        street,
        extra,
        city,
        zip,
        district,
        cityLine,
        search
      };
    });
  } catch (e) {
    console.warn('Failed to load address suggestions', e);
    this.addressAutocompleteOptions = [];
  } finally {
    this.addressAutocompleteLoaded = true;
  }
  return this.addressAutocompleteOptions;
},

loadCheckoutMeta() {
  const parse = (key) => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : null;
    } catch (e) {
      console.warn(`Failed to parse ${key}`, e);
      return null;
    }
  };
  this.checkoutDeliveryMeta = parse('checkout.delivery');
  this.checkoutPaymentMeta = parse('checkout.payment');
},

cartHasItems() {
  const cart = Alpine.store('cart');
  if (!cart || typeof cart.distinctCount !== 'function') return false;
  return cart.distinctCount() > 0;
},

redirectToCartIfEmpty() {
  if (this.cartHasItems()) return false;
  if (location.hash !== '#/cart' && location.hash !== '/cart') {
    location.hash = '/cart';
  } else {
    this.route = 'cart';
    this.params = {};
    this._scrollToTopSoon();
  }
  return true;
},

initAddressForm(schema = []) {
  const existingKeys = new Set();
  this.contactFormSections = [];
  this.contactFormFieldMap = {};
  this.contactFormValues = {};
  this.contactFormErrors = {};
  this.contactFormTouched = {};
  this.contactFormGroups = {};
  this.contactFormGroupToggles = {};
  this.contactFormGroupMembers = {};
  this.addressFormMessage = '';
  this.addressFormSubmitAttempted = false;

  schema.forEach((raw, idx) => {
    const sectionName = raw?.form_section || 'Ostatní';
    let section = this.contactFormSections.find(sec => sec.name === sectionName);
    if (!section) {
      section = { name: sectionName, fields: [] };
      this.contactFormSections.push(section);
    }
    const key = this.normalizeFieldKey(raw?.label || raw?.type || `field-${idx}`, idx, existingKeys);
    existingKeys.add(key);
    const field = {
      key,
      type: raw?.type || 'text',
      label: raw?.label || '',
      placeholder: raw?.placeholder || '',
      prefix: raw?.prefix || null,
      note: raw?.note || null,
      validations: Array.isArray(raw?.validations) ? raw.validations : [],
      section: sectionName,
      groupKey: raw?.fieldset_group || null,
      isToggle: raw?.type === 'checkbox_toggle_fieldset'
    };
    section.fields.push(field);
    this.contactFormFieldMap[key] = field;
    this.contactFormErrors[key] = [];
    this.contactFormTouched[key] = false;
    if (field.isToggle && field.groupKey) {
      this.contactFormGroupToggles[field.groupKey] = key;
      this.contactFormGroups[field.groupKey] = false;
    } else if (field.groupKey) {
      if (!this.contactFormGroupMembers[field.groupKey]) this.contactFormGroupMembers[field.groupKey] = [];
      this.contactFormGroupMembers[field.groupKey].push(key);
    }
    this.contactFormValues[key] = this.defaultFieldValue(field);
  });

  const saved = this.loadSavedAddressForm();
  this.checkoutFormData = saved;
  const savedValues = saved.values || {};
  const savedGroups = saved.groups || {};

  Object.entries(this.contactFormFieldMap).forEach(([key, field]) => {
    if (field.isToggle && field.groupKey) {
      const boolVal = typeof savedGroups[field.groupKey] === 'boolean'
        ? savedGroups[field.groupKey]
        : !!savedValues[key];
      this.contactFormGroups[field.groupKey] = boolVal;
      this.contactFormValues[key] = boolVal;
    } else if (field.groupKey && !(field.groupKey in this.contactFormGroups)) {
      this.contactFormGroups[field.groupKey] = false;
    }

    if (field.type === 'address') {
      this.contactFormValues[key] = this.normalizeAddressValue(savedValues[key] ?? this.contactFormValues[key]);
    } else if (!field.isToggle && Object.prototype.hasOwnProperty.call(savedValues, key)) {
      this.contactFormValues[key] = savedValues[key];
    }
  });

  this.addressFormLoaded = true;
},

normalizeFieldKey(label, idx, existingSet = new Set()) {
  const base = String(label || `field-${idx}`)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
  const seed = base || `field-${idx}`;
  let key = seed;
  let counter = 1;
  while (existingSet.has(key)) {
    key = `${seed}-${counter++}`;
  }
  return key;
},

defaultFieldValue(field) {
  if (!field) return '';
  switch (field.type) {
    case 'checkbox_toggle_fieldset':
    case 'checkbox':
      return false;
    case 'textarea':
    case 'text':
    case 'email':
    case 'tel':
      return '';
    case 'address':
      return { street: '', extra: '', city: '', zip: '' };
    default:
      return '';
  }
},

normalizeAddressValue(val) {
  if (val && typeof val === 'object') {
    return {
      street: String(val.street ?? val.line1 ?? '').trim(),
      extra: String(val.extra ?? val.line2 ?? '').trim(),
      city: String(val.city ?? '').trim(),
      zip: String(val.zip ?? '').trim()
    };
  }
  if (typeof val === 'string') {
    return { street: val.trim(), extra: '', city: '', zip: '' };
  }
  return { street: '', extra: '', city: '', zip: '' };
},

addressAutocomplete(fieldKey) {
  const store = this;
  return {
    fieldKey,
    query: '',
    open: false,
    highlighted: -1,
    init() {
      store.loadAddressSuggestions().then(() => {
        this.syncFromValue(store.contactFormValues[this.fieldKey]);
      });
      this.$watch(
        () => store.contactFormValues[this.fieldKey],
        (value) => this.syncFromValue(value)
      );
    },
    get filteredOptions() {
      const options = store.addressAutocompleteOptions || [];
      const q = this.query.trim().toLowerCase();
      if (!q) return options.slice(0, 8);
      return options.filter(opt => opt.search.includes(q)).slice(0, 8);
    },
    get hasValue() {
      const value = store.normalizeAddressValue(store.contactFormValues[this.fieldKey]);
      return !!(value.street || value.extra || value.city || value.zip);
    },
    get summaryBody() {
      return store.formatAddressDisplay(store.contactFormValues[this.fieldKey]);
    },
    openSuggestions() {
      this.open = true;
      if (this.highlighted === -1 && this.filteredOptions.length) {
        this.highlighted = 0;
      }
    },
    closeSuggestions() {
      this.open = false;
      this.highlighted = -1;
    },
    onInput(event) {
      this.query = event.target.value;
      const next = store.normalizeAddressValue(store.contactFormValues[this.fieldKey]);
      const updated = { ...next, street: this.query };
      store.contactFormValues[this.fieldKey] = updated;
      store.handleFieldInput(this.fieldKey);
      this.openSuggestions();
    },
    onBlur() {
      setTimeout(() => this.closeSuggestions(), 120);
      store.handleFieldBlur(this.fieldKey);
    },
    highlightNext() {
      if (!this.filteredOptions.length) return;
      this.openSuggestions();
      this.highlighted = (this.highlighted + 1) % this.filteredOptions.length;
    },
    highlightPrev() {
      if (!this.filteredOptions.length) return;
      this.openSuggestions();
      this.highlighted = this.highlighted <= 0 ? this.filteredOptions.length - 1 : this.highlighted - 1;
    },
    selectHighlighted() {
      if (this.highlighted < 0 || this.highlighted >= this.filteredOptions.length) return;
      this.selectOption(this.filteredOptions[this.highlighted]);
    },
    selectOption(opt) {
      const value = store.normalizeAddressValue(opt);
      store.contactFormValues[this.fieldKey] = value;
      store.handleFieldInput(this.fieldKey);
      store.handleFieldBlur(this.fieldKey);
      this.query = store.formatAddressLine(value);
      this.closeSuggestions();
    },
    clearSelection() {
      store.contactFormValues[this.fieldKey] = store.normalizeAddressValue({});
      this.query = '';
      store.handleFieldInput(this.fieldKey);
      store.handleFieldBlur(this.fieldKey);
      this.closeSuggestions();
    },
    syncFromValue(value) {
      const normalized = store.normalizeAddressValue(value);
      const current = store.normalizeAddressValue(store.contactFormValues[this.fieldKey]);
      if (!this.addressesEqual(normalized, current)) {
        store.contactFormValues[this.fieldKey] = normalized;
      }
      this.query = store.formatAddressLine(normalized);
    },
    addressesEqual(a, b) {
      if (!a && !b) return true;
      const keys = ['street', 'extra', 'city', 'zip'];
      return keys.every(k => String(a?.[k] ?? '') === String(b?.[k] ?? ''));
    }
  };
},

addressPlaceholder(field, part) {
  if (!field || field.type !== 'address') return undefined;
  const ph = field.placeholder;
  if (ph && typeof ph === 'object') {
    const val = ph?.[part];
    return val ? String(val) : undefined;
  }
  if (typeof ph === 'string') {
    return ph;
  }
  return undefined;
},

loadSavedAddressForm() {
  try {
    const raw = localStorage.getItem('checkout.addressForm');
    const parsed = raw ? JSON.parse(raw) : null;
    if (!parsed || typeof parsed !== 'object') return { values: {}, groups: {} };
    return {
      values: parsed.values && typeof parsed.values === 'object' ? parsed.values : {},
      groups: parsed.groups && typeof parsed.groups === 'object' ? parsed.groups : {},
      timestamp: parsed.timestamp || null
    };
  } catch (e) {
    console.warn('Failed to load saved address form', e);
    return { values: {}, groups: {} };
  }
},

hydrateAddressFormValues() {
  if (!this.addressFormLoaded) return;
  const saved = this.loadSavedAddressForm();
  this.checkoutFormData = saved;
  this.addressFormSubmitAttempted = false;
  this.addressFormMessage = '';
  const values = saved.values || {};
  const groups = saved.groups || {};
  Object.entries(this.contactFormFieldMap).forEach(([key, field]) => {
    if (field.isToggle && field.groupKey) {
      const boolVal = typeof groups[field.groupKey] === 'boolean'
        ? groups[field.groupKey]
        : !!values[key];
      this.contactFormGroups[field.groupKey] = boolVal;
      this.contactFormValues[key] = boolVal;
    } else if (field.type === 'address') {
      this.contactFormValues[key] = this.normalizeAddressValue(values[key] ?? this.contactFormValues[key]);
    } else if (!field.isToggle && Object.prototype.hasOwnProperty.call(values, key)) {
      this.contactFormValues[key] = values[key];
    }
    this.contactFormErrors[key] = [];
    this.contactFormTouched[key] = false;
  });
},

persistAddressForm() {
  const cloneValues = JSON.parse(JSON.stringify(this.contactFormValues));
  const payload = {
    values: cloneValues,
    groups: { ...this.contactFormGroups },
    timestamp: Date.now()
  };
  try {
    localStorage.setItem('checkout.addressForm', JSON.stringify(payload));
  } catch (e) {
    console.warn('Failed to persist address form', e);
  }
  this.checkoutFormData = payload;
},

isPickupDelivery() {
  const meta = this.checkoutDeliveryMeta;
  if (!meta) return false;
  const type = String(meta.type || '').toLowerCase();
  if (type === 'pickup') return true;
  if (!type && meta.pickup) return true;
  return false;
},

shouldShowSection(name) {
  if (!name) return true;
  const normalized = String(name).trim().toLowerCase();
  if (normalized === 'doručovací adresa') {
    return !this.isPickupDelivery();
  }
  return true;
},

isFieldVisible(field) {
  if (!field) return false;
  if (!this.shouldShowSection(field.section)) return false;
  if (field.isToggle) return true;
  if (!field.groupKey) return true;
  return !!this.contactFormGroups[field.groupKey];
},

isPhoneField(field) {
  if (!field) return false;
  if (field.type === 'tel') return true;
  const validations = Array.isArray(field.validations) ? field.validations : [];
  return validations.some(v => (v?.type || '').toLowerCase() === 'phone');
},

isFieldActive(field) {
  if (!field || field.isToggle) return false;
  if (!this.shouldShowSection(field.section)) return false;
  if (!field.groupKey) return true;
  return !!this.contactFormGroups[field.groupKey];
},

handleGroupToggle(fieldKey) {
  const field = this.contactFormFieldMap[fieldKey];
  if (!field || !field.groupKey) return;
  const value = !!this.contactFormValues[fieldKey];
  this.contactFormGroups[field.groupKey] = value;
  if (!value) {
    (this.contactFormGroupMembers[field.groupKey] || []).forEach(memberKey => {
      this.contactFormErrors[memberKey] = [];
      if (!this.addressFormSubmitAttempted) this.contactFormTouched[memberKey] = false;
    });
  } else if (this.addressFormSubmitAttempted) {
    (this.contactFormGroupMembers[field.groupKey] || []).forEach(memberKey => this.validateFieldByKey(memberKey));
  }
},

handleFieldBlur(fieldKey) {
  this.contactFormTouched[fieldKey] = true;
  this.validateFieldByKey(fieldKey);
},

handleFieldInput(fieldKey) {
  if (this.addressFormMessage) this.addressFormMessage = '';
  if (this.addressFormSubmitAttempted || this.contactFormTouched[fieldKey]) {
    this.validateFieldByKey(fieldKey);
  }
},

computeFieldErrors(field) {
  if (!this.isFieldActive(field)) return [];
  const value = this.contactFormValues[field.key];
  const errors = [];
  const rules = Array.isArray(field.validations) ? field.validations : [];
  const textValue = typeof value === 'string' ? value.trim() : value;

  for (const rule of rules) {
    const msg = rule?.fails || 'Zkontrolujte hodnotu';
    switch (rule?.type) {
      case 'required': {
        let ok = true;
        if (field.type === 'address') {
          const addr = this.normalizeAddressValue(value);
          ok = !!(addr.street && addr.city && addr.zip);
        } else if (typeof value === 'boolean') {
          ok = value;
        } else if (Array.isArray(value)) {
          ok = value.length > 0;
        } else {
          ok = String(textValue || '').length > 0;
        }
        if (!ok) errors.push(msg);
        break;
      }
      case 'email': {
        const v = String(value || '').trim();
        if (v && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
          errors.push(msg);
        }
        break;
      }
      case 'phone': {
        const digits = String(value || '').replace(/\D+/g, '');
        if (digits && digits.length !== 9) {
          errors.push(msg);
        }
        break;
      }
      case 'address': {
        const addr = this.normalizeAddressValue(value);
        const zipPlain = addr.zip.replace(/\s+/g, '');
        if (!(addr.street && addr.city && /^\d{5}$/.test(zipPlain))) {
          errors.push(msg);
        }
        break;
      }
      default:
        break;
    }
  }
  return Array.from(new Set(errors));
},

validateFieldByKey(fieldKey) {
  const field = this.contactFormFieldMap[fieldKey];
  if (!field) return [];
  const errs = this.computeFieldErrors(field);
  this.contactFormErrors[fieldKey] = errs;
  return errs;
},

validateAllFields() {
  let ok = true;
  this.contactFormSections.forEach(section => {
    if (!this.shouldShowSection(section.name)) return;
    section.fields.forEach(field => {
      if (field.isToggle) return;
      const errs = this.validateFieldByKey(field.key);
      if (errs.length) ok = false;
    });
  });
  return ok;
},

submitAddressForm() {
  if (!this.addressFormLoaded) return;
  this.addressFormSubmitAttempted = true;
  Object.keys(this.contactFormTouched).forEach(key => { this.contactFormTouched[key] = true; });
  const valid = this.validateAllFields();
  if (!valid) {
    this.addressFormMessage = 'Zkontrolujte zvýrazněné údaje ve formuláři.';
    return;
  }
  this.addressFormMessage = '';
  this.persistAddressForm();
  this.refreshCheckoutReview();
  this.resetCheckoutConsents();
  location.hash = '/purchase-review';
},

formatPhoneDisplay(val) {
  const digits = String(val || '').replace(/\D+/g, '');
  if (!digits) return '';
  return digits.replace(/(\d{3})(?=\d)/g, '$1 ').trim();
},

formatAddressLine(val) {
  const addr = this.normalizeAddressValue(val);
  const parts = [];
  if (addr.street) parts.push(addr.street);
  const cityLine = [addr.zip, addr.city].filter(Boolean).join(' ');
  if (cityLine) parts.push(cityLine);
  return parts.join(', ');
},

formatAddressDisplay(val) {
  const addr = this.normalizeAddressValue(val);
  const parts = [];
  if (addr.street) parts.push(addr.street);
  if (addr.extra) parts.push(addr.extra);
  const cityLine = [addr.zip, addr.city].filter(Boolean).join(' ');
  if (cityLine) parts.push(cityLine);
  return parts.join('\n');
},

formatFieldValue(field, value) {
  if (!field) return '';
  if (field.type === 'address') {
    return this.formatAddressDisplay(value);
  }
  if (this.isPhoneField(field)) {
    const trimmed = String(value || '').trim();
    if (!trimmed) return '';
    const formatted = this.formatPhoneDisplay(trimmed);
    return field.prefix ? `${field.prefix} ${formatted}` : formatted;
  }
  return String(value ?? '').trim();
},

sectionSummary(sectionName, saved = null) {
  const data = saved || this.checkoutFormData || this.loadSavedAddressForm();
  const section = this.contactFormSections.find(sec => sec.name === sectionName);
  if (!section) return [];
  const values = data.values || {};
  const groups = data.groups || {};

  return section.fields
    .filter(field => {
      if (field.isToggle) return false;
      if (field.groupKey && !groups[field.groupKey]) return false;
      const formatted = this.formatFieldValue(field, values[field.key]);
      return formatted.length > 0;
    })
    .map(field => ({
      label: field.label,
      value: this.formatFieldValue(field, values[field.key])
    }));
},

groupSummary(groupName, saved = null) {
  const data = saved || this.checkoutFormData || this.loadSavedAddressForm();
  const groups = data.groups || {};
  if (!groups[groupName]) return [];
  const values = data.values || {};
  const keys = this.contactFormGroupMembers[groupName] || [];
  return keys
    .map(key => this.contactFormFieldMap[key])
    .filter(Boolean)
    .map(field => ({
      label: field.label,
      value: this.formatFieldValue(field, values[field.key])
    }))
    .filter(entry => entry.value.length > 0);
},

checkoutCartSummary() {
  const cart = Alpine.store('cart');
  if (!cart) {
    return { items: [], totals: { subtotal: 0, discounts: 0, toPay: 0 } };
  }
  const items = cart.list().map(it => ({
    id: it.id,
    name: it.product?.name || it.name || '',
    qty: it.qty,
    price: cart._linePrice(it),
    unitPrice: it.price,
    image: it.image
  }));
  return {
    items,
    totals: {
      subtotal: cart.subtotal(),
      discounts: cart.promoDiscount(),
      toPay: cart.totalToPay()
    }
  };
},

isSelectedPaymentOnline() {
  const name = (this.checkoutReview?.payment?.name || this.checkoutPaymentMeta?.name || '').toLowerCase();
  const patterns = ['kartou online', 'benefitní kartou online'];
  return patterns.some(label => name.includes(label));
},

paygateTotal() {
  const toNumber = (value) => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  const cartTotal = toNumber(this.checkoutReview?.cart?.totals?.toPay || 0);
  const delivery = toNumber(this.checkoutReview?.delivery?.finalPrice || 0);
  const payment = toNumber(this.checkoutReview?.payment?.finalPrice || 0);
  const total = cartTotal + delivery + payment;
  return total > 0 ? total : 0;
},

openPaygate() {
  if (this.paygateModal.open) return;
  if (this.route !== 'purchase-review') {
    this.finalizePurchase();
    return;
  }
  this.refreshCheckoutReview();
  const amount = this.paygateTotal();
  if (amount <= 0) {
    this.paygateModal.open = false;
    this.paygateModal.step = 'intro';
    this.paygateModal.amount = 0;
    this.syncPaygateModal();
    this.finalizePurchase();
    return;
  }
  this.paygateModal.amount = amount;
  this.paygateModal.step = 'intro';
  this.paygateModal.open = true;
  this.$nextTick(() => this.syncPaygateModal());
},

startPaygateProcessing() {
  if (this.paygateModal.step !== 'intro') return;
  this.paygateModal.step = 'processing';
  if (this.paygateModal.timer) {
    clearTimeout(this.paygateModal.timer);
    this.paygateModal.timer = null;
  }
  this.paygateModal.timer = setTimeout(() => {
    this.paygateModal.step = 'success';
    if (this.paygateModal.timer) {
      clearTimeout(this.paygateModal.timer);
      this.paygateModal.timer = null;
    }
    this.paygateModal.timer = setTimeout(() => {
      this.closePaygate(true);
    }, 2000);
  }, 2000);
},

closePaygate(proceed = false) {
  if (this.paygateModal.timer) {
    clearTimeout(this.paygateModal.timer);
    this.paygateModal.timer = null;
  }
  this.paygateModal.open = false;
  this.paygateModal.step = 'intro';
  this.paygateModal.amount = 0;
  this.syncPaygateModal();
  if (proceed) {
    this.finalizePurchase();
  }
},

paygateManualCancel() {
  if (this.paygateModal.step !== 'intro') return;
  this.closePaygate(false);
},

syncPaygateModal() {
  const dialog = this.$refs?.paygate;
  if (!dialog) return;
  try {
    if (this.paygateModal.open) {
      if (typeof dialog.showModal === 'function' && !dialog.open) {
        dialog.showModal();
      }
    } else {
      if (typeof dialog.close === 'function' && dialog.open) {
        dialog.close();
      }
      if (typeof dialog.removeAttribute === 'function') {
        dialog.removeAttribute('open');
      }
    }
  } catch (e) {
    console.warn('paygate modal sync failed', e);
  }
},

finalizePurchase() {
  this.closePaygate(false);
  const reviewSnapshot = this.checkoutReview || this.refreshCheckoutReview();
  const orderStore = Alpine.store('activeOrder');
  if (orderStore && typeof orderStore.createFromCheckout === 'function') {
    try {
      orderStore.createFromCheckout({
        review: reviewSnapshot,
        deliveryMeta: this.checkoutDeliveryMeta,
        paymentMeta: this.checkoutPaymentMeta
      });
    } catch (e) {
      console.warn('activeOrder: failed to create order snapshot', e);
    }
  }
  this.reviewValidationErrors = [];
  this.suppressCartRedirect = true;
  const cart = Alpine.store('cart');
  cart?.clear?.();
  this.checkoutReview = null;
  try { localStorage.removeItem('checkout.review'); } catch (_) {}
  location.hash = '/active-order';
},

refreshCheckoutReview() {
  this.loadCheckoutMeta();
  if (!this.addressFormLoaded && !this.contactFormSections.length && this.contactFormSchema.length) {
    this.initAddressForm(this.contactFormSchema);
  }
  const saved = this.checkoutFormData || this.loadSavedAddressForm();
  this.checkoutFormData = saved;
  const review = {
    contact: this.sectionSummary('Kontaktní údaje', saved),
    deliveryDetails: this.groupSummary('Podrobnosti k doručení', saved),
    companyDetails: this.groupSummary('Firemní údaje', saved),
    delivery: this.checkoutDeliveryMeta,
    payment: this.checkoutPaymentMeta,
    cart: this.checkoutCartSummary()
  };
  this.checkoutReview = review;
  try { localStorage.setItem('checkout.review', JSON.stringify(review)); }
  catch (e) { console.warn('Failed to persist checkout review', e); }
  return review;
},

formatCZK(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return window.__fitMoney.format(0, { fromCurrency: 'CZK' });
  return window.__fitMoney.format(num, { fromCurrency: 'CZK' });
},

resetCheckoutConsents() {
  this.checkoutConsents = { terms: false, privacy: false, marketing: false };
  this.reviewValidationErrors = [];
},

purchaseReviewReady() {
  return !!(this.checkoutConsents.terms && this.checkoutConsents.privacy);
},

submitPurchaseReview() {
  if (!this.purchaseReviewReady()) {
    this.reviewValidationErrors = ['Potvrďte souhlas s obchodními podmínkami a zásadami zpracování osobních údajů.'];
    return;
  }
  this.reviewValidationErrors = [];
  if (this.isSelectedPaymentOnline()) {
    this.openPaygate();
    return;
  }
  this.finalizePurchase();
},

loadCheckoutReviewFromStorage() {
  try {
    const raw = localStorage.getItem('checkout.review');
    const parsed = raw ? JSON.parse(raw) : null;
    if (parsed && typeof parsed === 'object') {
      this.checkoutReview = parsed;
    }
  } catch (e) {
    console.warn('Failed to load checkout review', e);
  }
}

})),

  // HAMBURGER MENU  
  Alpine.store('menu', {
    // state
    open: false,
    menus: [],
    current: null,     // active menu object
    stack: [],         // for back navigation
    slideDir: 1,       // 1 forward, -1 back (animation)
    viewKey: 0,        // bump to retrigger pane animation
    loading: false,
    error: null,

    _currentLocale: null,
    async load(url = 'data/menus.json') {
      const locale = (Alpine.store('i18n')?.locale) || window.__fitI18n.defaultLocale;
      if (this._currentLocale && this._currentLocale !== locale) {
        this.menus = [];
      }
      if (this.menus.length) return;
      this.loading = true; this.error = null;
      try {
        const raw = await window.__fitI18n.loadData(url, { locale });
        this.menus = Array.isArray(raw) ? this.normalize(raw) : [];
        this._currentLocale = locale;
        window.dispatchEvent(new CustomEvent('fit:menu-loaded', { detail: { locale } }));
      } catch (e) {
        console.error('menu load failed', e);
        this.error = 'Nepodařilo se načíst menu.';
      } finally {
        this.loading = false;
      }
    },

    refreshForLocale() {
      this.menus = [];
      this.load();
    },

    // Accepts either my camelCase schema or your snake_case + single-string icon
    normalize(arr){
      const normItem = (it = {}) => {
        const out = { ...it };

        // snake_case -> camelCase
        if (out.link_to_menu_id != null) out.linkMenuId = out.link_to_menu_id;
        if (out.router_link) out.route = out.router_link;
        if (out.row_type) out.rowType = out.row_type;

        // icon: "fa-regular capsules" -> { iconSet:'fa-regular', icon:'capsules' }
        if (!out.iconSet && typeof out.icon === 'string' && out.icon.includes(' ')) {
          const [set, name] = out.icon.split(/\s+/, 2);
          out.iconSet = set;
          out.icon = name;
        }

        return out;
      };

      return (arr || []).map(m => ({
        id: m.id,
        parentId: m.parentId ?? m.parent ?? null,
        name: m.name,
        banner: !!m.banner,
        bannerProductId: (m.bannerProductId != null && !Number.isNaN(Number(m.bannerProductId)))
          ? Number(m.bannerProductId)
          : null,
        footer_position: (m.footer_position != null && !Number.isNaN(Number(m.footer_position)))
          ? Number(m.footer_position)
          : null,
        // some menus have root items, some only sections – handle both
        items: Array.isArray(m.items) ? m.items.map(normItem) : [],
        sections: Array.isArray(m.sections)
          ? m.sections.map(s => ({
              name: s.name ?? null,
              tag: s.tag ?? null,
              type: s.type ?? null,     // 'language' / 'loyalty' / undefined
              items: Array.isArray(s.items) ? s.items.map(normItem) : []
            }))
          : []
      }));
    },

    // helpers
    byId(id){ return this.menus.find(m => Number(m.id) === Number(id)); },
    canGoBack(){ return this.stack.length > 0 || (this.current && this.current.parentId != null); },

    // open from anywhere; default id by screen (lg desktop -> 2, mobile -> 1)
    async openAt(id = null) {
      await this.load();
      if (id == null) {
        id = window.matchMedia('(min-width: 1024px)').matches ? 2 : 1;
      }
      this.stack = [];
      this.slideDir = 1;
      this.current = this.byId(id) || null;
      this.viewKey++;
      this.open = true;
      document.documentElement.style.overflow = 'hidden'; // lock scroll
    },

    close() {
      this.open = false;
      this.stack = [];
      this.current = null;
      document.documentElement.style.overflow = '';
    },

    goToMenu(id) {
      if (!id) return;
      if (!this.current || Number(this.current.id) !== Number(id)) {
        if (this.current) this.stack.push(this.current.id);
        this.slideDir = 1;
        this.current = this.byId(id) || this.current;
        this.viewKey++;
      }
    },

    back() {
      if (!this.canGoBack()) { this.close(); return; }
      const prevId = this.stack.pop() ?? this.current?.parentId;
      if (prevId != null) {
        this.slideDir = -1;
        this.current = this.byId(prevId) || this.current;
        this.viewKey++;
      }
    },

    // click handlers
    onItemClick(item) {
      if (item.linkMenuId != null) {
        this.goToMenu(item.linkMenuId);
        return;
      }
      if (item.route) {
        location.hash = '#/' + String(item.route).replace(/^#?\/?/, '');
        this.close();
        return;
      }
      // no link/route: no-op
    }
  }),
  
  Alpine.data('menuPortal', () => ({
    product: null,
    visible: false,
    isDesktop: window.matchMedia('(min-width: 768px)').matches,
    _mq: null,
    _mqHandler: null,
    _products: null,
    _productsPromise: null,
    _currentMenuId: null,
    _onMenuLoaded: null,
    _onLocaleChange: null,

    init() {
      this._mq = window.matchMedia('(min-width: 768px)');
      this._mqHandler = (event) => {
        this.isDesktop = event.matches;
        this.evaluate();
      };
      if (this._mq?.addEventListener) this._mq.addEventListener('change', this._mqHandler);
      else if (this._mq?.addListener) this._mq.addListener(this._mqHandler);

      this.$watch('$store.menu.open', () => this.evaluate());
      this.$watch('$store.menu.viewKey', () => this.evaluate());
      this.$watch(() => {
        const current = Alpine.store('menu')?.current;
        return current ? current.id : null;
      }, () => this.evaluate());

      this._onMenuLoaded = () => this.evaluate();
      window.addEventListener('fit:menu-loaded', this._onMenuLoaded);

      this._onLocaleChange = () => {
        this._products = null;
        this._productsPromise = null;
        this.evaluate();
      };
      window.addEventListener('fit:locale-change', this._onLocaleChange);

      if (this.$el) {
        this.$el.addEventListener('alpine:destroy', () => this.destroy());
      }

      this.evaluate();
    },

    destroy() {
      if (this._mq?.removeEventListener) this._mq.removeEventListener('change', this._mqHandler);
      else if (this._mq?.removeListener) this._mq.removeListener(this._mqHandler);
      if (this._onMenuLoaded) window.removeEventListener('fit:menu-loaded', this._onMenuLoaded);
      if (this._onLocaleChange) window.removeEventListener('fit:locale-change', this._onLocaleChange);
    },

    async evaluate() {
      const store = Alpine.store('menu');
      const current = store?.current;
      const shouldShow = !!(this.isDesktop && store?.open && current && current.banner);
      if (!shouldShow) {
        this.visible = false;
        this._currentMenuId = null;
        return;
      }

      if (!this.product || this._currentMenuId !== current.id) {
        this.product = await this.pickProduct(current);
        this._currentMenuId = current.id;
      }

      this.visible = !!this.product;
    },

    async pickProduct(menu) {
      const list = await this.ensureProducts();
      if (!Array.isArray(list) || !list.length) return null;

      const requestedId = Number(menu?.bannerProductId);
      if (Number.isFinite(requestedId)) {
        const match = list.find(p => Number(p.id) === requestedId);
        if (match) return match;
      }

      const menuName = String(menu?.name || '').toLowerCase();
      let candidate = list.find(p => String(p.category || '').toLowerCase().includes(menuName));
      if (!candidate) candidate = list.find(p => p.discounted_price != null);
      return candidate || list[0];
    },

    async ensureProducts() {
      if (Array.isArray(this._products)) return this._products;
      if (this._productsPromise) return this._productsPromise;

      this._productsPromise = fetch('data/products.json', { cache: 'no-store' })
        .then(res => res.json())
        .then(arr => Array.isArray(arr) ? arr : [])
        .catch(err => {
          console.warn('menu banner products load failed', err);
          return [];
        })
        .then(arr => {
          this._products = arr;
          return arr;
        });

      return this._productsPromise;
    },

    formatPrice(value) {
      try {
        return window.__fitMoney.format(value, { fromCurrency: 'CZK' });
      } catch {
        const num = Number(value || 0);
        return Number.isFinite(num) ? `${num.toFixed(0)} CZK` : '—';
      }
    },

    currentPrice(product) {
      const price = product?.discounted_price != null
        ? Number(product.discounted_price)
        : Number(product?.price || 0);
      return Number.isFinite(price) ? price : 0;
    },

    crossedPrice(product) {
      if (product?.discounted_price != null) return Number(product?.price || 0);
      if (product?.oldPrice != null) return Number(product.oldPrice);
      return null;
    },

    discountPct(product) {
      const now = this.currentPrice(product);
      const was = this.crossedPrice(product);
      if (!was || !now || !(was > now)) return null;
      return Math.round(100 - (now / was) * 100);
    },

    link(name, params = {}) {
      if (name === 'product') return `#/product/${params.id ?? ''}`;
      if (name === 'cart') return '#/cart';
      return '#/products';
    }
  })),
  
  // PRODUCT RATING
    Alpine.data('ratingLine', (src = {}) => ({
    avg: Number(src?.average ?? 0),
    count: Number(src?.count ?? 0),

    set(r){
      this.avg = Number(r?.average ?? 0);
      this.count = Number(r?.count ?? 0);
    },

    // array of 5 slots: 'full' | 'half' | 'empty'
    stars() {
      const v = Math.max(0, Math.min(5, Math.round(this.avg * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    },

    fmtAvg(){ return (isFinite(this.avg) ? this.avg : 0).toFixed(1); },

    hasRating(){ return Number(this.count) > 0; }
  })),

      // CATEGORIES LIST
      Alpine.data('categoriesList', () => ({
      categories: [],
      fallback: './images/placeholder.png',

      async init() {
        const res = await fetch('./data/categories.json');
        const raw = await res.json();
        this.categories = Array.isArray(raw) ? raw.map(cat => this.normalizeCategory(cat)) : [];
      },

      normalizeCategory(cat) {
        const base = { ...cat };
        const appearance = { ...(cat?.appearance || {}) };
        if (cat?.icon && !appearance.icon) appearance.icon = cat.icon;
        if (cat?.bg && !appearance.backgroundClass) appearance.backgroundClass = cat.bg;
        if (cat?.backgroundClass && !appearance.backgroundClass) appearance.backgroundClass = cat.backgroundClass;
        if (cat?.backgroundToken && !appearance.backgroundToken) appearance.backgroundToken = cat.backgroundToken;
        if (cat?.background && !appearance.background) appearance.background = cat.background;
        if (cat?.iconClass && !appearance.iconClass) appearance.iconClass = cat.iconClass;
        if (cat?.iconToken && !appearance.iconToken) appearance.iconToken = cat.iconToken;
        if (cat?.iconColor && !appearance.iconColor) appearance.iconColor = cat.iconColor;
        if (cat?.iconShadow && !appearance.iconShadow) appearance.iconShadow = cat.iconShadow;
        if (Object.keys(appearance).length) base.appearance = appearance;
        else delete base.appearance;
        return base;
      },

      imageUrl(cat) {
        const base = (cat.image || '').trim();
        const withSlug = base.endsWith('/') ? `${base}${this.slug(cat.name)}.webp` : base;
        return base ? withSlug : this.fallback;
      },

      isIconTile(cat) {
        return !!(cat?.appearance && cat.appearance.icon);
      },

      squareClass(cat) {
        const app = cat?.appearance || {};
        const cls = [];
        if (app.backgroundClass) cls.push(app.backgroundClass);
        if (!cls.length && !this.isIconTile(cat)) cls.push('bg-base-200');
        return cls.join(' ');
      },

      squareStyle(cat) {
        const app = cat?.appearance || {};
        const styles = [];
        if (app.backgroundGradient) styles.push(`background:${app.backgroundGradient}`);
        else if (app.background) styles.push(`background:${app.background}`);
        else if (app.backgroundToken) styles.push(`background:${this.tokenToVar(app.backgroundToken)}`);
        return styles.join(';');
      },

      iconClass(cat) {
        const app = cat?.appearance || {};
        const cls = [];
        if (app.icon) cls.push(app.icon);
        if (app.iconClass) cls.push(app.iconClass);
        if (!cls.length) cls.push('fa-solid fa-circle-info');
        if (!cls.some(c => /text-/i.test(c))) cls.push('text-lg md:text-2xl');
        return cls.join(' ');
      },

      iconStyle(cat) {
        const app = cat?.appearance || {};
        const styles = [];
        if (app.iconToken) styles.push(`color:${this.tokenToVar(app.iconToken)}`);
        else if (app.iconColor) styles.push(`color:${app.iconColor}`);
        if (app.iconShadow) styles.push(`text-shadow:${app.iconShadow}`);
        return styles.join(';');
      },

      hrefFor(cat) {
        const route = String(cat?.route || '').trim();
        if (!route || route.toUpperCase() === 'TBD') return '#';
        const normalized = route.replace(/^#/,'').replace(/^\/+/, '');
        return normalized ? `#/${normalized}` : '#';
      },

      handleClick(cat, event) {
        const href = this.hrefFor(cat);
        if (!href || href === '#') {
          event.preventDefault();
          return;
        }
        if (href.startsWith('#/')) {
          event.preventDefault();
          window.location.hash = href.slice(1);
        }
      },

      slug(str) {
        return str
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      },

      tokenToVar(token) {
        const raw = String(token || '').trim();
        if (!raw) return '';
        if (/^var\(/.test(raw) || raw.startsWith('#') || raw.startsWith('rgb') || raw.startsWith('hsl') || raw.includes('gradient')) {
          return raw;
        }
        const cleaned = raw.replace(/^--/, '');
        return `var(--${cleaned})`;
      },

      productsLabel(n) {
        if (n === 1) return '1 produkt';
        if (n >= 2 && n <= 4) return `${n} produkty`;
        return `${n} produktů`;
      },
    }))
    })
    // other helpers
      
    
    function qtyBlinker(id){
    return {
      alpha: 0,           // 0..1 opacity
      _phaseTimer: null,  // timer for fade-out
      init(){
        this.$watch(
          () => (Alpine.store('cart')?.qty(String(id)) ?? 0),
          (next, prev) => { if (next !== prev) this.blink(); }
        );
      },
      blink(ms = 1000){
        // Clear any ongoing fade-out
        clearTimeout(this._phaseTimer);
        this.alpha = 0;
        requestAnimationFrame(() => { this.alpha = 1; });
        const hold = Math.max(200, ms - 200);
        this._phaseTimer = setTimeout(() => { this.alpha = 0; }, hold);
      }
    }
  }
  </script>
<script>
  //MAP LOGIC
  function pickupMapUI(cfg) {
    const pngs = {
      pharmacy: { normal: './images/map/pharmacy.png', selected: './images/map/pharmacy_selected.png' },
      box: { normal: './images/map/box.png', selected: './images/map/box_selected.png' },
      'z-box': { normal: './images/map/zasilkovna.png', selected: './images/map/zasilkovna_selected.png' },
      shadow: './images/map/shadow.png'
    };
    const prague = [50.0755, 14.4378];
    const placeholderImg = './images/pup-photos/placeholder.webp';
    const normalizedCenter = Array.isArray(cfg?.defaultCenter) && cfg.defaultCenter.length === 2
      ? cfg.defaultCenter.map((value, idx) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : prague[idx];
        })
      : prague;
    const normalizedZoom = Number.isFinite(Number(cfg?.defaultZoom))
      ? Number(cfg.defaultZoom)
      : 12;
  
    return {
      // CONFIG
      jsonUrl: cfg?.jsonUrl || './data/map-points.json',
      tracestrackKey: cfg?.tracestrackKey || '',
      enableClustering: !!cfg?.enableClustering,
      defaultCenter: normalizedCenter,
      defaultZoom: normalizedZoom,

      // STATE
      map: null,
      cluster: null,
      all: [],
      filtered: [],
      markers: new Map(),
      selected: null,
      mode: 'map',
      modeBeforeDetail: null,
      search: '',
      district: '',
      typeFilter: 'pharmacy',
      defaultType: 'pharmacy',
      districts: ['Praha 1','Praha 2','Praha 3','Praha 4','Praha 5','Praha 6','Praha 7','Praha 8','Praha 9','Praha 10'],
      types: [],
      typeOptions: [],
      typeLabels: {},
      fabOpen: false,
      placeholderImg,
      enableGeolocateOnLoad: true,   
      geolocateOncePerSession: true, 
      userMarker: null,
      userAccuracy: null,
      _bodyLocked: false,
      _prevOverflow: '',
      _inited: false,
      selectionContext: null,

      // RESPONSIVE FLAGS
      isMd: false,
      isLg: false,
  
      // COMPUTED
      get filterActive(){
        const defaultType = this.defaultType || 'pharmacy';
        const typeActive = this.typeFilter && this.typeFilter !== defaultType;
        return !!(this.search || this.district || typeActive);
      },
      get filterSummary(){ return `Zobrazuji ${this.filtered.length} z ${this.all.length}`; },
  
      // HELPERS
      updateBreakpoints() {
        this.isMd = window.matchMedia('(min-width: 768px)').matches;
        this.isLg = window.matchMedia('(min-width: 1024px)').matches;
      },
      hasCluster() { return !!(this.cluster && typeof this.cluster.addLayer === 'function'); },
      withMap(cb) {
        if (this.map) { cb(this.map); return true; }
        this.$nextTick(() => { if (this.map) cb(this.map); });
        return false;
      },
  
      async init() {
        if (this._inited) return; this._inited = true;

        this.updateBreakpoints();
        this._onResize = () => this.updateBreakpoints();
        window.addEventListener('resize', this._onResize);

        await this.loadData();
        this.lockBody();

        this.$nextTick(async () => {
          await this.ensureVisibleSize();

          this.initMap();
          this.renderMarkers();

          this.withMap(m => {
            m.setView(this.defaultCenter, this.defaultZoom);
            setTimeout(() => m.invalidateSize(false), 0);
          });
  
          if (this.enableGeolocateOnLoad) {
            const key = 'geoPrompted';
            const already = this.geolocateOncePerSession && sessionStorage.getItem(key);
            if (!already) {
              this.locateUser();              
              if (this.geolocateOncePerSession) sessionStorage.setItem(key, '1');
            }
          }

            // Observe container size changes
            const host = this.$refs?.mapEl || document.getElementById('map');
            if (host && !this._ro) {
              const target = host.parentElement || host;
              this._ro = new ResizeObserver(() => this.withMap(m => m.invalidateSize(false)));
              this._ro.observe(target);
            }
  
            // Listen for external invalidate requests (from mapPane)
            if (host) {
              this._onInvalidate = () => this.withMap(m => m.invalidateSize(false));
              window.addEventListener('map:invalidate', this._onInvalidate);
            }
          });

  
        // Global open-from-search
        this._onOpenPharmacy = (e) => {
          const id = e.detail?.id; if (!id) return;
          const p = this.all.find(x => x.id === id); if (!p) return;
          this.selected = p; this.updateMarkerIcons();
          const latlng = [p.coords.lat, p.coords.lng];
          const marker = this.markers.get(p.id);
  
          const goto = () => {
            this.withMap(m => {
              m.setView(latlng, Math.max(m.getZoom(), 15), { animate: true });
            });
            if (marker && this.hasCluster() && this.cluster.hasLayer(marker)) {
              this.cluster.zoomToShowLayer(marker, () => marker.setZIndexOffset(1000));
            }
          };
  
          if (!this.isLg) {
            this.mode = 'map';
            this.$nextTick(() => {
              this.withMap(m => m.invalidateSize(false));
              goto();
            });
          } else {
            goto();
          }
        };
        window.addEventListener('pharmacy:open', this._onOpenPharmacy);
  
        // Cleanup
        window.addEventListener('beforeunload', () => this.teardown());
      },
  
      async ensureVisibleSize(el) {
        el = el
        || this.$refs?.mapEl?.parentElement
        || this.$refs?.mapEl
        || document.getElementById('map')?.parentElement
        || document.getElementById('map');
      if (!el) return;

      const hasSize = () => el.offsetWidth > 0 && el.offsetHeight > 0;
      if (hasSize()) {
        // double-check next frame to avoid mid-transition
        await new Promise(r => requestAnimationFrame(r));
        if (hasSize()) return;
      }

      await new Promise(resolve => {
        let readyFrames = 0;
        const tick = () => {
          if (hasSize()) {
            readyFrames++;
            if (readyFrames >= 2) { cleanup(); resolve(); return; }
          } else {
            readyFrames = 0;
          }
          raf = requestAnimationFrame(tick);
        };

        const ro = new ResizeObserver(() => { /* just trigger next raf tick */ });
        ro.observe(el);

        let raf = requestAnimationFrame(tick);
        const cleanup = () => { try { ro.disconnect(); } catch(_){} cancelAnimationFrame(raf); };
        // safety timeout (in case no resize ever fires)
        setTimeout(() => { cleanup(); resolve(); }, 1500);
      });
    },

      teardown() {
        if (!this._inited) return;
        if (this._onResize) window.removeEventListener('resize', this._onResize), this._onResize = null;
        if (this._onOpenPharmacy) window.removeEventListener('pharmacy:open', this._onOpenPharmacy), this._onOpenPharmacy = null;
        if (this._onHashChange) window.removeEventListener('hashchange', this._onHashChange), this._onHashChange = null;
        if (this._onPickupSelected) window.removeEventListener('pickup:selected', this._onPickupSelected), this._onPickupSelected = null;
        if (this._ro) { try { this._ro.disconnect(); } catch(_) {} this._ro = null; }
        const host = this.$refs?.mapEl || document.getElementById('map');
        if (this._onInvalidate) { window.removeEventListener('map:invalidate', this._onInvalidate); this._onInvalidate = null; }
        if (this.cluster) { try { this.cluster.clearLayers(); } catch(_) {} }
        if (this.map) { try { this.map.remove(); } catch(_) {} this.map = null; }
        if (host && host._leaflet_id) try { host._leaflet_id = null; } catch(_) {}
        window.__pickupMap = null;
        this.clearSelectionContext();
        this.unlockBody();
        this._inited = false;
      },
  
      async loadData() {
        const json = await window.__fitI18n.loadData(this.jsonUrl);
        const source = Array.isArray(json) ? json : [];
        this.all = source.map(p => {
          const type = (p.type || '').toLowerCase();
          const entry = {
            ...p,
            type,
            coords: { lat: +p.coords.lat, lng: +p.coords.lng },
            searchIndex: [p.name, type, p.address?.street, p.address?.city, p.address?.district, p.address?.zip]
            .filter(Boolean).join(' ').toLowerCase()
          };
          return entry;
        });
        const uniqueTypes = Array.from(new Set(this.all.map(p => (p.type || '').toLowerCase()).filter(Boolean)));
        this.types = uniqueTypes;
        this.typeLabels = uniqueTypes.reduce((acc, t) => {
          acc[t] = this.formatTypeLabel(t);
          return acc;
        }, {});
        this.defaultType = uniqueTypes.includes('pharmacy') ? 'pharmacy' : 'all';
        this.typeOptions = this.buildTypeOptions();
        this.selectionContext = this.loadSelectionContext();
        const ctxType = this.normalizeTypeParam(this.selectionContext?.mapType, uniqueTypes);
        const initialType = this.normalizeTypeParam(this.extractTypeParam(), uniqueTypes) ?? ctxType ?? this.defaultType;
        this.typeFilter = initialType;
        this.applyFilters();
        if (this.selectionContext?.selectedId) {
          const selectedId = this.selectionContext.selectedId;
          const selectedPoint = this.all.find(p => String(p.id) === String(selectedId));
          if (selectedPoint) {
            this.selected = selectedPoint;
            this.$nextTick(() => {
              this.updateMarkerIcons();
              this.selectFromMap(selectedPoint);
            });
          }
        }

        this._onHashChange = () => {
          const hash = location.hash || '';
          if (!hash.startsWith('#/map')) {
            this.teardown();
            return;
          }
          this.lockBody();
          const typeFromHash = this.normalizeTypeParam(this.extractTypeParam(), this.types);
          const next = typeFromHash ?? this.defaultType;
          if (next !== this.typeFilter) {
            this.typeFilter = next;
            this.applyFilters();
            this.fabOpen = false;
          }
        };
        window.addEventListener('hashchange', this._onHashChange);
      },
  
      initMap() {
        const el = this.$refs.mapEl || document.getElementById('map');
        if (!el) return;
  
        // Clean reused node / previous instance
        if (el._leaflet_id) {
          try { if (window.__pickupMap && window.__pickupMap._container === el) window.__pickupMap.remove(); } catch(_) {}
          el.innerHTML = '';
          try { el._leaflet_id = null; } catch(_) {}
        }
        if (window.__pickupMap && window.__pickupMap.remove) {
          try { window.__pickupMap.remove(); } catch(_) {}
          window.__pickupMap = null;
        }
  
        // Create map
        this.map = L.map(el, { zoomControl: true, attributionControl: true });
  
        // Tiles
        if (this.tracestrackKey) {
          L.tileLayer(
            'https://tile.tracestrack.com/topo/{z}/{x}/{y}.png?key=' + this.tracestrackKey,
            { maxZoom: 19, attribution: '&copy; Tracestrack, &copy; OpenStreetMap contributors' }
          ).addTo(this.map);
        } else {


          L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          subdomains: 'abcd', maxZoom: 19,
          attribution: '© OpenStreetMap contributors, © CARTO'
        }).addTo(this.map);
        }
  
        // Clustering (optional)
        this.cluster = null;
        if (this.enableClustering && L && typeof L.markerClusterGroup === 'function') {
          this.cluster = L.markerClusterGroup({
            showCoverageOnHover:false, spiderfyOnMaxZoom:true, disableClusteringAtZoom:16
          }).addTo(this.map);
        }
    // Simple custom control: "Locate me"
    const LocateControl = L.Control.extend({
      onAdd: () => {
        const btn = L.DomUtil.create('button', 'leaflet-bar');
        btn.setAttribute('type','button');
        btn.style.cssText = 'background:#fff;border:2px solid rgba(0, 0, 0, 0.2);width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer';
        btn.innerHTML = '<i class="fa-solid fa-location-crosshairs fa-xl"></i>';
        btn.title = 'Najít moji polohu';
        L.DomEvent.on(btn, 'click', (e) => { L.DomEvent.stopPropagation(e); this.locateUser(); });
        return btn;
      },
      onRemove: () => {}
    });
    this.map.addControl(new LocateControl({ position: 'topleft' }));


        window.__pickupMap = this.map;
      },
  
      iconFor(p, isSelected=false) {
        const typeIcons = pngs[p.type] || pngs.pharmacy;
        const url = isSelected ? typeIcons.selected : typeIcons.normal;
        return L.icon({
          iconUrl: url, iconSize: [32, 42], iconAnchor: [16, 40],
          popupAnchor: [0, -38], shadowUrl: pngs.shadow, shadowSize: [36, 20], shadowAnchor: [10, 20]
        });
      },
  
      renderMarkers() {
        const clustered = this.hasCluster();
  
        if (clustered) this.cluster.clearLayers();
        this.markers.forEach(m => { try { m.remove(); } catch(_) {} });
        this.markers.clear();
  
        const list = this.filtered;

        list.forEach(p => {
          const m = L.marker([p.coords.lat, p.coords.lng], { icon: this.iconFor(p) })
            .on('click', () => this.selectFromMap(p));
          this.markers.set(p.id, m);
          if (clustered) this.cluster.addLayer(m);
          else this.withMap(mm => m.addTo(mm));
        });
  
        if (list.length) {
          const b = L.latLngBounds(list.map(p => [p.coords.lat, p.coords.lng]));
          this.withMap(mm => mm.fitBounds(b.pad(0.2)));
        }

      },
  
      updateMarkerIcons() {
        this.all.forEach(p => {
          const m = this.markers.get(p.id);
          if (m) m.setIcon(this.iconFor(p, !!(this.selected && this.selected.id===p.id)));
        });
      },

      closeDetail() {
        if (this.selected) {
          this.selected = null;
          this.updateMarkerIcons();
        }
        this.restoreModeAfterDetail();
      },

      restoreModeAfterDetail() {
        if (!this.isLg && this.modeBeforeDetail) {
          this.mode = this.modeBeforeDetail;
        }
        this.modeBeforeDetail = null;
      },
  
      selectFromMap(p) {
        this.selected = p; this.updateMarkerIcons();
        const m = this.markers.get(p.id);
        if (m) {
          const latlng = [p.coords.lat, p.coords.lng];
          this.withMap(mm => mm.setView(latlng, Math.max(mm.getZoom(), 15), { animate: true }));
        }
        this.scrollListTo(p.id);
      },
  
      selectFromList(p) {
        this.selected = p; this.updateMarkerIcons();

        const go = () => {
          const marker = this.markers.get(p.id);
          const latlng = [p.coords.lat, p.coords.lng];
          this.withMap(mm => mm.setView(latlng, Math.max(mm.getZoom(), 15), { animate: true }));
          if (marker && this.hasCluster() && this.cluster.hasLayer(marker)) {
            this.cluster.zoomToShowLayer(marker, () => marker.setZIndexOffset(1000));
          }
        };
  
        if (!this.isLg) {
          this.modeBeforeDetail = this.mode;
          this.mode = 'map';
          this.$nextTick(() => {
            this.withMap(mm => mm.invalidateSize(false));
            go();
            const host = this.$refs?.mapEl || document.getElementById('map');
            if (host) host.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        } else {
          go();
        }
      },
  
      scrollListTo(id) {
        const safeId = (window.CSS && CSS.escape) ? CSS.escape(id) : id;
        const row = document.querySelector(`[data-pickup-id="${safeId}"]`);
        if (!row) return;
        row.scrollIntoView({ block: 'center', behavior: 'smooth' });
        const pulse = ['ring', 'ring-primary', 'ring-offset-1'];
        row.classList.add(...pulse);
        setTimeout(() => row.classList.remove(...pulse), 900);
      },
  
      confirmSelection() {
        if (!this.selected) return;
        const ctx = this.selectionContext || this.loadSelectionContext() || {};
        const detail = {
          deliveryId: ctx.deliveryId || null,
          mapType: ctx.mapType || this.selected.type || '',
          point: {
            id: this.selected.id,
            type: this.selected.type,
            name: this.selected.name,
            address: this.selected.address,
            phone: this.selected.phone,
            note: this.selected.note,
            coords: this.selected.coords
          }
        };
        window.dispatchEvent(new CustomEvent('pickup:selected', { detail }));
        this.toast(`Vybráno: ${this.selected.name}`);
        this.clearSelectionContext();
        this.closeModal();
      },
  
      toast(msg) {
        const t = document.createElement('div');
        t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 z-[1000]';
        t.innerHTML = `<div class="alert alert-success shadow">${msg}</div>`;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 1600);
      },
  
      // FILTERING
      applyFilters(newQuery = null) {
        if (typeof newQuery === 'string') {
          this.search = newQuery;
        }
        const q = (this.search || '').toLowerCase().trim();
        const d = this.district;
        const t = this.typeFilter || this.defaultType || 'pharmacy';
        this.filtered = this.all.filter(p => {
          const okQ = q ? p.searchIndex.includes(q) : true;
          const okD = d ? (p.address?.city||'').toLowerCase().includes(d.toLowerCase()) : true;
          const okT = (t === 'all') ? true : (p.type || '').toLowerCase() === t;
          return okQ && okD && okT;
        });
        this.renderMarkers();
        if (this.selected && !this.filtered.some(pp => pp.id===this.selected.id)) {
          this.closeDetail();
        }
        this.updateHashWithType();
      },
      clearAllFilters() {
        this.search='';
        this.district='';
        this.typeFilter = this.defaultType;
        this.applyFilters();
      },
      setTypeFilter(type) {
        const normalized = this.normalizeTypeParam(type, this.types) ?? this.defaultType;
        if (this.typeFilter === normalized) {
          this.fabOpen = false;
          return;
        }
        this.typeFilter = normalized;
        this.applyFilters();
        this.fabOpen = false;
      },
      extractTypeParam() {
        const hash = location.hash || '';
        const parts = hash.split('?');
        if (parts.length < 2) return null;
        const params = new URLSearchParams(parts[1]);
        return params.get('type');
      },
      normalizeTypeParam(type, available) {
        if (!type) return null;
        const val = String(type).toLowerCase();
        if (val === 'all') return 'all';
        if (Array.isArray(available) && available.includes(val)) return val;
        return null;
      },
      buildTypeOptions() {
        const options = [];
        options.push({ value: 'all', label: 'Vše' });
        const ordered = [...this.types];
        ordered.sort();
        if (ordered.includes('pharmacy')) {
          options.push({ value: 'pharmacy', label: this.formatTypeLabel('pharmacy') });
        }
        ordered.filter(t => t !== 'pharmacy').forEach(t => {
          options.push({ value: t, label: this.formatTypeLabel(t) });
        });
        return options;
      },
      formatTypeLabel(type) {
        const map = {
          pharmacy: 'Lékárny',
          box: 'Boxy',
          'z-box': 'Zásilkovna boxy',
          pickup: 'Výdejní místa',
          partner: 'Partneři'
        };
        if (map[type]) return map[type];
        if (!type) return 'Neznámé';
        return type
          .replace(/[_-]+/g, ' ')
          .replace(/\b\w/g, (s) => s.toUpperCase());
      },
      updateHashWithType() {
        if (!(location.hash || '').startsWith('#/map')) return;
        const params = new URLSearchParams(location.hash.split('?')[1] || '');
        const effectiveDefault = this.defaultType || 'pharmacy';
        if (this.typeFilter && this.typeFilter !== effectiveDefault) {
          params.set('type', this.typeFilter);
        } else {
          params.delete('type');
        }
        const query = params.toString();
        const newHash = `#/map${query ? '?' + query : ''}`;
        const newUrl = `${location.pathname}${location.search}${newHash}`;
        history.replaceState(null, '', newUrl);
      },
      loadSelectionContext() {
        try {
          const raw = localStorage.getItem('pickupSelectionContext');
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') return parsed;
        } catch (e) {
          console.warn('Failed to parse pickup selection context', e);
        }
        return null;
      },
      clearSelectionContext() {
        try { localStorage.removeItem('pickupSelectionContext'); } catch (_) {}
        this.selectionContext = null;
      },
      lockBody() {
        if (this._bodyLocked) return;
        this._prevOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        this._bodyLocked = true;
      },
      unlockBody() {
        if (!this._bodyLocked) return;
        document.body.style.overflow = this._prevOverflow || '';
        this._bodyLocked = false;
      },
      closeModal() {
        this.teardown();
        this.fabOpen = false;
        if (window.history.length > 1) {
          history.back();
        } else {
          location.hash = '#/products';
        }
      },
      
      locateUser() {
      if (!navigator.geolocation) {
        this.toast('Geolokace není podporována v tomto prohlížeči.');
        return;
      }

      // Leaflet convenience: fires 'locationfound' / 'locationerror'
      this.map.once('locationfound', (e) => {
        const { latlng, accuracy } = e;

        // remove previous
        if (this.userMarker) this.userMarker.remove();
        if (this.userAccuracy) this.userAccuracy.remove();

        // a small blue dot marker
        const youIcon = L.divIcon({
          className: 'you-are-here',
          html: `<div style="width:10px;height:10px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.25)"></div>`,
          iconSize: [10,10], iconAnchor: [5,5]
        });

        this.userMarker = L.marker(latlng, { icon: youIcon }).addTo(this.map);
        this.userAccuracy = L.circle(latlng, { radius: accuracy, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 0.08, weight: 1 })
          .addTo(this.map);

        // center/zoom nicely
        const targetZoom = Math.max(this.map.getZoom(), 15);
        this.map.setView(latlng, targetZoom, { animate: true });
      });

      this.map.once('locationerror', (err) => {
        // Common: blocked by user, insecure (needs HTTPS), or timeout
        this.toast('Nepodařilo se zjistit polohu. Zkontrolujte oprávnění/HTTPS.');
        console.warn('Geolocation error:', err);
      });

      // Start locate (will show browser prompt)
      this.map.locate({
        setView: false,             // we’ll setView after drawing marker
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    },

      dayCZ(d) {
        const m = { Mon:'Pondělí', Tue:'Úterý', Wed:'Středa', Thu:'Čtvrtek', Fri:'Pátek', Sat:'Sobota', Sun:'Neděle' };
        return m[d] || d;
      },
    };
  }
  </script>
<script>
  function rtbStrip() {
    return {
      items: [],
      scrolled: false,
      _onLocale: null,
      async init() {
        await this.load();
        this._onLocale = () => this.load();
        window.addEventListener('fit:locale-change', this._onLocale);
        if (this.$el) {
          this.$el.addEventListener('alpine:destroy', () => {
            if (this._onLocale) {
              window.removeEventListener('fit:locale-change', this._onLocale);
              this._onLocale = null;
            }
          });
        }
      },
      async load() {
        try {
          const data = await window.__fitI18n.loadData('data/rtbs.json');
          this.items = Array.isArray(data) ? data : [];
        } catch (err) {
          console.warn('rtbs load failed', err);
          this.items = [];
        }
        this.$nextTick(() => {
          if (this.$refs?.rail) {
            this.handleScroll({ target: this.$refs.rail });
          }
        });
      },
      handleScroll(event) {
        const left = event?.target?.scrollLeft || 0;
        this.scrolled = left > 8;
      }
    };
  }
</script>

<script>
  // Recompute map size right after the route settles
  window.addEventListener('hashchange', () => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        const el = document.getElementById('map');
        if (el) el.dispatchEvent(new CustomEvent('map:invalidate', { bubbles: true }));
      }, 220); 
    });
  });
</script>

<script>
  /** LEGAL TOOLTIPS **/
  function formatCZDate(d) {
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }
  function randomDateWithinLast(days = 30) {
    const now = new Date();
    const past = new Date(now);
    past.setDate(now.getDate() - days);
    const ts = past.getTime() + Math.random() * (now.getTime() - past.getTime());
    return new Date(ts);
  }
  function isDiscounted(p) {
    return p?.discounted_price && p.discounted_price < p.price;
  }
  function replaceWildcards(str, { price, dateStr }) {
    return String(str || '')
      .replaceAll('{{PRICE}}', String(price))
      .replaceAll('{{DATE}}', dateStr);
  }
  
  document.addEventListener('alpine:init', () => {
    //preloads legal texts for legal tooltips
    Alpine.store('legal', {
      loaded: false,
      _bound: false,
      _locale: null,
      base: { legal_always: '', legal_extended: { price_info: '', date_info: '' } },

      async init() {
        const locale = (Alpine.store('i18n')?.locale) || (window.__fitI18n?.defaultLocale) || 'cs-CZ';
        if (this.loaded && this._locale === locale) return;
        try {
          const arr = await window.__fitI18n.loadData('data/legal.json', { locale });
          // file structure is an array with one object
          this.base = Array.isArray(arr) && arr[0] ? arr[0] : this.base;
          this.loaded = true;
          this._locale = locale;
        } catch (e) {
          console.warn('Failed to load legal.json', e);
          this.loaded = true;
          this._locale = locale;
        }
        if (!this._bound) {
          window.addEventListener('fit:locale-change', () => {
            this.loaded = false;
            this.init();
          });
          this._bound = true;
        }
      },

      paragraphsFor(product) {
        const always = this.base?.legal_always || '';
        const ext = this.base?.legal_extended || {};
        const list = [];
  
        if (always) list.push(always);

        if (isDiscounted(product)) {
          const dateStr = formatCZDate(randomDateWithinLast(30));
          const formattedPrice = window.__fitMoney.format(product.price, { fromCurrency: 'CZK' });
          const priceInfo = ext.price_info
            ? replaceWildcards(ext.price_info, { price: formattedPrice, dateStr })
            : '';
          const dateInfo = ext.date_info
            ? replaceWildcards(ext.date_info, { price: formattedPrice, dateStr })
            : '';

          if (priceInfo) list.push(priceInfo);
          if (dateInfo) list.push(dateInfo);
        }
        return list;
      }
    });
  });
  </script>
<script>
  document.addEventListener('alpine:init', () => {
    Object.assign(Alpine.store('precart'), {
  
      // normalize products to ensure id/name/image/price are usable in the modal
      _normalize(p) {
        if (!p) return null;
        const id = String(p.id ?? p.product_id ?? p.sku ?? '');
        if (!id) return null;
  
        // image via cart helper (covers many shapes), fallback to p.image
        const img = Alpine.store('cart')?.imgFor?.(p) || p.image || '';
  
        const priceFull = Number(p.price ?? 0);
        const priceNow  = Number(p.discounted_price ?? priceFull);
        const discounted_price = (priceNow < priceFull) ? priceNow : null;
  
        return {
          ...p,
          id,
          name: p.name ?? p.title ?? `Produkt #${id}`,
          image: img,
          price: priceFull,
          discounted_price
        };
      },
  
      setCatalog(arr) {
        const norm = Array.isArray(arr)
          ? arr.map(x => this._normalize(x)).filter(Boolean)
          : [];
        // Only overwrite when we actually have something to show
        if (norm.length) this.catalog = norm;
      },
  
      async _ensureCatalog() {
        if (Array.isArray(this.catalog) && this.catalog.length) return;
  
        // 1) Try common global caches if you keep any around
        let src = (window.allProducts || window.products || window.PRODUCTS || []);
        // 2) As a prototype fallback, fetch the master JSON
        if (!src.length) {
          try {
            const res = await fetch('./data/products.json', { cache: 'no-store' });
            src = await res.json();
          } catch (e) {
            console.warn('precart: failed to fetch products.json', e);
          }
        }
        this.setCatalog(src);
      },
  
      open(product) {
        this.product = product || null;
        this.isOpen  = !!this.product;
        this.quickAdded.clear();
        // Make sure we have recommendations even on pages without storeApp
        this._ensureCatalog();
      },
    });
  });
  </script>
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('configPage', () => ({
      store: null,
      orderStore: null,
      localeStore: null,
      defaultLocale: (window.__fitI18n && window.__fitI18n.defaultLocale) || 'cs-CZ',
      defaultCurrency: (window.__fitI18n && window.__fitI18n.defaultCurrency) || 'CZK',
      selectedStep: '',
      authStore: null,
      authFallbackDraft: '',
      authFallbackError: '',
      authThrottleDraft: 1300,
      init() {
        this.store = Alpine.store('appConfig');
        this.orderStore = Alpine.store('activeOrder');
        this.localeStore = Alpine.store('i18n');
        this.authStore = Alpine.store('auth');
        Promise.resolve(this.orderStore?.ensureData?.());
        this.selectedStep = this.orderStore?.order?.currentStepId || '';
        this.$watch(() => this.orderStore?.order, () => {
          this.selectedStep = this.orderStore?.order?.currentStepId || '';
        });
        this.$watch(() => this.orderStore?.order?.currentStepId, (value) => {
          this.selectedStep = value || '';
        });
        Promise.resolve(this.localeStore?.ensureCurrencyConfig?.());
        this.authFallbackDraft = this.formatFallback(this.authStore?.fallbackAccount);
        this.authThrottleDraft = Number(this.authStore?.throttleMs ?? 1300);
        this.$watch(() => JSON.stringify(this.authStore?.fallbackAccount || {}), () => {
          this.authFallbackDraft = this.formatFallback(this.authStore?.fallbackAccount);
        });
        this.$watch(() => this.authStore?.throttleMs, (value) => {
          this.authThrottleDraft = Number(value ?? 0);
        });
      },
      formatFallback(data) {
        try {
          const payload = data && typeof data === 'object' ? data : {};
          return JSON.stringify(payload, null, 2);
        } catch {
          return '{}';
        }
      },
      applyFallbackDraft() {
        if (!this.authStore) return;
        this.authFallbackError = '';
        try {
          const payload = this.authFallbackDraft ? JSON.parse(this.authFallbackDraft) : {};
          this.authStore.setFallbackAccount(payload);
          this.authFallbackDraft = this.formatFallback(this.authStore.fallbackAccount);
        } catch (e) {
          console.warn('Failed to apply auth fallback draft', e);
          this.authFallbackError = 'Nepodařilo se načíst JSON. Zkontrolujte formát.';
        }
      },
      resetFallbackDraft() {
        this.authFallbackError = '';
        this.authFallbackDraft = this.formatFallback(this.authStore?.fallbackAccount);
      },
      applyThrottle() {
        if (!this.authStore) return;
        const value = Number(this.authThrottleDraft);
        this.authStore.setThrottle(Number.isFinite(value) ? value : this.authStore.throttleMs);
        this.authThrottleDraft = Number(this.authStore.throttleMs);
      },
      get showBadge() {
        return !!(this.store?.get ? this.store.get('showBreakpointBadge') : this.store?.showBreakpointBadge);
      },
      setBadge(value) {
        if (!this.store) return;
        if (typeof this.store.set === 'function') {
          this.store.set('showBreakpointBadge', !!value);
        } else {
          this.store.showBreakpointBadge = !!value;
          this.store.persist?.();
        }
      },
      get drMaxWomanEnabled() {
        return !!(this.store?.get ? this.store.get('drMaxWomanPromo') : this.store?.drMaxWomanPromo);
      },
      setDrMaxWoman(value) {
        if (!this.store) return;
        if (typeof this.store.set === 'function') {
          this.store.set('drMaxWomanPromo', !!value);
        } else {
          this.store.drMaxWomanPromo = !!value;
          this.store.persist?.();
          window.dispatchEvent(new CustomEvent('fit:config-change', { detail: { key: 'drMaxWomanPromo', value: !!value } }));
        }
      },
      get translationHintsEnabled() {
        return !!(this.store?.get ? this.store.get('showTranslationHints') : this.store?.showTranslationHints);
      },
      setTranslationHints(value) {
        if (!this.store) return;
        if (typeof this.store.set === 'function') {
          this.store.set('showTranslationHints', !!value);
        } else {
          this.store.showTranslationHints = !!value;
          this.store.persist?.();
          window.dispatchEvent(new CustomEvent('fit:config-change', { detail: { key: 'showTranslationHints', value: !!value } }));
        }
      },
      get localeCode() {
        return this.localeStore?.locale || this.defaultLocale;
      },
      get localeOptions() {
        return this.localeStore?.listLocales?.() || [];
      },
      localeLabel(option) {
        if (!option) return '';
        const fallback = option.nativeName || option.englishName || option.code;
        return typeof window.t === 'function'
          ? t('header.languageMenu.options.' + option.code, fallback)
          : fallback;
      },
      changeLocale(value) {
        const code = String(value || '').trim();
        if (!code) return;
        this.localeStore?.setLocale?.(code);
      },
      get currencyCode() {
        return this.localeStore?.currency || this.defaultCurrency;
      },
      get currencyOptions() {
        const list = [];
        const store = this.localeStore;
        const config = store?.currencyConfig || {};
        const currencies = config.currencies || {};
        const seen = new Set();
        const pushMeta = (code) => {
          if (!code || seen.has(code)) return;
          const meta = currencies[code] || {};
          list.push({ code, ...meta });
          seen.add(code);
        };
        pushMeta(config.baseCurrency || this.defaultCurrency);
        Object.keys(currencies).forEach(pushMeta);
        if (!list.length) {
          pushMeta(this.currencyCode);
        }
        return list;
      },
      currencyLabel(option) {
        if (!option) return '';
        const symbol = option.symbol && option.symbol !== option.code ? ` (${option.symbol})` : '';
        return `${option.code}${symbol}`;
      },
      changeCurrency(value) {
        const code = String(value || '').trim();
        if (!code) return;
        this.localeStore?.setCurrency?.(code);
      },
      resetAll() {
        if (typeof this.store?.reset === 'function') {
          this.store.reset();
        } else {
          this.setBadge(this.store?.defaults?.showBreakpointBadge ?? true);
        }
      },
      get snapshot() {
        try {
          const payload = this.store?.all?.() ?? { showBreakpointBadge: this.showBadge };
          return JSON.stringify(payload, null, 2);
        } catch {
          return '';
        }
      },
      get hasActiveOrder() {
        return !!(this.orderStore?.hasOrder?.());
      },
      changeOrderStep(value) {
        if (!this.orderStore || !value) return;
        this.orderStore.setCurrentStep(value);
      },
      cancelOrder() {
        if (!this.orderStore) return;
        this.orderStore.clearOrder();
        this.selectedStep = '';
      }
    }));
    Alpine.data('activeOrderPage', () => ({
      store: null,
      init() {
        this.store = Alpine.store('activeOrder');
        Promise.resolve(this.store?.ensureData?.()).then(() => {
          this.store.openCashModalIfNeeded();
        });
        this.$watch(() => this.store?.order?.flowId, () => {
          this.store.openCashModalIfNeeded();
        });
        this.$watch(() => this.store?.order?.cashModalShown, () => {
          this.store.openCashModalIfNeeded();
        });
      }
    }));
  });
</script>
  <script defer>
    (() => {
      const register = () => {
        Alpine.magic('fx', () => {
          const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
          return {
            confetti(type = 'celebrate', el = null) {
              if (prefersReduced || typeof window.confetti !== 'function') return;
    
              // compute origin near element (if provided)
              let origin = { x: 0.5, y: 0.6 };
              if (el?.getBoundingClientRect) {
                const r = el.getBoundingClientRect();
                const cx = (r.left + r.width / 2) / window.innerWidth;
                const cy = (r.top + r.height / 2 + window.scrollY) /
                           (document.documentElement.scrollHeight || window.innerHeight);
                origin = { x: Math.min(0.98, Math.max(0.02, cx)),
                           y: Math.min(0.98, Math.max(0.02, cy)) };
              }
    
              const base  = { ticks: 200, gravity: 0.9, scalar: 1, spread: 60, origin };
              const burst = (opts) => window.confetti({ ...base, ...opts });
    
              if (type === 'coupon')       burst({ particleCount: 40, spread: 75, scalar: 0.9 });
              else if (type === 'success') burst({ particleCount: 25, spread: 45, scalar: 0.8 });
              else {
                burst({ particleCount: 80, angle:  60, origin: { x: 0, y: 0.6 } });
                burst({ particleCount: 80, angle: 120, origin: { x: 1, y: 0.6 } });
                burst({ particleCount: 60, spread: 100, scalar: 1.1 });
              }
            }
          };
        });
      };
    

      if (window.Alpine) register();
      window.addEventListener('alpine:init', register);
    })();
    function scrollFades() {
      return {
        showLeft: false,
        showRight: false,
        update() {
          const el = this.$refs.scroller;
          if (!el) return;
          const { scrollLeft, scrollWidth, clientWidth } = el;
          this.showLeft  = scrollLeft > 4;
          this.showRight = scrollLeft + clientWidth < scrollWidth - 4;
        },
        init() {
          // initialize and listen
          this.$nextTick(() => {
            this.update();
            const el = this.$refs.scroller;
            el?.addEventListener('scroll', () => this.update(), { passive: true });
            const ro = new ResizeObserver(() => this.update());
            el && ro.observe(el);
            window.addEventListener('orientationchange', () => this.update(), { passive: true });
          });
        },
      };
    }

    // Billboard carousel
    // HOME BILLBOARD CAROUSEL (Alpine component)
    function homeCarousel() {
  const AUTOPLAY_MS = 6000;
  const DRAG_THRESHOLD_PX = 50;
  const CLICK_TAP_MAX_MS = 220;
  const CLICK_MOVE_MAX_PX = 8;
  const RESISTANCE_K = 0.0025;
  const INTENT_THRESHOLD_PX = 8;   // how far before we decide direction
  const H_BIAS = 1.2;              // horizontal must be ~20% stronger than vertical

  return {
    index: 0,
    slides: [],
    templates: {},     // { [id]: { id, classes:{...}, styles:{...}, anim:{...} } }
    timer: null,
    trackEl: null,
    viewportEl: null,
    width: 0,

    // drag / click guard
    pointerDown: false,
    dragging: false,
    lock: null,        // null | 'h' | 'v'
    startX: 0,
    startY: 0,         // ✅ added
    currX: 0,
    currY: 0,          // ✅ added
    lastDX: 0,
    pressT: 0,
    pressX: 0,

    // animation restart nonce (changes when active slide changes)
    animNonce: 0,

    count() { return this.slides.length; },
    isActive(i) { return this.index === i; },

    go(i) {
     // if (!this.count()) return;
     // const n = this.count();
     // const nextIndex = ((i % n) + n) % n;
     // if (nextIndex !== this.index) {
     //   this.index = nextIndex;
     //   this.bumpAnimNonce();  // replay entry animations on newly active slide
     // }
     // this.resetAutoplay();
    },
    next() { this.go(this.index + 1); },
    prev() { this.go(this.index - 1); },

    startAutoplay() { this.stopAutoplay(); this.timer = setInterval(()=>this.next(), AUTOPLAY_MS); },
    stopAutoplay()  { if (this.timer) clearInterval(this.timer); this.timer = null; },
    resetAutoplay() { this.stopAutoplay(); this.startAutoplay(); },

    modalId(slide) { return `banner-legal-${slide.id ?? this.slides.indexOf(slide)}`; },
    openModal(slide) { document.getElementById(this.modalId(slide))?.showModal?.(); },

    // ---- TEMPLATE HANDLING ----
    normalizeTemplate(raw) {
      const id = String(raw?.id ?? '');
      if (!id) return null;
      const pick = (obj, paths) => {
        for (const p of paths) {
          const v = p.split('.').reduce((o, k) => (o && o[k] != null) ? o[k] : undefined, obj);
          if (typeof v === 'string' && v.trim()) return v.trim();
        }
        return '';
      };
      const layer = (n) => ({
        cls:  pick(raw, [`layer_${n}.image`, `layer${n}.image`]),
        anim: pick(raw, [`layer_${n}.entry_animation`, `layer${n}.entry_animation`]),
      });
      const L = {}; for (let n=1;n<=6;n++) L[`layer_${n}`] = layer(n);

      return {
        id,
        classes: {
          wrapper:    pick(raw, ['wrapper','container']),
          background: pick(raw, ['background']),
          title:      pick(raw, ['title']),
          text:       pick(raw, ['text.long','text.short','text']),
          cta:        pick(raw, ['cta.button','cta','button']),
          legal_link: pick(raw, ['legal.button','legal_link']),
          layer_1: L.layer_1.cls, layer_2: L.layer_2.cls, layer_3: L.layer_3.cls,
          layer_4: L.layer_4.cls, layer_5: L.layer_5.cls, layer_6: L.layer_6.cls,
        },
        styles: { background_color: pick(raw, ['background_color']) },
        anim: {
          layer_1: L.layer_1.anim, layer_2: L.layer_2.anim, layer_3: L.layer_3.anim,
          layer_4: L.layer_4.anim, layer_5: L.layer_5.anim, layer_6: L.layer_6.anim,
        }
      };
    },

    // Class / style / animation lookups
    cls(slide, key) {
      const sVal = slide?.classes?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim();
      const tid = String(slide?.banner_template_id ?? '');
      const t = this.templates[tid];
      const c = t?.classes?.[key];
      return (typeof c === 'string' && c.trim()) ? c.trim() : '';
    },
    tcls(slide, key) { return this.cls(slide, key); }, // legacy alias

    style(slide, key) {
      const sVal = slide?.styles?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim();
      const tid = String(slide?.banner_template_id ?? '');
      const t = this.templates[tid];
      const v = t?.styles?.[key];
      return (typeof v === 'string' && v.trim()) ? v.trim() : '';
    },

    // copy helper (handles text.long / text.short)
    txt(slide) {
      const t = slide?.text;
      if (typeof t === 'string') return t;
      if (t && typeof t === 'object') return t.long || t.short || '';
      return slide?.subtitle || '';
    },
    // CTA helpers (from slide data)
    ctaHref(slide)  { return slide?.cta?.link   || slide?.href || '#/products'; },
    ctaLabel(slide) { return slide?.cta?.label  || slide?.cta?.button || 'Nakoupit'; },
    ctaIcon(slide)  { return slide?.cta?.icon   || 'fa-solid fa-arrow-right'; },

    // animation class only for active slide; animNonce forces replay
    anim(slide, key, i) {
      if (!this.isActive(i)) return '';
      const sVal = slide?.animations?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim() + ` anim-${this.animNonce}`;
      const tid = String(slide?.banner_template_id ?? '');
      const t   = this.templates[tid];
      const v   = t?.anim?.[key];
      return (typeof v === 'string' && v.trim()) ? v.trim() + ` anim-${this.animNonce}` : '';
    },
    bumpAnimNonce() { this.animNonce = (this.animNonce + 1) % 1e9; },

    // ---- RENDER / INTERACTION ----
    trackStyle() {
      const baseX = -(this.index * this.width);
      let dragOffset = 0;
      if (this.dragging) {
        const dx = this.currX - this.startX;
        dragOffset = dx * (1 - Math.min(Math.abs(dx) * RESISTANCE_K, 0.35));
      }
      const x = baseX + dragOffset;
      return `transform: translate3d(${x}px,0,0); transition: ${this.dragging ? 'none' : 'transform 500ms ease'};`;
    },

    measure() {
      if (!this.viewportEl) return;
      this.width = this.viewportEl.clientWidth;
    },

    // Tap vs drag guard (single definition)
    onSlideClick(e) {
      const dt = performance.now() - this.pressT;
      const moved = Math.abs(this.currX - this.pressX);
      const isTap = dt <= CLICK_TAP_MAX_MS && moved <= CLICK_MOVE_MAX_PX && !this.dragging && this.lock !== 'h';
      if (!isTap) { e.preventDefault(); e.stopPropagation(); this.resetAutoplay(); }
    },

    onPointerDown(e) {
    // don't preventDefault yet
    this.pointerDown = true;            // 👈 NEW
    this.measure();
    this.lock = null;
    this.dragging = false;

    const x = (e.touches?.[0]?.clientX) ?? e.clientX ?? 0;
    const y = (e.touches?.[0]?.clientY) ?? e.clientY ?? 0;
    this.startX = this.currX = x;
    this.startY = this.currY = y;
    this.lastDX = 0;

    this.pressT = performance.now();
    this.pressX = x;
  },

  onPointerMove(e) {
    // ❗ Ignore all desktop mousemoves unless a button is held
    if (!this.pointerDown) return;                     // 👈 NEW (fixes “follows cursor”)
    if (!e.touches && e.buttons === 0) return;         // 👈 extra guard for stray moves

    const x = (e.touches?.[0]?.clientX) ?? e.clientX ?? 0;
    const y = (e.touches?.[0]?.clientY) ?? e.clientY ?? 0;
    this.currX = x; this.currY = y;

    const dx = this.currX - this.startX;
    const dy = this.currY - this.startY;
    const adx = Math.abs(dx), ady = Math.abs(dy);

    if (this.lock === null) {
      if (adx < INTENT_THRESHOLD_PX && ady < INTENT_THRESHOLD_PX) return;

      if (adx > ady * H_BIAS) {
        this.lock = 'h';
        this.dragging = true;
        this.stopAutoplay();
        e.preventDefault?.();
      } else {
        this.lock = 'v';
        this.dragging = false;
        return;
      }
    }

    if (this.lock === 'v') return;

    this.lastDX = dx;
    e.preventDefault?.();
  },

  onPointerUp() {
    // clear pointer state first
    this.pointerDown = false;        // 👈 NEW
    if (this.lock !== 'h') { this.lock = null; return; }

    const moved = this.lastDX;
    this.dragging = false;
    this.lock = null;

    if (Math.abs(moved) > DRAG_THRESHOLD_PX) (moved < 0) ? this.next() : this.prev();
    else this.go(this.index);
    this.resetAutoplay();
  },

    onKeydown(e) { if (e.key === 'ArrowLeft') this.prev(); if (e.key === 'ArrowRight') this.next(); },

    async loadData() {
      const locale = Alpine.store('i18n')?.locale || window.__fitI18n?.defaultLocale || 'cs-CZ';
      const [slides, tpls] = await Promise.all([
        window.__fitI18n.loadData('data/slides.json', { locale }),
        fetch('data/banner_templates.json').then(r => r.json()).catch(() => []),
      ]);

      const map = {};
      (Array.isArray(tpls) ? tpls : []).forEach(t => {
        const norm = this.normalizeTemplate(t);
        if (norm) map[norm.id] = norm;
      });
      this.templates = map;

      this.slides = (Array.isArray(slides) ? slides : []).map(s => ({
        ...s,
        banner_template_id: s.banner_template_id != null ? String(s.banner_template_id) : '',
        classes: (s.classes && typeof s.classes === 'object') ? s.classes : null,
        styles:  (s.styles  && typeof s.styles  === 'object') ? s.styles  : null,
        animations: (s.animations && typeof s.animations === 'object') ? s.animations : null,
      }));
    },

    async init() {
      this.trackEl = this.$refs.track;
      this.viewportEl = this.$refs.viewport;

      await this.loadData();
      this.startAutoplay();
      window.addEventListener('fit:locale-change', () => {
        this.loadData().then(() => {
          this.index = Math.min(this.index, Math.max(0, this.count() - 1));
          this.measure();
          this.stopAutoplay();
          this.startAutoplay();
        });
      });

      // Hover pause (desktop)
      this.$root.addEventListener('mouseenter', () => this.stopAutoplay(), { passive: true });
      this.$root.addEventListener('mouseleave', () => this.startAutoplay(), { passive: true });

      // Mouse / touch
      this.$root.addEventListener('mousedown', (e)=>this.onPointerDown(e));
      window.addEventListener('mousemove', (e)=>this.onPointerMove(e));
      window.addEventListener('mouseup', ()=>this.onPointerUp());

      // Important: touch listeners must be non-passive for move so we can preventDefault after lock
      this.$root.addEventListener('touchstart', (e)=>this.onPointerDown(e), { passive: true });
      this.$root.addEventListener('touchmove',  (e)=>this.onPointerMove(e),  { passive: false });
      this.$root.addEventListener('touchend',   ()=>this.onPointerUp(),      { passive: true  });
      this.$root.addEventListener('touchcancel',()=>this.onPointerUp(),      { passive: true  });

      // Keyboard
      this.$root.addEventListener('keydown', (e)=>this.onKeydown(e));

      // Sizing
      const ro = new ResizeObserver(()=>this.measure());
      ro.observe(this.$root);
      ro.observe(this.viewportEl);
      this.measure();

      window.__homeCarousel = this;
    },
  };
}

    </script>

<!-- TOAST OUTLET -->
<div x-data x-cloak class="fixed inset-0 z-50 pointer-events-none">
  <div
    class="toast toast-end toast-bottom gap-2 p-4"
    style="padding-bottom: calc(env(safe-area-inset-bottom, 0) + 1rem);"
  >
    <template x-for="t in $store.toast.items" :key="t.id">
      <div
        x-show="t.show"
        x-transition:enter="transform ease-out duration-300"
        x-transition:enter-start="translate-y-4 opacity-0"
        x-transition:enter-end="translate-y-0 opacity-100"
        x-transition:leave="transform ease-in duration-300"
        x-transition:leave-start="translate-y-0 opacity-100"
        x-transition:leave-end="translate-y-4 opacity-0"
        class="alert pointer-events-auto cursor-pointer min-w-[240px] max-w-[92vw] sm:max-w-sm shadow"
        :class="{
          'alert-success': t.type === 'success',
          'alert-warning': t.type === 'warning',
          'alert-error'  : t.type === 'error',
          'alert-info'   : !t.type || t.type === 'info'
        }"
        :role="t.type === 'error' ? 'alert' : 'status'"
        aria-live="polite"
        @click="$store.toast.hide(t.id)"
        @mouseenter="clearTimeout(t._lifeTimer)"
        @mouseleave="t._lifeTimer = setTimeout(() => $store.toast.hide(t.id), 1200)"
      >
        <!-- Icon per type -->
        <template x-if="t.type === 'success'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </template>
        <template x-if="t.type === 'warning'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          </svg>
        </template>
        <template x-if="t.type === 'error'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07"/>
          </svg>
        </template>
        <template x-if="!t.type || t.type === 'info'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
          </svg>
        </template>

        <span class="pr-6" x-text="t.text"></span>

        <!-- Close (optional; still clickable anywhere) -->
        <button
          class="btn btn-xs btn-ghost absolute right-2 top-2"
          type="button"
          aria-label="Zavřít"
          @click.stop="$store.toast.hide(t.id)"
        >✕</button>
      </div>
    </template>
  </div>

<!-- MENU PORTAL (place near end of <body>) -->
  <div x-data="menuPortal()" x-cloak class="fixed inset-0 z-[11000] pointer-events-none">

    <!-- BACKDROP -->
    <div
      x-show="$store.menu.open"
      x-transition.opacity.duration.150ms
      class="absolute inset-0 bg-black/50 pointer-events-auto"
      @click="$store.menu.close()"
      @keydown.escape.window="$store.menu.close()"
      aria-hidden="true">
    </div>
  
    <!-- PANEL -->
    <aside
      class="absolute inset-y-0 left-0 w-[100dvw] max-w-full lg:max-w-md bg-base-100 shadow-2xl
             transform transition-transform duration-200 ease-out
             -translate-x-full pointer-events-auto flex flex-col"
      :class="{ 'translate-x-0': $store.menu.open }"
      role="dialog"
      aria-modal="true"
      aria-label="Menu"
    >
      <!-- Top bar -->
      <div class="sticky top-0 z-10 bg-base-100 border-b border-base-200 h-18 px-3">
        <div class="h-full flex items-center gap-2">
          <!-- Left: Back OR Account -->
          <div class="shrink-0">
            <template x-if="$store.menu.canGoBack()">
              <button class="btn btn-ghost btn-sm" @click.stop="$store.menu.back()" aria-label="Zpět">
                <i class="fa-solid fa-chevron-left fa-xl"></i>
              </button>
            </template>
            <template x-if="!$store.menu.canGoBack()">
              <button class="btn btn-ghost btn-sm" @click.stop="$store.menu.goToMenu(9)" aria-label="Můj účet">
                <i class="fa-regular fa-user-circle fa-xl"></i>
              </button>
            </template>
          </div>
  
          <div class="flex-1"></div>
  
          <!-- Right: Close -->
          <button class="btn btn-ghost btn-sm shrink-0" @click.stop="$store.menu.close()" aria-label="Zavřít">
            <i class="fa-solid fa-xmark fa-xl"></i>
          </button>
        </div>
  
        <div class="absolute inset-x-14 top-1/2 -translate-y-1/2 text-center font-semibold">
          <span class="block truncate" x-text="$store.menu.current?.name || 'Menu'"></span>
        </div>
      </div>
  
      <!-- Content (slides on menu change) -->
      <div
        class="flex-1 min-h-0 overflow-y-auto p-2"
        :class="$store.menu.slideDir === 1 ? 'slide-in-right' : 'slide-in-left'"
        :key="$store.menu.viewKey"
      >
        <!-- Loading / Error -->
        <template x-if="$store.menu.loading">
          <div class="p-4 space-y-2">
            <div class="skeleton h-6 w-48"></div>
            <div class="skeleton h-4 w-64"></div>
            <div class="skeleton h-4 w-56"></div>
          </div>
        </template>
  
        <template x-if="$store.menu.error">
          <div class="alert alert-error m-2" x-text="$store.menu.error"></div>
        </template>
  
        <!-- Current menu -->
        <template x-if="$store.menu.current && !$store.menu.loading && !$store.menu.error">
          <div>
            <!-- root items (optional) -->
            <div class="divide-y divide-base-200">
              <template x-for="(it, i) in ($store.menu.current.items || [])" :key="'root-'+i">
                <button
                  class="w-full text-left py-3 px-3 flex items-center gap-3 hover:bg-base-200/60 active:bg-base-300/60 rounded-lg transition-colors duration-150 cursor-pointer"
                  data-tap-flash
                  @click.stop="$store.menu.onItemClick(it)"
                >
                  <!-- left icon (only if present) -->
                  <template x-if="it.icon || it.iconSet">
                    <i :class="[
                          it.iconSet === 'custom' && it.icon === 'check' ? 'fa-solid fa-circle-check' :
                          it.iconSet === 'custom' && it.icon === 'empty' ? 'fa-regular fa-circle' :
                          (it.iconSet || 'fa-regular') + ' fa-' + (it.icon || ''),
                          it.rowType === 'bold' ? 'text-error' : 'text-base-content/70'
                        ]"></i>
                  </template>
  
                  <div class="flex-1">
                    <div :class="it.rowType === 'bold' ? 'text-error font-semibold' : 'font-medium'">
                      <span x-text="it.name"></span>
                    </div>
                    <div x-show="it.description" class="text-xs opacity-70 mt-0.5" x-text="it.description"></div>
                  </div>
  
                  <i x-show="it.linkMenuId" class="fa-solid fa-chevron-right text-base-content/40 self-center"></i>
                </button>
              </template>
            </div>
  
            <!-- sections -->
            <div class="mt-2 space-y-3 mb-12">
              <template x-for="(sec, si) in ($store.menu.current.sections || [])" :key="'sec-'+si">
                <section>
                  <h3 class="px-3 pt-3 pb-2 text-xs font-semibold tracking-wide uppercase text-base-content/50" x-text="sec.name"></h3>
  
                  <!-- special: loyalty card -->
                  <template x-if="sec.type === 'loyalty'">
                    <div class="px-3 pb-2">
                      <div class="rounded-xl border border-base-300 p-3 bg-gradient-to-br from-base-100 to-base-200">
                        <div class="flex items-center justify-between">
                          <img src="./images/logoDrmax.svg" alt="Dr. Max" class="h-6">
                          <span class="text-xs font-semibold text-success">Celková úspora: <span x-text="formatPrice(123)"></span></span>
                        </div>
                        <div class="mt-3 text-center">
                          <div class="font-mono text-lg tracking-widest">1234 5678 9012</div>
                          <div class="mt-2 bg-white h-14 rounded-sm flex items-center justify-center">
                            <img src="./images/barcode.png" alt="Čárový kód" class="h-16 w-auto">
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
  
                  <!-- special: language list (radio-like) -->
                  <template x-if="sec.type === 'language'">
                    <div class="divide-y divide-base-200 bg-base-100 rounded-lg mx-2">
                      <template x-for="locale in ($store.i18n?.listLocales?.() || [])" :key="'lang-'+locale.code">
                        <button
                          class="w-full text-left py-3 px-3 flex items-center gap-3 hover:bg-base-200/60 active:bg-base-300/60 transition-colors duration-150"
                          data-tap-flash
                          @click.stop.prevent="$store.i18n?.setLocale?.(locale.code)"
                        >
                          <i
                            :class="$store.i18n?.locale === locale.code
                              ? 'fa-solid fa-circle-check text-success'
                              : 'fa-regular fa-circle text-base-content/40'"
                          ></i>
                          <div class="flex-1">
                            <div class="font-medium"
                              x-text="t('header.languageMenu.options.' + locale.code, locale.nativeName || locale.englishName || locale.code)">
                            </div>
                            <div
                              x-show="locale.currency"
                              class="text-xs text-base-content/60 mt-0.5"
                              x-text="locale.currency"
                            ></div>
                          </div>
                        </button>
                      </template>
                    </div>
                  </template>
  
                  <!-- default: list -->
                  <template x-if="!sec.type || sec.type === 'list'">
                    <div class="divide-y divide-base-200 bg-base-100 rounded-lg mx-2">
                      <template x-for="(it, i) in (sec.items || [])" :key="'item-'+i">
                        <button
                          class="w-full text-left py-4 px-3 flex items-center gap-3 hover:bg-max-gray-50 active:bg-base-200/60 border-0 transition-colors duration-150 cursor-pointer"
                          data-tap-flash
                          @click.stop="$store.menu.onItemClick(it)"
                        >
                          <template x-if="it.icon || it.iconSet">
                            <i :class="[
                                  it.iconSet === 'custom' && it.icon === 'check' ? 'fa-solid fa-circle-check fa-xl ' :
                                  it.iconSet === 'custom' && it.icon === 'empty' ? 'fa-regular fa-circle fa-xl ' :
                                  (it.iconSet || 'fa-regular') + ' fa-xl fa-' + (it.icon || ''),
                                  it.rowType === 'bold' ? 'text-error' : 'fa-light text-max-green-500 fa-xl'
                                ]"></i>
                          </template>
  
                          <div class="flex-1">
                            <div :class="it.rowType === 'bold' ? 'text-error font-semibold' : 'font-normal'">
                              <span x-text="it.name"></span>
                            </div>
                            <div x-show="it.description" class="text-xs opacity-70 mt-0.5" x-text="it.description"></div>
                          </div>
  
                          <i x-show="it.linkMenuId" class="fa-regular fa-chevron-right text-base-content/40 self-center"></i>
                        </button>
                      </template>
                    </div>
                  </template>
                </section>
              </template>
            </div>
          </div>
        </template>
      </div>
    </aside>

    <!-- Sponsored banner -->
    <template x-if="product">
      <div
        x-cloak
        x-show="visible"
        x-transition:enter="transform ease-out duration-200"
        x-transition:enter-start="opacity-0 translate-y-4 scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 scale-100"
        x-transition:leave="transform ease-in duration-150"
        x-transition:leave-start="opacity-100 translate-y-0 scale-100"
        x-transition:leave-end="opacity-0 translate-y-2 scale-95"
        class="hidden md:block pointer-events-auto fixed bottom-6 right-6 md:bottom-8 md:right-8 w-[17rem] max-w-[80vw] z-[11005] flex flex-col gap-2 items-start"
        role="complementary"
        aria-live="polite"
      >
        <span class="px-3 py-1 rounded-full border border-white/20 bg-white/10 text-xs font-normal tracking-wide text-white/60 backdrop-blur-sm">
          Sponzorováno
        </span>
        <article class="card bg-white shadow-xl relative overflow-hidden mt-1">
          <span
            x-show="discountPct(product) !== null"
            class="badge badge-error text-white font-semibold absolute right-3 top-3"
          >
            <span x-text="`-${discountPct(product)}%`"></span>
          </span>
          <figure class="p-3 h-44 overflow-hidden">
            <a :href="link('product', { id: product.id })" class="block h-full">
              <img :src="product.image || './images/placeholder.webp'" :alt="product.name"
                   class="w-full h-full object-cover">
            </a>
          </figure>
          <div class="card-body pt-0 flex flex-col gap-2">
            <a :href="link('product', { id: product.id })"
               class="text-sm font-medium line-clamp-2 leading-snug min-h-[2.45rem] max-h-[2.45rem] hover:underline"
               x-text="product.name"></a>
            <div class="mt-auto">
              <div class="text-base font-semibold">
                <span x-text="formatPrice(currentPrice(product))"></span>
                <span class="ml-2 line-through text-xs opacity-60"
                      x-show="crossedPrice(product) !== null"
                      x-text="formatPrice(crossedPrice(product))"></span>
              </div>
            </div>
            <div class="mt-3">
              <template x-if="!$store.cart.inCart(product.id)">
                <button class="btn btn-primary btn-md w-full font-semibold" @click="$store.cart.add(product)">
                  <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                </button>
              </template>
              <template x-if="$store.cart.inCart(product.id)">
                <div class="join w-full justify-center">
                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.decrement(product.id)"
                          :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>
                  <input type="text" inputmode="numeric" pattern="[0-9]*"
                         class="input input-bordered input-md w-12 text-center join-item tabular-nums"
                         :value="$store.cart.qty(product.id)"
                         @input="$store.cart.setQty(product.id, $event.target.value.replace(/[^0-9]/g,''))"
                         @keydown.enter.prevent
                         :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />
                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.increment(product.id)"
                          :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                </div>
              </template>
            </div>
          </div>
        </article>
      </div>
    </template>
  </div>
<!-- MOBILE SEARCH OVERLAY -->
<template x-teleport="body">
  <div
    data-mobile-search-overlay
    x-data="mobileSearchOverlayShell()"
    x-show="isOpen"
    x-transition.opacity
    class="fixed inset-0 z-[12050] pointer-events-auto" 
    role="dialog" aria-modal="true"

    @open-mobile-search.window="openOverlay()"
    @mobile-search-close.window="closeOverlay($event?.detail || { reason:'ui' })"

    @pointerdown.stop
    @click.stop
  >
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/40 z-[12050]" @click="closeOverlay()"></div>

    <!-- Panel -->
    <section
      class="absolute inset-x-0 top-0 bg-base-100 z-[12051] flex flex-col"
      :style="panelStyle"
      @click.stop
      @keydown.escape.stop.prevent="closeOverlay()"
    >
      <!-- Reuse your existing searchBox -->
      <div
        x-data="searchBox({
          getProducts:   () => products,
          getCategories: () => navCategories,
          getLinks:      () => infoLinks,
          goTo:          (id) => go(`product/${id}`)
        })"
        x-init="open = true"
        class="flex flex-col h-full pt-4"
      >
        <!-- Top bar -->
        <div class="flex items-center gap-2 p-3 pb-2 sticky top-0 bg-base-100 z-[12052]" style="padding-top: env(safe-area-inset-top)">
          <button
          type="button"
          class="btn btn-ghost btn-square"
          @click.stop="$dispatch('mobile-search-close', { reason:'ui' })"
          aria-label="Zavřít vyhledávání">
            <i class="fa-regular fa-arrow-left"></i>
          </button>

          <!-- type=text to avoid native clear '×' -->
          <label
            class="relative input input-lg pl-4 pr-10 input-bordered rounded-full items-center gap-2 w-full max-input-gradient"
            @pointerdown.capture.stop
          >
            <i class="fa-classic fa-regular fa-search"></i>
            <input
            data-mobile-search-input
            x-ref="input"
            type="text"
            inputmode="search"
            enterkeyhint="search"
            autocapitalize="none"
            autocorrect="off"
            class="grow min-w-0 bg-transparent outline-none"
            placeholder="Hledej dle názvu"
            x-model.debounce.150ms="q"
            @input="onInput()"
            @keydown="(e) => { onKeydown(e); if(e.key==='Enter'){ $dispatch('mobile-search-close', { reason:'navigate' }) } }"
            role="combobox"
            aria-autocomplete="list"
            :aria-expanded="true"
            :aria-controls="listId"
            :aria-activedescendant="activeDesc()"
          />
            <span
            role="button"
            tabindex="0"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1"
            x-show="q.length"
            @mousedown.prevent.stop="q=''; onInput(); $nextTick(()=> $refs.input.focus())"
            aria-label="Smazat dotaz">
            <i class="fa-regular fa-xmark"></i>
          </span>
          </label>
        </div>

        <!-- Results (same as you have, with safe keys and pointerdown) -->
        <div class="flex-1 overflow-y-auto overscroll-contain" style="padding-bottom: env(safe-area-inset-bottom)">
          <template x-if="q.trim().length < minChars">
            <ul class="p-3 pb-8 w-full flex flex-col space-y-3" :id="listId" role="listbox">
              <li class="px-2 py-1 text-xs font-semibold text-base-content/60">Naposledy hledané</li>
              <template x-if="!recentItems().length">
                <li class="w-full px-2 py-3 text-sm text-base-content/60">Začněte psát váš dotaz…</li>
              </template>
              <template x-for="(item, i) in recentItems()" :key="`${item.t}-${item.k ?? i}`">
                <li :id="itemId(i)" role="option" @mouseenter="highlighted = i">
                  <a href="#"
                  @click.prevent.stop="onSelect(item); $dispatch('mobile-search-close', { reason:'navigate' })"
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                    <!-- thumbs/icons same as your code -->
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-10 h-10 object-contain rounded bg-base-200/40" />
                    </template>
                    <template x-if="!item.img">
                      <span class="w-10 h-10 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
                  </a>
                </li>
              </template>
            </ul>
          </template>

          <template x-if="q.trim().length >= minChars">
            <ul class="p-3 pb-8 w-full flex flex-col space-y-3" :id="listId" role="listbox">
              <template x-if="!suggestions().length">
                <li class="w-full px-2 py-6 font-medium text-base text-center text-max-gray-400">Žádné výsledky</li>
              </template>

              <template x-for="(item, i) in suggestions()" :key="`${item.t}-${item.k ?? i}`">
                <li :id="itemId(i)" role="option" @mouseenter="highlighted = i">
                  <a href="#"
                  @click.prevent.stop="onSelect(item); $dispatch('mobile-search-close', { reason:'navigate' })"
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-10 h-10 object-contain rounded bg-base-200/40" />
                    </template>
                    <template x-if="!item.img">
                      <span class="w-10 h-10 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
                    <span class="badge badge-ghost badge-sm shrink-0"
                          x-text="item.t === 'product' ? 'Produkt' : (item.t==='category' ? 'Kategorie' : 'Info')"></span>
                  </a>
                </li>
              </template>

              <li class="pt-4">
                <button class="btn btn-block btn-outline"
                        @pointerdown.prevent.stop="$dispatch('mobile-search-close', { reason:'navigate' }); $dispatch('see-all', { q })">
                  Zobrazit všechny výsledky
                </button>
              </li>
            </ul>
          </template>
        </div>
      </div>
    </section>
  </div>
</template>

<!-- CONTACTS MODAL -->
<dialog
  id="contact_modal"
  x-data="contactModal()"
  x-ref="dlg"
  x-effect="
    const s = $store.contacts;
    if (s && s.open) { $refs.dlg.open || $refs.dlg.showModal(); }
    else if ($refs.dlg.open) { $refs.dlg.close(); }
  "
  @click.self="close()"
  @keydown.escape.window="close()"
  @close.prevent="close()"
  class="modal bg-base-200/95 backdrop-blur-sm"
  aria-labelledby="contact_modal_title"
>
  <div class="modal-box w-11/12 max-w-3xl bg-base-200 px-4 lg:px-8 py-6 lg:py-8 relative space-y-4">
    <button
      type="button"
      class="btn btn-sm btn-circle btn-ghost absolute top-4 right-4"
      @click="close()"
      aria-label="Zavřít kontakty"
      :aria-label="t('header.actions.phone.close', 'Zavřít kontakty')"
    >
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="flex items-start gap-4 pr-10">
      <div>
        <h2 id="contact_modal_title" class="text-2xl font-semibold" x-text="t('header.actions.phone.modalTitle', 'Kontaktujte nás')">
          Kontaktujte nás
        </h2>
        <p class="text-sm text-base-content/70 mt-1" x-text="t('header.actions.phone.modalSubtitle', 'Vyberte si preferovaný způsob komunikace.')">
          Vyberte si preferovaný způsob komunikace.
        </p>
      </div>
    </div>

    <div class="mt-6">
      <div class="flex items-center gap-3 text-base-content/70" x-show="isLoading" x-cloak>
        <span class="loading loading-spinner loading-sm"></span>
        <span x-text="t('header.actions.phone.loading', 'Načítáme kontakty…')">Načítáme kontakty…</span>
      </div>

      <div class="alert alert-warning mt-4" x-show="hasError" x-cloak role="alert">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span x-text="errorMessage || t('header.actions.phone.error', 'Kontakty se nepodařilo načíst. Zkuste to prosím znovu.')">
          Kontakty se nepodařilo načíst. Zkuste to prosím znovu.
        </span>
      </div>

      <div x-show="!isLoading && !hasError" x-cloak>
        <template x-if="items.length">
          <div class="flex flex-col gap-3 mt-4">
            <template x-for="contact in items" :key="contact.id">
              <article
                class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-2xl transition">
                <input type="checkbox" />
                <div class="collapse-title flex items-center gap-4 text-base-content/90 min-h-[3.5rem]">
                  <span class="w-12 h-12 rounded-full bg-primary/10 text-primary grid place-items-center flex-none">
                    <i :class="[contact.icon || 'fa-regular fa-address-card', 'text-2xl']"></i>
                  </span>
                  <h3 class="text-lg font-semibold leading-snug" x-text="contact.name"></h3>
                </div>
                <div class="collapse-content flex flex-col gap-4 text-sm text-base-content/70">
                  <p x-text="contact.description"></p>
                  <div class="space-y-2">
                    <template x-if="contact.phone">
                      <a
                        class="btn btn-link px-0 text-secondary font-medium justify-start gap-2 group"
                        :href="phoneHref(contact) || '#'"
                        @click="phoneHref(contact) ? close() : $event.preventDefault()"
                      >
                        <i class="fa-solid fa-phone"></i>
                        <span class="underline-offset-4 decoration-1 decoration-current group-hover:underline group-focus-visible:underline" x-text="contact.phone"></span>
                      </a>
                    </template>
                    <template x-if="contact.email">
                      <a
                        class="btn btn-link px-0 text-secondary font-medium justify-start gap-2 group"
                        :href="emailHref(contact) || '#'"
                        @click="emailHref(contact) ? close() : $event.preventDefault()"
                      >
                        <i class="fa-solid fa-envelope"></i>
                        <span class="underline-offset-4 decoration-1 decoration-current group-hover:underline group-focus-visible:underline" x-text="contact.email"></span>
                      </a>
                    </template>
                    <template x-if="routeHref(contact)">
                      <a
                        class="btn btn-link px-0 text-secondary font-medium justify-start gap-2 group"
                        :href="routeHref(contact)"
                        @click="handleRoute(contact, $event)"
                      >
                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        <span class="underline-offset-4 decoration-1 decoration-current group-hover:underline group-focus-visible:underline" x-text="t('header.actions.phone.route', 'Přejít na stránku')">Přejít na stránku</span>
                      </a>
                    </template>
                  </div>
                </div>
              </article>
            </template>
          </div>
        </template>
        <p class="mt-4 text-sm text-base-content/70" x-show="!items.length">
          <span x-text="t('header.actions.phone.empty', 'Momentálně nejsou dostupné žádné kontakty.')">
            Momentálně nejsou dostupné žádné kontakty.
          </span>
        </p>
      </div>
    </div>
  </div>
</dialog>

<!-- PRE-BASKET MODAL -->
<dialog
  id="precart_modal"
  x-data="precartModal()"
  x-ref="dlg"
  x-effect="
    const s = $store.precart;
    if (s && s.isOpen) { $refs.dlg.open || $refs.dlg.showModal(); }
    else { $refs.dlg.open && $refs.dlg.close(); }
  "
  @click.self="close()"
  @keydown.escape.window="close()"
  class="modal"
>
  <div class="modal-box w-11/12 max-w-3xl bg-base-200 px-4 lg:px-8 py-6 lg:py-10 flex flex-col overflow-hidden">
    <div class="flex-1 overflow-y-auto">
      <div class="sticky top-0 z-10 bg-base-200 pt-0 pb-2">
        <h2 class="text-2xl font-medium text-max-green-500 mb-2 pr-10">
          <i class="fa-classic fa-md fa-solid fa-check-circle"></i> Přidáno do košíku
        </h2>
        <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"
                @click.prevent="close()"
                aria-label="Zavřít">
          <i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i>
        </button>
      </div>

      <!-- Context product -->
      <template x-if="$store.precart.product">
        <div x-transition.opacity.duration.200ms class="py-4 w-auto mx-auto items-stretch">
          <article class="h-full" x-data="precartItem($store.precart.product)">
            <div class="card card-side h-full relative px-2 items-center bg-base-100 overflow-visible">
              <!-- BADGES -->
              <div x-show="product.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
                <template x-for="(b,i) in (product?.badges || [])" :key="i">
                  <span class="badge badge-error badge-sm font-semibold" x-text="b"></span>
                </template>
              </div>

              <!-- IMAGE (clickable) -->
              <figure class="w-36 flex items-center justify-center overflow-hidden">
                <a :href="link('product', { id: product.id })"
                   @click="close()"
                   class="block w-full h-full">
                  <img
                    :src="imgSrc"
                    class="object-contain max-h-full w-full h-full"
                    :alt="product.name"
                    @error="handleImgError($event)"
                  />
                </a>
              </figure>

              <!-- BODY -->
              <div class="card-body min-w-0 flex flex-col">
                <h3 class="text-xl font-medium">
                  <a :href="link('product', { id: product.id })"
                     @click="close()"
                     class="hover:underline focus:outline-none focus:ring-2 focus:ring-primary/50"
                     x-text="product.name"></a>
                </h3>

                <div class="card-actions mt-0 justify-between items-center">

                  <!-- PRICE with LEGAL TOOLTIP -->
                  <div
                    class="tooltip tooltip-right md:tooltip-top cursor-help overflow-visible"
                    x-init="$store.legal.init()"
                    x-data="{
                      get paras(){
                        const hasDisc = !!(product.discounted_price && product.discounted_price < product.price);
                        const original = hasDisc ? product.price : product.price;
                        const discounted = hasDisc ? product.discounted_price : null;
                        return $store.legal.paragraphsFor({ price: original, discounted_price: discounted });
                      }
                    }"
                  >
                    <div class="tooltip-content lg:p-3">
                      <template x-for="(p, idx) in paras" :key="idx">
                        <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                      </template>
                    </div>

                    <div class="flex flex-col leading-tight">
                      <span
                        x-show="product.discounted_price && product.discounted_price < product.price"
                        class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                        x-text="koruny(product.discounted_price)"
                      ></span>
                      <span
                        x-show="product.discounted_price && product.discounted_price < product.price"
                        class="text-sm line-through text-base-content/60 -mt-0.5"
                        x-text="koruny(product.price)"
                      ></span>
                      <span
                        x-show="!product.discounted_price || !(product.discounted_price < product.price)"
                        class="font-medium text-lg underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                        x-text="koruny(product.price)"
                      ></span>
                    </div>
                  </div>

                  <!-- CTA or STEPPER -->
                  <template x-if="!$store.cart.inCart(product.id)">
                    <button class="btn btn-primary btn-md font-semibold" @click="$store.cart.add(product)">
                      <span x-text="t('routes.products.cart.add', 'Do košíku')"></span>
                    </button>
                  </template>
                  <template x-if="$store.cart.inCart(product.id)">
                    <div class="join">
                      <button class="btn btn-square btn-md join-item"
                              @click="$store.cart.decrement(product.id)"
                              :aria-label="t('routes.products.cart.decrementAria', 'Odebrat kus')">−</button>

                      <input type="text" inputmode="numeric" pattern="[0-9]*"
                             class="input input-bordered input-md w-10 text-center join-item"
                             :value="$store.cart.qty(product.id)"
                             @input="$store.cart.setQty(product.id, $event.target.value.replace(/[^0-9]/g,''))"
                             @keydown.enter.prevent
                             :aria-label="t('routes.products.cart.quantityAria', 'Počet kusů')" />

                      <button class="btn btn-square btn-md join-item"
                              @click="$store.cart.increment(product.id)"
                              :aria-label="t('routes.products.cart.incrementAria', 'Přidat kus')">+</button>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </article>
        </div>
      </template>


     <!--  <div class="py-1 free-ship-bar select-none w-full">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Doprava zdarma</span>
        </div>

        <div class="relative h-1 rounded-full bg-base-300 overflow-hidden"
             role="progressbar"
             :aria-valuemin="0" :aria-valuemax="100"
             :aria-valuenow="$store.cart.freeShipProgress()">
          <div class="fill h-full rounded-full transition-[width] duration-500"
               :class="{
                 'bg-success' : $store.cart.hasFreeShipping(),
                 'bg-primary/80 shimmer' : !$store.cart.hasFreeShipping()
               }"
               :style="`width: ${$store.cart.freeShipProgress()}%`">
          </div>
        </div>
      </div>-->

      <!-- Upsell -->
      <h4 class="text-sm font-medium my-4">Ostatní k tomuto produktu kupují</h4>

      <div class="grid grid-cols-1 gap-2">
        <ul
          class="max-h-40 lg:max-h-80 overflow-y-auto w-full flex flex-col space-y-1"
          :id="listId"
          role="listbox"
          x-data="{ highlighted: -1, get items(){ return ($store.precart?.recommend?.(8) || []); } }"     
        >
          <template x-for="(item, i) in items" :key="item.id">
            <li
              :id="itemId(i)"
              class="w-full rounded-xl bg-white px-2 py-4"
              role="option"
              @mouseenter="highlighted = i"
              :class="i===highlighted ? 'bg-white' : 'hover:bg-base-200'"
            >
            <div class="flex w-full items-center gap-3 min-h-12">
              <a :href="link('product', { id: item.id })"
                 @click.prevent="goDetail(item)"
                 class="flex flex-1 items-center gap-3 min-h-12 min-w-0">
                <img :src="item.image" alt="" class="w-14 h-14 object-contain rounded" />

                <div class="min-w-0 flex-1">
                  <div class="text-base font-medium truncate" x-text="item.name"></div>
                  <div class="text-sm font-medium text-base-content/60 truncate max-w-5/6" x-text="item.description"></div>
                  <div class="text-xs font-medium text-base-content/40 mt-1 text-[9px]">Sponzorováno</div>
                </div>

                <!-- price block (desktop only) -->
                <div class="hidden md:flex">
                  <div
                    class="tooltip tooltip-left cursor-help"
                    x-init="$store.legal.init()"
                    @click.prevent.stop
                    x-data="{
                      get paras(){
                        const hasDisc = !!(item.discounted_price && item.discounted_price < item.price);
                        const original = item.price;
                        const discounted = hasDisc ? item.discounted_price : null;
                        return $store.legal.paragraphsFor({ price: original, discounted_price: discounted });
                      }
                    }"
                  >
                    <div class="tooltip-content lg:p-3">
                      <template x-for="(p, idx) in paras" :key="idx">
                        <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                      </template>
                    </div>
                    <div class="flex flex-col leading-tight">
                      <span
                        x-show="item.discounted_price && item.discounted_price < item.price"
                        class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                        x-text="koruny(item.discounted_price)"
                      ></span>
                      <span
                        x-show="item.discounted_price && item.discounted_price < item.price"
                        class="text-sm line-through text-base-content/60 -mt-0.5"
                        x-text="koruny(item.price)"
                      ></span>
                      <span
                        x-show="!item.discounted_price || !(item.discounted_price < item.price)"
                        class="font-medium text-base underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                        x-text="koruny(item.price)"
                      ></span>
                    </div>
                  </div>
                </div>
              </a>

              <!-- Quick add -->
              <button
                type="button"
                class="hidden md:block btn btn-sm shrink-0 w-16"
                :class="$store.precart.isQuickAdded(item.id) ? 'btn-ghost btn-disabled text-max-green-500' : ''"
                @click.prevent.stop="quickAdd(item)"
                x-text="$store.precart.isQuickAdded(item.id) ? 'Přidáno' : 'Přidat'">
              </button>
            </div>
          </li>
          </template>

        </ul>
      </div>
    </div>

    <!-- Footer actions -->
    <div class="sticky bottom-0 z-10 bg-base-200 pt-4">
      <div class="modal-action w-full flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <button type="button" class="btn btn-outline btn-block sm:w-auto" @click="close()">
          Pokračovat v nákupu
        </button>
        <form method="dialog" class="w-full sm:w-auto flex items-center justify-end gap-2">
          <button class="btn btn-primary btn-block sm:w-auto" @click.prevent="goCart()">
            Přejít do košíku
          </button>
        </form>
      </div>
    </div>
  </div>
</dialog>

  
<script>
function precartItem(initialProduct) {
  return {
    product: initialProduct,
    imgSrc: '',
    init() {
      this.refreshImage();
      this.$watch(
        () => Alpine.store('precart').product,
        (next) => {
          if (next !== this.product) {
            this.product = next;
            this.refreshImage();
          }
        }
      );
    },
    refreshImage() {
      const fallback = './images/placeholder.png';
      if (!this.product) {
        this.imgSrc = fallback;
        return;
      }
      const viaCart = Alpine.store('cart')?.imgFor?.(this.product);
      this.imgSrc = viaCart || this.product.image || fallback;
    },
    handleImgError(event) {
      if (!event || !event.target) return;
      if (event.target.dataset.fallbackTried) {
        this.imgSrc = './images/placeholder.png';
        return;
      }
      event.target.dataset.fallbackTried = '1';
      const alt = Alpine.store('cart')?.imgFor?.({ ...this.product, image: '' });
      this.imgSrc = (alt && alt !== event.target.src) ? alt : './images/placeholder.png';
    }
  };
}

function topNav() {
  return {
    drawerItem: null,
    highlightItems: [],
    promoItems: [],
    hiddenLeftIndices: [],
    showDrawer: window.matchMedia('(min-width: 1024px)').matches,
    _resizeHandler: null,
    _mq: null,
    _mqHandler: null,
    _ro: null,
    _raf: null,

    async init() {
      await Alpine.store('menu').load();
      this.extractItems();
      this._onMenuLoaded = () => {
        this.extractItems();
        this.scheduleMeasure();
      };
      window.addEventListener('fit:menu-loaded', this._onMenuLoaded);
      this.setupMediaWatcher();
      this.$nextTick(() => {
        this.setupResizeObserver();
        this.scheduleMeasure();
      });
    },

    destroy() {
      if (this._resizeHandler) window.removeEventListener('resize', this._resizeHandler);
      if (this._mq && this._mqHandler) this._mq.removeEventListener('change', this._mqHandler);
      if (this._ro) this._ro.disconnect();
      if (this._raf) cancelAnimationFrame(this._raf);
      if (this._onMenuLoaded) window.removeEventListener('fit:menu-loaded', this._onMenuLoaded);
    },

    setupMediaWatcher() {
      const mq = window.matchMedia('(min-width: 1024px)');
      const handler = (e) => {
        const prev = this.showDrawer;
        this.showDrawer = e.matches;
        if (prev !== this.showDrawer) {
          this.scheduleMeasure();
        }
      };
      mq.addEventListener('change', handler);
      this._mq = mq;
      this._mqHandler = handler;

      const onResize = () => this.scheduleMeasure();
      window.addEventListener('resize', onResize);
      this._resizeHandler = onResize;
    },

    setupResizeObserver() {
      const ro = new ResizeObserver(() => this.scheduleMeasure());
      if (this.$refs.leftWrap) ro.observe(this.$refs.leftWrap);
      if (this.$refs.navRoot) ro.observe(this.$refs.navRoot);
      this._ro = ro;
    },

    extractItems() {
      const store = Alpine.store('menu');
      const root = store.byId(1) || store.menus.find(m => Array.isArray(m.sections) && m.sections.some(sec => sec.tag));
      if (!root) return;

      const highlightSection = (root.sections || []).find(sec => sec.tag === 'highlights') || { items: [] };
      const promoSection = (root.sections || []).find(sec => sec.tag === 'promotions') || { items: [] };

      const highlightsRaw = Array.isArray(highlightSection.items) ? highlightSection.items.slice() : [];
      let drawer = null;
      const normalizeName = (value) => String(value || '').toLowerCase().replace(/\s*•$/, '').trim();
      const drawerLabels = (() => {
        const base = 'Procházet kategorie';
        const translated = typeof window.t === 'function'
          ? window.t('header.nav.browseCategories', base)
          : base;
        const english = 'Browse categories';
        const names = [base, translated, english]
          .map(normalizeName)
          .filter(Boolean);
        return Array.from(new Set(names));
      })();
      const drawerIndex = highlightsRaw.findIndex((it) => {
        const name = normalizeName(it?.name);
        return drawerLabels.some(label => label && name.includes(label));
      });
      if (drawerIndex >= 0) {
        drawer = highlightsRaw.splice(drawerIndex, 1)[0];
      }
      if (!drawer) {
        const fallbackName = typeof window.t === 'function'
          ? window.t('header.nav.browseCategories', 'Procházet kategorie')
          : 'Procházet kategorie';
        drawer = { name: fallbackName, linkMenuId: 2, _i18nKey: 'header.nav.browseCategories' };
      }
      this.drawerItem = this.normalizeItem(drawer, 'drawer', true, 0);
      this.highlightItems = highlightsRaw.map((item, idx) => this.normalizeItem(item, 'highlight', false, idx));
      this.promoItems = Array.isArray(promoSection.items)
        ? promoSection.items.map((item, idx) => this.normalizeItem(item, 'promo', false, idx))
        : [];
      this.hiddenLeftIndices = [];
    },

    normalizeItem(raw, prefix, isDrawer = false, idx = 0) {
      const label = String(raw?.name || '').trim();
      const key = `${prefix}-${idx}-${label.replace(/[^a-z0-9]+/gi, '-').toLowerCase() || 'item'}`;
      return {
        label,
        linkMenuId: raw?.linkMenuId ?? null,
        route: raw?.route ?? '',
        key,
        isDrawer,
        translationKey: raw?._i18nKey || null
      };
    },

    handleDrawerClick() {
      const target = this.drawerItem?.linkMenuId != null ? this.drawerItem.linkMenuId : undefined;
      Alpine.store('menu').openAt(target);
    },

    handleItemClick(item) {
      if (!item) return;
      if (item.linkMenuId != null) {
        Alpine.store('menu').openAt(item.linkMenuId);
        return;
      }
      if (item.route) {
        const route = String(item.route).replace(/^#?\/?/, '');
        location.hash = '#/' + route;
      }
    },

    handlePromoClick(item) {
      this.handleItemClick(item);
    },

    scheduleMeasure() {
      if (this._raf) cancelAnimationFrame(this._raf);
      this._raf = requestAnimationFrame(() => this.recalcVisibility());
    },

    recalcVisibility() {
      if (!this.$refs.leftWrap) return;
      this.hiddenLeftIndices = [];
      this.$nextTick(() => {
        const wrap = this.$refs.leftWrap;
        const items = Array.from(wrap.querySelectorAll('[data-left-item]'));
        if (!items.length) return;
        let available = wrap.clientWidth;
        let used = 0;
        const hidden = [];
        const gapValue = parseFloat(getComputedStyle(wrap).getPropertyValue('column-gap') || getComputedStyle(wrap).getPropertyValue('gap') || '0') || 0;

        items.forEach((el, orderIdx) => {
          const idx = Number(el.dataset.index);
          const sticky = el.dataset.sticky === 'true';
          const width = el.offsetWidth;
          const addition = width + (orderIdx > 0 ? gapValue : 0);
          if (sticky) {
            used += addition;
            return;
          }
          if (idx < 0) return;
          if (used + addition <= available) {
            used += addition;
          } else {
            hidden.push(idx);
          }
        });

        this.hiddenLeftIndices = hidden;
      });
    },

    isLeftHidden(idx) {
      return this.hiddenLeftIndices.includes(idx);
    }
  };
}

function pageFooter() {
  return {
    columns: [],

    async init() {
      await Alpine.store('menu').load();
      this.buildColumns();
      this._onMenuLoaded = () => this.buildColumns();
      window.addEventListener('fit:menu-loaded', this._onMenuLoaded);
      if (this.$el) {
        this.$el.addEventListener('alpine:destroy', () => {
          if (this._onMenuLoaded) {
            window.removeEventListener('fit:menu-loaded', this._onMenuLoaded);
            this._onMenuLoaded = null;
          }
        });
      }
    },

    buildColumns() {
      const store = Alpine.store('menu');
      const cols = (store.menus || [])
        .filter(m => typeof m.footer_position === 'number')
        .sort((a, b) => Number(a.footer_position) - Number(b.footer_position))
        .map((menu, idx) => {
          const sections = Array.isArray(menu.sections) && menu.sections.length
            ? menu.sections
            : [{ name: null, items: menu.items || [] }];

          const normSections = sections.map((sec, sIdx) => ({
            key: `${menu.id}-section-${sIdx}`,
            title: sec.name ? String(sec.name).trim() : null,
            items: (Array.isArray(sec.items) ? sec.items : []).map((it, iIdx) => ({
              key: `${menu.id}-item-${sIdx}-${iIdx}`,
              label: String(it.name || '').trim(),
              route: it.route || null,
              linkMenuId: it.linkMenuId ?? null
            }))
          })).filter(sec => sec.items.length);

          return {
            key: `footer-col-${idx}-${menu.id}`,
            sections: normSections
          };
        }).filter(col => col.sections.length);

      this.columns = cols;
    },

    gridClass() {
      const count = Math.max(1, this.columns.length);
      return {
        [`grid-cols-${count}`]: count <= 6,
        'sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6': count > 6
      };
    },

    handleItemClick(item) {
      if (item.linkMenuId != null) {
        Alpine.store('menu').openAt(item.linkMenuId);
        return;
      }
      if (item.route) {
        const route = String(item.route).replace(/^#?\/?/, '');
        location.hash = '#/' + route;
      }
    }
  };
}

function contactModal() {
  return {
    get store() { return Alpine.store('contacts'); },
    get items() { return this.store?.items || []; },
    get isLoading() { return (this.store?.status || '') === 'loading'; },
    get hasError() { return (this.store?.status || '') === 'error'; },
    get errorMessage() { return this.store?.error || ''; },
    phoneHref(contact) { return this.store?.phoneHref(contact) || null; },
    emailHref(contact) { return this.store?.emailHref(contact) || null; },
    routeHref(contact) { return this.store?.routeHref(contact) || null; },
    close() {
      this.store?.closeModal?.();
    },
    handleRoute(contact, event) {
      const href = this.routeHref(contact);
      if (!href) {
        event?.preventDefault?.();
        return;
      }
      if (event && (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button === 1)) {
        return;
      }
      event?.preventDefault?.();
      this.close();
      if (/^(https?:)?\/\//i.test(href) || href.startsWith('/')) {
        window.location.href = href;
        return;
      }
      if (href.startsWith('#')) {
        window.location.hash = href;
        return;
      }
      window.location.href = href;
    }
  };
}

function precartModal() {
  const randId = Math.random().toString(36).slice(2, 9);
  return {
    // accessibility helpers
    listId: 'precart-list-' + randId,
    itemId(i) { return `precart-item-${randId}-${i}`; },

    // price formatter; fallback if global isn't present
    koruny(v) {
      if (window.__fitMoney) return window.__fitMoney.format(v, { fromCurrency: 'CZK' });
      if (window.koruny) return window.koruny(v);
      try {
        const currency = (window.__fitI18n && window.__fitI18n.defaultCurrency) || 'CZK';
        return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency, maximumFractionDigits: 0 }).format(v);
      }
      catch {
        const currency = (window.__fitI18n && window.__fitI18n.defaultCurrency) || 'CZK';
        return `${v} ${currency}`;
      }
    },

    // link builder; use your existing global link() if available
    link(name, params) {
      if (typeof window.link === 'function') return window.link(name, params);
      // fallback hash routes
      if (name === 'product') return `#/product/${params?.id ?? ''}`;
      if (name === 'cart') return '#/cart';
      return '#';
    },

    // actions
    close() { Alpine.store('precart').close(); },
    goCart() {
      this.close();
      window.location.href = this.link('cart');
    },
    goDetail(item) {
      this.close();
      window.location.href = this.link('product', { id: item.id });
    },
    quickAdd(item) {
      Alpine.store('cart').silentAdd(item);
      Alpine.store('precart').markQuickAdded(item.id);
    },
  };
}
</script>

<!-- Auth Modal -->
<div class="modal bg-base-200/95 backdrop-blur-sm"
     x-cloak
     :class="{ 'modal-open': $store.auth?.modalOpen }"
     x-show="$store.auth?.modalOpen"
     @click.self="$store.auth?.closeModal()"
     @keydown.escape.window="$store.auth?.closeModal()">
  <div class="modal-box max-w-md space-y-2 relative p-6 md:p-10" @click.stop>
    <div class="flex items-start justify-between gap-4">
      <div class="space-y-1">
        <h2 class="text-2xl font-semibold"
            x-text="$store.auth?.view === 'register'
              ? 'Registrace'
              : ($store.auth?.view === 'forgot' ? 'Zapomenuté heslo' : 'Přihlášení')"></h2>
      </div>
      <button type="button"
              class="absolute top-2 right-2 btn btn-md btn-circle btn-ghost shrink-0"
              aria-label="Zavřít přihlašovací dialog"
              @click="$store.auth?.closeModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <template x-if="$store.auth?.view === 'login'">
      <form class="flex flex-col gap-4" @submit.prevent="$store.auth?.submitLogin()">
        <label class="form-control w-full">
          <span class="label-text text-sm font-semibold text-base-content/80">E-mail</span>
          <input
            type="email"
            class="input input-bordered w-full"
            x-model.trim="$store.auth.loginForm.email"
            autocomplete="email"
            placeholder="jan.novak@example.com"
            required
          >
        </label>
        <label class="form-control w-full">
          <span class="label-text text-sm font-semibold text-base-content/80">Heslo</span>
          <div class="relative">
            <input
              :type="$store.auth?.passwordVisible ? 'text' : 'password'"
              class="input input-bordered w-full pr-12"
              x-model.trim="$store.auth.loginForm.password"
              autocomplete="current-password"
              placeholder="••••••••"
              required
            >
            <button
              type="button"
              class="absolute inset-y-0 right-2 flex items-center px-2 text-base-content transition-colors duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-secondary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-base-100 hover:text-secondary z-20"
              :aria-label="$store.auth?.passwordVisible ? 'Skrýt heslo' : 'Zobrazit heslo'"
              :title="$store.auth?.passwordVisible ? 'Skrýt heslo' : 'Zobrazit heslo'"
              :aria-pressed="$store.auth?.passwordVisible ? 'true' : 'false'"
              @click="$store.auth?.togglePasswordVisibility()">
              <i class="fa-regular text-base-content"
                 :class="$store.auth?.passwordVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
            </button>
          </div>
          <button type="button"
          class="btn btn-link text-secondary btn-md px-0 self-start no-underline hover:underline"
          @click="$store.auth?.openForgot()">
            Zapomněli jste heslo?
          </button>  
        </label>

        <p class="text-sm text-error"
           x-show="$store.auth?.status === 'error'"
           x-text="$store.auth?.error || 'Přihlášení se nezdařilo.'"></p>

        <div class="modal-action justify-between mt-0">
          <button type="button"
                  class="btn btn-outline"
                  @click="$store.auth?.toggleView('register')">
            Nová registrace
          </button>
          <button type="submit"
                  class="btn btn-primary"
                  :class="{ 'btn-disabled': $store.auth?.status === 'loading' }">
            Přihlásit se
          </button>
        </div>
      </form>
    </template>

    <template x-if="$store.auth?.view === 'forgot'">
      <form class="flex flex-col gap-4" @submit.prevent>
        <label class="form-control w-full">
          <span class="label-text text-sm font-semibold text-base-content/80">E-mail</span>
          <input
            type="email"
            class="input input-bordered w-full"
            x-model.trim="$store.auth.forgotForm.email"
            autocomplete="email"
            placeholder="jan.novak@example.com"
            required
          >
        </label>
        <div class="modal-action justify-between">
          <button type="button"
                  class="btn btn-link px-0 text-secondary no-underline hover:underline btn-md"
                  @click="$store.auth?.toggleView('login')">
            Zpět na přihlášení
          </button>
          <button type="button"
                  class="btn btn-primary">
            Odeslat
          </button>
        </div>
      </form>
    </template>

    <template x-if="$store.auth?.view === 'register'">
      <div class="space-y-6 relative">
        <template x-if="$store.auth.registration.loading">
          <div class="rounded-2xl border border-base-300 bg-base-100 p-6 text-base-content/70">
            Načítám registrační formulář…
          </div>
        </template>

        <template x-if="!$store.auth.registration.loading && $store.auth.registration.loadError">
          <div class="rounded-xl border border-error/40 bg-error/5 p-4 text-sm text-error">
            <span x-text="$store.auth.registration.loadError"></span>
          </div>
        </template>

        <template x-if="!$store.auth.registration.loading && $store.auth.registration.ready">
          <div class="space-y-5">
            <!-- Step 1 -->
            <section class="space-y-4" x-show="$store.auth.registration.step === 1" x-transition.opacity>
              <p class="text-sm text-base-content/70">
                Vyberte, jak chcete registraci dokončit.
              </p>
              <div class="space-y-3">
                <template x-for="option in $store.auth.registration.flowOptions" :key="option.id">
                  <label class="flex items-start gap-3 rounded-xl border border-base-200 bg-base-100 p-4 cursor-pointer transition hover:border-primary"
                         :class="{
                           'opacity-60 cursor-not-allowed': option.disabled,
                           'border-primary ring-1 ring-primary/30': $store.auth.registration.selectedFlow === option.value
                         }">
                    <input type="radio"
                           class="radio radio-primary mt-1"
                           name="registration-flow"
                           :value="option.value"
                           :checked="$store.auth.registration.selectedFlow === option.value"
                           :disabled="option.disabled"
                           @change="$store.auth.registration.selectedFlow = option.value">
                    <div class="grow">
                      <div class="flex items-center gap-2">
                        <span class="font-semibold" x-text="option.label"></span>
                        <span class="badge badge-sm badge-outline" x-show="option.disabled">Brzy</span>
                      </div>
                      <p class="text-sm text-base-content/70" x-show="option.disabled">
                        Tuto možnost aktuálně v prototypu nepodporujeme.
                      </p>
                    </div>
                  </label>
                </template>
              </div>
              <div class="modal-action justify-between pt-2">
                <button type="button"
                        class="btn btn-link px-0 text-secondary no-underline hover:underline btn-md"
                        @click="$store.auth.toggleView('login')">
                  Zpět na přihlášení
                </button>
                <button type="button"
                        class="btn btn-primary"
                        @click="$store.auth.nextRegistrationStep()">
                  Pokračovat
                </button>
              </div>
            </section>

            <!-- Step 2 -->
            <section class="space-y-5" x-show="$store.auth.registration.step === 2" x-transition.opacity>
              <div class="space-y-3" x-data="{ field: $store.auth.registrationEmailField() }" x-show="field">
                <p class="text-sm text-base-content/70">
                  Nejprve ověříme váš e-mail. Poté doplníte osobní údaje.
                </p>
                <label class="form-control w-full gap-2">
                  <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                  <input type="email"
                         class="input input-bordered w-full"
                         :placeholder="field.placeholder || 'jan.novak@example.com'"
                         x-model="$store.auth.registration.values[field.key]"
                         @input="$store.auth.registrationHandleInput(field.key)"
                         @blur="$store.auth.registrationHandleBlur(field.key)">
                </label>
                <p class="text-xs text-base-content/70" x-show="field.note" x-text="field.note"></p>
                <p class="text-sm text-error"
                   x-show="$store.auth.registration.errors[field.key]?.length"
                   x-text="$store.auth.registration.errors[field.key][0]"></p>
              </div>

              <template x-if="$store.auth.registration.phase === 'verifying-email'">
                <div class="rounded-xl border border-base-200 bg-base-100/80 px-4 py-3 flex items-center gap-3">
                  <span class="loading loading-spinner text-secondary"></span>
                  <span class="text-sm text-base-content/70">Ověřujeme e-mail…</span>
                </div>
              </template>

              <div class="modal-action justify-end" x-show="!$store.auth.registration.emailVerified">
                <button type="button"
                        class="btn btn-primary"
                        :class="{ 'btn-disabled': $store.auth.registration.phase === 'verifying-email' }"
                        @click="$store.auth.registrationStartEmailVerification()">
                  Ověřit e-mail
                </button>
              </div>

              <template x-if="$store.auth.registration.emailVerified">
                <div class="space-y-5">
                  <div class="space-y-4">
                    <template x-for="field in $store.auth.registrationStepFields(2, { excludeTypes: ['email'] })" :key="field.key">
                      <div class="space-y-2">
                        <template x-if="field.isToggle">
                          <label class="flex items-center gap-3 rounded-lg border border-base-200 bg-base-100 px-4 py-3">
                            <input type="checkbox"
                                   class="checkbox checkbox-secondary"
                                   x-model="$store.auth.registration.values[field.key]"
                                   @change="$store.auth.registrationHandleGroupToggle(field.key)">
                            <div>
                              <span class="font-semibold" x-text="field.label"></span>
                              <p class="text-sm text-base-content/70" x-show="field.note" x-text="field.note"></p>
                            </div>
                          </label>
                        </template>
                        <template x-if="!field.isToggle">
                          <div class="space-y-2">
                            <template x-if="$store.auth.registrationIsPhoneField(field)">
                              <div class="space-y-1">
                                <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                <label class="input input-bordered flex items-center gap-3"
                                       :class="$store.auth.registration.errors[field.key]?.length ? 'input-error' : ''">
                                  <span class="font-semibold text-base-content/70" x-show="field.prefix" x-text="field.prefix"></span>
                                  <div class="relative grow min-w-0">
                                    <input type="tel"
                                           class="w-full bg-transparent focus:outline-none tabular-nums"
                                           :style="$store.auth.registration.values[field.key] ? 'color: transparent; caret-color: var(--fallback-bc, currentColor);' : ''"
                                           x-model="$store.auth.registration.values[field.key]"
                                           @input="$store.auth.registrationHandleInput(field.key)"
                                           @blur="$store.auth.registrationHandleBlur(field.key)"
                                           :placeholder="field.placeholder || '123456789'">
                                    <span class="pointer-events-none absolute inset-0 flex items-center text-base-content tabular-nums"
                                          :class="$store.auth.registration.values[field.key] ? 'opacity-100' : 'opacity-0'"
                                          x-text="$store.auth.registrationFormatPhoneDisplay($store.auth.registration.values[field.key])"></span>
                                  </div>
                                </label>
                              </div>
                            </template>

                            <template x-if="!$store.auth.registrationIsPhoneField(field) && field.type === 'password'">
                              <label class="form-control w-full gap-2">
                                <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                <div class="relative">
                                  <input :type="$store.auth.registration.passwordVisible ? 'text' : 'password'"
                                         class="input input-bordered w-full pr-12"
                                         :placeholder="field.placeholder || '••••••••'"
                                         x-model="$store.auth.registration.values[field.key]"
                                         @input="$store.auth.registrationHandleInput(field.key)"
                                         @blur="$store.auth.registrationHandleBlur(field.key)">
                                  <button type="button"
                                          class="absolute inset-y-0 right-2 flex items-center px-2 text-base-content transition-colors duration-150 hover:text-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-secondary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-base-100 z-20"
                                          @click="$store.auth.registration.passwordVisible = !$store.auth.registration.passwordVisible"
                                          :aria-label="$store.auth.registration.passwordVisible ? 'Skrýt heslo' : 'Zobrazit heslo'">
                                    <i class="fa-regular text-base-content"
                                       :class="$store.auth.registration.passwordVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                                  </button>
                                </div>
                              </label>
                            </template>

                            <template x-if="!$store.auth.registrationIsPhoneField(field) && ['text','email'].includes(field.type) && field.type !== 'password'">
                              <label class="form-control w-full gap-2">
                                <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                <input :type="field.type === 'email' ? 'email' : 'text'"
                                       class="input input-bordered w-full"
                                       :placeholder="field.placeholder || undefined"
                                       x-model="$store.auth.registration.values[field.key]"
                                       @input="$store.auth.registrationHandleInput(field.key)"
                                       @blur="$store.auth.registrationHandleBlur(field.key)">
                              </label>
                            </template>

                            <template x-if="field.type === 'radio' && field.items.length">
                              <div class="space-y-2">
                                <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                <div class="space-y-2">
                                  <template x-for="item in field.items" :key="item">
                                    <label class="flex items-center gap-3 rounded-lg border border-base-200 px-4 py-2">
                                      <input type="radio"
                                             class="radio radio-primary"
                                             :name="`reg-${field.key}`"
                                             :value="item"
                                             x-model="$store.auth.registration.values[field.key]"
                                             @change="$store.auth.registrationHandleInput(field.key); $store.auth.registrationHandleBlur(field.key)">
                                      <span class="text-sm" x-text="item"></span>
                                    </label>
                                  </template>
                                </div>
                              </div>
                            </template>

                            <template x-if="field.type === 'checkbox' && !field.isToggle">
                              <label class="flex items-start gap-3 rounded-lg border border-base-200 bg-base-100 px-4 py-3">
                                <input type="checkbox"
                                       class="checkbox checkbox-secondary mt-1"
                                       x-model="$store.auth.registration.values[field.key]"
                                       @change="$store.auth.registrationHandleInput(field.key); $store.auth.registrationHandleBlur(field.key)">
                                <span class="text-sm leading-snug" x-html="field.label"></span>
                              </label>
                            </template>

                            <template x-if="field.type === 'date'">
                              <label class="form-control w-full gap-2">
                                <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                <input type="date"
                                       class="input input-bordered w-full"
                                       x-model="$store.auth.registration.values[field.key]"
                                       @input="$store.auth.registrationHandleInput(field.key)"
                                       @blur="$store.auth.registrationHandleBlur(field.key)">
                              </label>
                            </template>

                            <template x-if="field.type === 'address'">
                              <div x-data="$store.auth.registrationAddressField(field.key)" x-init="init()" class="space-y-2">
                                <label class="form-control w-full gap-2">
                                  <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                                  <div class="relative">
                                    <input type="text"
                                           class="input input-bordered w-full"
                                           :placeholder="(field.placeholder && field.placeholder.street) || 'Začněte psát adresu'"
                                           x-model="query"
                                           @focus="openSuggestions()"
                                           @input="onInput($event)"
                                           @blur="onBlur()"
                                           @keydown.arrow-down.prevent="highlightNext()"
                                           @keydown.arrow-up.prevent="highlightPrev()"
                                           @keydown.enter.prevent="selectHighlighted()">
                                    <button type="button"
                                            class="btn btn-xs btn-ghost absolute right-2 top-1/2 -translate-y-1/2"
                                            @click="clearSelection()"
                                            x-show="hasValue">
                                      Vymazat
                                    </button>
                                  </div>
                                </label>
                                <div class="relative" x-show="open && options.length">
                                  <ul class="menu absolute z-10 w-full rounded-xl border border-base-200 bg-base-100 shadow">
                                    <template x-for="(option, index) in options" :key="option.id">
                                      <li>
                                        <button type="button"
                                                class="flex flex-col items-start"
                                                :class="{ 'active text-primary': highlighted === index }"
                                                @mouseenter="highlighted = index"
                                                @click="selectOption(option)">
                                          <span class="font-semibold" x-text="option.label"></span>
                                          <span class="text-xs text-base-content/70" x-text="option.cityLine"></span>
                                        </button>
                                      </li>
                                    </template>
                                  </ul>
                                </div>
                                <div class="rounded-lg border border-dashed border-base-300 bg-base-100 p-4 text-sm" x-show="hasValue">
                                  <div class="font-semibold text-base-content">Vybraná adresa</div>
                                  <p class="text-base-content/70 whitespace-pre-line" x-text="summaryBody"></p>
                                </div>
                              </div>
                            </template>

                            <p class="text-xs text-base-content/70" x-show="field.note" x-text="field.note"></p>
                            <p class="text-sm text-error"
                               x-show="$store.auth.registration.errors[field.key]?.length"
                               x-text="$store.auth.registration.errors[field.key][0]"></p>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                  <div class="modal-action justify-end">
                    <button type="button"
                            class="btn btn-primary"
                            @click="$store.auth.advanceAfterStepTwo()">
                      Pokračovat
                    </button>
                  </div>
                </div>
              </template>
            </section>

            <!-- Step 3 -->
            <section class="space-y-5" x-show="$store.auth.registration.step === 3" x-transition.opacity>
              <p class="text-sm text-base-content/70">
                Doplňte kontaktní údaje pro doručení i věrnostní program.
              </p>
              <div class="space-y-4">
                <template x-for="field in $store.auth.registrationStepFields(3)" :key="field.key">
                  <div class="space-y-2">
                    <template x-if="field.isToggle">
                      <label class="flex items-center gap-3 rounded-lg border border-base-200 bg-base-100 px-4 py-3">
                        <input type="checkbox"
                               class="checkbox checkbox-secondary"
                               x-model="$store.auth.registration.values[field.key]"
                               @change="$store.auth.registrationHandleGroupToggle(field.key)">
                        <div>
                          <span class="font-semibold" x-text="field.label"></span>
                          <p class="text-sm text-base-content/70" x-show="field.note" x-text="field.note"></p>
                        </div>
                      </label>
                    </template>
                    <template x-if="!field.isToggle">
                      <div class="space-y-2">
                        <template x-if="$store.auth.registrationIsPhoneField(field)">
                          <div class="space-y-1">
                            <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                            <label class="input input-bordered flex items-center gap-3"
                                   :class="$store.auth.registration.errors[field.key]?.length ? 'input-error' : ''">
                              <span class="font-semibold text-base-content/70" x-show="field.prefix" x-text="field.prefix"></span>
                              <div class="relative grow min-w-0">
                                <input type="tel"
                                       class="w-full bg-transparent focus:outline-none tabular-nums"
                                       :style="$store.auth.registration.values[field.key] ? 'color: transparent; caret-color: var(--fallback-bc, currentColor);' : ''"
                                       x-model="$store.auth.registration.values[field.key]"
                                       @input="$store.auth.registrationHandleInput(field.key)"
                                       @blur="$store.auth.registrationHandleBlur(field.key)"
                                       :placeholder="field.placeholder || '123456789'">
                                <span class="pointer-events-none absolute inset-0 flex items-center text-base-content tabular-nums"
                                      :class="$store.auth.registration.values[field.key] ? 'opacity-100' : 'opacity-0'"
                                      x-text="$store.auth.registrationFormatPhoneDisplay($store.auth.registration.values[field.key])"></span>
                              </div>
                            </label>
                          </div>
                        </template>

                        <template x-if="!$store.auth.registrationIsPhoneField(field) && field.type === 'password'">
                          <label class="form-control w-full gap-2">
                            <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                            <div class="relative">
                              <input :type="$store.auth.registration.passwordVisible ? 'text' : 'password'"
                                     class="input input-bordered w-full pr-12"
                                     :placeholder="field.placeholder || '••••••••'"
                                     x-model="$store.auth.registration.values[field.key]"
                                     @input="$store.auth.registrationHandleInput(field.key)"
                                     @blur="$store.auth.registrationHandleBlur(field.key)">
                              <button type="button"
                                      class="absolute inset-y-0 right-2 flex items-center px-2 text-base-content transition-colors duration-150 hover:text-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-secondary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-base-100 z-20"
                                      @click="$store.auth.registration.passwordVisible = !$store.auth.registration.passwordVisible"
                                      :aria-label="$store.auth.registration.passwordVisible ? 'Skrýt heslo' : 'Zobrazit heslo'">
                                <i class="fa-regular text-base-content"
                                   :class="$store.auth.registration.passwordVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                              </button>
                            </div>
                          </label>
                        </template>

                        <template x-if="!$store.auth.registrationIsPhoneField(field) && ['text','email'].includes(field.type) && field.type !== 'password'">
                          <label class="form-control w-full gap-2">
                            <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                            <input :type="field.type === 'email' ? 'email' : 'text'"
                                   class="input input-bordered w-full"
                                   :placeholder="field.placeholder || undefined"
                                   x-model="$store.auth.registration.values[field.key]"
                                   @input="$store.auth.registrationHandleInput(field.key)"
                                   @blur="$store.auth.registrationHandleBlur(field.key)">
                          </label>
                        </template>

                        <template x-if="field.type === 'radio' && field.items.length">
                          <div class="space-y-2">
                            <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                            <div class="space-y-2">
                              <template x-for="item in field.items" :key="item">
                                <label class="flex items-center gap-3 rounded-lg border border-base-200 px-4 py-2">
                                  <input type="radio"
                                         class="radio radio-primary"
                                         :name="`reg-${field.key}`"
                                         :value="item"
                                         x-model="$store.auth.registration.values[field.key]"
                                         @change="$store.auth.registrationHandleInput(field.key); $store.auth.registrationHandleBlur(field.key)">
                                  <span class="text-sm" x-text="item"></span>
                                </label>
                              </template>
                            </div>
                          </div>
                        </template>

                        <template x-if="field.type === 'checkbox' && !field.isToggle">
                          <label class="flex items-start gap-3 rounded-lg border border-base-200 bg-base-100 px-4 py-3">
                            <input type="checkbox"
                                   class="checkbox checkbox-secondary mt-1"
                                   x-model="$store.auth.registration.values[field.key]"
                                   @change="$store.auth.registrationHandleInput(field.key); $store.auth.registrationHandleBlur(field.key)">
                            <span class="text-sm leading-snug" x-html="field.label"></span>
                          </label>
                        </template>

                        <template x-if="field.type === 'date'">
                          <label class="form-control w-full gap-2">
                            <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                            <input type="date"
                                   class="input input-bordered w-full"
                                   x-model="$store.auth.registration.values[field.key]"
                                   @input="$store.auth.registrationHandleInput(field.key)"
                                   @blur="$store.auth.registrationHandleBlur(field.key)">
                          </label>
                        </template>

                        <template x-if="field.type === 'address'">
                          <div x-data="$store.auth.registrationAddressField(field.key)" x-init="init()" class="space-y-2">
                            <label class="form-control w-full gap-2">
                              <span class="text-sm font-semibold text-base-content/80" x-text="field.label"></span>
                              <div class="relative">
                                <input type="text"
                                       class="input input-bordered w-full"
                                       :placeholder="(field.placeholder && field.placeholder.street) || 'Začněte psát adresu'"
                                       x-model="query"
                                       @focus="openSuggestions()"
                                       @input="onInput($event)"
                                       @blur="onBlur()"
                                       @keydown.arrow-down.prevent="highlightNext()"
                                       @keydown.arrow-up.prevent="highlightPrev()"
                                       @keydown.enter.prevent="selectHighlighted()">
                                <button type="button"
                                        class="btn btn-xs btn-ghost absolute right-2 top-1/2 -translate-y-1/2"
                                        @click="clearSelection()"
                                        x-show="hasValue">
                                  Vymazat
                                </button>
                              </div>
                            </label>
                            <div class="relative" x-show="open && options.length">
                              <ul class="menu absolute z-10 w-full rounded-xl border border-base-200 bg-base-100 shadow">
                                <template x-for="(option, index) in options" :key="option.id">
                                  <li>
                                    <button type="button"
                                            class="flex flex-col items-start"
                                            :class="{ 'active text-primary': highlighted === index }"
                                            @mouseenter="highlighted = index"
                                            @click="selectOption(option)">
                                      <span class="font-semibold" x-text="option.label"></span>
                                      <span class="text-xs text-base-content/70" x-text="option.cityLine"></span>
                                    </button>
                                  </li>
                                </template>
                              </ul>
                            </div>
                            <div class="rounded-lg border border-dashed border-base-300 bg-base-100 p-4 text-sm" x-show="hasValue">
                              <div class="font-semibold text-base-content">Vybraná adresa</div>
                              <p class="text-base-content/70 whitespace-pre-line" x-text="summaryBody"></p>
                            </div>
                          </div>
                        </template>

                        <p class="text-xs text-base-content/70" x-show="field.note" x-text="field.note"></p>
                        <p class="text-sm text-error"
                           x-show="$store.auth.registration.errors[field.key]?.length"
                           x-text="$store.auth.registration.errors[field.key][0]"></p>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
              <div class="modal-action justify-end">
                <button type="button"
                        class="btn btn-primary"
                        :class="{ 'btn-disabled': $store.auth.registration.phase === 'processing' }"
                        @click="$store.auth.submitRegistration()">
                  Dokončit registraci
                </button>
              </div>
            </section>
          </div>
        </template>

        <div class="absolute inset-0 rounded-2xl bg-base-100/90 backdrop-blur-sm grid place-items-center"
             x-show="$store.auth.registration.phase === 'processing' || $store.auth.registration.phase === 'success'"
             x-transition.opacity>
          <template x-if="$store.auth.registration.phase === 'processing'">
            <div class="flex flex-col items-center gap-3 text-center">
              <span class="loading loading-spinner loading-lg text-secondary"></span>
              <p class="text-sm text-base-content/70">Dokončujeme registraci…</p>
            </div>
          </template>
          <template x-if="$store.auth.registration.phase === 'success'">
            <div class="flex flex-col items-center gap-3 text-center">
              <span class="text-4xl text-success">
                <i class="fa-solid fa-circle-check"></i>
              </span>
              <h3 class="text-lg font-semibold">Hotovo! Přihlašujeme vás…</h3>
              <p class="text-sm text-base-content/70">Za malou chvíli budete pokračovat jako přihlášený uživatel.</p>
            </div>
          </template>
        </div>
      </div>
    </template>

    <div class="absolute inset-0 rounded-2xl bg-base-100/90 backdrop-blur-sm grid place-items-center"
         x-show="$store.auth?.status === 'loading'"
         x-transition.opacity>
      <div class="flex flex-col items-center gap-3">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-sm text-base-content/70">Ověřujeme údaje…</p>
      </div>
    </div>
  </div>
</div>

<!-- Tailwind breakpoint badge (dev helper) -->
<div
  id="tw-breakpoint-indicator"
  class="fixed bottom-4 left-4 z-[9999] flex items-center gap-2 rounded-full border border-base-300 bg-base-100/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-base-content shadow-lg pointer-events-none select-none backdrop-blur">
  <span aria-hidden="true" class="inline-flex h-2 w-2 rounded-full bg-success animate-pulse"></span>
  <span data-label>base</span>
  <span data-width class="font-normal lowercase text-base-content/70">(0px)</span>
</div>
<script>
  (() => {
    const badge = document.getElementById('tw-breakpoint-indicator');
    if (!badge) return;
    const STORAGE_KEY = 'fit:app-config';
    const SETTING_KEY = 'showBreakpointBadge';
    const DEFAULT_VISIBLE = true;
    const labelEl = badge.querySelector('[data-label]');
    const widthEl = badge.querySelector('[data-width]');
    const breakpoints = [
      { name: '2xl', min: 1536 },
      { name: 'xl', min: 1280 },
      { name: 'lg', min: 1024 },
      { name: 'md', min: 768 },
      { name: 'sm', min: 640 }
    ];
    const maxOnly = { name: 'xs', max: 413 };
    const baseName = 'base';
    const readVisibility = () => {
      if (typeof localStorage === 'undefined') return DEFAULT_VISIBLE;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return DEFAULT_VISIBLE;
        const parsed = JSON.parse(raw);
        const value = parsed && typeof parsed === 'object' ? parsed[SETTING_KEY] : undefined;
        return typeof value === 'boolean' ? value : DEFAULT_VISIBLE;
      } catch (e) {
        console.warn('badge visibility read failed', e);
        return DEFAULT_VISIBLE;
      }
    };
    const applyVisibility = (show) => {
      badge.classList.toggle('hidden', !show);
      badge.setAttribute('aria-hidden', show ? 'false' : 'true');
      badge.dataset.visible = show ? '1' : '0';
    };
    let visible = readVisibility();
    applyVisibility(visible);

    const resolve = (width) => {
      if (width <= maxOnly.max) return maxOnly.name;
      for (const bp of breakpoints) {
        if (width >= bp.min) return bp.name;
      }
      return baseName;
    };

    const update = () => {
      const width = Math.round(window.innerWidth || document.documentElement.clientWidth || 0);
      labelEl.textContent = resolve(width);
      widthEl.textContent = `(${width}px)`;
    };

    update();
    window.addEventListener('resize', update, { passive: true });
    window.addEventListener('orientationchange', update, { passive: true });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', update, { passive: true });
    }

    const setVisible = (value) => {
      const show = !!value;
      if (visible === show) return;
      visible = show;
      applyVisibility(visible);
    };

    window.addEventListener('fit:config-change', (event) => {
      if (!event || event.detail?.key !== SETTING_KEY) return;
      setVisible(event.detail.value);
    });

    window.addEventListener('storage', (event) => {
      if (event.key !== STORAGE_KEY) return;
      setVisible(readVisibility());
    });
  })();
</script>


</body>
</html>
