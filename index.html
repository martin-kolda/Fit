<!doctype html>
<html data-theme="max">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prototype prototype</title>

  <!-- CDN / dependecies -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/2c7f1c6cae.js" crossorigin="anonymous"></script>   
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="./theme/max-tokens.css"> 
  <script> // cannot be loaded by classic link
    fetch('./theme/tw-mapping.css', { cache: 'no-store' }).then(r => r.text()).then(css => {const s = document.createElement('style');s.type = 'text/tailwindcss';s.textContent = css;document.head.appendChild(s);});
  </script>
  <link rel="stylesheet" href="./theme/max.css" type="text/css">
  <script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>

  <style>
  [x-cloak]{display:none}
  @keyframes slideInLeft  { from { transform: translateX(-6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  @keyframes slideInRight { from { transform: translateX( 6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  .slide-in-left  { animation: slideInLeft  .18s ease-out; }
  .slide-in-right { animation: slideInRight .18s ease-out; }
  body {font-family: 'Figtree', sans-serif;}
  .leaflet-container img { max-width: none !important; }
  .ms-overlay-panel {height: 100vh; max-height: 100vh;}
  @supports (height: 100lvh) { .ms-overlay-panel { height: 100lvh; max-height: 100lvh;}}
  .reflection {-webkit-box-reflect: below -80px linear-gradient(transparent 60%, rgba(0, 0, 0, .5) 100%);}
  .free-ship-bar .fill { position: relative; }
  .free-ship-bar .fill.shimmer::after {content: "";position: absolute;inset: 0; background-image: linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,0.35) 18%,rgba(255,255,255,0) 36%);background-size: 200% 100%;animation: bar-shimmer 2.6s linear infinite;pointer-events: none;}
  @keyframes bar-shimmer {0%   { background-position: 50% 0; } 30%  { background-position: -100% 0; } 100% { background-position: -100% 0; }}
  @media (prefers-reduced-motion: reduce) {.free-ship-bar .fill.shimmer::after { animation: none; }}  

.timeline.no-start > li {grid-template-columns: auto 1fr !important;}
.timeline.no-start > li > .timeline-middle { grid-column: 1 !important; justify-self: center; }
.timeline.no-start > li > .timeline-end    { grid-column: 2 / -1 !important; padding-left: 0 !important; margin-left: 0 !important; }
.timeline.no-start > li > hr {grid-column: 1 !important; justify-self: center !important; align-self: stretch !important; width: 2px !important; border: 0 !important; }

  /* isolate each slide's painting & stacking on iOS to stop z-index flicker */
.banner-slide{
  isolation: isolate;          /* new stacking context */
  contain: paint;              /* confine repaints */
  -webkit-transform: translateZ(0); /* force its own layer on Safari */
  transform: translateZ(0);
  backface-visibility: hidden; /* reduce flicker */
}

/* make the moving track a GPU layer too */
.banner-track{
  will-change: transform;
  transform: translateZ(0);
}

/* optional: on very small screens, avoid backdrop compositing cost on chevrons */
@media (max-width: 640px){
  .banner-chevron{ -webkit-backdrop-filter: none; backdrop-filter: none; }
}



/* Base: set your normal button radius once */
.btn-squish {
  --br: 0.75rem;          /* change if your theme uses a different radius */
  border-radius: var(--br);
  will-change: transform, border-radius;
}

/* Trigger class; adjust duration freely (0.28s ... 1s) */
.btn-squish.is-squishing {
  animation: br-bounce var(--squish-dur, 1s) both;
}

/* Smoother, long-duration friendly bounce */
@keyframes br-bounce {
  /* press in */
  0% {
    transform: scale(1);
    border-radius: var(--br);
    animation-timing-function: cubic-bezier(.2,.7,.2,1); /* ease-in-ish */
  }
  35% {
    transform: scale(.985, .96);
    border-radius: calc(var(--br) - 0.20rem);
  }

  /* rebound */
  65% {
    transform: scale(1.018, 1.035);
    border-radius: calc(var(--br) + 0.10rem);
    animation-timing-function: cubic-bezier(.16,.84,.38,1); /* smooth ease-out */
  }

  /* settle */
  100% {
    transform: scale(1);
    border-radius: var(--br);
  }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .btn-squish.is-squishing { animation: none; }
}


  </style>

<script>
  document.addEventListener('alpine:init', () => {
    if (!Alpine.store('precart')) {
      Alpine.store('precart', {
        // state
        isOpen: false,
        product: null,
        catalog: [],
        quickAdded: new Set(),
  
        // api
        setCatalog(arr) { this.catalog = Array.isArray(arr) ? arr : []; },
        recommend(limit = 8) {
          const cur = String(this.product?.id ?? '');
          return (this.catalog || []).filter(p => String(p.id) !== cur).slice(0, limit);
        },
        open(product) {
          this.product = product || null;
          this.isOpen = !!this.product;
          this.quickAdded.clear();
        },
        close() {
          this.isOpen = false;
          this.product = null;
          this.quickAdded.clear();
        },
        markQuickAdded(id) { this.quickAdded.add(String(id)); },
        isQuickAdded(id)   { return this.quickAdded.has(String(id)); },
      });
    }
  });
  </script>
</head>

<body class="bg-base-200 overflow-x-hidden" x-data="storeApp()">
  <!-- TOP-BAR LOGO + SEARCH -->
<div class="navbar md:p-6 p-2 pt-4 pb-2 bg-base-100 overflow-x-hidden">
  <!-- left: menu + logo + (desktop) search -->
  <div class="flex flex-1 items-center gap-3 md:gap-4 min-w-0">
    <button class="btn btn-primary w-[46px] h-[46px] btn-lg btn-square max-gradient inline-flex md:hidden shrink-0"
            @click="$store.menu.openAt()">
      <img alt="Menu" class="relative h-[26px] w-[27px]" src="./icons/Bars.svg" />
    </button>

    <a href="/" @click.prevent="go('home')">
         <svg viewBox="0 0 137 46" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-[46px] md:h-[56px] shrink-0">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M23.2836 45.2917C10.8401 45.2917 0.716797 35.2915 0.716797 23C0.716797 10.7082 10.8401 0.708008 23.2836 0.708008H113.716C126.16 0.708008 136.283 10.7082 136.283 23C136.283 35.2915 126.16 45.2917 113.716 45.2917H23.2836Z" fill="white"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M113.716 0H23.284C10.4451 0 0 10.3177 0 22.9999C0 35.682 10.4451 46 23.284 46H113.716C126.555 46 137 35.682 137 22.9999C137 10.3177 126.555 0 113.716 0M113.716 1.41634C125.765 1.41634 135.566 11.0987 135.566 22.9999C135.566 34.901 125.765 44.5837 113.716 44.5837H23.284C11.2357 44.5837 1.43382 34.901 1.43382 22.9999C1.43382 11.0987 11.2357 1.41634 23.284 1.41634H113.716" fill="#A7A8AA"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M120.794 11.6358H117.464V8.34591C117.464 7.1797 116.503 6.23047 115.322 6.23047C114.141 6.23047 113.18 7.1797 113.18 8.34591V11.6358H109.85C108.669 11.6358 107.708 12.5847 107.708 13.7512C107.708 14.9177 108.669 15.8669 109.85 15.8669H113.18V19.1565C113.18 20.3233 114.141 21.2722 115.322 21.2722C116.503 21.2722 117.464 20.3233 117.464 19.1565V15.8669H120.794C121.975 15.8669 122.936 14.9177 122.936 13.7512C122.936 12.5847 121.975 11.6358 120.794 11.6358Z" fill="#78BE20"/>
          <path d="M85.4546 17.7158C89.5262 17.7158 93.0472 19.4528 93.0474 24.2979V33.2529C93.0473 33.6425 92.7276 33.9578 92.3335 33.958H88.9282C88.5144 33.958 88.1792 33.6269 88.1792 33.2188V31.46H88.1177C86.8629 33.4403 85.3324 34.3242 83.0669 34.3242C79.9134 34.3242 77.0962 32.7696 77.0962 29.3262C77.0964 24.4812 82.3933 23.9023 85.3325 23.9023C86.2199 23.9024 87.1996 23.9932 87.9038 24.1152C87.873 21.9519 86.2503 21.373 84.2603 21.373C82.6326 21.3731 81.0676 21.6288 79.6284 22.333C79.4478 22.4213 79.1721 22.2252 79.1675 22.0264L79.0972 19.2578C79.0909 19.0095 79.2418 18.7797 79.4771 18.6924C81.3186 18.0086 83.2532 17.7158 85.4546 17.7158ZM47.1782 29.4854C48.4415 29.4856 49.4653 30.5441 49.4653 31.8486C49.4653 33.1535 48.4415 34.2117 47.1782 34.2119C45.9147 34.2119 44.8901 33.1536 44.8901 31.8486C44.8901 30.5439 45.9148 29.4854 47.1782 29.4854ZM24.3267 12.6641C30.8944 12.6641 35.4896 14.9892 35.4897 23.2168C35.4897 31.1702 30.7595 33.9433 24.3267 33.9434H18.2173C17.8497 33.9434 17.5513 33.6068 17.5513 33.1924V13.415C17.5513 13.0003 17.8497 12.6641 18.2173 12.6641H24.3267ZM41.9097 20.1387C43.7154 17.3021 46.6765 17.5948 48.2319 18.1738C48.4727 18.2637 48.6008 18.5224 48.519 18.7637L47.5317 21.6865C47.4225 22.0103 47.0734 22.18 46.7407 22.0879C44.3565 21.4305 41.9097 22.7076 41.9097 26.7285V33.1924C41.9097 33.6067 41.6122 33.9433 41.2446 33.9434H37.8833C37.5157 33.9433 37.2173 33.6068 37.2173 33.1924V18.8701C37.2175 18.4559 37.5158 18.1201 37.8833 18.1201H41.2446C41.6121 18.1202 41.9095 18.4559 41.9097 18.8701V20.1387ZM59.356 12.6787C59.7235 12.6787 60.1161 13.0144 60.2329 13.4287L63.772 26.0264L67.312 13.4287C67.4286 13.0145 67.8214 12.6787 68.189 12.6787H73.1606C73.528 12.679 73.8571 13.0146 73.896 13.4287L75.731 33.2949C75.7694 33.7095 75.5027 33.9432 75.1353 33.9434H71.5171C71.1493 33.9432 70.8204 33.7095 70.7817 33.2949L69.5894 20.3486L65.98 33.2949C65.8851 33.6328 65.7294 33.9432 65.3315 33.9434H62.2134C61.8363 33.9434 61.6599 33.6329 61.5649 33.2949L57.9556 20.3486L56.5542 33.2949C56.5158 33.7095 56.1873 33.9432 55.8198 33.9434H52.4097C52.0421 33.9433 51.7753 33.7096 51.814 33.2949L53.6489 13.4287C53.6875 13.0145 54.0165 12.6788 54.3843 12.6787H59.356ZM98.8892 18.1201C99.3107 18.1199 99.5588 18.18 99.8657 18.5938L102.433 22.0898L105 18.5938C105.307 18.1798 105.555 18.1198 105.977 18.1201H109.941C110.362 18.1206 110.513 18.4106 110.303 18.7119L105.075 25.8076L110.512 33.1992C110.777 33.5263 110.627 33.9432 110.218 33.9434H106.217C105.799 33.9414 105.523 33.7421 105.278 33.4072L102.433 29.5254L99.5884 33.4072C99.343 33.7422 99.0674 33.9413 98.6489 33.9434H94.6479C94.2389 33.9433 94.0884 33.5263 94.353 33.1992L99.7915 25.8076L94.563 18.7119C94.3531 18.4106 94.5034 18.1205 94.9253 18.1201H98.8892ZM85.5776 26.8271C83.7099 26.8271 82.2397 27.407 82.2397 28.9307C82.24 30.0275 83.22 30.667 84.5054 30.667C86.5872 30.667 87.9038 28.7777 87.9038 26.9189C87.1997 26.8886 86.4039 26.8272 85.5776 26.8271ZM22.7231 16.8789V29.7383H24.4341C28.9445 29.7383 30.1958 27.5444 30.1958 23.3086C30.1958 19.0729 28.9804 16.8789 24.4341 16.8789H22.7231Z" fill="#E72234"/>
        </svg>
      </a>

    <!-- DESKTOP TOPBAR SEARCH -->
    <div class="relative hidden md:block w-full">
        <div
        x-data="searchBox({
          getProducts:   () => products,
          getCategories: () => navCategories,
          getLinks:      () => infoLinks,
          goTo: (id) => go(`product/${id}`)
        })"
        @keydown="onKeydown($event)"
        @click.outside="open = false"
        @resize.window="onWindowResize()"
        @scroll.window.passive="onWindowResize()"
        class="w-full"
      >
        <label
          x-ref="anchor"
          class="input p-4 input-bordered rounded-full max-w-2xl items-center gap-2 w-full h-[46px] md:h-[56px] max-input-gradient"
          aria-label="Vyhledávání"
        >
          <i class="fa-classic fa-xl fa-regular fa-search text-max-gray-600"></i>
    
          <input
            x-ref="input"
            type="search"
            class="grow text-lg min-w-0"
            placeholder="Hledej dle názvu"
            x-model.debounce.150ms="q"
            @focus="onFocus()"
            @input="onInput()"
            role="combobox"
            aria-autocomplete="list"
            :aria-expanded="open"
            :aria-controls="listId"
            :aria-activedescendant="activeDesc()"
          />
        </label>
    
        <!-- Dropdown  -->
        <div
        x-show="open"
        x-transition.opacity
        class="fixed z-[33]"
        :style="dropdownStyle"
      >
        <div class="bg-base-100 rounded-2xl shadow-xl border border-base-200 w-full box-border">
          <!-- RECENT -->
          <template x-if="q.trim().length < minChars">
            <ul
              class="p-2 max-h-80 overflow-y-auto w-full flex flex-col space-y-0"
              :id="listId" role="listbox"
            >
              <li class="px-2 py-1 text-xs font-semibold text-base-content/60">Naposledy hledané</li>

              <template x-if="!recentItems().length">
                <li class="w-full px-2 py-2 text-sm text-base-content/60">Začněte psát psát váš dotaz…</li>
              </template>

              <template x-for="(item, i) in recentItems()" :key="`${item.t}-${item.k ?? i}`">
                <li
                  :id="itemId(i)"
                  class="w-full"
                  role="option"
                  @mouseenter="highlighted = i"
                >
                <a :href="item.href || '#'"
                  @click.prevent="onSelect(item)" 
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
              
                    <!-- thumb for product/category -->
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-14 h-14 object-contain rounded bg-base-200/40" />
                    </template>
              
                    <!-- FA icon bubble for info -->
                    <template x-if="!item.img">
                      <span class="w-14 h-14 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
              
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
              
                    <!-- small type badge (optional) -->
                    <span class="badge badge-ghost badge-sm shrink-0" x-text="item.t === 'product' ? 'Produkt' : (item.t==='category' ? 'Kategorie' : 'Info')"></span>
                  </a>
                </li>
              </template>
            </ul>
          </template>
    
            <!-- SUGGESTIONS -->
            <template x-if="q.trim().length >= minChars">
              <ul
                class="p-2 max-h-80 overflow-y-auto w-full flex flex-col space-y-1"
                :id="listId" role="listbox"
              >
                <template x-if="!suggestions().length">
                  <li class="w-full px-2 py-3 font-medium text-base text-center text-max-gray-400">
                    Žádné výsledky
                  </li>
                </template>

                <template x-for="(item, i) in suggestions()" :key="`${item.t}-${item.k ?? i}`">
                  <li
                    :id="itemId(i)"
                    class="w-full"
                    role="option"
                    @mouseenter="highlighted = i"
                  >
                    <a :href="item.href || '#'"
                       @click.prevent="onSelect(item)" 
                       class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                       :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                
                      <!-- thumb for product/category -->
                      <template x-if="item.img">
                        <img :src="item.img" alt="" class="w-14 h-14 object-contain rounded bg-base-200/40" />
                      </template>
                
                      <!-- FA icon bubble for info -->
                      <template x-if="!item.img">
                        <span class="w-14 h-14 rounded-full bg-base-200 grid place-items-center">
                          <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                        </span>
                      </template>
                
                      <div class="min-w-0 flex-1">
                        <div class="font-medium text-base truncate" x-text="item.name"></div>
                        <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                      </div>
                
                      <!-- small type badge (optional) -->
                      <span class="badge badge-ghost badge-sm shrink-0" x-text="item.t === 'product' ? 'Produkt' : (item.t==='category' ? 'Kategorie' : 'Info')"></span>
                    </a>
                  </li>
                </template>
              </ul>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOP-BAR QUICK ACTIONS (desktop only) -->
  <div class="hidden md:flex md:px-4">
    <button type="button" class="btn btn-link hidden lg:flex items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline">
      <i class="fa-classic fa-xl fa-solid fa-map-location-dot"></i>
      <span class="hidden xl:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary">
        <a href="#/map">Mapa lékáren a boxů</a>
      </span>
    </button>

    <div class="dropdown dropdown-start">
      <button type="button" class="btn btn-link hidden md:flex items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline">
        <img alt="Language" class="relative h-[26px] w-[27px]" src="./icons/languages/En.svg" />
        <span class="hidden 2xl:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary">
          English
        </span>
        <i class="fa-classic fa-md fa-solid fa-chevron-down"></i>
      </button>
      <ul tabindex="0" class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52">
        <li><a><i class="fa-classic fa-md fa-solid fa-empty"></i> English</a></li>
        <li><a><i class="fa-classic fa-md fa-solid fa-empty"></i> Polski</a></li>
        <li><a><i class="fa-classic fa-md fa-solid fa-check"></i> Česky</a></li>
      </ul>
    </div>

    <button type="button" class="btn btn-link hidden md:flex items-center gap-2 p-2 md:p-4 group no-underline hover:!no-underline focus-visible:!no-underline">
      <i class="fa-classic fa-xl fa-solid fa-phone"></i>
      <span class="hidden lg:block underline-offset-2 decoration-1 decoration-current group-hover:underline group-focus-visible:underline text-secondary">
        516 770 100
      </span>
    </button>
  </div>

  <!-- TOP-BAR BUTTONS + CART (mobile + desktop) -->
  <div class="flex gap-2 flex-none">
    <button class="btn btn-primary w-12 h-12 btn-lg btn-square max-gradient-gray hidden md:block"
    aria-label="Otevřít právě doručujeme" title="Právě doručujeme"
    @click="location.hash='/my-account'"
    >
      <i class="fa-classic fa-xl fa-regular fa-truck-fast text-gray-700 max-embos-v-gray"></i>
    </button>

    <button class="btn btn-primary w-12 h-12 btn-lg btn-square max-gradient" 
    aria-label="Otevřít moje uložené" title="Moje uložené"
    @click="location.hash='/my-saved'"
    >
      <i class="fa-classic fa-xl fa-regular fa-heart text-white max-embos-v"></i>
    </button>

    <button class="btn btn-primary w-12 h-12 btn-lg btn-square max-gradient" 
    aria-label="Otevřít můk účet" title="Můj účet"
    @click="location.hash='/my-account'"
    >
      <i class="fa-classic fa-xl fa-regular fa-user-circle text-white max-embos-v"></i>
    </button>

    <button
    class="btn btn-primary btn-squish w-12 h-12 btn-lg btn-square max-gradient indicator"
    aria-label="Otevřít košík" title="Košík"
    @click="location.hash='/cart'"
    @pointerdown="$el.classList.add('is-squishing')"
    @animationend="requestAnimationFrame(()=> $el.classList.remove('is-squishing'))"
    x-data
  >
    <i class="fa-classic fa-xl fa-regular fa-basket-shopping text-white max-embos-v"></i>
  
    <!-- Badge (distinct items). Empty badge if 1 item, show number if >1 -->
    <template x-if="$store.cart.distinctCount() > 0">
      <span
        class="badge badge-error badge-sm indicator-item"
        :class="{ 'scale-110': $store.cart._badgePulse }"
        x-text="$store.cart.distinctCount() > 1 ? $store.cart.distinctCount() : ''"
        x-transition.scale.origin-center
      ></span>
    </template>
  </button>
  </div>
</div>

<!-- MOBILE TOPBAR SEARCH (trigger only) -->
<div class="navbar md:hidden h-12 p-2 pt-0 bg-white mb-6 text-base-content relative" x-data>
    <button
    type="button"
    class="input input-lg px-4 input-bordered rounded-full max-w-2xl items-center gap-2 w-full text-left max-input-gradient"
    aria-label="Vyhledávání"
    @pointerdown="
      window.__msGhost = $refs.msGhost;                // stash a reference
      $refs.msGhost && $refs.msGhost.focus({ preventScroll:true }); // pop keyboard
      $dispatch('open-mobile-search', { from: 'tap' }) // open overlay in same gesture
    "
  >
    <i class="fa-classic fa-regular fa-search text-max-gray-600"></i>
    <span class="grow min-w-0 text-base-content/60">Hledej dle názvu</span>
  </button>

  <!-- Invisible but focusable 'ghost' input to trigger the keyboard -->
  <input
    x-ref="msGhost"
    type="text"
    autocomplete="off"
    autocapitalize="none"
    spellcheck="false"
    inputmode="search"
    style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; z-index:1;"
  />
</div>

  <!-- NAVBAR PRODUCT NAVIGATION -->
  <div class="navbar hidden md:flex bg-primary max-gradient-v text-primary-content h-12 p-1 pl-4 pr-4">

    <ul class="menu flex-none w-fit menu-horizontal rounded-box text-base font-medium">
      <li>
        <a @click="$store.menu.openAt()"><i class="fa-solid fa-bars"></i>Procházet kategorie</a>
      </li>

      <li>
        <a>Zdravé léto</a>
      </li>
      <li>
        <a>Na opalování
        </a>
      </li>
      <li>
        <a>Produkty Dr. Max</a>
      </li>
      <li>
        <a>3 za 2</a>
      </li>      
    </ul>
  </div>




<!-- ROUTER SHELL -->
<div id="app">

<!-- ROUTE == HOMEPAGE -->
<template x-if="is('home')">
  <div class="sm:w-11/12 lg:w-10/12 mx-auto p-4 pb-12 pt-1 md:pt-6">
    


<!-- Billboard Carousel -->
<section x-data="homeCarousel()" class="mt-0 lg:mt-4">
  <div class="group relative rounded-2xl overflow-hidden shadow-md select-none h-100"
       tabindex="0" x-ref="viewport" style="touch-action: pan-y;">

    <!-- track -->
    <div x-ref="track"
         class="flex h-full banner-track will-change-transform transform-gpu" 
         :style="trackStyle()">

      <template x-for="(slide,i) in slides" :key="slide.id || i">
        <a :href="ctaHref(slide)"
           class="shrink-0 min-w-full block h-full overflow-hidden" 
           @click="onSlideClick($event)">

          <!-- FIXED HEIGHT slide container -->
          <div class="relative bg-base-200 h-100 banner-slide transform-gpu"
               :class="cls(slide,'wrapper')"
               :style="style(slide,'background_color')">

            <!-- background -->
            <img :src="slide.background || './images/banners/default-bg.jpg'"
                 :alt="slide.title"
                 class="absolute inset-0 w-full h-full object-cover z-0"
                 :class="cls(slide,'background')">

            <!-- texts & CTA -->
            <h2 class="absolute" :class="cls(slide,'title')" x-text="slide.title"></h2>

            <p class="absolute opacity-90" :class="cls(slide,'text')" x-text="txt(slide)"></p>

            <span class="btn absolute btn-squish"
                  @pointerdown="$el.classList.add('is-squishing')"
                  @animationend="requestAnimationFrame(()=> $el.classList.remove('is-squishing'))"
                  :class="cls(slide,'cta')">
              <span x-text="ctaLabel(slide)"></span>
              <i :class="ctaIcon(slide)" class="ml-2"></i>
            </span>

            <button type="button"
                    class="btn btn-link btn-sm absolute"
                    :class="cls(slide,'legal_link')"
                    @click.stop.prevent="openModal(slide)">
              <span x-text="slide.legal?.linkLabel || 'Podmínky akce'"></span>
            </button>

            <!-- layers -->
            <template x-for="n in 6" :key="`layer-${i}-${n}-${isActive(i)?animNonce:'off'}`">
              <img :src="slide[`layer_${n}_src`] || slide[`layer_${n}`] || (slide.layers?.[n]?.src)"
                   x-show="slide[`layer_${n}`] || slide[`layer_${n}_src`] || (slide.layers && slide.layers[n])"
                   class="absolute pointer-events-none"
                   :class="[cls(slide, `layer_${n}`), anim(slide, `layer_${n}`, i)].filter(Boolean).join(' ')">
            </template>

          </div>
        </a>
      </template>
    </div>

    <!-- chevrons (hover-only, as before) -->
    <button
      class="hidden md:flex absolute left-2 top-1/2 -translate-y-1/2
             h-10 w-10 items-center justify-center rounded-full
             bg-white/70 shadow-sm backdrop-blur leading-none
             transition duration-200
             opacity-0 group-hover:opacity-100
             pointer-events-none group-hover:pointer-events-auto
             outline-none focus:outline-none focus:ring-0"
      @click.stop.prevent="prev()" aria-label="Předchozí banner">
      <i class="fa-solid fa-chevron-left"></i>
    </button>

    <button
      class="hidden md:flex absolute right-2 top-1/2 -translate-y-1/2
             h-10 w-10 items-center justify-center rounded-full
             bg-white/70 shadow-sm backdrop-blur leading-none
             transition duration-200
             opacity-0 group-hover:opacity-100
             pointer-events-none group-hover:pointer-events-auto
             outline-none focus:outline-none focus:ring-0"
      @click.stop.prevent="next()" aria-label="Další banner">
      <i class="fa-solid fa-chevron-right"></i>
    </button>
 
    
    
    

  </div>

  <!-- dots outside -->
  <div class="mt-3 flex items-center justify-center gap-2">
    <template x-for="(s,i) in slides" :key="s.id || i">
      <button class="btn btn-circle border-none w-3 h-3 min-h-0 p-0"
              :class="isActive(i) ? 'btn-primary h-4 w-4' : 'bg-base-300'"
              @click="go(i)"
              :aria-label="`Slide ${i+1}`"></button>
    </template>
  </div>

  <!-- per-slide legal modals -->
  <template x-for="(slide,i) in slides" :key="'m'+(slide.id||i)">
    <dialog :id="modalId(slide)" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" aria-label="Zavřít">✕</button>
        </form>
        <h3 class="text-lg font-bold" x-text="slide.legal?.title || slide.title"></h3>
        <p class="py-4 whitespace-pre-line" x-text="slide.legal?.text || ''"></p>
      </div>
    </dialog>
  </template>
</section>

 <!-- hits of the week -->
 <section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Hity týdne</h3>
  </div>

  <div class="relative group">
    <!-- indicators (use the same key) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile affordance -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['hits']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller: call registerTopStrip with the same key, use $el not $refs -->
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'hits')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-5">
        <template x-for="p in topProductsShuffledFor('hits', 12)" :key="p.id">
          <!-- card markup unchanged -->
          <a :href="link('product',{id:p.id})"
             class="snap-start shrink-0 w-48 sm:w-56 card bg-white hover:shadow-md transition relative">
            <span x-show="discountPct(p) !== null"
                  class="absolute left-2 top-2 badge badge-error text-white font-semibold">
              <span x-text="`-${discountPct(p)}%`"></span>
            </span>
            <figure class="p-3 h-40">
              <img :src="p.image || './images/placeholder.webp'" :alt="p.name"
                   class="w-full h-full object-cover">
            </figure>
            <div class="card-body pt-0 flex flex-col">
              <div class="text-sm font-medium line-clamp-2 min-h-[3rem]" x-text="p.name"></div>
              <div class="mt-auto">
                <div class="text-base font-semibold">
                  <span x-text="formatPrice(currentPrice(p))"></span>
                  <span class="ml-2 line-through text-xs opacity-60"
                        x-show="crossedPrice(p) !== null"
                        x-text="formatPrice(crossedPrice(p))"></span>
                </div>
                <div class="mt-1" x-show="isInStock(p)">
                  <span class="badge badge-success">Skladem</span>
                </div>
              </div>
            </div>
          </a>
        </template>
      </div>
    </div>
  </div>
</section>




 <!-- favorites in sale -->
 <section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Hity týdne</h3>
  </div>

  <div class="relative group">
    <!-- indicators (use the same key) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['hits']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile affordance -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['hits']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller: call registerTopStrip with the same key, use $el not $refs -->
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'hits')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-5">
        <template x-for="p in topProductsShuffledFor('saved', 12)" :key="p.id">
          <!-- card markup unchanged -->
          <a :href="link('product',{id:p.id})"
             class="snap-start shrink-0 w-48 sm:w-56 card bg-white hover:shadow-md transition relative">
            <span x-show="discountPct(p) !== null"
                  class="absolute left-2 top-2 badge badge-error text-white font-semibold">
              <span x-text="`-${discountPct(p)}%`"></span>
            </span>
            <figure class="p-3 h-40">
              <img :src="p.image || './images/placeholder.webp'" :alt="p.name"
                   class="w-full h-full object-cover">
            </figure>
            <div class="card-body pt-0 flex flex-col">
              <div class="text-sm font-medium line-clamp-2 min-h-[3rem]" x-text="p.name"></div>
              <div class="mt-auto">
                <div class="text-base font-semibold">
                  <span x-text="formatPrice(currentPrice(p))"></span>
                  <span class="ml-2 line-through text-xs opacity-60"
                        x-show="crossedPrice(p) !== null"
                        x-text="formatPrice(crossedPrice(p))"></span>
                </div>
                <div class="mt-1" x-show="isInStock(p)">
                  <span class="badge badge-success">Skladem</span>
                </div>
              </div>
            </div>
          </a>
        </template>
      </div>
    </div>
  </div>
</section>


<!-- Top brands -->
<section class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">Top značky</h3>
  </div>

  <div class="relative group">
    <!-- indicators (left/right) -->
    <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['brands']?.left ? 'opacity-100' : 'opacity-0'"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent
                transition-opacity duration-200 z-10"
         :class="tpStates['brands']?.right ? 'opacity-100' : 'opacity-0'"></div>

    <!-- mobile scroll affordance (fades after first scroll) -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="tpStates['brands']?.scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none">
        <i class="fa-solid fa-chevron-right fa-lg"></i>
      </div>
    </div>

    <!-- scroller -->
    <div class="overflow-x-auto scrollbar-thin"
         x-init="registerTopStrip($el, 'brands')">
      <div class="flex gap-3 snap-x snap-mandatory px-0 pb-2">
        <template x-for="b in brandsShuffledFor('brands', 18)" :key="b.name">
          <a :href="brandHref(b)"
             class="snap-start shrink-0
                    w-36 sm:w-40 md:w-44 lg:w-48 xl:w-52
                    aspect-square rounded-xl bg-white p-3 hover:shadow-md transition
                    focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40
                    relative grid place-items-center">
            <!-- logo -->
            <img :src="b.logo" :alt="b.name" class="object-contain max-w-full max-h-full">

            <!-- badge (optional) -->
            <template x-if="badgeText(b)">
              <span class="absolute right-1.5 top-1.5 badge"
                    :class="badgeClass(b)" x-text="badgeText(b)"></span>
            </template>
          </a>
        </template>
      </div>
    </div>
  </div>
</section>


<!-- Magazine blog -->
<section class="mt-8" x-cloak x-show="Array.isArray(blogPosts) && blogPosts.length">
  <h3 class="text-lg font-semibold mb-3">Blog</h3>

  <!-- Mobile: horizontal scroller (2-up + tiny peek) · md+: 3-col grid -->
  <div class="flex gap-3 overflow-x-auto snap-x snap-mandatory pb-6
              md:overflow-visible md:grid md:grid-cols-3 md:gap-4 md:snap-none md:pb-0">
    <template x-for="post in blogFeatured(6)" :key="post.id || post.title">
      <article class="shrink-0 w-[calc(50%-0.9rem)] snap-start md:w-auto md:shrink md:col-span-1">
        <div class="card h-full bg-base-100 shadow rounded-xl overflow-hidden">
          <!-- IMAGE (clickable) -->
          <figure class="h-48 overflow-hidden">
            <a :href="blogLink(post)" class="block w-full h-full">
              <img :src="post.image" :alt="post.title" class="w-full h-full object-cover" loading="lazy">
            </a>
          </figure>

          <!-- BODY -->
          <div class="card-body min-w-0 flex flex-col gap-2 md:gap-3">
            <!-- TITLE (clickable) · fixed 2 lines -->
            <h2 class="text-xl font-semibold leading-snug line-clamp-2 min-h-[3.5rem]">
              <a :href="blogLink(post)" class="hover:underline" x-text="post.title"></a>
            </h2>

            <!-- META -->
            <div class="text-sm">
              <span class="text-success font-bold" x-text="readingTimeLabel(post)"></span>
              <span class="mx-1 opacity-40">•</span>
              <span class="opacity-70" x-text="post.category"></span>
            </div>

            <!-- EXCERPT -->
            <p class="text-base line-clamp-4" x-text="blogExcerpt(post)"></p>

            <!-- CTA + likes -->
            <div class="mt-4 flex items-center opacity-70">
              <a :href="blogLink(post)" class="btn btn-sm btn-outline">Číst dál</a>
              <div class="ml-auto flex items-center gap-1">
                <i class="fa-regular fa-thumbs-up fa-lg"></i>
                <span x-text="post.likes ?? 0"></span>
              </div>
            </div>
          </div>
        </div>
      </article>
    </template>
  </div>
</section>

<!-- Reasons to buy -->
<section class="mt-8">
  <h3 class="text-lg font-semibold mb-3">Proč nakoupit u Dr. Max 2</h3>
  <div x-data="{ scrolled:false }" class="relative">
    <div
      x-ref="rail"
      @scroll.passive="scrolled = $event.target.scrollLeft > 8"
      class="flex gap-2 overflow-x-auto snap-x snap-mandatory pb-2
             md:overflow-visible md:grid md:grid-cols-4 md:gap-3 md:snap-none md:pb-0"
    >

      <!-- Tile -->
      <div class="shrink-0 w-[calc(50%-0.75rem)] snap-start
                  md:w-auto md:shrink md:col-span-1 md:contents">
        <a href="#" @click.prevent
           class="block h-full rounded-xl bg-white p-3 hover:shadow-md transition
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40">
          <div class="flex h-full flex-col gap-3">
            <div class="rounded-xl overflow-hidden grid place-items-center">
              <img src="./images/rtbs/free-shipping.webp" alt="" class="max-h-24 w-auto object-contain">
            </div>
            <span class="text-base font-medium text-center [&_b]:text-max-green-600">
              <b>Doprava ZDARMA</b> od 399 Kč pro přihlášené
            </span>
          </div>
        </a>
      </div>

      <!-- Tile -->
      <div class="shrink-0 w-[calc(50%-0.75rem)] snap-start
                  md:w-auto md:shrink md:col-span-1 md:contents">
        <a href="#" @click.prevent
           class="block h-full rounded-xl bg-white p-3 hover:shadow-md transition
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40">
          <div class="flex h-full flex-col gap-3">
            <div class="rounded-xl overflow-hidden grid place-items-center">
              <img src="./images/rtbs/private-label.webp" alt="" class="max-h-24 w-auto object-contain">
            </div>
            <span class="text-base font-medium text-center [&_b]:text-max-green-600">
              Široká nabídka <b>produktů značky Dr. Max</b>
            </span>
          </div>
        </a>
      </div>

      <!-- Tile -->
      <div class="shrink-0 w-[calc(50%-0.75rem)] snap-start
                  md:w-auto md:shrink md:col-span-1 md:contents">
        <a href="#" @click.prevent
           class="block h-full rounded-xl bg-white p-3 hover:shadow-md transition
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40">
          <div class="flex h-full flex-col gap-3">
            <div class="rounded-xl overflow-hidden grid place-items-center">
              <img src="./images/rtbs/loyalty-program.webp" alt="" class="max-h-24 w-auto object-contain">
            </div>
            <span class="text-base font-medium text-center [&_b]:text-max-green-600">
              Kopa výhod <b>věrnostního programu Dr. Max</b>
            </span>
          </div>
        </a>
      </div>
      <!-- Tile -->
      <div class="shrink-0 w-[calc(50%-0.75rem)] snap-start
                  md:w-auto md:shrink md:col-span-1 md:contents">
        <a href="#" @click.prevent
           class="block h-full rounded-xl bg-white p-3 hover:shadow-md transition
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40">
          <div class="flex h-full flex-col gap-3">
            <div class="rounded-xl overflow-hidden grid place-items-center">
              <img src="./images/rtbs/mobile-app.webp" alt="" class="max-h-24 w-auto object-contain">
            </div>
            <span class="text-base font-medium text-center [&_b]:text-max-green-600">
              <b>Mobilní aplikace</b> plná užitečných funkcí
            </span>
          </div>
        </a>
      </div>      

    </div>

    <!-- Scroll affordance (mobile only): gradient + chevron, fades after first scroll -->
    <div class="md:hidden pointer-events-none absolute inset-y-0 right-0 w-10 z-10 transition-opacity"
         :class="scrolled ? 'opacity-0' : 'opacity-100'">
      <div class="h-full bg-gradient-to-l from-base-100 to-transparent"></div>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/60 animate-pulse select-none"><i class="fa-solid fa-chevron-right fa-lg"></i></div>
    </div>
  </div>
</section>


  </div>
</template>



<!-- ROUTE == PRODUCTS -->
<section x-show="is('products')" x-cloak>

<!-- CATEGORIES GRID -->
<div x-data="categoriesList" x-cloak class="sm:w-11/12 lg:w-10/12 mx-auto">
  <!-- BREADCRUMBS -->
  <div class="breadcrumbs hidden md:block text-sm mx-auto px-4 pt-6">
    <ul>
      <li>Domů</li>
      <li><a href="#/products">Zdraví a léky</a></li>
    </ul>
  </div>
  <h1 class="text-3xl mx-auto mt-4 px-4 pb-4">Zdraví a léky</h1>

  <div class="grid gap-2 md:gap-4 sm:grid-cols-2 lg:grid-cols-3 p-4">
    
    <template x-for="cat in categories" :key="cat.name">
      <a class="card card-side items-center shadow-sm hover:shadow-md bg-white transition cursor-pointer h-14 md:h-auto">
        <figure class="p-2 shrink-0 ">
          <div class="h-10 md:h-16 w-10 md:w-16 rounded bg-base-200 overflow-hidden grid place-content-center">
            <img
              :src="imageUrl(cat)"
              :alt="cat.name"
              class="h-full w-full object-contain"
              @error="$event.target.src = fallback"
            />
          </div>
        </figure>
    
        <div class="card-body min-w-0 pl-1">
          <h2 class="card-title block truncate max-w-full text-base font-medium" :title="cat.name" x-text="cat.name"></h2>
          <!--<div class="card-actions justify-end">
            <span class="badge badge-outline" x-text="productsLabel(cat.products)"></span>
          </div>-->
        </div>
      </a>
    </template>

  </div>
</div>


<!-- FILTERS -->
<section aria-labelledby="filters-heading" class="space-y-3">
  <!-- Heading row -->
  <div class="lg:w-10/12 sm:w-11/12 mx-auto px-4 pt-6 flex flex-wrap items-center gap-2">
    <h2 id="filters-heading" class="text-lg font-semibold">Filtry a řazení</h2>
  </div>

  <!-- Controls -->
  <div class="flex flex-col sm:flex-row flex-wrap items-stretch gap-2 px-4 lg:w-10/12 sm:w-11/12 mx-auto">

    <!-- Kategorie -->
    <div class="dropdown">
        <div tabindex="0" role="button"
             class="relative select select-bordered w-full sm:w-56 flex items-center justify-between gap-2"
             x-ref="catBtn">
          <span class="truncate" x-text="selectedCategory || 'Kategorie: všechny'"></span>
      
          <!-- Clear button -->
          <button type="button"
                  class="btn btn-xs btn-outline bg-white absolute right-2"
                  x-show="!!selectedCategory"
                  aria-label="Zrušit kategorii"
                  @mousedown.prevent.stop
                  @click.prevent.stop="selectedCategory=''; $refs.catBtn.blur()">
            ✕
          </button>
        </div>
      <ul tabindex="0"
          class="dropdown-content menu bg-base-100 rounded-box shadow p-2 w-full sm:w-64
                 max-h-72 overflow-auto grid grid-cols-1">
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="cat" class="radio radio-sm radio-secondary"
                   :checked="!selectedCategory" @change="selectedCategory=''" />
            <span>Všechny kategorie</span>
          </label>
        </li>
        <template x-for="c in categories" :key="'cat-'+c">
          <li>
            <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
              <input type="radio" name="cat" class="radio radio-sm radio-secondary"
                     :checked="selectedCategory===c" @change="selectedCategory=c" />
              <span x-text="c"></span>
            </label>
          </li>
        </template>
      </ul>
    </div>

    <!-- Forma -->
    <div class="dropdown">
      <div tabindex="0" role="button"
           class="relative select select-bordered w-full sm:w-56 flex items-center justify-between gap-2"
           x-ref="formBtn">
        <span class="truncate" x-text="selectedForm || 'Forma: všechny'"></span>
    
        <!-- Clear button -->
        <button type="button"
                class="btn btn-xs btn-outline bg-white absolute right-2"
                x-show="!!selectedForm"
                aria-label="Zrušit formu"
                @mousedown.prevent.stop
                @click.prevent.stop="selectedForm=''; $refs.formBtn.blur()">
          ✕
        </button>
      </div>
      <ul tabindex="0"
          class="dropdown-content menu bg-base-100 rounded-box shadow p-2 w-full sm:w-64
                 max-h-72 overflow-auto grid grid-cols-1">
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="form" class="radio radio-sm radio-secondary"
                   :checked="!selectedForm" @change="selectedForm=''" />
            <span>Všechny typy</span>
          </label>
        </li>
        <template x-for="f in forms" :key="'form-'+f">
          <li>
            <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
              <input type="radio" name="form" class="radio radio-sm radio-secondary"
                     :checked="selectedForm===f" @change="selectedForm=f" />
              <span x-text="f"></span>
            </label>
          </li>
        </template>
      </ul>
    </div>

    <!-- Vhodné pro (multi) -->
    <div class="dropdown">
      <div tabindex="0" role="button"
           class="relative select select-bordered w-full sm:w-56 flex items-center justify-between gap-2"
           x-ref="consBtn">
        <span class="truncate" x-text="consumersLabel()"></span>
    
        <!-- Clear button -->
        <button type="button"
                class="btn btn-xs btn-outline bg-white absolute right-2"
                x-show="selectedConsumers.length"
                aria-label="Zrušit Vhodné pro"
                @mousedown.prevent.stop
                @click.prevent.stop="selectedConsumers=[]; $refs.consBtn.blur()">
          ✕
        </button>
      </div>
      <ul tabindex="0"
          class="dropdown-content menu bg-base-100 rounded-box shadow p-2 w-full sm:w-64
                 max-h-72 overflow-auto grid grid-cols-1">
        <template x-for="opt in consumersList" :key="'cons-'+opt">
          <li>
            <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
              <input type="checkbox" class="checkbox checkbox-sm checkbox-secondary"
                     :value="opt"
                     @change="toggleConsumer(opt)"
                     :checked="selectedConsumers.includes(opt)"/>
              <span x-text="opt"></span>
            </label>
          </li>
        </template>
      </ul>
    </div>

    <!-- Možnosti (binary toggles) -->
    <div class="dropdown">
      <div tabindex="0" role="button"
           class="relative select select-bordered w-full sm:w-56 flex items-center justify-between gap-2"
           x-ref="optsBtn">
        <span class="truncate" x-text="optionsLabel()"></span>
    
        <!-- Clear button -->
        <button type="button"
                class="btn btn-xs btn-outline bg-white absolute right-2"
                x-show="optionsCount()>0"
                aria-label="Zrušit možnosti"
                @mousedown.prevent.stop
                @click.prevent.stop="clearOptions(); $refs.optsBtn.blur()">
          ✕
        </button>
      </div>
      <ul tabindex="0"
          class="dropdown-content menu bg-base-100 rounded-box shadow p-2 w-full sm:w-64
                 max-h-72 overflow-auto grid grid-cols-1">
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="checkbox" class="checkbox checkbox-sm checkbox-secondary" x-model="onlyInStock">
            <span>Pouze skladem</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="checkbox" class="checkbox checkbox-sm checkbox-secondary" x-model="benefitOnly">
            <span>Lze platit benefity</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="checkbox" class="checkbox checkbox-sm checkbox-secondary" x-model="onlyDiscounted">
            <span>Produkty v akci</span>
          </label>
        </li>
      </ul>
    </div>

    <!-- Řadit dle -->
    <div class="dropdown">
      <div tabindex="0" role="button"
           class="select select-bordered w-full sm:w-56 flex items-center justify-between">
        <span x-text="sortLabel()"></span>
      </div>
      <ul tabindex="0"
          class="dropdown-content menu bg-base-100 rounded-box shadow p-2 w-full sm:w-64
                 max-h-72 overflow-auto grid grid-cols-1">
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="sort" class="radio radio-sm radio-secondary"
                   :checked="!sortOrder" @change="sortOrder=''" />
            <span>Doporučeno</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="sort" class="radio radio-sm radio-secondary"
                   :checked="sortOrder==='priceAsc'" @change="sortOrder='priceAsc'" />
            <span>Cena ↑</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="sort" class="radio radio-sm radio-secondary"
                   :checked="sortOrder==='priceDesc'" @change="sortOrder='priceDesc'" />
            <span>Cena ↓</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="sort" class="radio radio-sm radio-secondary"
                   :checked="sortOrder==='alphaAsc'" @change="sortOrder='alphaAsc'" />
            <span>Abecedně A–Z</span>
          </label>
        </li>
        <li>
          <label class="label cursor-pointer justify-start gap-2 text-max-gray-800">
            <input type="radio" name="sort" class="radio radio-sm radio-secondary"
                   :checked="sortOrder==='alphaDesc'" @change="sortOrder='alphaDesc'" />
            <span>Abecedně Z–A</span>
          </label>
        </li>
      </ul>
    </div>

    <!-- Search (compact & flexible) -->
     <div>
    <label class="input input-bordered items-center gap-2 w-full"
           aria-label="Vyhledávání">
           <i class="fa-solid fa-magnifying-glass text-max-gray-600"></i>
      <input type="search" placeholder="Filtruj dle názvu"
             x-model.debounce.300ms="search" />
    </label>
  </div>
  </div>


<!-- Heading row -->
<div class="lg:w-10/12 sm:w-11/12 mx-auto px-4 pt-6 flex flex-wrap items-center gap-2">
  <h2 id="filters-heading" class="text-lg font-semibold">Výpis produktů: <span class="ml-1 font-semibold" x-text="filteredCount()"></span></h2>
  <button class="btn btn-sm btn-outline ml-2 border-max-blue-500 text-max-blue-600" @click="clearFilters()" x-show="hasActiveFilters()" x-cloak x-transition.opacity.scale>
    Vymazat filtry
  </button>
</div>
</section>

<!-- LOADER -->
<div x-show="isLoading" class="flex justify-center py-8" aria-live="polite" aria-busy="true">
  <span class="loading loading-spinner loading-lg"></span>
</div>


<div x-show="!isLoading" x-transition.opacity.duration.200ms class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 lg:w-10/12 sm:w-11/12 mx-auto items-stretch">
  <template x-for="product in pagedProducts().filter(p => String(p.id) === '4')" :key="product.id">
    <article class="h-full">
      <div class="card card-side h-full bg-base-100 shadow relative px-8">
        <!-- BADGES -->
        <div x-show="product.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
          <template x-for="(b,i) in (product?.badges || [])" :key="i">
            <span class="badge badge-error badge-sm font-semibold" x-text="b"></span>
          </template>
        </div>

        <!-- IMAGE (clickable) -->
        <figure class="w-128 flex items-center justify-center overflow-hidden">
          <a :href="link('product', { id: product.id })"
           @click="_saveScroll('products')" class="block w-full h-full">
           <img :src="product.image" class="object-contain max-h-full w-full h-full" :alt="product.name" />
          </a>
        </figure>

        <!-- BODY -->
        <div class="card-body min-w-0 flex flex-col">
          <!-- EXPERIMENTAL TILE -->
          <h2 class="card-title">
            <a :href="link('product', { id: product.id })"
               @click="_saveScroll('products')"
               class="hover:underline focus:outline-none focus:ring-2 focus:ring-primary/50"
               x-text="product.name"></a>
          </h2>

          <p class="clamp-2" x-text="product.description"></p>

          <div x-data="ratingLine()" x-init="$watch('product.reviews', v => v && set(v))" class="flex items-center gap-2 text-sm">
            <span class="flex items-center gap-0 text-lg leading-none">
              <template x-for="(s,i) in stars()" :key="i">
                <i
                  :class="s === 'full'
                    ? 'fa-solid fa-star text-yellow-400'
                    : (s === 'half'
                        ? 'fa-solid fa-star-half-stroke text-yellow-400'
                        : 'fa-regular fa-star text-base-content/30')">
                </i>
              </template>
            </span>
          
            <span class="font-bold" x-text="fmtAvg()"></span>
            <span class="text-base-content/60">(<span x-text="count"></span> recenzí)</span>
          </div>




          <!-- ACTIONS -->
          <div class="card-actions mt-auto justify-between items-center">
            <!-- PRICE BLOCK -->
            <div class="flex flex-col leading-tight">
              <span
                x-show="product.discounted_price && product.discounted_price < product.price"
                class="font-bold text-lg text-error"
                x-text="`${product.discounted_price} Kč`"
              ></span>
              <span
                x-show="product.discounted_price && product.discounted_price < product.price"
                class="text-sm line-through text-base-content/60 -mt-0.5"
                x-text="`${product.price} Kč`"
              ></span>
              <span
                x-show="!product.discounted_price || !(product.discounted_price < product.price)"
                class="font-bold text-lg"
                x-text="`${product.price} Kč`"
              ></span>
            </div>

            <!-- CTA or STEPPER -->
            <template x-if="!$store.cart.inCart(product.id)">
              <button class="btn btn-primary btn-md font-semibold"
                      @click="$store.cart.add(product)">
                Do košíku
              </button>
            </template>

            <template x-if="$store.cart.inCart(product.id)">
              <div class="join">
                <button class="btn btn-square btn-md join-item"
                        @click="$store.cart.decrement(product.id)"
                        aria-label="Odebrat kus">−</button>

                <input type="text" inputmode="numeric" pattern="[0-9]*"
                      class="input input-bordered input-md w-10 text-center join-item"
                      :value="$store.cart.qty(product.id)"
                      @input="$store.cart.setQty(product.id, $event.target.value)"
                      @keydown.enter.prevent
                      aria-label="Počet kusů" />

                <button class="btn btn-square btn-md join-item"
                        @click="$store.cart.increment(product.id)"
                        aria-label="Přidat kus">+</button>
              </div>
            </template>
          </div>

          <!-- META -->
          <div class="mt-2 text-sm">
            <span class="text-success font-bold" x-text="product.stock"></span>
            <span class="mx-1 opacity-40">•</span>
            <span class="opacity-70" x-text="product.category"></span>
          </div>
        </div>
      </div>
    </article>
  </template>
</div>


<!-- PRODUCT CARDS GRID -->
<div x-show="!isLoading" x-transition.opacity.duration.200ms class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:w-10/12 sm:w-11/12 mx-auto items-stretch">
  <template x-for="product in pagedProducts()" :key="product.id">
    <article class="h-full">
      <div class="card h-full bg-base-100 shadow relative">
        <!-- BADGES -->
        <div x-show="product.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
          <template x-for="(b,i) in (product?.badges || [])" :key="i">
            <span class="badge badge-error badge-sm font-semibold" x-text="b"></span>
          </template>
        </div>

        <!-- IMAGE (clickable) -->
        <figure class="h-48 flex items-center justify-center overflow-hidden">
          <a :href="link('product', { id: product.id })"
           @click="_saveScroll('products')" class="block w-full h-full">
           <img :src="product.image" class="object-contain max-h-full w-full h-full" :alt="product.name" />
          </a>
        </figure>

        <!-- BODY -->
        <div class="card-body min-w-0 flex flex-col">
          <!-- TITLE (clickable) -->
          <h2 class="card-title">
            <a :href="link('product', { id: product.id })"
               @click="_saveScroll('products')"
               class="hover:underline focus:outline-none focus:ring-2 focus:ring-primary/50"
               x-text="product.name"></a>
          </h2>

          <p class="clamp-2" x-text="product.description"></p>

          <!-- ACTIONS -->
          <div class="card-actions mt-auto justify-between items-center">
          <!-- PRICE + LEGAL TOOLTIP -->
          <div
            class="tooltip tooltip-right md:tooltip-top cursor-help"
            x-init="$store.legal.init()"
            x-data="{ paras: $store.legal.paragraphsFor(product) }"
          >
            <!-- DaisyUI tooltip body (kept exactly like your sample, but dynamic) -->
            <div class="tooltip-content lg:p-3 max-w-64 md:max-w-auto">
              <template x-for="(p, idx) in paras" :key="idx">
                <p
                  :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''"
                  x-text="p"
                ></p>
              </template>
            </div>

            <!-- PRICE BLOCK (unchanged styles) -->
            <div class="flex flex-col leading-tight">
              <span
                x-show="product.discounted_price && product.discounted_price < product.price"
                class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                x-text="`${product.discounted_price} Kč`"
              ></span>
              <span
                x-show="product.discounted_price && product.discounted_price < product.price"
                class="text-sm line-through text-base-content/60 -mt-0.5"
                x-text="`${product.price} Kč`"
              ></span>
              <span
                x-show="!product.discounted_price || !(product.discounted_price < product.price)"
                class="font-bold text-lg underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                x-text="`${product.price} Kč`"
              ></span>
            </div>
          </div>


            <!-- CTA or STEPPER -->
            <template x-if="!$store.cart.inCart(product.id)">
              <button class="btn btn-primary btn-md font-semibold" @click="$store.cart.add(product)">
                Do košíku
              </button>
            </template>

            <template x-if="$store.cart.inCart(product.id)">
              <div class="join">
                <button class="btn btn-square btn-md join-item"
                        @click="$store.cart.decrement(product.id)"
                        aria-label="Odebrat kus">−</button>

                <input type="text" inputmode="numeric" pattern="[0-9]*"
                      class="input input-bordered input-md w-10 text-center join-item"
                      :value="$store.cart.qty(product.id)"
                      @input="$store.cart.setQty(product.id, $event.target.value)"
                      @keydown.enter.prevent
                      aria-label="Počet kusů" />

                <button class="btn btn-square btn-md join-item"
                        @click="$store.cart.increment(product.id)"
                        aria-label="Přidat kus">+</button>
              </div>
            </template>
          </div>

          <!-- META -->
          <div class="mt-2 text-sm">
            <span class="text-success font-bold" x-text="product.stock"></span>
            <span class="mx-1 opacity-40">•</span>
            <span class="opacity-70" x-text="product.category"></span>
          </div>
        </div>
      </div>
    </article>
  </template>
</div>


<!-- EMPTY STATE -->
<div x-show="!isLoading && filteredProducts().length === 0" class="py-16 text-center opacity-70">
  Nic jsme nenašli pro zadané filtrování.
</div>

<!-- PAGINATION + LOAD MORE -->
<div x-show="!isLoading && (totalPages() > 1 || canLoadMoreFirstPage())"
     class="mt-6 flex items-center justify-between gap-4 flex-wrap w-11/12 lg:w-10/12 mx-auto p-4">
  <!-- left: range -->
  <div class="text-sm opacity-70">
    <span x-text="rangeLabel()"></span>
  </div>

  <!-- center: pager -->
  <div class="join mx-auto">
    <button class="btn btn-md join-item" :class="{'btn-disabled': page === 1}"
            @click="page = Math.max(1, page - 1)" aria-label="Předchozí stránka">«</button>

    <template x-for="n in pagesToShow()" :key="`p-${n}-${page}`">
      <button class="btn btn-md join-item"
              :class="{'btn-active': n === page, 'btn-disabled': n === '…'}"
              @click="if(n !== '…') page = n"
              x-text="n === '…' ? '…' : n"
              :aria-current="n === page ? 'page' : null"></button>
    </template>

    <button class="btn btn-md join-item" :class="{'btn-disabled': page === totalPages()}"
            @click="page = Math.min(totalPages(), page + 1)" aria-label="Další stránka">»</button>
  </div>

  <button x-show="canLoadMoreFirstPage()" class="btn btn-secondary btn-md" @click="loadMore()" :disabled="isLoading">
    <span x-text="loadMoreLabel()"></span>
  </button>
</div>

<div class="w-11/12 lg:w-10/12 mx-auto p-4 pt-12 pb-12">V kategorii Zdraví a léky naleznete volně prodejné léčivé přípravky, které pomáhají při různých obtížích. Jsou to například léky proti bolesti, při rýmě či kašli, na zvýšenou teplotu nebo při chřipce a nachlazení. Léčbu těmito přípravky zvládnete sami doma. V případě opakujících se nebo déle přetrvávajících obtíží je vždy na místě vyhledat pomoc lékaře. O vhodném léku se nejprve poraďte s lékárníkem.</div>
</section>

<!-- ROUTE == PRODUCT DETAIL -->
<section x-show="is('product')" x-cloak>
  <template x-if="is('product')">
      <!-- BREADCRUMBS -->

    <div
      x-data="productDetail({ fetchUrl: `data/product-details/${params.id}.json` })"
      x-effect="load(`data/product-details/${params.id}.json`)"
      class="mx-auto w-auto md:w-11/12 lg:w-8/12 p-4 py-6"
    >
    <div class="breadcrumbs hidden md:block text-sm mx-auto py-4">
      <ul>
        <li>Domů</li>
        <li><a href="#/products">Zdraví a léky</a></li>
      </ul>
    </div>
    <!-- gallery -->
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <section class="relative">
        <div x-show="product?.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
          <template x-for="(b,i) in (product?.badges || [])" :key="i">
            <span class="badge badge-accent border-0 bg-max-red-500 badge-md font-semibold" x-text="b"></span>
          </template>
        </div>
        <div class="aspect-square bg-base-200 rounded-xl flex items-center justify-center overflow-hidden">
          <img class="object-contain w-full h-full"
               :src="images[currentImage] || ''"
               :alt="`${product?.name || ''} – obrázek ${currentImage+1}`">
        </div>
        <div class="mt-3 flex gap-2 overflow-x-auto">
          <template x-for="(img, idx) in images" :key="idx">
            <button type="button" class="shrink-0 rounded-md border p-1 w-16 h-16 bg-base-100"
                    :class="idx === currentImage ? 'ring ring-primary' : 'border-base-300'"
                    @click="currentImage = idx">
              <img :src="img" class="object-contain w-full h-full" :alt="`Náhled ${idx+1}`">
            </button>
          </template>
        </div>
      </section>
  
      <!-- buy box (variants + price + add to cart) -->
      <section class="space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold" x-text="product?.name || '…'"></h1>

        <!-- user rating -->
        <div x-data="ratingLine()" x-init="$watch('product.reviews', v => v && set(v))" class="flex items-center gap-2 text-sm">
          <span class="flex items-center gap-0 text-lg leading-none">
            <template x-for="(s,i) in stars()" :key="i">
              <i
                :class="s === 'full'
                  ? 'fa-solid fa-star text-yellow-400'
                  : (s === 'half'
                      ? 'fa-solid fa-star-half-stroke text-yellow-400'
                      : 'fa-regular fa-star text-base-content/30')">
              </i>
            </template>
          </span>
        
          <span class="font-bold" x-text="fmtAvg()"></span>
          <span class="text-base-content/60">(<span x-text="count"></span> recenzí)</span>
        </div>
        
        <div x-text="product?.perex || ''"></div>   

        <section>
          <div>Brand: <a href="" class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold" x-text="product?.brand || ''"></span></a> /
          <a href="" class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold" x-text="product?.productLine || ''"></span></a></div>
        </section>
        <div x-show="variants?.length" class="space-y-2">
          <div class="textmd font-semibold">Varianta</div>
          <div class="flex flex-wrap gap-2">
            <template x-for="v in variants" :key="v.id">
              <button
                type="button"
                class="btn btn-md rounded-lg"
                :class="selectedVariant?.id === v.id ? 'btn-secondary' : 'btn-outline'"
                @click="selectVariant(v.id)"
                x-text="v.name"
              ></button>
            </template>
          </div>
        </div>
  

        <!-- PRODUCT DETAIL: PRICE + LEGAL TOOLTIP -->
        <div
          class="tooltip cursor-help"
          x-init="$store.legal.init()"
          x-data="{
            // Build a pseudo 'product' for the legal helper based on your local API
            get paras () {
              const pseudo = {
                price: priceOriginal(),                               
                discounted_price: hasDiscount() ? priceNow() : null  
              };
              return $store.legal.paragraphsFor(pseudo);
            }
          }"
        >
          <!-- Tooltip content (auto paragraphs; same separators as in grid) -->
          <div class="tooltip-content lg:p-3">
            <template x-for="(p, idx) in paras" :key="idx">
              <p
                :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''"
                x-text="p"
              ></p>
            </template>
          </div>

          <!-- Your original price area (unchanged design) -->
          <div class="flex items-end gap-3">
            <div class="flex flex-col">
              <span x-show="hasDiscount()" class="text-2xl font-extrabold text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400" x-text="formatPrice(priceNow())"></span>
              <span x-show="hasDiscount()" class="text-sm line-through text-base-content/60 -mt-0.5" x-text="formatPrice(priceOriginal())"></span>
              <span x-show="!hasDiscount()" class="text-2xl font-extrabold underline decoration-dotted underline-offset-4 decoration-max-gray-400" x-text="formatPrice(priceOriginal())"></span>
            </div>
            <span x-show="hasDiscount()" class="badge badge-error badge-sm">-<span x-text="discountPercent()"></span>%</span>
          </div>
        </div>

  
            <div class="text-sm mt-1 gap-1 grid">
              <div class="text-success font-semibold text-xl" x-text="product?.stock || 'Skladem'"></div>

              <div class="text-base"><i class="fa-classic fa-md fa-regular fa-truck-fast"></i> Odešleme ještě dnes, předpokládané doručení 1.10.</div>
              <div class="text-base"><i class="fa-classic fa-md fa-regular fa-shop"></i> Dostupné také v 347 lékárnách</div>
             
            </div>
  
            <div class="pt-2">
              <!-- ADD / STEPPER -->
              <template x-if="!$store.cart.inCart(product.id)">
                <button class="btn btn-primary btn-lg font-medium" @click="$store.cart.add(product)">
                  Do košíku
                </button>
              </template>

              <template x-if="$store.cart.inCart(product.id)">
                <div class="flex items-center gap-4" x-data="qtyBlinker(product.id)">
                  <div class="join">
                    <button class="btn btn-square btn-lg join-item"
                            @click="$store.cart.decrement(product.id)"
                            aria-label="Odebrat kus">−</button>

                    <input type="text" inputmode="numeric" pattern="[0-9]*"
                          class="input input-bordered input-lg w-12 text-center join-item"
                          :value="$store.cart.qty(product.id)"
                          @input="$store.cart.setQty(product.id, $event.target.value)"
                          @keydown.enter.prevent aria-label="Počet kusů" />

                    <button class="btn btn-square btn-lg join-item"
                            @click="$store.cart.increment(product.id)"
                            aria-label="Přidat kus">+</button>
                  </div>

                  <div class="flex items-center gap-2">
                    <span>ks v košíku</span>
                    <i class="fa-classic fa-md fa-solid fa-check-circle text-success transition-opacity duration-200"
                    :style="`opacity:${alpha}`"
                    aria-hidden="true"></i>
                  </div>
                </div>
              </template>
            </div>

      </section>
    </div>
    
      <!-- ACCORIDONS -->
       <section class="space-y-2 py-6">

        <div class="collapse bg-base-100 collapse-arrow border-yellow-300 border p-2">
          <input type="checkbox" />
          <div class="collapse-title font-medium text-lg text-max-gray-600 inline-flex gap-3 items-center"><i class="fa-classic fa-md fa-solid fa-truck-fast"></i>Jak získat dopravu zdrama?</div>
          <div class="collapse-content text-md flex gap-3 items-center">
            Doprava zdarma při nákupu nad 1 500 Kč. Limit pro přihlášené je 399 Kč
            <button class="btn btn-secondary btn-md">Přihlásit se</button>
          </div>
        </div>
        <div class="collapse bg-yellow-50 collapse-arrow border-yellow-300 border p-2">
          <input type="checkbox" />
          <div class="collapse-title font-medium text-lg text-max-gray-600 inline-flex gap-3 items-center"><i class="fa-classic fa-md fa-solid fa-badge-percent"></i>Máte možnost získat slevu 13%</div>
          <div class="collapse-content text-md flex gap-3 items-center">
            Staňte se členem věrnostního programu Dr. Max a získejte produkt za 108 Kč (sleva 13%)
            <button class="btn btn-secondary btn-md">Přihlásit se</button>
          </div>
        </div>


      <div class="collapse collapse-open bg-base-100 collapse-arrow border-base-300 border p-3">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">O produktu </div>
        
        <div class="collapse-content text-md">

          <div x-text="product?.name" class="uppercase text-max-gray-600"></div>
          <div class="pb-4 text-max-gray-600">SKU: <span x-text="product?.SKU" class="uppercase"></span></div>
          <div x-html="product?.description || ''"></div>

        </div>
      </div>
      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">Parametry</div>
        <div class="collapse-content">

            <div class="overflow-x-auto">
              <table class="table table-zebra text-sm md:text-base">
                <tbody>
                  <template x-for="(row,i) in product?.parameters || []" :key="i">
                    <tr>
                      <td class="w-auto md:w-1/3 font-semibold" x-text="row.name"></td>
                      <td x-text="row.value"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          
        </div>
      </div>
      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">Skladem v lékárnách <span class="opacity-50 text-sm">(347)</span></div>
        <div class="collapse-content text-sm">
          <iframe src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d81853.65539237593!2d14.427750211155628!3d50.1250929885876!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1sDr.%20Max!5e0!3m2!1sen!2scz!4v1758902085984!5m2!1sen!2scz" width="100%" height="450" style="border:0;"  allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
 
      <template x-if="product?.comparison_id">
        <div x-data="comparisonSection({ url: 'data/comparison.json', id: product.comparison_id })"
             class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
      
          <input type="checkbox" />
      
          <!-- Heading: N podobných produktů k porovnání -->
          <div class="collapse-title font-medium text-lg text-max-gray-600">
            <span x-show="loading">Načítám porovnání…</span>
            <span x-show="!loading" x-text="`Podobné produkty k porovnání`"></span> <span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
          </div>
      
          <div class="collapse-content text-md">
            <!-- Error -->
            <div x-show="!loading && error" class="alert alert-error my-2">
              <span x-text="error"></span>
            </div>
      
            <!-- Empty -->
            <div x-show="!loading && !error && !count()" class="alert my-2">
              <span>Pro tento produkt zatím nemáme srovnatelné položky.</span>
            </div>
      
            <!-- Table -->
            <div x-show="!loading && !error && count()" class="overflow-x-auto">
              <table class="table table-zebra min-w-[900px]">
                <thead>
                  <tr>
                    <!-- attribute column heading -->
                    <th class="w-36 md:w-60"></th>
      
                    <!-- product columns -->
                    <template x-for="(p, i) in items" :key="i">
                      <th class="align-top">
                        <img :src="p.image" :alt="p.name" class="h-20 object-contain mb-2">
                        <div class="font-medium text-sm leading-snug line-clamp-2" x-text="p.name"></div>
                      </th>
                    </template>
                  </tr>
                </thead>
      
                <tbody>
                  <!-- Kategorie -->
                  <tr>
                    <th>Kategorie</th>
                    <template x-for="(p, i) in items" :key="'cat-'+i">
                      <td x-text="p.category || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Forma -->
                  <tr>
                    <th>Forma</th>
                    <template x-for="(p, i) in items" :key="'form-'+i">
                      <td x-text="p.form || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Účinná látka -->
                  <tr>
                    <th>Účinná látka</th>
                    <template x-for="(p, i) in items" :key="'subst-'+i">
                      <td x-text="p.medicinal_substance || '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Objem -->
                  <tr>
                    <th>Objem</th>
                    <template x-for="(p, i) in items" :key="'vol-'+i">
                      <td x-text="p.volume ? `${p.volume} ${p.unit || ''}` : '—'"></td>
                    </template>
                  </tr>
      
                  <!-- Cena (zohlední slevu) -->
                  <tr>
                    <th>Cena</th>
                    <template x-for="(p, i) in items" :key="'price-'+i">
                      <td class="align-middle">
                        <div x-show="(Number(p.discounted_price||0) > 0) && (Number(p.discounted_price) < Number(p.price||0))" class="space-y-0.5">
                          <div class="font-semibold text-error" x-text="fmtPrice(priceNow(p))"></div>
                          <div class="text-sm line-through text-base-content/60" x-text="fmtPrice(priceOriginal(p))"></div>
                        </div>
                        <div x-show="!(Number(p.discounted_price||0) > 0 && Number(p.discounted_price) < Number(p.price||0))">
                          <span class="font-semibold" x-text="fmtPrice(priceOriginal(p))"></span>
                        </div>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Cena za jednotku -->
                  <tr>
                    <th>Cena za jednotku</th>
                    <template x-for="(p, i) in items" :key="'ppu-'+i">
                      <td x-text="unitPriceText(p)"></td>
                    </template>
                  </tr>
      
                  <!-- Dostupnost -->
                  <tr>
                    <th>Dostupnost</th>
                    <template x-for="(p, i) in items" :key="'stock-'+i">
                      <td>
                        <span :class="(p.stock||'').toLowerCase().includes('sklad') ? 'text-success font-medium' : ''"
                              x-text="p.stock || '—'"></span>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Štítky -->
                  <tr>
                    <th>Štítky</th>
                    <template x-for="(p, i) in items" :key="'badges-'+i">
                      <td>
                        <div class="flex flex-wrap gap-1">
                          <template x-for="(b, bi) in (p.badges || [])" :key="bi">
                            <span class="badge badge-accent badge-xs" x-text="b"></span>
                          </template>
                          <span x-show="!(p.badges && p.badges.length)">—</span>
                        </div>
                      </td>
                    </template>
                  </tr>
      
                  <!-- Popis (krátký) -->
                  <tr>
                    <th>Popis</th>
                    <template x-for="(p, i) in items" :key="'desc-'+i">
                      <td x-text="shortDesc(p.description)"></td>
                    </template>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </template>


      <div class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-lg text-max-gray-600">
          Dokumenty, návody, letáky
          <span class="opacity-50 text-sm">(1)</span>
        </div>
        <div class="collapse-content text-sm">
          <a class="underline-offset-2 decoration-1 decoration-current hover:underline focus-visible:underline text-secondary font-semibold">PDF</a>
        </div>
      </div>

      <div x-data="benefitsSection({ url: 'data/benefits.json' })"
      class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
 
   <input type="checkbox" />
   <div class="collapse-title font-medium text-lg text-max-gray-600 flex items-center gap-2">
     Lze platit vybranými benefity<span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
   </div>
 
   <div class="collapse-content text-sm">
     <!-- Loading -->
     <div x-show="loading" class="flex gap-2 items-center">
       <div class="skeleton h-5 w-24"></div>
       <div class="skeleton h-5 w-40"></div>
     </div>
 
     <!-- Error -->
     <div x-show="!loading && error" class="alert alert-error my-2">
       <span x-text="error"></span>
     </div>
 
     <!-- Table -->
     <div x-show="!loading && !error" class="overflow-x-auto">
       <table class="table table-zebra text-sm md:text-base">
         <thead>
           <tr>
            <th class="font-medium w-auto md:w-1/3">Název benefitu</th>
            <th class="w-14 text-center font-medium">V e-shopu</th>
            <th class="w-14 text-center font-medium">V lékárně</th>
            <th class="hidden md:block w-auto"></th>
           </tr>
         </thead>
         <tbody>
           <template x-for="(b, i) in items" :key="i">
             <tr>
              <td class="font-medium" x-text="b.name"></td>
              <td class="text-center">
                 <i :class="b.eshop_payment
                           ? 'fa-solid fa-circle-check text-success fa-lg'
                           : 'fa-solid fa-circle-xmark text-error fa-lg'"></i>
               </td>               
               <td class="text-center">
                <i :class="b.pharmacy_payment
                          ? 'fa-solid fa-circle-check text-success fa-lg'
                          : 'fa-solid fa-circle-xmark text-error fa-lg'"></i>
              </td>
              <td class="hidden md:block w-auto"></td>
             </tr>
           </template>
         </tbody>
       </table>
     </div>
 
     <!-- Empty state -->
     <div x-show="!loading && !error && !count()" class="alert mt-3">
       <span>Pro tento produkt nejsou k dispozici žádné benefity.</span>
     </div>
   </div>
 </div>
      
      <!-- User reviews -->
      <div x-data="reviewsSection({ url: 'data/reviews.json' })"
      class="collapse bg-base-100 collapse-arrow border-base-300 border p-2">
 
   <input type="checkbox" />
 
   <!-- Title: N recenzí + avg stars (only when loaded) -->
   <div class="collapse-title font-medium text-lg text-max-gray-600 block md:flex items-center justify-between gap-3">
     <span>
       Recenze zákazníků <span class="opacity-50 text-sm" x-show="!loading && !error">(<span x-text="count()"></span>)</span>
     </span>
 
     <!-- Average stars summary using your ratingLine component -->
     <template x-if="count()">
       <div x-data="ratingLine({ average: average(), count: count() })"
            class="flex items-center gap-2 text-sm pt-2 md:pt-0">
         <span class="flex items-center gap-0 text-lg leading-none">
           <template x-for="(s,i) in stars()" :key="i">
             <i :class="s === 'full'
                         ? 'fa-solid fa-star text-yellow-400'
                         : (s === 'half'
                             ? 'fa-solid fa-star-half-stroke text-yellow-400'
                             : 'fa-regular fa-star text-base-content/30')"></i>
           </template>
         </span>
         <span class="font-bold" x-text="fmtAvg()"></span>

       </div>
     </template>
   </div>
 
   <div class="collapse-content text-md">
     <!-- Loading / error -->
     <div x-show="loading" class="flex gap-2 items-center">
       <div class="skeleton h-5 w-24"></div>
       <div class="skeleton h-5 w-40"></div>
     </div>
     <div x-show="!loading && error" class="alert alert-error my-2">
       <span x-text="error"></span>
     </div>
 
     <!-- Reviews list -->
     <div x-show="!loading && !error" class="space-y-3 pt-3">
       <template x-for="(r, i) in items" :key="i">
         <article class="border border-base-300 rounded-lg p-3 md:p-4 space-y-1">
           <header class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm">
             <!-- Stars per review -->
             <span class="flex items-center gap-0.5">
               <template x-for="(s, si) in starsFor(r.score)" :key="si">
                 <i :class="s === 'full'
                             ? 'fa-solid fa-star text-yellow-400'
                             : (s === 'half'
                                 ? 'fa-solid fa-star-half-stroke text-yellow-400'
                                 : 'fa-regular fa-star text-base-content/30')"></i>
               </template>
             </span>
             <span class="font-medium" x-text="Number(r.score).toFixed(1)"></span>
             <span class="opacity-50">•</span>
             <span class="opacity-70" x-text="r.source"></span>
             <span class="opacity-50">•</span>
             <span class="opacity-70" x-text="r.date"></span>
           </header>
 
           <div class="text-sm opacity-70">
             <span class="font-semibold" x-text="r.author"></span>
           </div>
 
           <p class="mt-1 leading-relaxed" x-text="r.review"></p>
         </article>
       </template>
 
       <!-- Empty state -->
       <div x-show="!count()" class="alert">
         <span>Zatím zde nejsou žádné recenze.</span>
       </div>
     </div>
   </div>
 </div> 
      
    </section>
  
    <a href="#/products"
    class="font-medium text-max-blue-600 group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded my-8">
   <i class="fa-solid fa-arrow-left fa-sm" aria-hidden="true"></i>
   <span class="group-hover:underline group-focus-visible:underline underline-offset-2">
    Zpět na výpis produktů
   </span>
  </a>
   
    <!-- Mobile sticky CTA bar -->
    <div
      class="fixed inset-x-0 bottom-0 z-50 md:hidden
            transition-all duration-200
            ease-out pb-[env(safe-area-inset-bottom)]" 
      :class="ctaVisible ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0 pointer-events-none'">

      <div class="bg-base-100 border-t border-base-200 shadow-2xl
                  px-4 py-3
                  pb-[calc(env(safe-area-inset-bottom,0px)+0.75rem)]">
        <div class="flex items-center justify-between gap-3">
          <!-- price -->
          <div class="flex flex-col leading-tight">
            <!-- discounted -->
            <span x-show="hasDiscount()" class="text-lg font-extrabold text-error"
                  x-text="formatPrice(priceNow())"></span>
            <span x-show="hasDiscount()" class="text-xs line-through text-base-content/60 -mt-0.5"
                  x-text="formatPrice(priceOriginal())"></span>

            <!-- regular -->
            <span x-show="!hasDiscount()" class="text-lg font-extrabold"
                  x-text="formatPrice(priceOriginal())"></span>
          </div>

          <!-- CTA -->
          <div class="pt-2">
            <!-- ADD / STEPPER -->
            <template x-if="!$store.cart.inCart(product.id)">
              <button class="btn btn-primary btn-md font-medium" @click="$store.cart.add(product)">
                Do košíku
              </button>
            </template>

            <template x-if="$store.cart.inCart(product.id)">
              <div class="flex items-center gap-4" x-data="qtyBlinker(product.id)">
                <div class="join">
                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.decrement(product.id)"
                          aria-label="Odebrat kus">−</button>

                  <input type="text" inputmode="numeric" pattern="[0-9]*"
                        class="input input-bordered input-md w-12 text-center join-item"
                        :value="$store.cart.qty(product.id)"
                        @input="$store.cart.setQty(product.id, $event.target.value)"
                        @keydown.enter.prevent aria-label="Počet kusů" />

                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.increment(product.id)"
                          aria-label="Přidat kus">+</button>
                </div>

              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

  </div>
  </template>
</section>

<!-- ROUTE == CART -->
<section x-show="is('cart')" x-cloak>


    <section x-data="cartPage()" class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
      <h1 class="text-3xl mx-auto mb-6">Nákupní košík</h1>
  <!-- EMPTY STATE -->
  <template x-if="$store.cart.distinctCount() === 0">
    <div class="grid place-items-center py-16">
      <dotlottie-wc src="https://lottie.host/eb88511c-2fed-471c-8171-78a57701e4ef/z9tvJoPVCp.lottie" style="width: 160px;height: 160px" autoplay loop></dotlottie-wc>
      <p class="mt-4 font-medium">Váš košík je prázdný. Pojďme to napravit!</p>
      <button class="btn btn-outline mt-6" @click="location.hash='/products'">Pokračovat v nákupu</button>
    </div>
  </template>

  <!-- CART TABLE -->
  <template x-if="$store.cart.distinctCount() > 0">
    <div class="space-y-2">

      <!-- CART LIST: MOBILE TILES (no horizontal scroll) -->
      <div class="md:hidden space-y-3">
        <template x-for="it in $store.cart.list()" :key="it.id + '-' + it.image">
          <article class="card bg-white border border-base-200 shadow-sm">
            <div class="card-body p-3">
              <!-- Header: image + title + price -->
              <div class="flex gap-3 items-center">
                <div class="h-18 w-18 rounded bg-base-200 overflow-hidden shrink-0 grid place-content-center">
                  <img
                    :src="it.image"
                    :alt="it.name"
                    class="h-full w-full object-contain"
                    loading="lazy"
                    @error="$event.target.closest('.grid')?.classList.add('opacity-50')"
                  >
                </div>

                <div class="min-w-0 flex-1">
                  <h3 class="font-medium text-base" :title="it.name" x-text="it.name"></h3>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <template x-for="b in (it.badges || [])">
                      <span class="badge badge-ghost badge-sm" x-text="b"></span>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Controls: stepper + subtotal + remove -->
              <div class="mt-3 flex items-center justify-between gap-3">
                <div class="join">
                  <button class="btn btn-square btn-md join-item" @click="$store.cart.decrement(it.id)" aria-label="Odebrat kus">−</button>
                  <input
                  type="text" inputmode="numeric" pattern="[0-9]*"
                  class="input input-bordered input-md w-12 text-center join-item px-0 tabular-nums"
                  :value="$store.cart.qty(it.id)"
                  @input="$store.cart.setQty(it.id, $event.target.value.replace(/[^0-9]/g,''))"
                  @keydown.enter.prevent
                  />
                  <button class="btn btn-square btn-md join-item" @click="$store.cart.increment(it.id)" aria-label="Přidat kus">+</button>
                </div>

                <div class="text-right">
                  <template x-if="it.priceBefore && it.priceBefore > it.price">
                    <span class="text-sm line-through text-base-content/50 ml-2" x-text="koruny(it.priceBefore)"></span>
                  </template>
                  <div class="font-medium" x-text="koruny($store.cart.linePrice(it))"></div>
                  
                  <!-- CART: MOBILE PRICE + LEGAL TOOLTIP (wrap only the price, leave '/ ks' outside) -->
                  <span
                    class="tooltip tooltip-left cursor-help inline-flex"
                    x-init="$store.legal.init()"
                    x-data="{
                      get paras () {
                        const hasDisc = !!(it.priceBefore && it.priceBefore > it.price);
                        const original = hasDisc ? it.priceBefore : it.price;
                        const discounted_price = hasDisc ? it.price : null;
                        return $store.legal.paragraphsFor({ price: original, discounted_price });
                      }
                    }"
                  >
                    <div class="tooltip-content lg:p-3 max-w-64 md:max-w-auto">
                      <template x-for="(p, idx) in paras" :key="idx">
                        <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                      </template>
                    </div>

                    <span class="font-medium text-base underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                          x-text="koruny(it.price)"></span>
                  </span>
                  <span> / ks</span>

                </div>
              </div>

            </div>
          </article>
        </template>
      </div>

<!-- CART TABLE: DESKTOP/MD+ -->
<div class="hidden md:block overflow-x-auto rounded-xl border border-base-200 bg-white p-10">
  <table class="table text-base">
    <thead>
      <tr>
        <th class="font-medium">Produkt</th>
        <th class="text-center font-medium">Cena za kus</th>
        <th class="text-center font-medium">Množství</th>
        <th class="text-right font-medium">Mezisoučet</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="it in $store.cart.list()" :key="it.id + '-' + it.image">
        <tr>
          <td>
            <div class="flex gap-3 items-center">
              <div class="h-20 w-20 rounded bg-base-200 overflow-hidden grid place-content-center mr-2 flex-shrink-0">
                <img
                :src="it.image"
                :alt="it.name"
                class="h-full w-full object-contain"
                loading="lazy"
                @error="$event.target.closest('.grid')?.classList.add('opacity-50')"
              >
              </div>
              <div class="min-w-0">
                <div class="font-medium" :title="it.name" x-text="it.name"></div>
                <div class="flex gap-1 mt-1">
                  <template x-for="b in (it.badges || [])">
                    <span class="badge badge-ghost badge-sm" x-text="b"></span>
                  </template>
                </div>
                <template x-if="it.priceBefore && it.priceBefore > it.price">
                  <div class="text-sm text-success mt-1" x-text="`Sleva ${Math.round((1 - it.price/it.priceBefore)*100)} %`"></div>
                </template>
              </div>
            </div>
          </td>

          <td class="text-center align-center">
            <div>
            <!-- CART: DESKTOP PRICE + LEGAL TOOLTIP (priceBefore-aware) -->
            <div
              class="tooltip cursor-help"
              x-init="$store.legal.init()"
              x-data="{
                get paras () {
                  const hasDisc = !!(it.priceBefore && it.priceBefore > it.price);
                  const original = hasDisc ? it.priceBefore : it.price;      // pre-discount for legal
                  const discounted_price = hasDisc ? it.price : null;        // discount only when present
                  return $store.legal.paragraphsFor({ price: original, discounted_price });
                }
              }"
            >
              <div class="tooltip-content lg:p-3">
                <template x-for="(p, idx) in paras" :key="idx">
                  <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                </template>
              </div>

              <!-- Your original desktop price element (unchanged look) -->
              <div class="font-medium underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                  x-text="koruny(it.price)"></div>
            </div>


              <template x-if="it.priceBefore && it.priceBefore > it.price">
                <div class="text-sm line-through text-base-content/50" x-text="koruny(it.priceBefore)"></div>
              </template>
            </div>
          </td>

          <td class="text-center">
            <div class="join justify-end">
              <button class="btn btn-square btn-md join-item" @click="$store.cart.decrement(it.id)">−</button>
              <input
              type="text" inputmode="numeric" pattern="[0-9]*"
              class="input input-bordered input-md w-12 text-center join-item px-0 tabular-nums"
              :value="$store.cart.qty(it.id)"
              @input="$store.cart.setQty(it.id, $event.target.value.replace(/[^0-9]/g,''))"
              @keydown.enter.prevent
              />
              <button class="btn btn-square btn-md join-item" @click="$store.cart.increment(it.id)">+</button>
            </div>
          </td>

          <td class="text-right align-center">
            <div class="font-medium" x-text="koruny($store.cart.linePrice(it))"></div>
            <template x-if="(it.priceBefore ?? it.price) > it.price">
              <div class="text-xs text-success">
                − <span x-text="koruny($store.cart.lineDiscount(it))"></span>
              </div>
            </template>
          </td>


        </tr>
      </template>
    </tbody>
  </table>
</div>




      <!-- Totals -->
      <div class="grid md:grid-cols-2 gap-4">
        
    <!-- Free shipping bar -->
    <div class="rounded-xl border border-base-200 bg-white p-4 md:p-10 free-ship-bar select-none">
      <div class="flex items-center justify-between mb-2">
        <span class="font-medium">Doprava zdarma</span>

        <span class="text-sm text-base-content/70" x-show="$store.cart.totalToPay() < $store.cart.freeShipThreshold">
          Chybí <strong x-text="koruny($store.cart.freeShipMissing())"></strong> do
          <strong x-text="koruny($store.cart.freeShipThreshold)"></strong>
        </span>

        <span class="text-sm text-success" x-show="$store.cart.totalToPay() >= $store.cart.freeShipThreshold">
          Splněno 🎉
        </span>
      </div>

      <!-- Track -->
      <div class="relative h-6 rounded-full bg-base-200 overflow-hidden"
          role="progressbar"
          :aria-valuemin="0" :aria-valuemax="100"
          :aria-valuenow="$store.cart.freeShipProgress()">

        <!-- Fill -->
        <div class="fill h-full rounded-full transition-[width] duration-500"
            :class="{
              'bg-success' : $store.cart.hasFreeShipping(),
              'bg-primary/80 shimmer' : !$store.cart.hasFreeShipping()
            }"
            :style="`width: ${$store.cart.freeShipProgress()}%`">
        </div>
      </div>

      
<!-- COUPONS / GIFTCARDS ACTIONS (inline buttons) -->
<div class="flex flex-wrap gap-3 items-stretch mt-12">
  <!-- Coupon button + modal -->
  <div x-data="{ open:false, code:'', error:'' }" class="indicator">
    <button
      class="btn btn-outline btn-md px-4 indicator"
      @click="open = true"
      type="button"
    >
      Mám slevový kupón
      <!-- indicator with count -->
      <template x-if="$store.cart.couponCount() > 0">
        <span class="badge badge-error badge-sm indicator-item"
              x-text="$store.cart.couponCount()"></span>
      </template>
    </button>

    <!-- DaisyUI modal -->
    <dialog class="modal" :open="open" @close="open=false">
      <div class="modal-box lg:px-8 lg:py-10">
        <form method="dialog">
          <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"><i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i></button>
        </form>
        
        <h3 class="font-semibold text-xl">Slevové kupóny</h3>

        <!-- Input row -->
        <div class="mt-4 flex gap-2">
          <input class="input input-bordered w-full"
                 placeholder="Zadejte kód (např. SLEVA10)"
                 x-model="code"
                 @keydown.enter.prevent="$refs.apply.click()">
                 <button class="btn btn-primary" x-ref="apply" @click="
                 error='';
                 const r = $store.cart.applyCoupon(code);
                 if (!r.ok) { error = r.message }
                 else {
                   code='';
                   $store.toast.push('Kupón uplatněn', 'success');
                   $fx.confetti('coupon', $el)
                 }
               ">Uplatnit</button>
        </div>
        <p class="text-error text-sm mt-2" x-text="error" x-show="error"></p>

        <!-- Applied list -->
        <div class="mt-4">
          <div class="flex flex-wrap gap-2">
            <template x-if="$store.cart.couponCount() === 0">
              <div class="text-sm mb-2 text-base-content/70">Zatím žádné uplatněné kupóny</div>
            </template>
            <template x-for="c in $store.cart.listCoupons()" :key="c.code">
              <div class="gap-2">
                <div class="text-sm mb-2 w-auto text-base-content/70">Uplatněné kupóny</div>             
                <span class="badge badge-lg badge-outline badge-success pr-1 gap-1">
                  <span class="font-mono" x-text="c.code"></span>
                  <button class="btn btn-link no-underline hover:!no-underline btn-xs px-1"
                          type="button"
                          aria-label="Zrušit"
                          @click="$store.cart.removeCoupon(c.code)">
                      <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
                  </button>
                </span>
              </div>
            </template>
          </div>
        </div>

      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
  </div>

    <!-- Gift card button + modal -->
    <div x-data="{ open:false, code:'', error:'' }" class="indicator">
      <button
        class="btn btn-outline btn-md px-4 indicator"
        @click="open = true"
        type="button"
      >
        Mám dárkovou kartu
        <!-- indicator with count -->
        <template x-if="$store.cart.giftCardCount() > 0">
          <span class="badge badge-error badge-sm indicator-item"
                x-text="$store.cart.giftCardCount()"></span>
        </template>
      </button>

      <!-- DaisyUI modal -->
      <dialog class="modal" :open="open" @close="open=false">
        <div class="modal-box  lg:px-8 lg:py-10">
          <form method="dialog">
            <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"><i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i></button>
          </form>
          <h3 class="font-semibold text-xl">Dárkové karty</h3>

          <!-- Input row -->
          <div class="mt-4 flex gap-2">
            <input class="input input-bordered w-full"
                  placeholder="Zadejte kód (např. DAR100)"
                  x-model="code"
                  @keydown.enter.prevent="$refs.apply2.click()">
            <button class="btn btn-primary" x-ref="apply2" @click="
              error='';
              const r = $store.cart.applyGiftCard(code);
              if (!r.ok) { error = r.message; }
              else {
                code='';
                $store.toast.push('Dárková karta uplatněna', 'success');
                $fx.confetti('coupon', $el)
              }
            ">Vložit</button>
          </div>
          <p class="text-error text-sm mt-2" x-text="error" x-show="error"></p>

          <!-- Applied list -->
          <div class="mt-4">
            <div class="flex flex-wrap gap-2">
              <template x-if="$store.cart.giftCardCount() === 0">
                <span class="text-sm text-base-content/70">Zatím žádné uplatňené karty</span>
              </template>
              <template x-for="g in $store.cart.listGiftCards()" :key="g.code">
                  <div class="gap-2">
                    <div class="text-sm mb-2 w-auto text-base-content/70">Uplatněné karty</div>
                  <span class="badge badge-lg badge-outline badge-success pr-1 gap-1">
                    <span class="font-mono" x-text="g.code"></span>
                    <button class="btn btn-link no-underline hover:!no-underline btn-xs px-1"
                            type="button"
                            aria-label="Zrušit"
                            @click="$store.cart.removeGiftCard(g.code)">
                        <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
                    </button>
                  </span>
                </div>
              </template>
            </div>
          </div>

        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    </div>

    </div>
      </div>
        
        
        <div class="p-4 md:p-10 rounded-xl border border-base-200 bg-white">
          <div class="flex flex-col gap-2">
            <div class="flex justify-between">
              <span>Mezisoučet (bez kupónů)</span>
              <span x-text="koruny($store.cart.subtotal())"></span>
            </div>

            <div class="flex justify-between text-success" x-show="$store.cart.totalDiscountsRaw() > 0">
              <span>Slevy z produktů</span>
              <span>− <span x-text="koruny($store.cart.totalDiscountsRaw())"></span></span>
            </div>

            <template x-if="$store.cart.coupon">
              <div class="flex justify-between text-success">
                <span>Slevový kupón <span class="font-mono" x-text="$store.cart.coupon.code"></span></span>
                <span>− <span x-text="koruny(calcCouponValue($store.cart))"></span></span>
              </div>
            </template>

            <template x-if="$store.cart.giftCard">
              <div class="flex justify-between text-success">
                <span>Dárková karta <span class="font-mono" x-text="$store.cart.giftCard.code"></span></span>
                <span>− <span x-text="koruny(calcGiftCardValue($store.cart))"></span></span>
              </div>
            </template>

            <div class="divider my-2"></div>

            <div class="flex justify-between text-lg font-semibold">
              <span>Celkem k úhradě</span>
              <span x-text="koruny($store.cart.totalToPay())"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/products'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0"
        @click="location.hash='/delivery-payment'">
        Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</section>

<script>
  // Helpers for the cart page only
  function cartPage() {
    return {
      koruny(v) {
        try { return (Math.round(Number(v)) || 0).toLocaleString('cs-CZ') + ' Kč'; }
        catch { return v + ' Kč'; }
      },
      calcCouponValue(store) {
        const sub = store.subtotal();
        if (!store.coupon) return 0;
        return store.coupon.type === 'percent'
          ? Math.floor(sub * (store.coupon.value / 100))
          : store.coupon.value;
      },
      calcGiftCardValue(store) {
        if (!store.giftCard) return 0;
        return store.giftCard.value;
      }
    }
  }
</script>
<script>
  // Simple singleton for pharmacies search
  const PharmacyIndex = (() => {
    let _data = null; // cached array
    let _loading = null;
  
    const load = async () => {
      if (_data) return _data;
      if (_loading) return _loading;
      _loading = fetch('./data/map-points.json')
        .then(r => r.json())
        .then(arr => {
          _data = arr.map(p => ({
            ...p,
            // normalize + index
            id: p.id,
            name: p.name,
            type: p.type, // 'pharmacy' | 'box'
            address: p.address || {},
            coords: { lat: +p.coords.lat, lng: +p.coords.lng },
            searchIndex: [
              p.name,
              p.type,
              p.address?.street,
              p.address?.city,
              p.address?.district,
              p.address?.zip
            ].filter(Boolean).join(' ').toLowerCase()
          }));
          return _data;
        })
        .finally(() => { _loading = null; });
      return _loading;
    };
  
    const search = async (q) => {
      const list = await load();
      if (!q) return [];
      const s = q.toLowerCase().trim();
      return list
        .filter(p => p.searchIndex.includes(s))
        .slice(0, 10) // cap like other sections
        .map(p => ({
          kind: 'pharmacy', // tag for rendering
          id: p.id,
          title: p.name,
          subtitle: `${p.address.street || ''} • ${p.address.city || ''}`.trim(),
          icon: p.type === 'box' ? 'fa-box' : 'fa-location-dot',
          raw: p // keep the full record for click
        }));
    };
  
    return { load, search };
  })();
  </script>
</section>

<!-- ROUTE == DELIVERY AND PAYMENt -->
<section x-show="is('delivery-payment')" x-cloak>


    <section x-data="" class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
<!-- DELIVERY/PAYMENT: Cart Avatars (from localStorage 'cart.v1') -->
<div x-data="cartAvatars({ key: 'cart.v1', max: 4 })" x-init="init()" class="flex items-center gap-4 pb-4">
  <h1 class="text-3xl">Nákup</h1>

  <!-- Only render the group after items are ready -->
  <template x-if="items.length">
    <div class="avatar-group -space-x-6 overflow-visible" aria-label="Produkty v košíku">
      <template x-for="it in visible()" :key="it.id + '-' + it.img">
        <div class="avatar" :title="it.name">
          <div class="w-14 xl:w-18">
            <img
              :src="it.img"
              :alt="it.name || 'Produkt v košíku'"
              loading="lazy"
              @load="$event.target.style.opacity = 1"
              @error="$event.target.style.opacity = 0.3"
            />
          </div>
        </div>
      </template>

      <div class="avatar avatar-placeholder" x-show="overflow() > 0">
        <div class="bg-neutral text-neutral-content w-12">
          <span x-text="'+' + overflow()"></span>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('cartAvatars', (opts = {}) => ({
    items: [],
    key: opts.key ?? 'cart.v1',
    max: opts.max ?? 4,

    _bc: null,
    _onCartChange: null,
    _onStorage: null,

    init() {
      this.refresh();

      // 1) Same-tab: Alpine store reactivity
      if (this.$store?.cart) {
        this.$watch(() => this.$store.cart._version, () => this.refreshFromStore());
      }

      // 2) Same-tab: custom event from cart store
      this._onCartChange = () => this.refresh();
      window.addEventListener('cart:change', this._onCartChange);

      // 3) Cross-tab: storage fallback
      this._onStorage = (e) => { if (!e.key || e.key === this.key) this.refresh(); };
      window.addEventListener('storage', this._onStorage);

      // 4) Cross-tab: BroadcastChannel (if supported)
      try {
        this._bc = ('BroadcastChannel' in window) ? new BroadcastChannel('cart') : null;
        if (this._bc) this._bc.onmessage = (ev) => {
          if (ev?.data?.type === 'cart:change') this.refresh();
        };
      } catch(_) { this._bc = null; }
    },

    // Prefer live Alpine store (instant same-tab)
    refreshFromStore() {
      const storeItems = this.$store?.cart?.items;
      if (storeItems && typeof storeItems === 'object') {
        this.items = this.normalizeFromObject(storeItems);
        return true;
      }
      return false;
    },

    refresh() {
      if (this.refreshFromStore()) return; // same-tab path

      // Fallback to localStorage
      try {
        const raw = localStorage.getItem(this.key);
        if (!raw) { this.items = []; return; }
        const data = JSON.parse(raw);
        this.items = this.normalizeFromObject(data?.items || {});
      } catch { this.items = []; }
    },

    normalizeFromObject(obj) {
      const list = Object.values(obj || {}).map(e => e?.product).filter(Boolean);
      return list.map(p => ({
        id: p.id,
        name: p.name || 'Produkt v košíku',
        img: this.primaryImage(p),
      }))
      .filter(it => !!it.img)
      .filter((v, i, self) => self.findIndex(x => x.id === v.id && x.img === v.img) === i);
    },

    // Pick the first usable image across multiple shapes
    primaryImage(p) {
      const candidates = [];

      // Strings
      if (typeof p?.image === 'string') candidates.push(p.image);
      if (Array.isArray(p?.images) && p.images.length) {
        const first = p.images[0];
        if (typeof first === 'string') candidates.push(first);
        else if (first && typeof first === 'object') {
          if (typeof first.url === 'string') candidates.push(first.url);
          if (typeof first.src === 'string') candidates.push(first.src);
        }
      }

      // Other possible fields, just in case
      ['thumbnail','img','photo','picture'].forEach(k => {
        if (typeof p?.[k] === 'string') candidates.push(p[k]);
      });

      const chosen = candidates.find(v => typeof v === 'string' && v.trim().length > 0);
      return chosen ? new URL(chosen, window.location.href).href : '';
    },

    visible() { return this.items.slice(0, this.max); },
    overflow() { return Math.max(0, this.items.length - this.max); },
  }));
});
</script>

  


<!-- Delivery & Payment (Alpine component) -->
<div x-data="deliveryPaymentUI()" x-init="init()" class="grid grid-cols-1 lg:grid-cols-2 gap-12">

  <!-- DOPRAVA -->
  <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
    <h2 class="text-xl font-medium mb-4 ml-3">Doprava</h2>

    <template x-if="loading">
      <div class="p-3 text-sm text-base-content/70">Načítám možnosti…</div>
    </template>

    <template x-for="opt in delivery" :key="opt.id">
      <!-- Only select after confirm if followup exists, else select immediately -->
      <label :class="rowClasses('delivery', opt)"
             @click.prevent="handleDeliveryClick(opt)">
        <div class="flex items-center gap-3 min-w-0">
          <!-- Radio reflects state (we set it in JS) -->
          <input type="radio"
                 name="shipping"
                 class="radio radio-secondary shrink-0"
                 :checked="selectedDeliveryId === opt.id"
                 tabindex="-1" />
          <img :src="opt.icon" :alt="opt.name"
               class="size-11 rounded-full bg-base-200 object-contain shrink-0"
               @error="$event.target.style.opacity=0.3" />
          <div class="min-w-0">
            <div class="font-medium leading-tight">
              <!-- keep text truncation on the text only, not the container -->
              <div class="flex items-center gap-1 min-w-0">
                <span class="truncate max-w-full" x-text="opt.name"></span>
            
                <!-- DaisyUI tooltip (works on hover/focus; forced open on tap) -->
                <div
                  x-show="opt.tooltip"
                  x-data="{ open:false }"
                  class="tooltip tooltip-left md:tooltip-top shrink-0 z-10"
                  :class="{ 'tooltip-open': open }"
                  :data-tip="opt.tooltip"
                  tabindex="0"
                  @keydown.escape.window="open=false"
                  @blur="open=false"
                >
                  <button
                    type="button"
                    class="ml-1 inline-flex h-5 w-5 items-center justify-center rounded-full text-[10px] bg-base-200"
                    aria-label="Více informací"
                    @click.stop="open = !open"
                  ><i class="fa-regular fa-question-circle fa-lg text-max-gray-600" aria-hidden="true"></i></button>
                </div>
              </div>
            </div>
            <template x-if="opt.description">
              <p class="text-sm font-medium text-base-content/70 leading-snug line-clamp-2" x-text="opt.description"></p>
            </template>
          </div>
        </div>

        <!-- Price (free shipping overrides everything in this column) -->
        <div class="text-right shrink-0">
          <template x-if="freeShippingActive || opt.price === 0">
            <div class="font-semibold">Zdarma</div>
          </template>
          <template x-if="!freeShippingActive && opt.price > 0">
            <div>
              <div class="text-xs tracking-wide font-medium text-base-content/60" x-show="opt.price_from">Od</div>
              <div class="font-semibold" x-text="formatCZK(opt.price)"></div>
            </div>
          </template>
        </div>
      </label>
    </template>
  </fieldset>

  <!-- PLATBA -->
  <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
    <h2 class="text-xl font-medium mb-4 ml-3">Platba</h2>

    <template x-if="loading">
      <div class="p-3 text-sm text-base-content/70">Načítám možnosti…</div>
    </template>

    <template x-for="opt in payment" :key="opt.id">
      <label :class="rowClasses('payment', opt)"
             :aria-disabled="isPaymentDisabled(opt.id)"
             @click.prevent="handlePaymentClick(opt)">
        <div class="flex items-center gap-3 min-w-0">
          <input type="radio"
                 name="payment"
                 class="radio radio-secondary shrink-0"
                 :checked="selectedPaymentId === opt.id"
                 :disabled="isPaymentDisabled(opt.id)"
                 tabindex="-1" />
          <img :src="opt.icon" :alt="opt.name"
               class="size-11 rounded-full bg-base-200 object-contain shrink-0"
               @error="$event.target.style.opacity=0.3" />
          <div class="min-w-0">
            <div class="font-medium leading-tight">
              <span x-text="opt.name"></span>
              <!-- Tooltip #1: option’s own tooltip (DaisyUI) -->
              <span x-show="opt.tooltip" class="inline-block" x-data="{ open:false }" @keydown.escape.window="open=false">
                <div
                  class="tooltip tooltip-left md:tooltip-top"
                  :class="{ 'tooltip-open': open }"
                  :data-tip="opt.tooltip"
                  tabindex="0"
                  @blur="open=false"
                >
                  <button
                    type="button"
                    class="ml-1 inline-flex size-5 items-center justify-center rounded-full text-xs bg-base-200"
                    aria-label="Více informací"
                    @click.stop="open=!open"
                  ><i class="fa-regular fa-question-circle fa-lg text-max-gray-600" aria-hidden="true"></i></button>
                </div>
              </span>
            </div>
            <template x-if="opt.description">
              <p class="text-sm font-medium text-base-content/70 leading-snug" x-text="opt.description"></p>
            </template>
          </div>
        </div>

        <!-- Price area -->
        <div class="text-right shrink-0">
          <!-- When disabled by the selected delivery, show “Neumožňuje” with tooltip -->
          <template x-if="isPaymentDisabled(opt.id)">
            <div class="tooltip tooltip-left" :data-tip="disabledReason()">
              <div class="tracking-wide font-semibold">Nelze</div>
            </div>
          </template>

          <template x-if="!isPaymentDisabled(opt.id)">
            <template x-if="opt.price === 0">
              <div class="font-semibold">Zdarma</div>
            </template>
            <template x-if="opt.price > 0">
              <div>
                <div class="text-xs tracking-wide font-medium text-base-content/60" x-show="opt.price_from">Od</div>
                <div class="font-semibold" x-text="formatCZK(opt.price)"></div>
              </div>
            </template>
          </template>
        </div>
      </label>
    </template>
  </fieldset>



  <!-- Follow-up modal (placeholder content) -->
  <dialog x-ref="modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg" x-text="followupTitle()"></h3>
      <div class="py-3 text-base-content/70">
        <template x-if="currentFollowup?.type === 'map'">
          <p>Zde bude mapa pro výběr výdejního místa.</p>
        </template>
        <template x-if="currentFollowup?.type === 'timeslot'">
          <p>Zde bude výběr časového okna doručení.</p>
        </template>
        <template x-if="currentFollowup?.type === 'benefits'">
          <p>Zde bude výběr benefitní platby (Pluxee, Benefit Plus, Edenred…).</p>
        </template>
      </div>
      <div class="modal-action">
        <button class="btn btn-ghost" @click="cancelFollowup()">Zrušit</button>
        <button class="btn btn-primary" @click="confirmFollowup()">Potvrdit</button>
      </div>
    </div>
  </dialog>
</div>

<p class="mt-18 text-sm space-y-3 sm:space-y-0 sm:flex sm:flex-wrap sm:items-center sm:gap-x-6 sm:gap-y-2">
  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Všeobecné obchodní podmínky
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Rezervační podmínky
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Ochrana osobních údajů v e-shopu
  </a>

  <a href="#"
     class="block w-full py-2 rounded hover:underline focus-visible:underline underline-offset-2
            focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50
            sm:inline-flex sm:w-auto sm:items-center sm:gap-1 sm:py-0">
    Co je rezervace, co objednávka a jak to funguje?
  </a>
</p>


<script>
function deliveryPaymentUI() {
  return {
    loading: true,
    items: [],
    delivery: [],
    payment: [],

    // current selections
    selectedDeliveryId: null,
    selectedPaymentId: null,

    // follow-up handling
    currentFollowup: null,   // { type: 'map'|'timeslot'|'benefits', option, kind }
    pending: null,           // { kind: 'delivery'|'payment', id, opt }
    freeShippingActive: false,

    async init() {
      try {
        const res = await fetch('./data/delivery-payment.json', { cache: 'no-store' });
        this.items = await res.json();

        // split groups
        this.delivery = this.items.filter(i => i.type === 'delivery' || i.type === 'pickup');
        this.payment  = this.items.filter(i => i.type === 'payment');

        // restore selections
        const sd = Number(localStorage.getItem('selectedDeliveryId')) || null;
        const sp = Number(localStorage.getItem('selectedPaymentId')) || null;
        if (sd && this.delivery.some(d => d.id === sd)) this.selectedDeliveryId = sd;
        if (sp && this.payment.some(p => p.id === sp)) this.selectedPaymentId = sp;

        // validate existing combination after restore
        if (this.selectedPaymentId && this.isPaymentDisabled(this.selectedPaymentId)) {
          this.clearPaymentSelection();
        }
      } catch (e) {
        console.error('Failed to load delivery-payment.json', e);
      } finally {
        this.loading = false;
      }

      this.freeShippingActive = this.computeFreeShipping();
      this.$watch(() => Alpine.store('cart')?.totalToPay?.(), () => {
        this.freeShippingActive = this.computeFreeShipping();
      });
      this.$watch(() => Alpine.store('cart')?.freeShipThreshold, () => {
        this.freeShippingActive = this.computeFreeShipping();
      });
    },

    // ---------- helpers ----------
    computeFreeShipping() {
      const cart = Alpine.store('cart');
      if (!cart) return false;
      if (typeof cart.hasFreeShipping === 'function') return !!cart.hasFreeShipping();
      const t = Number(cart.freeShipThreshold || 0);
      if (t <= 0) return true;
      return cart.totalToPay() >= t;
    },
    getSelectedDelivery() {
      return this.delivery.find(d => d.id === this.selectedDeliveryId) || null;
    },
    isPaymentDisabled(paymentId) {
      if (!paymentId) return false;
      const d = this.getSelectedDelivery();
      if (!d) return false;
      return Array.isArray(d.disables_id) && d.disables_id.includes(paymentId);
    },
    disabledReason() {
      const d = this.getSelectedDelivery();
      return d ? `„${d.name}“ tuto platbu neumožňuje.` : 'Tato platba není dostupná pro vybranou dopravu.';
    },
    formatCZK(value) {
      return new Intl.NumberFormat('cs-CZ', { maximumFractionDigits: 0 }).format(value) + '\u00A0Kč';
    },

    rowClasses(kind, opt) {
      const selected = (kind === 'delivery' ? this.selectedDeliveryId : this.selectedPaymentId) === opt.id;
      const disabled = (kind === 'payment') && this.isPaymentDisabled(opt.id);
      return [
        'flex items-center justify-between gap-4 p-3 rounded-lg transition select-none',
        disabled ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:bg-base-100',
        // No borders by default; only selected rows get border (Ask #6)
        selected ? 'border-2 border-secondary bg-max-blue-25' : ''
      ].join(' ');
    },

    // ---------- click handlers (Ask #5 behavior) ----------
    handleDeliveryClick(opt) {
      // If followup is required, show modal first and set pending, not the selection
      if (opt.followup) {
        this.pending = { kind: 'delivery', id: opt.id, opt };
        this.currentFollowup = { type: opt.followup, option: opt, kind: 'delivery' };
        this.$refs.modal?.showModal();
        return;
      }
      // Immediate select when no follow-up
      this.applyDeliverySelection(opt.id);
    },

    handlePaymentClick(opt) {
      if (this.isPaymentDisabled(opt.id)) {
        // do nothing, and the tooltip on price explains why
        return;
      }
      if (opt.followup) {
        this.pending = { kind: 'payment', id: opt.id, opt };
        this.currentFollowup = { type: opt.followup, option: opt, kind: 'payment' };
        this.$refs.modal?.showModal();
        return;
      }
      this.applyPaymentSelection(opt.id);
    },

    confirmFollowup() {
      if (!this.pending) return this.$refs.modal?.close();
      if (this.pending.kind === 'delivery') this.applyDeliverySelection(this.pending.id);
      if (this.pending.kind === 'payment') this.applyPaymentSelection(this.pending.id);
      this.pending = null;
      this.currentFollowup = null;
      this.$refs.modal?.close();
    },
    cancelFollowup() {
      this.pending = null;
      this.currentFollowup = null;
      this.$refs.modal?.close();
    },

    // ---------- selection application ----------
    applyDeliverySelection(id) {
      const prev = this.selectedDeliveryId;
      this.selectedDeliveryId = id;
      localStorage.setItem('selectedDeliveryId', String(id));

      // Ask #1: if existing payment is now invalid, clear it
      if (this.selectedPaymentId && this.isPaymentDisabled(this.selectedPaymentId)) {
        this.clearPaymentSelection();
      }

      // If the delivery actually changed and has its own followup, we already handled via confirm
      // (nothing else needed here).
    },
    applyPaymentSelection(id) {
      this.selectedPaymentId = id;
      localStorage.setItem('selectedPaymentId', String(id));
    },
    clearPaymentSelection() {
      this.selectedPaymentId = null;
      localStorage.removeItem('selectedPaymentId');
    },

    // ---------- follow-up labels ----------
    followupTitle() {
      switch (this.currentFollowup?.type) {
        case 'map': return 'Výběr výdejního místa';
        case 'timeslot': return 'Výběr časového okna';
        case 'benefits': return 'Výběr benefitní platby';
        default: return 'Akce';
      }
    },
  };
}
</script>


      <!-- Sticky bottom bar -->
      <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
        <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
          <button class="btn btn-outline btn-lg" @click="location.hash='/cart'">
            Zpět</button>

          <button class="btn btn-primary btn-lg"
            :disabled="$store.cart.distinctCount() === 0"
            @click="location.hash='/addresses'">
            Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
          </button>
        </div>
      </div>
</section>

</section>

<!-- ROUTE == ADDRESSES -->
<section x-show="is('addresses')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Adresy</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">

      <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
        <h2 class="text-xl font-medium mb-4">Kontaktní údaje</h2>
        <fieldset class="fieldset">
          <legend class="fieldset-legend">E-mail</legend>
          <input type="text" class="input" placeholder="@" />
        </fieldset>
      
      
      
      
      </fieldset>
      <fieldset class="border border-base-300 rounded-xl bg-white shadow-sm p-4 py-8 md:p-10">
        <h2 class="text-xl font-medium mb-4 ml-3">Doručení a fakturace</h2>
      </fieldset>

    </div>  
  </section>


  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/delivery-payment'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0"
        @click="location.hash='/purchase-review'">
        Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</section>

<!-- ROUTE == PURCHASE REVIEW -->
<section x-show="is('purchase-review')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Kontrola nákupu</h1>
  
  </section>

  <!-- Sticky bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 border-t border-base-200 bg-white py-6 z-10">
    <div class="w-12/12 md:w-11/12 xl:w-8/12 mx-auto px-4 flex items-center justify-between gap-3">
      <button class="btn btn-outline btn-lg" @click="location.hash='/addresses'">
        Zpět</button>

      <button class="btn btn-primary btn-lg"
        :disabled="$store.cart.distinctCount() === 0"
        @click="location.hash='/thank-you'">
        Pokračovat <i class="fa-solid fa-arrow-right fa-sm" aria-hidden="true"></i>
      </button>
    </div>
  </div>  
</section>

<!-- ROUTE == THANK YOU PAGE -->
<section x-show="is('thank-you')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Hotovo!</h1>
  
  </section>

</section>

<!-- ROUTE == MY ACCOUNT ORDER HISTORY -->
<section x-show="is('my-account')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Vaše objednávky</h1>
  

<div class="grid grid-cols-4 gap-8">
<div class="flex flex-col gap-y-2">
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>  
  <div class="block rounded-2xl bg-base-300 w-full h-12 animate-pulse"></div>
</div>   

    <ul class="timeline timeline-snap-icon timeline-compact timeline-vertical no-start col-span-3">
      <li>
        <div class="timeline-middle">
          <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center">
            <i class="fa-solid fa-check text-primary-content"></i>
          </div>        
        </div>
        <div class="timeline-end md:mb-6 text-base">
        <time class="font-medium text-sm text-primary">11.12.2025 12:46</time>
        <div class="text-lg font-bold">Přijali jsme vaši objednávku</div>
        Zasíláme e-mail s potvrzením. Objednávka má číslo <span class="underline underline-offset-4 decoration-4 decoration-max-blue-500">7767789 12</span>
      </div>
      <hr class="bg-primary"/>
    </li>
    <li>
      <hr class="bg-primary"/>
      <div class="timeline-middle">
        <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center">
          <i class="fa-solid fa-check text-primary-content"></i>
        </div>
        
      </div>
      <div class="timeline-end md:mb-6 text-base">
      <time class="font-medium text-sm text-primary">11.12. 12:52</time>
      <div class="text-lg font-bold">Objednávka byla zaplacena</div>
      Kartou online
    </div>
    <hr class="bg-primary"/>
  </li>
  <li>
    <hr class="bg-primary"/>
    <div class="timeline-middle">
      <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center">
        <i class="fa-solid fa-check text-primary-content"></i>
      </div>
      
    </div>
    <div class="timeline-end md:mb-6 text-base">
    <time class="font-medium text-sm text-primary">11.12. 20:00</time>
    <div class="text-lg font-bold">Vaši objednávku jsme připravili a zabalili</div>
    <span class="underline underline-offset-4 decoration-4 decoration-max-blue-500">Očekávejte 1 balíček</span> o hmotnosti 729 g
  </div>
  <hr class="bg-primary"/>
</li>
<li>
  <hr class="bg-primary"/>
  <div class="timeline-middle">
    <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center">
      <i class="fa-solid fa-check text-primary-content"></i>
    </div>
    
  </div>
  <div class="timeline-end md:mb-6 text-base">
  <time class="font-medium text-sm text-primary">12.12. 6:42</time>
  <div class="text-lg font-bold">Objednávku jsme předali dopravci</div>
  Balíček Vám veze pan Karel ze společnosti PPL
</div>
<hr class="bg-primary"/>
</li>
<li>
  <hr class="bg-primary"/>
  <div class="timeline-middle">
    <div class="w-10 h-10 m-1 rounded-full bg-primary flex items-center justify-center">
      <i class="fa-solid fa-check text-primary-content"></i>
    </div>
    
  </div>
  <div class="timeline-end md:mb-6 text-base">
  <time class="font-medium text-sm text-primary">13.12. 8:51</time>
  <div class="text-lg font-bold">Objednávku byla doručena na adresu</div>
  Dr. Max Box, Havlínova 16, Praha 4 a počká tu <span class="underline underline-offset-4 decoration-4 decoration-max-blue-500">3 dny</span>
</div>
<hr class="bg-primary"/>
</li>
<li>
  <hr class="bg-max-gray-200"/>
  <div class="timeline-middle relative">
    <div class="absolute w-10 h-10 m-1 rounded-full bg-max-gray-200 animate-ping opacity-60"></div>
    <div class="relative w-10 h-10 m-1 rounded-full bg-max-gray-200 flex items-center justify-center">
      <i class="fa-solid fa-box-isometric-tape text-max-gray-600"></i>
    </div>         
  </div>
  <div class="timeline-end md:mb-6 text-base">
    <div class="text-lg font-bold ">Balíček čeká na vyzvednutí</div>
    PIN k vyzvednutí je <span class="underline underline-offset-4 decoration-4 decoration-max-blue-500">110 112</span>
  </div>
</li>

</ul>
  

</div>  
  </section>
</section>

<!-- ROUTE == MY SAVED FAVORITES -->
<section x-show="is('my-saved')" x-cloak>
  <section class="w-auto md:w-11/12 xl:w-8/12 mx-auto px-4 pt-2 md:pt-12 pb-32">
    <h1 class="text-3xl mx-auto mb-6">Moje uložené</h1>
  </section>
  
  
  
</section>

<!-- ROUTE == MAP -->
<section x-show="is('map')" x-cloak
         x-data="pickupMapUI({
           jsonUrl: './data/map-points.json',
           enableClustering: true
         })"
         x-init="init()" class="relative">
  <div class="bg-base-200" :class="mode === 'list' ? 'pb-0' : ''">
    <div class="px-4 py-0 md:py-6">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-stretch md:min-h-[60vh] lg:h-[70vh]">

        <!-- Mobile tabs -->
        <div class="md:hidden col-span-12">
          <div class="join w-full">
            <input class="join-item btn btn-block flex-1"
                   type="radio" name="maplist" aria-label="Mapa"
                   :checked="mode==='map'" @click="mode='map'"/>
            <input class="join-item btn btn-block flex-1"
                   type="radio" name="maplist" aria-label="Výpis"
                   :checked="mode==='list'" @click="mode='list'"/>
          </div>
        </div>

        <!-- LEFT COLUMN (hidden on <lg unless 'list' tab is selected on mobile) -->
          <aside class="min-h-0 col-span-12 lg:col-span-3"
          x-show="isLg || mode==='list'">
          <div class="bg-white border border-base-300 rounded-xl xl:p-8 p-4 h-full overflow-y-auto">
            <h1 class="text-3xl mx-auto mt-4 pb-4">Lékárny a boxy</h1>

            <!-- Search -->
            <div class="pb-4">
              <label class="input input-bordered items-center gap-2 w-full"
                     aria-label="Vyhledávání">
                <i class="fa-solid fa-magnifying-glass text-max-gray-600"></i>
                <input type="search" placeholder="Filtruj dle adresy"
                       x-model.debounce.250ms="search"
                       @input="applyFilters()" />
              </label>
            </div>

            <!-- “Městská část” (simple chips) -->
            <div class="items-center mt-1 mb-2 gap-2 flex flex-wrap">

              <!-- Vše (show all) -->
              <button type="button"
                      class="btn btn-sm"
                      :class="district==='' ? 'btn-primary' : 'btn-outline'"
                      @click="district=''; applyFilters()">
                Vše
              </button>

              <!-- District chips -->
              <template x-for="d in districts" :key="d">
                <button type="button"
                        class="btn btn-sm"
                        :class="district===d ? 'btn-primary' : 'btn-outline'"
                        @click="district = (district===d ? '' : d); applyFilters()"
                        x-text="d">
                </button>
              </template>
            </div>

            <!-- Filter summary -->
            <p class="text-sm opacity-70 mt-3"
            x-text="`Zobrazuji ${filtered.length} z ${all.length}`"></p>

            <!-- List -->
            <div class="overflow-x-auto">
              <table class="table">
                <tbody>
                  <template x-for="p in filtered" :key="p.id">
                    <tr class="cursor-pointer"
                        :class="selected && selected.id===p.id ? 'bg-max-blue-50' : 'hover:bg-max-gray-50'"
                        :data-pickup-id="p.id"
                        @click="selectFromList(p)">
                      <td>
                        <div class="flex items-center gap-3">
                          <div class="h-20 w-20 rounded bg-base-200 overflow-hidden mr-2 shrink-0">
                            <img :src="p.photo || placeholderImg" alt=""
                                 class="h-full w-full object-cover object-center" loading="lazy">
                          </div>
                          <div class="min-w-0">
                            <div class="font-medium text-base truncate" x-text="p.name"></div>
                            <div class="text-base opacity-70 truncate"
                                 x-text="`${p.address.street} • ${p.address.city}`"></div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </template>
                  <template x-if="!filtered.length">
                    <tr><td class="py-8 text-center text-sm opacity-70">Žádné výsledky.</td></tr>
                  </template>
                </tbody>
              </table>
            </div>
            
          </div>
        </aside>

        <!-- RIGHT: MAP -->
        <main class="min-h-0 col-span-12 lg:col-span-9" x-data="mapPane()" x-init="boot()" x-effect="onVisibilityChange(isLg || mode==='map')" x-show="isLg || mode==='map'">
  
          <div x-ref="wrap" class="relative rounded-xl border border-base-300 h-full min-h-[600px] overflow-hidden">

            <!-- Overlay (desktop / tablet) -->
            <div x-show="selected"
                 class="rounded-xl border border-base-300 px-4 py-6 lg:px-8 lg:py-10 w-80 sm:w-96 bg-white absolute m-2 z-10">
              <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"
                      @click="selected=null; updateMarkerIcons()">
                <i class="fa-solid fa-xmark fa-lg" aria-hidden="true"></i>
              </button>

              <div class="mb-2">
                <div class="font-medium text-base" x-text="selected?.name"></div>
                <div class="text-base opacity-70"
                     x-text="`${selected?.address?.street} • ${selected?.address?.city}`"></div>
              </div>

              <div class="overflow-x-auto max-h-40 lg:max-h-max">
                <table class="table table-zebra">
                  <tbody>
                    <template x-if="selected && selected.opening_hours">
                      <template x-for="(val, day) in selected.opening_hours" :key="day">
                        <tr>
                          <th x-text="dayCZ(day)"></th>
                          <td x-text="val"></td>
                        </tr>
                      </template>
                    </template>
                    <template x-if="selected && !selected.opening_hours">
                      <tr><td class="py-3 text-sm opacity-70">Bez zveřejněné provozní doby.</td></tr>
                    </template>
                  </tbody>
                </table>
              </div>

              <button class="btn btn-active btn-primary w-full mt-4"
                      @click="confirmSelection()">Potvrdit výběr</button>

              <p class="text-sm my-4" x-text="selected?.note"></p>

              <div class="flex flex-wrap gap-1 mt-4">
                <template x-for="t in (selected?.tags||[])" :key="t">
                  <div class="badge badge-soft badge-neutral" x-text="t"></div>
                </template>
              </div>

              <address class="not-italic mt-6">
                <p class="flex flex-wrap items-center gap-y-2 gap-x-6">
                  <a :href="selected?.phone ? `tel:${selected.phone}` : '#'"
                     class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded"
                     :class="selected?.phone ? '' : 'pointer-events-none opacity-50'">
                    <i class="fa-solid fa-phone fa-sm" aria-hidden="true"></i>
                    <span class="group-hover:underline group-focus-visible:underline underline-offset-2"
                          x-text="selected?.phone || '—'"></span>
                  </a>
                </p>
              </address>
            </div>

            <!-- The map element -->
            <div x-ref="mapEl" id="map" class="w-full h-full z-0"></div>

          </div>
        </main>

      </div>
    </div>
  </div>
</section>


<!-- FOOTER -->
<div class="block bg-gray-200">
<footer class="footer footer-horizontal hidden lg:grid py-12 mx-auto w-11/12 lg:w-10/12 px-4">
  <nav>
      <h6 class="footer-title">Services</h6>
      <a class="link link-hover">Branding</a>
      <a class="link link-hover">Design</a>
      <a class="link link-hover">Marketing</a>
      <a class="link link-hover">Advertisement</a>
    </nav>
    <nav>
      <h6 class="footer-title">Company</h6>
      <a class="link link-hover">About us</a>
      <a class="link link-hover">Contact</a>
      <a class="link link-hover">Jobs</a>
      <a class="link link-hover">Press kit</a>
    </nav>
    <nav>
      <h6 class="footer-title">Legal</h6>
      <a class="link link-hover">Terms of use</a>
      <a class="link link-hover">Privacy policy</a>
      <a class="link link-hover">Cookie policy</a>
    </nav>
    <nav>
      <h6 class="footer-title">Legal</h6>
      <a class="link link-hover">Terms of use</a>
      <a class="link link-hover">Privacy policy</a>
      <a class="link link-hover">Cookie policy</a>
    </nav>
    <nav>
      <h6 class="footer-title">Legal</h6>
      <a class="link link-hover">Terms of use</a>
      <a class="link link-hover">Privacy policy</a>
      <a class="link link-hover">Cookie policy</a>
    </nav>
  </footer>
  <footer class="footer footer-horizontal p-4 pb-6 lg:pb-6 pt-10 lg:pt-4 mx-auto w-11/12 lg:w-10/12 text-base-content">
    <aside class="w-full">
      <p class="text-sm opacity-70">© 2025 Dr. Max — All rights reserved</p>
  
      <!-- contact row -->
      <address class="not-italic mt-2">
        <p class="flex flex-wrap items-center gap-y-2 gap-x-6">
          <a href="tel:+420516770100"
             class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded">
            <i class="fa-solid fa-phone fa-sm" aria-hidden="true"></i>
            <span class="group-hover:underline group-focus-visible:underline underline-offset-2">
              +420 516 770 100
            </span>
          </a>
  
          <a href="mailto:info@drmax.cz"
             class="group inline-flex items-center gap-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded">
            <i class="fa-solid fa-envelope fa-sm" aria-hidden="true"></i>
            <span class="group-hover:underline group-focus-visible:underline underline-offset-2">
              info@drmax.cz
            </span>
          </a>
        </p>
      </address>
    </aside>
  </footer>
</div>


  <script>
    document.addEventListener('alpine:init', () => {
    //MOBILE "GOOGLE" SEARCH
    Alpine.data('mobileSearchOverlayShell', () => ({
    isOpen: false,
    viewportH: window.visualViewport ? window.visualViewport.height : window.innerHeight,
    pushedState: false,

    get panelStyle(){ return `height:${this.viewportH}px;max-height:${this.viewportH}px;`; },

    openOverlay(){
  if (this.isOpen) return;
  this.isOpen = true;
  this.lockPageScroll(true);
  this.attachViewportListener();

  // history stuff unchanged...
  history.pushState({ mobileSearch: true }, '');
  this.pushedState = true;
  this._onPop = () => { if (this.isOpen) this.closeOverlay({ fromPop:true }); };
  window.addEventListener('popstate', this._onPop);

  const focusRealInput = () => {
  const el = this.$root.querySelector('[data-mobile-search-input]');
  if (!el) return;

  el.focus({ preventScroll: true });
  try {
    const n = el.value?.length ?? 0;
    el.setSelectionRange(n, n); // place caret; helps iOS show cursor
  } catch {}

  // now blur the ghost (after the real input owns focus)
  try { if (window.__msGhost) window.__msGhost.blur(); } catch {}
  window.__msGhost = null;

  // If something stole focus, retry once
  setTimeout(() => {
    if (document.activeElement !== el) {
      el.focus({ preventScroll: true });
      try {
        const n2 = el.value?.length ?? 0;
        el.setSelectionRange(n2, n2);
      } catch {}
    }
  }, 50);
};

this.$nextTick(() => requestAnimationFrame(focusRealInput));

},

    // Pass an optional reason: 'ui' | 'navigate' | 'pop'
    closeOverlay({fromPop=false, reason='ui'} = {}){
      if (!this.isOpen) return;
      this.isOpen = false;
      this.detachViewportListener();
      this.lockPageScroll(false);

      if (this._onPop) {
        window.removeEventListener('popstate', this._onPop);
        this._onPop = null;
      }

      // Only "go back" when user is closing without navigating.
      if (this.pushedState && !fromPop && reason !== 'navigate') {
        this.pushedState = false;
        history.back();
      } else {
        this.pushedState = false;
      }
    },

    // Fixed-body scroll lock (keeps focus/caret stable on iOS)
    lockPageScroll(lock){
      const body = document.body;
      if (lock){
        this._scrollY = window.scrollY || window.pageYOffset;
        body.style.position = 'fixed';
        body.style.top = `-${this._scrollY}px`;
        body.style.left = '0';
        body.style.right = '0';
        body.style.width = '100%';
      } else {
        const y = this._scrollY || 0;
        body.style.position = '';
        body.style.top = '';
        body.style.left = '';
        body.style.right = '';
        body.style.width = '';
        window.scrollTo(0, y);
      }
    },

    attachViewportListener(){
      if (window.visualViewport){
        this._vv = () => { this.viewportH = window.visualViewport.height; };
        window.visualViewport.addEventListener('resize', this._vv);
      } else {
        this._wr = () => { this.viewportH = window.innerHeight; };
        window.addEventListener('resize', this._wr);
      }
    },
    detachViewportListener(){
      if (this._vv && window.visualViewport) window.visualViewport.removeEventListener('resize', this._vv);
      if (this._wr) window.removeEventListener('resize', this._wr);
      this._vv = this._wr = null;
    },
  }));


      //MAP  
    Alpine.data('mapPane', () => ({

    resizeObserver: null,

    boot() {
      this.$nextTick(() => {
        this._afterTransitionInvalidate();

        // Keep it healthy on container resizes
        const wrap = this.$refs.wrap || this.$refs.mapEl;
        if (wrap && !this.resizeObserver) {
          this.resizeObserver = new ResizeObserver(() => this._invalidate());
          this.resizeObserver.observe(wrap);
        }

        // Orientation
        window.addEventListener('orientationchange', () => this._afterTransitionInvalidate());
      });
    },

    onVisibilityChange(visible) {
      if (visible) this._afterTransitionInvalidate();
    },

    _invalidate() {
      window.dispatchEvent(new CustomEvent('map:invalidate'));
    },

    _afterTransitionInvalidate() {
      // Wait for x-show + Tailwind transition (~200ms)
      requestAnimationFrame(() => {
        setTimeout(() => this._invalidate(), 220);
      });
    }
  }));
  
      // CART
      Alpine.store('cart', {
  // --- state ---
  items: {},                 // { [id]: { qty, product } }
  _version: 0,               // bumped to notify UIs
  _bc: null,                 // BroadcastChannel for cross-tab (optional)

  // legacy single fields (kept for compatibility with existing UI)
  coupon: null,              // { code, type:'percent'|'amount', value }
  giftCard: null,            // { code, type:'amount', value }

  // new multi support
  coupons: [],               // [{ code, type, value }, ...]
  giftCards: [],             // [{ code, type, value }, ...]

  freeShipThreshold: 600, // Kč
  _badgePulse: false,
  

  // --- lifecycle / persistence ---
  init() {
    try {
      const raw = localStorage.getItem('cart.v1');
      if (raw) {
        const parsed = JSON.parse(raw) || {};
        this.items     = parsed.items     || {};
        this.coupon    = parsed.coupon    || null;
        this.giftCard  = parsed.giftCard  || null;
        this.coupons   = Array.isArray(parsed.coupons)   ? parsed.coupons   : [];
        this.giftCards = Array.isArray(parsed.giftCards) ? parsed.giftCards : [];

        // migrate legacy single fields into arrays if needed
        if (this.coupon && !this.coupons.find(c => c.code === this.coupon.code)) {
          this.coupons.push(this.coupon);
        }
        if (this.giftCard && !this.giftCards.find(g => g.code === this.giftCard.code)) {
          this.giftCards.push(this.giftCard);
        }
      }
    } catch (e) {
      console.warn('cart load failed', e);
    }

    // Optional cross-tab instant notifications
    try { this._bc = ('BroadcastChannel' in window) ? new BroadcastChannel('cart') : null; } catch (_) { this._bc = null; }

    // Persist normalized state for consistency
    this._persist();
  },

  _persist() {
    try {
      localStorage.setItem('cart.v1', JSON.stringify({
        items: this.items,
        // keep legacy mirrors for old UI bits
        coupon: this.coupon,
        giftCard: this.giftCard,
        // store new arrays
        coupons: this.coupons,
        giftCards: this.giftCards
      }));
    } catch (e) {
      console.warn('cart persist failed', e);
    }
  },

  _notifyChange(reason = '') {
    // 1) reactive watchers in same tab
    this._version = Date.now();

    // 2) event listeners in same tab (widgets like avatars listen to this)
    window.dispatchEvent(new CustomEvent('cart:change', { detail: { version: this._version, reason }}));

    // 3) other tabs (near-instant; storage event also works but is less direct)
    if (this._bc) this._bc.postMessage({ type: 'cart:change', version: this._version, reason });
  },

  _persistAndNotify(reason = '') {
    this._persist();
    this._notifyChange(reason);
  },

  _pingBadge() {
    this._badgePulse = false;
    requestAnimationFrame(() => { this._badgePulse = true; });
    setTimeout(() => { this._badgePulse = false; }, 200);
  },

  // --- queries / helpers ---
  inCart(id) { id = String(id); return Object.prototype.hasOwnProperty.call(this.items, id); },
  qty(id)    { id = String(id); return this.items[id]?.qty ?? 0; },
  distinctCount() { return Object.keys(this.items).length; },
  countAll() { return Object.values(this.items).reduce((s, it) => s + (it?.qty || 0), 0); },

  imgFor(p = {}) {
    const candidates = [];

    // simple string field
    if (typeof p.image === 'string') candidates.push(p.image);

    // array of strings or objects
    if (Array.isArray(p.images) && p.images.length) {
      const first = p.images[0];
      if (typeof first === 'string') candidates.push(first);
      else if (first && typeof first === 'object') {
        if (typeof first.url === 'string') candidates.push(first.url);
        if (typeof first.src === 'string') candidates.push(first.src);
      }
    }

    // other common fallbacks
    ['thumbnail', 'img', 'photo', 'picture'].forEach(k => {
      if (typeof p[k] === 'string') candidates.push(p[k]);
    });

    const chosen = candidates.find(v => typeof v === 'string' && v.trim().length > 0);
    return chosen ? new URL(chosen, window.location.href).href : '';
  },

  list() {
    // normalize a flat view for table: { id, qty, product, price, priceBefore, image, name, badges }
    return Object.entries(this.items).map(([id, rec]) => {
      const p = rec.product || {};
      const price = Number(p.discounted_price ?? p.price ?? 0);
      const priceBefore = Number(p.price ?? price);

      return {
        id,
        qty: rec.qty,
        product: p,
        name: p.name || p.title || `Produkt #${id}`,
        image: this.imgFor(p),                 // normalized primary image
        badges: p.badges || p.labels || p.tags || [],
        price,
        priceBefore
      };
    });
  },

  // public wrappers used by templates
  linePrice(itOrId) {
    let it = itOrId;
    if (typeof itOrId !== 'object') {
      const id = String(itOrId);
      it = this.list().find(x => String(x.id) === id);
    }
    return it ? this._linePrice(it) : 0;
  },
  lineBefore(itOrId) {
    let it = itOrId;
    if (typeof itOrId !== 'object') {
      const id = String(itOrId);
      it = this.list().find(x => String(x.id) === id);
    }
    return it ? this._lineBefore(it) : 0;
  },

  _addCore(product) {
  const id = String(product.id);
  if (this.inCart(id)) { this.increment(id); return false; }
  this.items = { ...this.items, [id]: { qty: 1, product } };
  this._persistAndNotify('add');
  this._pingBadge();
  return true; // indicates a fresh add (wasn't in cart)
  },
  // --- mutations (now with persist + notify) ---
  add(product) {
    // normal CTA: add and open precart modal (no toast)
    const fresh = this._addCore(product);
    if (fresh) {
      // open pre-basket modal
      Alpine.store('precart')?.open(product);
    }
  },
  silentAdd(product) {
    // impulse add: add 1 pc quietly (no toast, no modal)
    this._addCore(product);
  },

  increment(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    this.items[id].qty++;
    this._persistAndNotify('increment');
    this._pingBadge();
  },

  decrement(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    const next = this.items[id].qty - 1;
    if (next <= 0) {
      const removedName = this.items[id].product?.name || `Produkt #${id}`;
      const copy = { ...this.items };
      delete copy[id];
      this.items = copy;
      Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
    } else {
      this.items[id].qty = next;
    }
    this._persistAndNotify('decrement');
    this._pingBadge();
  },

  setQty(id, raw) {
    id = String(id);
    let n = parseInt(raw, 10);
    if (!Number.isFinite(n) || n <= 0) {
      if (!this.inCart(id)) return;
      const removedName = this.items[id].product?.name || `Produkt #${id}`;
      const copy = { ...this.items };
      delete copy[id];
      this.items = copy;
      this._persistAndNotify('setQty/remove');
      this._pingBadge();
      Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
      return;
    }
    if (!this.inCart(id)) return;
    this.items[id].qty = n;
    this._persistAndNotify('setQty');
    this._pingBadge();
  },

  remove(id) {
    id = String(id);
    if (!this.inCart(id)) return;
    const removedName = this.items[id].product?.name || `Produkt #${id}`;
    const copy = { ...this.items };
    delete copy[id];
    this.items = copy;
    this._persistAndNotify('remove');
    this._pingBadge();
    Alpine.store('toast')?.push(`Odebrán produkt: ${removedName}`, 'warning');
  },

  clear() {
    this.items = {};
    this.coupon = null;
    this.giftCard = null;
    this.coupons = [];
    this.giftCards = [];
    this._persistAndNotify('clear');
    this._pingBadge();
  },

  // --- line & totals (Kč numbers, no formatting) ---
  _linePrice(it) { return Math.max(0, Number(it.price) * it.qty); },
  _lineBefore(it) { return Math.max(0, Number(it.priceBefore ?? it.price) * it.qty); },
  linePriceById(id) {
    const rec = this.list().find(x => String(x.id) === String(id));
    return rec ? this._linePrice(rec) : 0;
  },
  subtotal() {
    return this.list().reduce((s, it) => s + this._linePrice(it), 0);
  },
  totalBefore() {
    return this.list().reduce((s, it) => s + this._lineBefore(it), 0);
  },
  lineDiscount(it) {
    const per = Math.max(0, (it.priceBefore ?? it.price) - it.price);
    return per * it.qty;
  },
  totalDiscountsRaw() {
    return this.list().reduce((s, it) => s + this.lineDiscount(it), 0);
  },

  // --- promos (multi + legacy mirrors; capped at subtotal) ---
  applyCoupon(code) {
    const c = String(code || '').trim().toUpperCase();
    if (!c) return { ok:false, message:'Zadejte kód.' };

    // Demo catalog
    const catalog = {
      'SLEVA10': { code:'SLEVA10', type:'percent', value:10 },
      'SLEVA50': { code:'SLEVA50', type:'amount',  value:50 }
    };
    const found = catalog[c];
    if (!found) return { ok:false, message:'Neplatný kód kupónu.' };
    if (this.coupons.find(x => x.code === c)) return { ok:false, message:'Kupón již uplatněn.' };

    this.coupons = [...this.coupons, found];
    this.coupon = found; // legacy mirror (last applied)
    this._persistAndNotify('applyCoupon');
    return { ok:true };
  },

  // remove by code; if no code passed, clear all (keeps old templates happy)
  removeCoupon(code) {
    if (typeof code === 'string' && code.trim()) {
      const c = code.trim().toUpperCase();
      this.coupons = this.coupons.filter(x => x.code !== c);
    } else {
      this.coupons = [];
    }
    this.coupon = this.coupons[this.coupons.length - 1] || null; // mirror
    this._persistAndNotify('removeCoupon');
  },

  applyGiftCard(code) {
    const c = String(code || '').trim().toUpperCase();
    if (!c) return { ok:false, message:'Zadejte kód.' };

    const catalog = {
      'DAR100': { code:'DAR100', type:'amount', value:100 }
    };
    const found = catalog[c];
    if (!found) return { ok:false, message:'Neplatná dárková karta.' };
    if (this.giftCards.find(x => x.code === c)) return { ok:false, message:'Karta již uplatněna.' };

    this.giftCards = [...this.giftCards, found];
    this.giftCard = found; // legacy mirror
    this._persistAndNotify('applyGiftCard');
    return { ok:true };
  },

  removeGiftCard(code) {
    if (typeof code === 'string' && code.trim()) {
      const c = code.trim().toUpperCase();
      this.giftCards = this.giftCards.filter(x => x.code !== c);
    } else {
      this.giftCards = [];
    }
    this.giftCard = this.giftCards[this.giftCards.length - 1] || null; // mirror
    this._persistAndNotify('removeGiftCard');
  },

  // counts/lists for UI indicators & modals
  couponCount() { return this.coupons.length; },
  giftCardCount() { return this.giftCards.length; },
  listCoupons() { return this.coupons.slice(); },
  listGiftCards() { return this.giftCards.slice(); },

  promoDiscount() {
    const sub = this.subtotal();
    let d = 0;

    // coupons: percent + amount
    for (const c of (this.coupons || [])) {
      if (c.type === 'percent') d += Math.floor(sub * (c.value / 100));
      else if (c.type === 'amount') d += c.value;
    }
    // gift cards: amount
    for (const g of (this.giftCards || [])) {
      if (g.type === 'amount') d += g.value;
    }
    return Math.min(d, sub);
  },
  totalToPay() {
    return Math.max(0, this.subtotal() - this.promoDiscount());
  },

  // --- free shipping helpers ---
  freeShipProgress() {
    const t = Number(this.freeShipThreshold || 0);
    if (t <= 0) return 100;
    return Math.max(0, Math.min(100, Math.round((this.totalToPay() / t) * 100)));
  },
  freeShipMissing() {
    const missing = Number(this.freeShipThreshold || 0) - this.totalToPay();
    return Math.max(0, Math.ceil(missing));
  },
  hasFreeShipping() {
    const t = Number(this.freeShipThreshold || 0);
    if (t <= 0) return true;
    return this.totalToPay() >= t; // threshold reached?
  }
});



      // TOASTS
      Alpine.store('toast', {
    items: [],
    push(text, type = 'success', life = 3000) {
      const id = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)) + Date.now();
      const item = { id, text, type, show: true };
      this.items.push(item);
      // auto-hide after `life` ms
      item._lifeTimer = setTimeout(() => this.hide(id), life);
    },
    hide(id) {
      const t = this.items.find(i => i.id === id);
      if (!t || !t.show) return;
      t.show = false; // triggers leave transition
      // remove after transition finishes (keep in sync with duration-300)
      clearTimeout(t._removeTimer);
      t._removeTimer = setTimeout(() => this.remove(id), 320);
    },
    remove(id) {
      this.items = this.items.filter(t => t.id !== id);
    }
  });
    // PRODUCT DETAIL
    Alpine.data('productDetail', (opts = {}) => ({
    // ---- inputs ----
    id: opts.id ?? null,
    fetchUrl: opts.fetchUrl ?? null,      // e.g. `data/product-details/${params.id}.json`
    initialProduct: opts.product ?? null, // optional preloaded data

    // ---- state ----
    product: { badges: [], description: '', parameters: [] },
    images: [],
    variants: [],
    selectedVariant: null,
    currentImage: 0,
    ctaVisible: false,

    // ---- internal fetch guards ----
    _currentUrl: null,
    _abort: null,

    // ================================
    // Lifecycle
    // ================================
    async init() {
      // initial load
      if (this.fetchUrl) await this.load(this.fetchUrl);

      // simple sticky CTA visibility on scroll
      this._onScrollBound = () => { this.ctaVisible = (window.scrollY || 0) > 240; };
      window.addEventListener('scroll', this._onScrollBound, { passive: true });
    },

    // ================================
    // Data loading (re-usable)
    // ================================
    async load(url) {
      if (!url) return;
      if (url === this._currentUrl && !this.initialProduct) return; // nothing to do
      this._currentUrl = url;

      // cancel previous request if any
      if (this._abort) try { this._abort.abort(); } catch {}

      try {
        let data;
        if (this.initialProduct) {
          data = this.initialProduct;
        } else {
          const ctrl = new AbortController();
          this._abort = ctrl;
          const res = await fetch(url, { signal: ctrl.signal });
          if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
          data = await res.json();
        }

        this._applyData(data);
      } catch (e) {
        console.error('productDetail.load error:', e);
      } finally {
        this._abort = null;
      }
    },

    _applyData(data) {
      const d = data || {};
      this.product = d;

      // images: prefer array; fallback to single image
      const imgs = Array.isArray(d.images) ? d.images.slice() : (d.image ? [d.image] : []);
      this.images = imgs;
      this.currentImage = 0;

      // variants + default selection
      this.variants = Array.isArray(d.variants) ? d.variants.slice() : [];
      const def = this.variants.find(v => v.default) || this.variants[0] || null;
      this.selectedVariant = def;
    },

    // ================================
    // Price helpers (use selected variant if any)
    // ================================
    _n(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; },

    _activeItem() {
      // what the UI considers the "current purchasable item"
      return this.selectedVariant || this.product || {};
    },

    priceOriginal(item = null) {
      const it = item || this._activeItem();
      return this._n(it.price ?? this.product.price);
    },

    priceNow(item = null) {
      const it = item || this._activeItem();
      const d = this._n(it.discounted_price ?? this.product.discounted_price);
      const p = this.priceOriginal(it);
      return (d > 0 && d < p) ? d : p;
    },

    hasDiscount(item = null) {
      const it = item || this._activeItem();
      const p = this.priceOriginal(it);
      const d = this._n(it.discounted_price ?? this.product.discounted_price);
      return d > 0 && d < p;
    },

    discountPercent(item = null) {
      const it = item || this._activeItem();
      const p = this.priceOriginal(it);
      const n = this.priceNow(it);
      if (!p) return 0;
      return Math.round(100 - (n / p) * 100);
    },

    formatPrice(v) {
      const n = this._n(v);
      return new Intl.NumberFormat('cs-CZ').format(n) + ' Kč';
    },

    // ================================
    // Variants / gallery
    // ================================
    selectVariant(id) {
      const v = this.variants.find(x => String(x.id) === String(id));
      this.selectedVariant = v || null;
    },

    // ================================
    // Cart CTA
    // ================================
    addToCartClick() {
      // Build a cart item compatible with your grid/cart store
      let item = { ...this.product };

      if (this.selectedVariant) {
        item = {
          ...item,
          // give variants unique ids to allow multiple variants in cart (string ids are fine)
          id: `${this.product.id}:${this.selectedVariant.id}`,
          name: `${this.product.name} – ${this.selectedVariant.name}`,
          price: this.priceOriginal(),
          discounted_price: this.hasDiscount() ? this.priceNow() : null
        };
      } else {
        // ensure prices are consistent even if product.json lacks them
        item.price = this.priceOriginal();
        item.discounted_price = this.hasDiscount() ? this.priceNow() : null;
      }

      try {
        if (this.$store?.cart?.add) this.$store.cart.add(item);
      } catch (e) {
        console.warn('Cart add failed (no $store.cart?)', e);
      }
    },
  })); 

    // USER REVIEWS LIS
    Alpine.data('reviewsSection', (opts = {}) => ({
    url: opts.url ?? 'data/reviews.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        this.items = await res.json();
      } catch (e) {
        console.error('reviews load failed', e);
        this.error = 'Nepodařilo se načíst recenze.';
      } finally {
        this.loading = false;
      }
    },

    count() {
      return Array.isArray(this.items) ? this.items.length : 0;
    },
    average() {
      if (!this.count()) return 0;
      const sum = this.items.reduce((s, r) => s + Number(r.score || 0), 0);
      return +(sum / this.count()).toFixed(1);
    },

    // Build 5 icons for a given score (full/half/empty)
    starsFor(val) {
      const v = Math.max(0, Math.min(5, Math.round(Number(val) * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    }
  })),    
    //BENEFIT PAYMENTS
    Alpine.data('benefitsSection', (opts = {}) => ({
    url: opts.url ?? 'data/benefits.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // sort: available first, then name
        this.items = (Array.isArray(data) ? data : [])
          .sort((a,b) => (b.available - a.available) || String(a.name).localeCompare(String(b.name), 'cs'));
      } catch (e) {
        console.error('benefits load failed', e);
        this.error = 'Nepodařilo se načíst seznam benefitních karet.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; }
  })),

  // SEARCH AUTOCOMPLETE
  Alpine.data('searchBox', (opts = {}) => ({
  // --- config ---
  maxResults: 7,
  minChars: 2,
  storageKey: 'recentAny',   // stores typed recents

  // --- state ---
  q: '',
  open: false,
  highlighted: -1,
  recent: [],
  listId: `ac-${Math.random().toString(36).slice(2)}`,
  dropdownStyle: '',

  results: { products: [], categories: [], links: [], pharmacies: [] },
  isLoading: false,
  pharmacies: [], // preloaded for fast suggestions

  // --- lifecycle ---
  init() {
    this.loadRecent();
    this.$watch('open', v => { if (v) this.$nextTick(() => this.reposition()); });
    this.$watch('q',    () => { this.$nextTick(() => this.reposition()); });
    // preload pharmacies (uses your PharmacyIndex singleton)
    PharmacyIndex.load().then(data => { this.pharmacies = data || []; });
  },

  // --- positioning (desktop) ---
  reposition() {
    const a = this.$refs.anchor; if (!a) return;
    const r = a.getBoundingClientRect();
    const left  = Math.round(r.left), top = Math.round(r.bottom) + 8, width = Math.round(r.width);
    this.dropdownStyle =
      `position:fixed;left:${left}px;top:${top}px;` +
      `width:${width}px;min-width:${width}px;max-width:${width}px;box-sizing:border-box`;
  },
  onWindowResize() { if (this.open) this.reposition(); },
  onFocus() { this.open = true; this.reposition(); },
  onInput() { this.open = true; this.highlighted = -1; this.reposition(); },

  // --- recent (typed) ---
  loadRecent() {
    try { this.recent = JSON.parse(localStorage.getItem(this.storageKey) || '[]'); }
    catch { this.recent = []; }
  },
  saveRecent(item) {
    const key = JSON.stringify({ t: item.t, k: item.k }); // type + key
    const arr = [key, ...this.recent.filter(x => x !== key)].slice(0, 5);
    this.recent = arr;
    localStorage.setItem(this.storageKey, JSON.stringify(arr));
  },
  recentItems() {
    const resolve = (rk) => {
      let obj; try { obj = JSON.parse(rk); } catch { return null; }
      if (!obj || !obj.t) return null;
      if (obj.t === 'product') {
        const p = this.products.find(p => String(p.id) === String(obj.k));
        return p ? this.asProduct(p) : null;
      }
      if (obj.t === 'category') {
        const c = this.categories.find(c => (c.name || '').toLowerCase() === String(obj.k).toLowerCase());
        return c ? this.asCategory(c) : null;
      }
      if (obj.t === 'info') {
        const l = this.links.find(l => (l.name || '').toLowerCase() === String(obj.k).toLowerCase());
        return l ? this.asInfo(l) : null;
      }
      if (obj.t === 'pharmacy') {
        const p = this.pharmacies.find(x => String(x.id) === String(obj.k));
        return p ? this.asPharmacy(p) : null;
      }
      return null;
    };
    return this.recent.map(resolve).filter(Boolean).slice(0, 3);
  },

  // --- getters from opts (unchanged pattern) ---
  get products()   { return (opts.getProducts && opts.getProducts())   || []; },
  get categories() { return (opts.getCategories && opts.getCategories()) || []; },
  get links()      { return (opts.getLinks && opts.getLinks())         || []; },

  // --- normalization to a single row shape ---
  asProduct(p) {
    return {
      t: 'product',
      k: String(p.id),
      id: p.id,
      name: p.name,
      sub: `${p.stock || ''}${p.category ? ` • ${p.category}` : ''}`,
      img: p.image || null,
      icon: null,
      href: `#/product/${p.id}`,
      raw: p
    };
  },
  asCategory(c) {
    return {
      t:'category', k:String(c.name || ''), id:null,
      name:c.name, sub:`Kategorie • ${c.products ?? 0} produktů`,
      img:c.image || null, icon:null, raw:c
    };
  },
  asInfo(l) {
    const set = (l.iconSet || 'fa-regular').trim();
    const name = (l.icon || 'circle-info').trim();
    return {
      t:'info', k:String(l.name || ''), id:null,
      name:l.name, sub:l.description || '',
      img:null, icon:`${set} fa-${name}`, raw:l
    };
  },
  asPharmacy(p) {
    return {
      t: 'pharmacy',
      k: String(p.id),
      id: p.id,
      name: p.name,
      sub: `${p.address?.street || ''}${p.address?.city ? ` • ${p.address.city}` : ''}`,
      img: null,
      icon: p.type === 'box' ? 'fa-solid fa-box' : 'fa-solid fa-location-dot',
      href: '#/map',
      raw: p
    };
  },

  // --- scoring & suggestions (sync, includes pharmacies) ---
  suggestions() {
    const s = this.q.trim().toLowerCase();
    if (s.length < this.minChars) return [];

    const scoreText = (txt) => {
      const t = (txt || '').toLowerCase();
      if (!t) return 0;
      if (t.startsWith(s)) return 100;
      if (t.includes(s))  return 60;
      return 0;
    };

    // products
    const prod = this.products.map(p => {
      const a = this.asProduct(p);
      let sc = scoreText(p.name);
      sc += Math.min(20, scoreText(p.category));
      return { a, sc };
    });

    // categories
    const cats = this.categories.map(c => {
      const base = scoreText(c.name);
      const sc = base ? base + 10 : 0;
      return { a: this.asCategory(c), sc };
    });

    // info links
    const inf = this.links.map(l => {
      const a = this.asInfo(l);
      const sc = Math.max(scoreText(l.name), Math.floor(scoreText(l.description) / 2));
      return { a, sc };
    });

    // pharmacies (name + address bits)
    const ph = (this.pharmacies || []).map(p => {
      const a = this.asPharmacy(p);
      let sc = scoreText(p.name);
      sc = Math.max(sc, scoreText(p.address?.street));
      sc = Math.max(sc, scoreText(p.address?.city));
      sc = Math.max(sc, scoreText(p.address?.district));
      sc = Math.max(sc, scoreText(p.address?.zip));
      if (sc) sc += 5; // tiny boost to surface alongside others
      return { a, sc };
    });

    return [...prod, ...cats, ...inf, ...ph]
      .filter(x => x.sc > 0)
      .sort((x, y) => y.sc - x.sc || String(x.a.name).localeCompare(String(y.a.name), 'cs'))
      .map(x => x.a)
      .slice(0, this.maxResults);
  },

  visibleItems() {
    return (this.q.trim().length >= this.minChars) ? this.suggestions() : this.recentItems();
  },

  // --- actions ---
  selectByIndex(i) { const it = this.visibleItems()[i]; if (it) this.onSelect(it); },
  onSelect(item) {
    this.saveRecent(item);
    this.open = false;
    this.highlighted = -1;

    if (item.t === 'product' && item.id != null) {
      if (opts.goTo) opts.goTo(item.id);
      else location.hash = `#/product/${item.id}`;
      return;
    }

    if (item.t === 'pharmacy' && item.id != null) {
      location.hash = '#/map';
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('pharmacy:open', { detail: { id: item.id } }));
      }, 0);
      return;
    }

    // categories/info: wire routes if/when needed
  },

  clear() { this.q = ''; this.highlighted = -1; },

  // --- keyboard ---
  onKeydown(e) {
    if (!this.open && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) this.open = true;
    const items = this.visibleItems();
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault(); if (!items.length) return;
        this.highlighted = (this.highlighted + 1) % items.length;
        this.$nextTick(() => document.getElementById(this.itemId(this.highlighted))?.scrollIntoView({ block:'nearest' }));
        break;
      case 'ArrowUp':
        e.preventDefault(); if (!items.length) return;
        this.highlighted = (this.highlighted <= 0 ? items.length - 1 : this.highlighted - 1);
        this.$nextTick(() => document.getElementById(this.itemId(this.highlighted))?.scrollIntoView({ block:'nearest' }));
        break;
      case 'Enter':
        if (this.open) { e.preventDefault(); if (items.length) this.selectByIndex(this.highlighted >= 0 ? this.highlighted : 0); }
        break;
      case 'Escape':
        this.open = false; this.highlighted = -1; break;
    }
  },

  // --- ARIA ---
  itemId(i){ return `${this.listId}-opt-${i}`; },
  activeDesc(){ return this.highlighted >= 0 ? this.itemId(this.highlighted) : null; },
})),


    //PRODUCT COMPARISON
    Alpine.data('comparisonSection', (opts = {}) => ({
    url: opts.url ?? 'data/comparison.json',
    id:  opts.id ?? null,

    loading: true,
    error: null,
    items: [],   // products to compare (columns)

    async init() {
      if (!this.id) { this.loading = false; return; }
      await this.load(this.id);
    },

    async load(groupId) {
      this.loading = true; this.error = null;
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const groups = await res.json();
        const found = Array.isArray(groups) ? groups.find(g => Number(g.id) === Number(groupId)) : null;
        this.items = found?.product_comparison || [];
      } catch (e) {
        console.error('comparison load failed', e);
        this.error = 'Nepodařilo se načíst porovnání.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; },

    priceNow(p){
      const price = Number(p?.price ?? 0);
      const disc  = Number(p?.discounted_price ?? 0);
      // use discounted only if it exists and is lower than regular
      return (disc > 0 && disc < price) ? disc : price;
    },
    priceOriginal(p){ return Number(p?.price ?? 0); },

    unitLabel(p){
      const u = (p?.unit || '').trim();
      return u || 'jedn.';
    },

    pricePerUnit(p){
      const v = Number(p?.volume ?? 0);
      if (!v) return null;
      return this.priceNow(p) / v;
    },

    unitPriceText(p){
      const v = Number(p?.volume ?? 0);
      if (!v) return '—';
      const num = new Intl.NumberFormat('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(this.pricePerUnit(p));
      return `${num} Kč / ${this.unitLabel(p)}`;
    },

    fmtPrice(v){
      return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(Number(v||0));
    },

    shortDesc(txt, n = 120){
      if (!txt) return '—';
      const t = String(txt).trim();
      return t.length > n ? t.slice(0, n - 1) + '…' : t;
    }
  })),

    // STORE CORE + ROUTER
    Alpine.data('storeApp', () => ({

// persisted prefs
locale: Alpine.$persist('cs').as('locale'),

// state
products: [],
categories: [],
forms: [],
consumersList: [],
navCategories: [],   
infoLinks: [],       

search: '',
selectedCategory: '',
selectedForm: '',
selectedConsumers: [],            // multi
onlyInStock: false,
benefitOnly: false,
onlyDiscounted: false,

sortOrder: '',
isLoading: true,
_filterTimer: null,
page: 1,
pageSize: 8,
showCount: 8,

// router
route: 'products',
params: {},
topCats: [],
topBrands: [],
benefits: [],

// product detail state
detail: null,
brands: [],
blogPosts: [],



// ---- lifecycle ----
init() {
  // 1) Router: support BOTH hash routes & path (no-hash) homepage
  window.addEventListener('hashchange', () => this._onRoute());
  window.addEventListener('popstate',   () => this._onRoute()); // for back/forward when at "/"
  this._onRoute();

  // 2) Watchers -> reset paging + loader delay when anything changes
  const trigger = () => {
    this.page = 1;
    this.showCount = this.pageSize;
    this.scheduleDisplayDelay();
  };
  this.$watch('search', trigger);
  this.$watch('selectedCategory', trigger);
  this.$watch('selectedForm', trigger);
  this.$watch('selectedConsumers', trigger);
  this.$watch('onlyInStock', trigger);
  this.$watch('benefitOnly', trigger);
  this.$watch('onlyDiscounted', trigger);
  this.$watch('sortOrder', trigger);

  // keep page in range if results shrink
  this.$watch(() => this.filteredProducts().length, () => {
    this.page = Math.min(this.page, this.totalPages());
  });

  // 3) Load data
  this.loadData().then(() => {
    // set initial catalog once data exists
    Alpine.store('precart').setCatalog(this.pagedProducts());
  });

  Alpine.store('cart').init?.();
  Alpine.store('legal').init();

  const refreshCatalog = () => Alpine.store('precart').setCatalog(this.pagedProducts());
  this.$watch('page', refreshCatalog);
  this.$watch('showCount', refreshCatalog);
  this.$watch(() => this.filteredProducts().length, refreshCatalog);
  this.$watch('search', refreshCatalog);
  this.$watch('selectedCategory', refreshCatalog);
  this.$watch('selectedForm', refreshCatalog);
  this.$watch('selectedConsumers', refreshCatalog);
  this.$watch('onlyInStock', refreshCatalog);
  this.$watch('benefitOnly', refreshCatalog);
  this.$watch('onlyDiscounted', refreshCatalog);
  this.$watch('sortOrder', refreshCatalog);

},
// Load brands.json (call from loadData or once on home)
async loadBrands() {
  try {
    const r = await fetch('data/brands.json');
    const arr = await r.json();
    this.brands = Array.isArray(arr) ? arr.filter(b => b?.name && b?.logo) : [];
  } catch (e) {
    console.warn('brands.json failed', e);
    this.brands = [];
  }
},

async loadBlog() {
  try {
    const res = await fetch('data/blog.json', { cache: 'no-store' });
    const arr = await res.json();
    this.blogPosts = Array.isArray(arr)
      ? arr.filter(post => post?.title && post?.image)
      : [];
  } catch (e) {
    console.warn('blog.json failed', e);
    this.blogPosts = [];
  }
  return this.blogPosts;
},

blogFeatured(count = 6) {
  return Array.isArray(this.blogPosts) ? this.blogPosts.slice(0, count) : [];
},
blogLink(post) {
  const url = String(post?.link || '').trim();
  return url || '#';
},
readingTimeLabel(post) {
  const minutes = Number(post?.minutes_to_read);
  if (!Number.isFinite(minutes) || minutes <= 0) return 'Čtení';
  const abs = Math.round(minutes);
  const forms = ['minuta', 'minuty', 'minut'];
  const form = abs === 1 ? forms[0] : (abs >= 2 && abs <= 4 ? forms[1] : forms[2]);
  return `${abs} ${form} čtení`;
},
blogExcerpt(post, limit = 220) {
  const text = String(post?.perex || '').trim();
  if (!text) return '';
  return text.length > limit ? `${text.slice(0, limit - 1)}…` : text;
},

// Optional: call in loadData() after products/aux files load:
/// await this.loadBrands();

// Brand link (adapt later if you add brand filtering in router)
brandHref(b) { return this.link('products'); },

// Badge helpers (supports e.g. "Až -31%" or "3za2")
badgeText(b) {
  const t = String(b?.badge || '').trim();
  if (!t) return '';
  if (t.toLowerCase() === '3za2') return '3 za 2';
  return t;
},
badgeClass(b) {
  const t = String(b?.badge || '').toLowerCase();
  if (t === '3za2') return 'badge-warning';
  // default discount style
  return 'badge-error text-white';
},

// Per-key shuffle cache for brands
_brandCacheMap: {},   // { [key]: shuffledArray }
brandsShuffledFor(key, count = 18) {
  if (!key) return [];
  if (!Array.isArray(this._brandCacheMap[key])) {
    const src = Array.isArray(this.brands) ? this.brands : [];
    if (src.length === 0) return [];
    const arr = src.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    this._brandCacheMap[key] = arr;
  }
  return this._brandCacheMap[key].slice(0, count);
},
async loadData() {
  try {
    const res = await fetch('data/products.json');
    this.products = await res.json();

    // facets (unchanged)
    this.categories = [...new Set(this.products.map(p => p.category).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'cs'));
    this.forms = [...new Set(this.products.map(p => (p.form || '').trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'cs'));
    const cons = new Set();
    this.products.forEach(p => (Array.isArray(p.consumers) ? p.consumers : []).forEach(c => cons.add(c)));
    this.consumersList = [...cons].sort((a,b)=>a.localeCompare(b,'cs'));

    // 👉 optional data
    const [cats, links] = await Promise.allSettled([
      fetch('data/categories.json').then(r => r.ok ? r.json() : []),
      fetch('data/links.json').then(r => r.ok ? r.json() : []),
    ]);
    this.navCategories = (cats.status === 'fulfilled'  && Array.isArray(cats.value))  ? cats.value  : [];
    this.infoLinks     = (links.status === 'fulfilled' && Array.isArray(links.value)) ? links.value : [];

    // ---- HOMEPAGE derived data (lightweight heuristics) ----
    // pick top categories by product count
    const counts = {};
    this.products.forEach(p => { if (p.category) counts[p.category] = (counts[p.category] || 0) + 1; });
    this.topCats = Object.entries(counts)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 6)
      .map(([name]) => ({ name, image: this.categoryImage(name) }));

    // Top brands (from product.brand if present)
    const brandSet = new Set(this.products.map(p => (p.brand || '').trim()).filter(Boolean));
    this.topBrands = Array.from(brandSet).slice(0, 10).map(name => ({ name, logo: this.brandLogo(name) }));
    await this.loadBrands();
    await this.loadBlog();

  } catch (e) {
    console.error('Failed to load products.json', e);
    try {
      const [cats, links] = await Promise.allSettled([
        fetch('data/categories.json').then(r => r.ok ? r.json() : []),
        fetch('data/links.json').then(r => r.ok ? r.json() : []),
      ]);
      this.navCategories = (cats.status === 'fulfilled'  && Array.isArray(cats.value))  ? cats.value  : [];
      this.infoLinks     = (links.status === 'fulfilled' && Array.isArray(links.value)) ? links.value : [];
      await this.loadBlog();
    } catch {}
  } finally {
    this.isLoading = false;
  }
},

// ---- scroll manager ----
_scrollStore: { home: 0, products: 0 },
_saveScroll(key = this.route) {
  this._scrollStore[key] = window.scrollY || window.pageYOffset || 0;
},
_restoreScroll(key = this.route) {
  const y = this._scrollStore[key] ?? 0;
  const restore = () => {
    if (this.isLoading) { requestAnimationFrame(restore); return; }
    setTimeout(() => { window.scrollTo({ top: y, left: 0, behavior: 'auto' }); }, 0);
  };
  requestAnimationFrame(restore);
},
_scrollToTopSoon() {
  requestAnimationFrame(() => window.scrollTo({ top: 0, left: 0, behavior: 'auto' }));
},

// ---- misc helpers ----
truncate(str, max = 34) {
  const s = String(str || '');
  return s.length > max ? s.slice(0, max - 1) + '…' : s;
},
consumersLabel() {
  if (!this.selectedConsumers.length) return 'Vhodné pro';
  return this.truncate(this.selectedConsumers.join(', '));
},
optionsLabel() {
  const on = [];
  if (this.onlyInStock)     on.push('Skladem');
  if (this.benefitOnly)     on.push('Benefity');
  if (this.onlyDiscounted)  on.push('V akci');
  return on.length ? this.truncate(on.join(', ')) : 'Možnosti';
},
clearOptions() {
  this.onlyInStock = false;
  this.benefitOnly = false;
  this.onlyDiscounted = false;
},

// ---- homepage helpers (images/logos; adapt paths as needed) ----
categoryImage(name) {
  // prefer categories.json image if present
  const c = (this.navCategories || []).find(c => (c.name || c.title) === name);
  return c?.image || `./images/categories/${encodeURIComponent(name)}.webp`;
},
brandLogo(name) {
  // try local logo by brand name
  return `./images/brands/${encodeURIComponent(name)}.svg`;
},

// ---- product picks for home ----
topProducts(limit = 12) {
  // naive "featured": in stock & discounted first
  const list = [...this.products];
  list.sort((a,b)=>{
    const ad = (b.discount || 0) - (a.discount || 0);
    if (ad !== 0) return ad;
    return (b.inStock ? 1:0) - (a.inStock ? 1:0);
  });
  return list.slice(0, limit);
},
productsByCategory(cat, limit = 10) {
  return this.products.filter(p => p.category === cat).slice(0, limit);
},

// link helper router
link(name, params = {}) {
  if (name === 'home')    return '/';
  if (name === 'product') return `#/product/${params.id}${params.tab ? '/' + params.tab : ''}`;
  if (name === 'cart')    return '#/cart';
  if (name === 'delivery-payment') return '#/delivery-payment';
  if (name === 'addresses') return '#/addresses';
  if (name === 'purchase-review') return '#/purchase-review';
  if (name === 'thank-you') return '#/thank-you';
  if (name === 'map')     return '#/map';
  if (name === 'my-account')     return '#/my-account';
  if (name === 'my-saved')     return '#/my-saved';
  return '#/products';
},

// --- Scroll indicators (no nested x-data) ---
tpShowLeft: false,
tpShowRight: false,
tpScrolled: false,
initStripe(el, leftKey = 'tpShowLeft', rightKey = 'tpShowRight') {
  const update = () => {
    if (!el) return;
    const { scrollLeft, scrollWidth, clientWidth } = el;
    this[leftKey]  = scrollLeft > 4;
    this[rightKey] = scrollLeft + clientWidth < scrollWidth - 4;
  };
  this.$nextTick(() => {
    update();
    el?.addEventListener('scroll', update, { passive: true });
    const ro = new ResizeObserver(update);
    el && ro.observe(el);
    window.addEventListener('orientationchange', update, { passive: true });
    window.addEventListener('resize', update, { passive: true });
  });
},

// --- Pricing helpers (supports discounted_price from your feed) ---
formatPrice(v) {
  const n = Number(v || 0);
  return n.toLocaleString('cs-CZ') + ' Kč';
},
currentPrice(p) {
  return (p?.discounted_price != null) ? Number(p.discounted_price) : Number(p?.price || 0);
},
crossedPrice(p) {
  if (p?.discounted_price != null) return Number(p?.price || 0);
  if (p?.oldPrice != null) return Number(p.oldPrice);
  return null;
},
discountPct(p) {
  const now = this.currentPrice(p);
  const was = this.crossedPrice(p);
  if (!was || !now || !(was > now)) return null;
  return Math.round(100 - (now / was) * 100);
},
isInStock(p) {
  // your schema: p.stock like "Skladem"
  return String(p?.stock || '').toLowerCase().includes('sklad');
},

// --- One-time shuffle per page load ---
_topProdCache: null,
// Source + per-key shuffle (unchanged logic, accepts any key)
_topSource() {
  const hasTopProducts = typeof this.topProducts === 'function';
  const hasTopPorudcts = typeof this.topPorudcts === 'function';
  if (hasTopProducts)  return this.topProducts(200);
  if (hasTopPorudcts)  return this.topPorudcts(200);
  return Array.isArray(this.products) ? this.products : [];
},
topProductsShuffledFor(key, count = 12) {
  if (!key) return [];
  if (!Array.isArray(this._topProdCacheMap[key])) {
    const src = this._topSource();
    if (!Array.isArray(src) || src.length === 0) return [];
    const arr = src.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    this._topProdCacheMap[key] = arr;
  }
  return this._topProdCacheMap[key].slice(0, count);
},
// ---- per-strip state (reactive) ----
_tpId: 0,
tpStates: {},            // { [key]: {left,right,scrolled} }
_topProdCacheMap: {},    // { [key]: shuffledArray }

// Register scroller with an explicit key (string) or auto-assigned if missing
registerTopStrip(el, key = null) {
  if (!el) return;
  const id = key || el.dataset.tpId || ('tp' + (++this._tpId));
  el.dataset.tpId = id;

  if (!this.tpStates[id]) this.tpStates[id] = { left: false, right: false, scrolled: false };

  const update = () => {
    const { scrollLeft, scrollWidth, clientWidth } = el;
    const st = this.tpStates[id];
    st.left  = scrollLeft > 4;
    st.right = scrollLeft + clientWidth < scrollWidth - 4;
    if (!st.scrolled && scrollLeft > 2) st.scrolled = true;
  };

  this.$nextTick(() => {
    update();
    el.addEventListener('scroll', update, { passive: true });
    const ro = new ResizeObserver(update);
    ro.observe(el);
    window.addEventListener('orientationchange', update, { passive: true });
    window.addEventListener('resize', update, { passive: true });
  });
},


go(to) {
  // special case: go to homepage WITHOUT hash
  if (to === 'home' || to === '/' || to === '') {
    // save scroll position of leaving route
    if (this.route === 'products') this._saveScroll('products');
    if (this.route !== 'home') this._saveScroll(this.route);
    window.history.pushState({}, '', window.location.pathname); // no hash
    this._onRoute(); // manually trigger since no 'hashchange'
    return;
  }

  const newHash = to.startsWith('#') ? to : ('#' + to.replace(/^#/, ''));
  if (location.hash === newHash) { this._onRoute(); return; }
  location.hash = newHash;
},

is(nameOrArr) {
  return Array.isArray(nameOrArr)
    ? nameOrArr.includes(this.route)
    : this.route === nameOrArr;
},

// ---- router ----
_onRoute() {
  const prevRoute = this.route;

  // if there's no hash (or just "#") -> HOME
  const emptyOrHome = !location.hash || location.hash === '#';

  // Keep existing hash router when present
  const raw = emptyOrHome ? '' : (location.hash).replace(/^#\/?/, '');
  const [pathPart] = (raw || '').split('?');
  const seg = (pathPart || '').split('/').map(s => decodeURIComponent(s || ''));
  const [path, id, sub] = seg;

  if (emptyOrHome || path === '') {
    // default + fallback = HOME
    if (prevRoute === 'products') this._saveScroll('products');
    this.route = 'home';
    this.params = {};
    this._restoreScroll('home');
    return;
  }

  switch (path) {
    case 'products':
      this.route = 'products';
      this.params = {};
      this._restoreScroll('products');
      break;

    case 'cart':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'cart';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'delivery-payment':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'delivery-payment';
      this.params = {};
      this._scrollToTopSoon();
      break;

      case 'addresses':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'addresses';
      this.params = {};
      this._scrollToTopSoon();
      break;

      case 'purchase-review':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'purchase-review';
      this.params = {};
      this._scrollToTopSoon();
      break;

      case 'thank-you':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'thank-you';
      this.params = {};
      this._scrollToTopSoon();
      break;
      
      case 'my-account':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'my-account';
      this.params = {};
      this._scrollToTopSoon();
      break;

      case 'my-saved':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'my-saved';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'map':
      if (prevRoute === 'products') this._saveScroll('products');
      this.route = 'map';
      this.params = {};
      this._scrollToTopSoon();
      break;

    case 'product':
      if (prevRoute === 'products') this._saveScroll('products');
      if (id) {
        this.route = 'product';
        this.params = { id, tab: sub || 'desc' };
        this._scrollToTopSoon();
        this.loadDetail(id);
      } else {
        this.route = 'product';
        this.params = {};
        this._scrollToTopSoon();
      }
      break;

    default:
      // 🌟 Fallback to HOME (no hash)
      if (prevRoute === 'products') this._saveScroll('products');
      window.history.replaceState({}, '', window.location.pathname);
      this.route = 'home';
      this.params = {};
      this._restoreScroll('home');
  }
},


// ---- detail loading with single source of truth for price ----
async getDetailById(id) {
  const res = await fetch(`data/product-details/${id}.json`);
  if (!res.ok) throw new Error(`detail ${id} ${res.status}`);
  return await res.json();
},

_mergeDetailPrice(detailObj, id) {
  const gridItem = this.products.find(p => String(p.id) === String(id));
  if (gridItem) {
    detailObj.price = gridItem.price ?? detailObj.price;
    detailObj.discounted_price = gridItem.discounted_price ?? detailObj.discounted_price;
    // keep variant price aligned with grid, if single default variant
    if (Array.isArray(detailObj.variants) && detailObj.variants.length) {
      detailObj.variants = detailObj.variants.map(v => ({
        ...v,
        price: gridItem.price ?? v.price,
        discounted_price: gridItem.discounted_price ?? v.discounted_price
      }));
    }
  }
  return detailObj;
},

// add near your state
_detailReq: 0,           // request counter
currentDetailId: null,    // last successfully shown id

async loadDetail(id) {
  const myReq = ++this._detailReq;        // mark this request as the latest
  try {
    console.log('loadDetail ->', id);
    const d = await this.getDetailById(id);

    // if a newer request started meanwhile, ignore this response
    if (myReq !== this._detailReq) return;

    this.detail = this._mergeDetailPrice(d, id);
    this.currentDetailId = id;
  } catch (e) {
    if (myReq === this._detailReq) this.detail = null;
    console.error('Failed to load product detail', id, e);
  }
},

// ---- filter helpers ----
optionsCount() {
  let n = 0;
  if (this.onlyInStock) n++;
  if (this.benefitOnly) n++;
  if (this.onlyDiscounted) n++;
  return n;
},
filteredCount() { return this.filteredProducts().length; },

sortLabel() {
  switch (this.sortOrder) {
    case 'priceAsc':  return 'Řadit dle: Cena ↑';
    case 'priceDesc': return 'Řadit dle: Cena ↓';
    case 'alphaAsc':  return 'Řadit dle: Abecedně A–Z';
    case 'alphaDesc': return 'Řadit dle: Abecedně Z–A';
    default:          return 'Řadit dle: Doporučeno';
  }
},
toggleConsumer(val) {
  const i = this.selectedConsumers.indexOf(val);
  if (i >= 0) this.selectedConsumers.splice(i, 1);
  else this.selectedConsumers.push(val);
  this.selectedConsumers = [...this.selectedConsumers]; // normalize
},

hasActiveFilters() {
  return !!(
    this.search ||
    this.selectedCategory ||
    this.selectedForm ||
    this.selectedConsumers.length ||
    this.onlyInStock ||
    this.benefitOnly ||
    this.onlyDiscounted
  );
},
activeFiltersCount() {
  let n = 0;
  if (this.search) n++;
  if (this.selectedCategory) n++;
  if (this.selectedForm) n++;
  n += this.selectedConsumers.length;
  if (this.onlyInStock) n++;
  if (this.benefitOnly) n++;
  if (this.onlyDiscounted) n++;
  return n;
},
clearFilters() {
  this.search = '';
  this.selectedCategory = '';
  this.selectedForm = '';
  this.selectedConsumers = [];
  this.onlyInStock = false;
  this.benefitOnly = false;
  this.onlyDiscounted = false;
  this.sortOrder = '';
},

// ---- loader delay ----
scheduleDisplayDelay() {
  this.isLoading = true;
  clearTimeout(this._filterTimer);
  this._filterTimer = setTimeout(() => { this.isLoading = false; }, 750);
},

// ---- filtering/sorting ----
filteredProducts() {
  let items = this.products;

  if (this.search) {
    const s = this.search.toLowerCase();
    items = items.filter(p =>
      (p.name || '').toLowerCase().includes(s) ||
      (p.description || '').toLowerCase().includes(s)
    );
  }
  if (this.selectedCategory) {
    items = items.filter(p => p.category === this.selectedCategory);
  }
  if (this.selectedForm) {
    items = items.filter(p => (p.form || '').trim() === this.selectedForm);
  }
  if (this.selectedConsumers.length) {
    items = items.filter(p => {
      const arr = Array.isArray(p.consumers) ? p.consumers : [];
      return this.selectedConsumers.some(c => arr.includes(c)); // ANY match
    });
  }
  if (this.onlyInStock) {
    items = items.filter(p => String(p.stock || '').toLowerCase().includes('sklad'));
  }
  if (this.benefitOnly) {
    items = items.filter(p => !!p.benefitPayment);
  }
  if (this.onlyDiscounted) {
    items = items.filter(p => {
      const d = Number(p.discounted_price || 0);
      const pr = Number(p.price || 0);
      return d > 0 && d < pr;
    });
  }

  if (this.sortOrder === 'priceAsc') {
    items = items.slice().sort((a, b) => (a.price ?? 0) - (b.price ?? 0));
  } else if (this.sortOrder === 'priceDesc') {
    items = items.slice().sort((a, b) => (b.price ?? 0) - (a.price ?? 0));
  } else if (this.sortOrder === 'alphaAsc') {
    items = items.slice().sort((a, b) => String(a.name).localeCompare(String(b.name), 'cs', {sensitivity:'base'}));
  } else if (this.sortOrder === 'alphaDesc') {
    items = items.slice().sort((a, b) => String(b.name).localeCompare(String(a.name), 'cs', {sensitivity:'base'}));
  }

  return items;
},

// ---- pagination (unchanged) ----
canLoadMoreFirstPage() {
  return this.page === 1 && this.showCount < this.filteredProducts().length;
},
loadMore() {
  const total = this.filteredProducts().length;
  this.showCount = Math.min(this.showCount + this.pageSize, total);
},
loadMoreLabel() {
  const remaining = this.filteredProducts().length - this.showCount;
  const n = Math.min(this.pageSize, Math.max(0, remaining));
  return n ? `Načíst dalších ${n} produktů` : 'Vše načteno';
},
totalPages() {
  const total = this.filteredProducts().length;
  if (total <= this.showCount) return 1;
  return 1 + Math.ceil((total - this.showCount) / this.pageSize);
},
pagedProducts() {
  const items = this.filteredProducts();
  if (this.page === 1) return items.slice(0, this.showCount);
  const start = this.showCount + (this.page - 2) * this.pageSize;
  return items.slice(start, start + this.pageSize);
},
pagesToShow() {
  const p = this.page, t = this.totalPages();
  if (t <= 7) return Array.from({ length: t }, (_, i) => i + 1);
  if (p <= 4) return [1, 2, 3, 4, 5, '…', t];
  if (p >= t - 3) return [1, '…', t - 4, t - 3, t - 2, t - 1, t];
  return [1, '…', p - 1, p, p + 1, '…', t];
},
rangeLabel() {
  const total = this.filteredProducts().length;
  if (!total) return '0 z 0';
  if (this.page === 1) return `1–${this.showCount} z ${total}`;
  const start = this.showCount + (this.page - 2) * this.pageSize + 1;
  const end = Math.min(this.showCount + (this.page - 1) * this.pageSize, total);
  return `${start}–${end} z ${total}`;
}

})),

  // HAMBURGER MENU  
  Alpine.store('menu', {
    // state
    open: false,
    menus: [],
    current: null,     // active menu object
    stack: [],         // for back navigation
    slideDir: 1,       // 1 forward, -1 back (animation)
    viewKey: 0,        // bump to retrigger pane animation
    loading: false,
    error: null,

    async load(url = 'data/menus.json') {
      if (this.menus.length) return;
      this.loading = true; this.error = null;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        this.menus = this.normalize(raw);
      } catch (e) {
        console.error('menu load failed', e);
        this.error = 'Nepodařilo se načíst menu.';
      } finally {
        this.loading = false;
      }
    },

    // Accepts either my camelCase schema or your snake_case + single-string icon
    normalize(arr){
      const normItem = (it = {}) => {
        const out = { ...it };

        // snake_case -> camelCase
        if (out.link_to_menu_id != null) out.linkMenuId = out.link_to_menu_id;
        if (out.router_link) out.route = out.router_link;
        if (out.row_type) out.rowType = out.row_type;

        // icon: "fa-regular capsules" -> { iconSet:'fa-regular', icon:'capsules' }
        if (!out.iconSet && typeof out.icon === 'string' && out.icon.includes(' ')) {
          const [set, name] = out.icon.split(/\s+/, 2);
          out.iconSet = set;
          out.icon = name;
        }

        return out;
      };

      return (arr || []).map(m => ({
        id: m.id,
        parentId: m.parentId ?? m.parent ?? null,
        name: m.name,
        // some menus have root items, some only sections – handle both
        items: Array.isArray(m.items) ? m.items.map(normItem) : [],
        sections: Array.isArray(m.sections)
          ? m.sections.map(s => ({
              name: s.name ?? null,
              type: s.type ?? null,     // 'language' / 'loyalty' / undefined
              items: Array.isArray(s.items) ? s.items.map(normItem) : []
            }))
          : []
      }));
    },

    // helpers
    byId(id){ return this.menus.find(m => Number(m.id) === Number(id)); },
    canGoBack(){ return this.stack.length > 0 || (this.current && this.current.parentId != null); },

    // open from anywhere; default id by screen (lg desktop -> 2, mobile -> 1)
    async openAt(id = null) {
      await this.load();
      if (id == null) {
        id = window.matchMedia('(min-width: 1024px)').matches ? 2 : 1;
      }
      this.stack = [];
      this.slideDir = 1;
      this.current = this.byId(id) || null;
      this.viewKey++;
      this.open = true;
      document.documentElement.style.overflow = 'hidden'; // lock scroll
    },

    close() {
      this.open = false;
      this.stack = [];
      this.current = null;
      document.documentElement.style.overflow = '';
    },

    goToMenu(id) {
      if (!id) return;
      if (!this.current || Number(this.current.id) !== Number(id)) {
        if (this.current) this.stack.push(this.current.id);
        this.slideDir = 1;
        this.current = this.byId(id) || this.current;
        this.viewKey++;
      }
    },

    back() {
      if (!this.canGoBack()) { this.close(); return; }
      const prevId = this.stack.pop() ?? this.current?.parentId;
      if (prevId != null) {
        this.slideDir = -1;
        this.current = this.byId(prevId) || this.current;
        this.viewKey++;
      }
    },

    // click handlers
    onItemClick(item) {
      if (item.linkMenuId != null) {
        this.goToMenu(item.linkMenuId);
        return;
      }
      if (item.route) {
        location.hash = '#/' + String(item.route).replace(/^#?\/?/, '');
        this.close();
        return;
      }
      // no link/route: no-op
    }
  }),  
  
  // PRODUCT RATING
    Alpine.data('ratingLine', (src = {}) => ({
    avg: Number(src?.average ?? 0),
    count: Number(src?.count ?? 0),

    set(r){ this.avg = Number(r?.average ?? 0); this.count = Number(r?.count ?? 0); },

    // array of 5 slots: 'full' | 'half' | 'empty'
    stars() {
      const v = Math.max(0, Math.min(5, Math.round(this.avg * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    },

    fmtAvg(){ return (isFinite(this.avg) ? this.avg : 0).toFixed(1); }
  })),

      // CATEGORIES LIST
      Alpine.data('categoriesList', () => ({
      categories: [],
      fallback: './images/placeholder.png',

      async init() {
        // adjust path if needed
        const res = await fetch('./data/categories.json');
        this.categories = await res.json();
      },

      imageUrl(cat) {
        const base = (cat.image || '').trim();
        const withSlug = base.endsWith('/') ? `${base}${this.slug(cat.name)}.webp` : base;
        return base ? withSlug : this.fallback;
      },

      slug(str) {
        return str
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove diacritics
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      },

      productsLabel(n) {
        // Czech pluralization-ish
        if (n === 1) return '1 produkt';
        if (n >= 2 && n <= 4) return `${n} produkty`;
        return `${n} produktů`;
      },
    }))
    })
    // other helpers
      
    
    function qtyBlinker(id){
    return {
      alpha: 0,           // 0..1 opacity
      _phaseTimer: null,  // timer for fade-out
      init(){
        this.$watch(
          () => (Alpine.store('cart')?.qty(String(id)) ?? 0),
          (next, prev) => { if (next !== prev) this.blink(); }
        );
      },
      blink(ms = 1000){
        // Clear any ongoing fade-out
        clearTimeout(this._phaseTimer);
        this.alpha = 0;
        requestAnimationFrame(() => { this.alpha = 1; });
        const hold = Math.max(200, ms - 200);
        this._phaseTimer = setTimeout(() => { this.alpha = 0; }, hold);
      }
    }
  }
  </script>
<script>
  //MAP LOGIC
  function pickupMapUI(cfg) {
    const pngs = {
      pharmacy: { normal: './images/map/pharmacy.png', selected: './images/map/pharmacy_selected.png' },
      box: { normal: './images/map/box.png', selected: './images/map/box_selected.png' },
      shadow: './images/map/shadow.png'
    };
    const prague = [50.0755, 14.4378];
    const placeholderImg = './images/pup-photos/placeholder.webp';
  
    return {
      // CONFIG
      jsonUrl: cfg?.jsonUrl || './data/map-points.json',
      tracestrackKey: cfg?.tracestrackKey || '',
      enableClustering: !!cfg?.enableClustering,
  
      // STATE
      map: null,
      cluster: null,
      all: [],
      filtered: [],
      markers: new Map(),
      selected: null,
      mode: 'map',
      search: '',
      district: '',
      districts: ['Praha 1','Praha 2','Praha 3','Praha 4','Praha 5','Praha 6','Praha 7','Praha 8','Praha 9','Praha 10'],
      placeholderImg,
      enableGeolocateOnLoad: true,   
      geolocateOncePerSession: true, 
      userMarker: null,
      userAccuracy: null,
  
      // RESPONSIVE FLAGS
      isMd: false,
      isLg: false,
  
      // COMPUTED
      get filterActive(){ return !!(this.search || this.district); },
      get filterSummary(){ return `Zobrazuji ${this.filtered.length} z ${this.all.length}`; },
  
      // HELPERS
      updateBreakpoints() {
        this.isMd = window.matchMedia('(min-width: 768px)').matches;
        this.isLg = window.matchMedia('(min-width: 1024px)').matches;
      },
      hasCluster() { return !!(this.cluster && typeof this.cluster.addLayer === 'function'); },
      withMap(cb) {
        if (this.map) { cb(this.map); return true; }
        this.$nextTick(() => { if (this.map) cb(this.map); });
        return false;
      },
  
      async init() {
        if (this._inited) return; this._inited = true;
  
        this.updateBreakpoints();
        this._onResize = () => this.updateBreakpoints();
        window.addEventListener('resize', this._onResize);
  
        await this.loadData();

        this.$nextTick(async () => {
          await this.ensureVisibleSize();

          this.initMap();
          this.renderMarkers();

          this.withMap(m => {
            m.setView([50.0755, 14.4378], 12);
            setTimeout(() => m.invalidateSize(false), 0);
          });
  
          if (this.enableGeolocateOnLoad) {
            const key = 'geoPrompted';
            const already = this.geolocateOncePerSession && sessionStorage.getItem(key);
            if (!already) {
              this.locateUser();              
              if (this.geolocateOncePerSession) sessionStorage.setItem(key, '1');
            }
          }

            // Observe container size changes
            const host = this.$refs?.mapEl || document.getElementById('map');
            if (host && !this._ro) {
              const target = host.parentElement || host;
              this._ro = new ResizeObserver(() => this.withMap(m => m.invalidateSize(false)));
              this._ro.observe(target);
            }
  
            // Listen for external invalidate requests (from mapPane)
            if (host) {
              this._onInvalidate = () => this.withMap(m => m.invalidateSize(false));
              window.addEventListener('map:invalidate', this._onInvalidate);
            }
          });

  
        // Global open-from-search
        this._onOpenPharmacy = (e) => {
          const id = e.detail?.id; if (!id) return;
          const p = this.all.find(x => x.id === id); if (!p) return;
          this.selected = p; this.updateMarkerIcons();
          const latlng = [p.coords.lat, p.coords.lng];
          const marker = this.markers.get(p.id);
  
          const goto = () => {
            this.withMap(m => {
              m.setView(latlng, Math.max(m.getZoom(), 15), { animate: true });
            });
            if (marker && this.hasCluster() && this.cluster.hasLayer(marker)) {
              this.cluster.zoomToShowLayer(marker, () => marker.setZIndexOffset(1000));
            }
          };
  
          if (!this.isLg) {
            this.mode = 'map';
            this.$nextTick(() => {
              this.withMap(m => m.invalidateSize(false));
              goto();
            });
          } else {
            goto();
          }
        };
        window.addEventListener('pharmacy:open', this._onOpenPharmacy);
  
        // Cleanup
        window.addEventListener('beforeunload', () => this.teardown());
      },
  
      async ensureVisibleSize(el) {
        el = el
        || this.$refs?.mapEl?.parentElement
        || this.$refs?.mapEl
        || document.getElementById('map')?.parentElement
        || document.getElementById('map');
      if (!el) return;

      const hasSize = () => el.offsetWidth > 0 && el.offsetHeight > 0;
      if (hasSize()) {
        // double-check next frame to avoid mid-transition
        await new Promise(r => requestAnimationFrame(r));
        if (hasSize()) return;
      }

      await new Promise(resolve => {
        let readyFrames = 0;
        const tick = () => {
          if (hasSize()) {
            readyFrames++;
            if (readyFrames >= 2) { cleanup(); resolve(); return; }
          } else {
            readyFrames = 0;
          }
          raf = requestAnimationFrame(tick);
        };

        const ro = new ResizeObserver(() => { /* just trigger next raf tick */ });
        ro.observe(el);

        let raf = requestAnimationFrame(tick);
        const cleanup = () => { try { ro.disconnect(); } catch(_){} cancelAnimationFrame(raf); };
        // safety timeout (in case no resize ever fires)
        setTimeout(() => { cleanup(); resolve(); }, 1500);
      });
    },

      teardown() {
        if (this._onResize) window.removeEventListener('resize', this._onResize), this._onResize = null;
        if (this._onOpenPharmacy) window.removeEventListener('pharmacy:open', this._onOpenPharmacy), this._onOpenPharmacy = null;
        if (this._ro) { try { this._ro.disconnect(); } catch(_) {} this._ro = null; }
        const host = this.$refs?.mapEl || document.getElementById('map');
        if (this._onInvalidate) { window.removeEventListener('map:invalidate', this._onInvalidate); this._onInvalidate = null; }
        if (this.cluster) { try { this.cluster.clearLayers(); } catch(_) {} }
        if (this.map) { try { this.map.remove(); } catch(_) {} this.map = null; }
        if (host && host._leaflet_id) try { host._leaflet_id = null; } catch(_) {}
        window.__pickupMap = null;
      },
  
      async loadData() {
        const res = await fetch(this.jsonUrl);
        const json = await res.json();
        this.all = json.map(p => ({
          ...p,
          coords: { lat: +p.coords.lat, lng: +p.coords.lng },
          searchIndex: [p.name, p.type, p.address?.street, p.address?.city, p.address?.district, p.address?.zip]
            .filter(Boolean).join(' ').toLowerCase()
        }));
        this.filtered = this.all.slice();
      },
  
      initMap() {
        const el = this.$refs.mapEl || document.getElementById('map');
        if (!el) return;
  
        // Clean reused node / previous instance
        if (el._leaflet_id) {
          try { if (window.__pickupMap && window.__pickupMap._container === el) window.__pickupMap.remove(); } catch(_) {}
          el.innerHTML = '';
          try { el._leaflet_id = null; } catch(_) {}
        }
        if (window.__pickupMap && window.__pickupMap.remove) {
          try { window.__pickupMap.remove(); } catch(_) {}
          window.__pickupMap = null;
        }
  
        // Create map
        this.map = L.map(el, { zoomControl: true, attributionControl: true });
  
        // Tiles
        if (this.tracestrackKey) {
          L.tileLayer(
            'https://tile.tracestrack.com/topo/{z}/{x}/{y}.png?key=' + this.tracestrackKey,
            { maxZoom: 19, attribution: '&copy; Tracestrack, &copy; OpenStreetMap contributors' }
          ).addTo(this.map);
        } else {


          L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          subdomains: 'abcd', maxZoom: 19,
          attribution: '© OpenStreetMap contributors, © CARTO'
        }).addTo(this.map);
        }
  
        // Clustering (optional)
        this.cluster = null;
        if (this.enableClustering && L && typeof L.markerClusterGroup === 'function') {
          this.cluster = L.markerClusterGroup({
            showCoverageOnHover:false, spiderfyOnMaxZoom:true, disableClusteringAtZoom:16
          }).addTo(this.map);
        }
    // Simple custom control: "Locate me"
    const LocateControl = L.Control.extend({
      onAdd: () => {
        const btn = L.DomUtil.create('button', 'leaflet-bar');
        btn.setAttribute('type','button');
        btn.style.cssText = 'background:#fff;border:2px solid rgba(0, 0, 0, 0.2);width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer';
        btn.innerHTML = '<i class="fa-solid fa-location-crosshairs fa-xl"></i>';
        btn.title = 'Najít moji polohu';
        L.DomEvent.on(btn, 'click', (e) => { L.DomEvent.stopPropagation(e); this.locateUser(); });
        return btn;
      },
      onRemove: () => {}
    });
    this.map.addControl(new LocateControl({ position: 'topleft' }));


        window.__pickupMap = this.map;
      },
  
      iconFor(p, isSelected=false) {
        const typeIcons = pngs[p.type] || pngs.pharmacy;
        const url = isSelected ? typeIcons.selected : typeIcons.normal;
        return L.icon({
          iconUrl: url, iconSize: [32, 42], iconAnchor: [16, 40],
          popupAnchor: [0, -38], shadowUrl: pngs.shadow, shadowSize: [36, 20], shadowAnchor: [10, 20]
        });
      },
  
      renderMarkers() {
        const clustered = this.hasCluster();
  
        if (clustered) this.cluster.clearLayers();
        this.markers.forEach(m => { try { m.remove(); } catch(_) {} });
        this.markers.clear();
  
        const list = this.filtered.length ? this.filtered : this.all;
  
        list.forEach(p => {
          const m = L.marker([p.coords.lat, p.coords.lng], { icon: this.iconFor(p) })
            .on('click', () => this.selectFromMap(p));
          this.markers.set(p.id, m);
          if (clustered) this.cluster.addLayer(m);
          else this.withMap(mm => m.addTo(mm));
        });
  
        if (list.length) {
          const b = L.latLngBounds(list.map(p => [p.coords.lat, p.coords.lng]));
          this.withMap(mm => mm.fitBounds(b.pad(0.2)));
        }

      },
  
      updateMarkerIcons() {
        this.all.forEach(p => {
          const m = this.markers.get(p.id);
          if (m) m.setIcon(this.iconFor(p, !!(this.selected && this.selected.id===p.id)));
        });
      },
  
      selectFromMap(p) {
        this.selected = p; this.updateMarkerIcons();
        const m = this.markers.get(p.id);
        if (m) {
          const latlng = [p.coords.lat, p.coords.lng];
          this.withMap(mm => mm.setView(latlng, Math.max(mm.getZoom(), 15), { animate: true }));
        }
        this.scrollListTo(p.id);
      },
  
      selectFromList(p) {
        this.selected = p; this.updateMarkerIcons();
  
        const go = () => {
          const marker = this.markers.get(p.id);
          const latlng = [p.coords.lat, p.coords.lng];
          this.withMap(mm => mm.setView(latlng, Math.max(mm.getZoom(), 15), { animate: true }));
          if (marker && this.hasCluster() && this.cluster.hasLayer(marker)) {
            this.cluster.zoomToShowLayer(marker, () => marker.setZIndexOffset(1000));
          }
        };
  
        if (!this.isLg) {
          this.mode = 'map';
          this.$nextTick(() => {
            this.withMap(mm => mm.invalidateSize(false));
            go();
            const host = this.$refs?.mapEl || document.getElementById('map');
            if (host) host.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        } else {
          go();
        }
      },
  
      scrollListTo(id) {
        const safeId = (window.CSS && CSS.escape) ? CSS.escape(id) : id;
        const row = document.querySelector(`[data-pickup-id="${safeId}"]`);
        if (!row) return;
        row.scrollIntoView({ block: 'center', behavior: 'smooth' });
        const pulse = ['ring', 'ring-primary', 'ring-offset-1'];
        row.classList.add(...pulse);
        setTimeout(() => row.classList.remove(...pulse), 900);
      },
  
      confirmSelection() {
        if (!this.selected) return;
        try { localStorage.setItem('selectedPickupPoint', JSON.stringify(this.selected)); } catch(e){}
        window.dispatchEvent(new CustomEvent('pickup:selected', { detail: this.selected }));
        this.toast(`Vybráno: ${this.selected.name}`);
      },
  
      toast(msg) {
        const t = document.createElement('div');
        t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 z-[1000]';
        t.innerHTML = `<div class="alert alert-success shadow">${msg}</div>`;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 1600);
      },
  
      // FILTERING
      applyFilters() {
        const q = (this.search || '').toLowerCase().trim();
        const d = this.district;
        this.filtered = this.all.filter(p => {
          const okQ = q ? p.searchIndex.includes(q) : true;
          const okD = d ? (p.address?.city||'').toLowerCase().includes(d.toLowerCase()) : true;
          return okQ && okD;
        });
        this.renderMarkers();
        if (this.selected && !this.filtered.some(pp => pp.id===this.selected.id)) {
          this.selected = null;
          this.updateMarkerIcons();
        }
      },
      clearAllFilters() { this.search=''; this.district=''; this.applyFilters(); },
      
      locateUser() {
      if (!navigator.geolocation) {
        this.toast('Geolokace není podporována v tomto prohlížeči.');
        return;
      }

      // Leaflet convenience: fires 'locationfound' / 'locationerror'
      this.map.once('locationfound', (e) => {
        const { latlng, accuracy } = e;

        // remove previous
        if (this.userMarker) this.userMarker.remove();
        if (this.userAccuracy) this.userAccuracy.remove();

        // a small blue dot marker
        const youIcon = L.divIcon({
          className: 'you-are-here',
          html: `<div style="width:10px;height:10px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.25)"></div>`,
          iconSize: [10,10], iconAnchor: [5,5]
        });

        this.userMarker = L.marker(latlng, { icon: youIcon }).addTo(this.map);
        this.userAccuracy = L.circle(latlng, { radius: accuracy, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 0.08, weight: 1 })
          .addTo(this.map);

        // center/zoom nicely
        const targetZoom = Math.max(this.map.getZoom(), 15);
        this.map.setView(latlng, targetZoom, { animate: true });
      });

      this.map.once('locationerror', (err) => {
        // Common: blocked by user, insecure (needs HTTPS), or timeout
        this.toast('Nepodařilo se zjistit polohu. Zkontrolujte oprávnění/HTTPS.');
        console.warn('Geolocation error:', err);
      });

      // Start locate (will show browser prompt)
      this.map.locate({
        setView: false,             // we’ll setView after drawing marker
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    },

      dayCZ(d) {
        const m = { Mon:'Pondělí', Tue:'Úterý', Wed:'Středa', Thu:'Čtvrtek', Fri:'Pátek', Sat:'Sobota', Sun:'Neděle' };
        return m[d] || d;
      },
    };
  }
  </script>

<script>
  // Recompute map size right after the route settles
  window.addEventListener('hashchange', () => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        const el = document.getElementById('map');
        if (el) el.dispatchEvent(new CustomEvent('map:invalidate', { bubbles: true }));
      }, 220); 
    });
  });
</script>

<script>
  /** LEGAL TOOLTIPS **/
  function formatCZDate(d) {
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }
  function randomDateWithinLast(days = 30) {
    const now = new Date();
    const past = new Date(now);
    past.setDate(now.getDate() - days);
    const ts = past.getTime() + Math.random() * (now.getTime() - past.getTime());
    return new Date(ts);
  }
  function isDiscounted(p) {
    return p?.discounted_price && p.discounted_price < p.price;
  }
  function replaceWildcards(str, { price, dateStr }) {
    return str
      .replaceAll('{{PRICE}}', String(price))
      .replaceAll('{{DATE}}', dateStr);
  }
  
  document.addEventListener('alpine:init', () => {
    //preloads legal texts for legal tooltips
    Alpine.store('legal', {
      loaded: false,
      base: { legal_always: '', legal_extended: { price_info: '', date_info: '' } },
  
      async init() {
        if (this.loaded) return;
        try {
          const res = await fetch('./data/legal.json', { cache: 'no-store' });
          const arr = await res.json();
          // file structure is an array with one object
          this.base = Array.isArray(arr) && arr[0] ? arr[0] : this.base; // :contentReference[oaicite:1]{index=1}
          this.loaded = true;
        } catch (e) {
          console.warn('Failed to load legal.json', e);
          this.loaded = true; // fail-safe; show nothing rather than block UI
        }
      },
  
      paragraphsFor(product) {
        const always = this.base?.legal_always || '';
        const ext = this.base?.legal_extended || {};
        const list = [];
  
        if (always) list.push(always);
  
        if (isDiscounted(product)) {
          const dateStr = formatCZDate(randomDateWithinLast(30));
          const priceInfo = ext.price_info
            ? replaceWildcards(ext.price_info, { price: product.price, dateStr })
            : '';
          const dateInfo = ext.date_info
            ? replaceWildcards(ext.date_info, { price: product.price, dateStr })
            : '';
  
          if (priceInfo) list.push(priceInfo);
          if (dateInfo) list.push(dateInfo);
        }
        return list;
      }
    });
  });
  </script>
<script>
  document.addEventListener('alpine:init', () => {
    Object.assign(Alpine.store('precart'), {
  
      // normalize products to ensure id/name/image/price are usable in the modal
      _normalize(p) {
        if (!p) return null;
        const id = String(p.id ?? p.product_id ?? p.sku ?? '');
        if (!id) return null;
  
        // image via cart helper (covers many shapes), fallback to p.image
        const img = Alpine.store('cart')?.imgFor?.(p) || p.image || '';
  
        const priceFull = Number(p.price ?? 0);
        const priceNow  = Number(p.discounted_price ?? priceFull);
        const discounted_price = (priceNow < priceFull) ? priceNow : null;
  
        return {
          ...p,
          id,
          name: p.name ?? p.title ?? `Produkt #${id}`,
          image: img,
          price: priceFull,
          discounted_price
        };
      },
  
      setCatalog(arr) {
        const norm = Array.isArray(arr)
          ? arr.map(x => this._normalize(x)).filter(Boolean)
          : [];
        // Only overwrite when we actually have something to show
        if (norm.length) this.catalog = norm;
      },
  
      async _ensureCatalog() {
        if (Array.isArray(this.catalog) && this.catalog.length) return;
  
        // 1) Try common global caches if you keep any around
        let src = (window.allProducts || window.products || window.PRODUCTS || []);
        // 2) As a prototype fallback, fetch the master JSON
        if (!src.length) {
          try {
            const res = await fetch('./data/products.json', { cache: 'no-store' });
            src = await res.json();
          } catch (e) {
            console.warn('precart: failed to fetch products.json', e);
          }
        }
        this.setCatalog(src);
      },
  
      open(product) {
        this.product = product || null;
        this.isOpen  = !!this.product;
        this.quickAdded.clear();
        // Make sure we have recommendations even on pages without storeApp
        this._ensureCatalog();
      },
    });
  });
  </script>
  <script defer>
    (() => {
      const register = () => {
        Alpine.magic('fx', () => {
          const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
          return {
            confetti(type = 'celebrate', el = null) {
              if (prefersReduced || typeof window.confetti !== 'function') return;
    
              // compute origin near element (if provided)
              let origin = { x: 0.5, y: 0.6 };
              if (el?.getBoundingClientRect) {
                const r = el.getBoundingClientRect();
                const cx = (r.left + r.width / 2) / window.innerWidth;
                const cy = (r.top + r.height / 2 + window.scrollY) /
                           (document.documentElement.scrollHeight || window.innerHeight);
                origin = { x: Math.min(0.98, Math.max(0.02, cx)),
                           y: Math.min(0.98, Math.max(0.02, cy)) };
              }
    
              const base  = { ticks: 200, gravity: 0.9, scalar: 1, spread: 60, origin };
              const burst = (opts) => window.confetti({ ...base, ...opts });
    
              if (type === 'coupon')       burst({ particleCount: 40, spread: 75, scalar: 0.9 });
              else if (type === 'success') burst({ particleCount: 25, spread: 45, scalar: 0.8 });
              else {
                burst({ particleCount: 80, angle:  60, origin: { x: 0, y: 0.6 } });
                burst({ particleCount: 80, angle: 120, origin: { x: 1, y: 0.6 } });
                burst({ particleCount: 60, spread: 100, scalar: 1.1 });
              }
            }
          };
        });
      };
    

      if (window.Alpine) register();
      window.addEventListener('alpine:init', register);
    })();
    function scrollFades() {
      return {
        showLeft: false,
        showRight: false,
        update() {
          const el = this.$refs.scroller;
          if (!el) return;
          const { scrollLeft, scrollWidth, clientWidth } = el;
          this.showLeft  = scrollLeft > 4;
          this.showRight = scrollLeft + clientWidth < scrollWidth - 4;
        },
        init() {
          // initialize and listen
          this.$nextTick(() => {
            this.update();
            const el = this.$refs.scroller;
            el?.addEventListener('scroll', () => this.update(), { passive: true });
            const ro = new ResizeObserver(() => this.update());
            el && ro.observe(el);
            window.addEventListener('orientationchange', () => this.update(), { passive: true });
          });
        },
      };
    }

    // Billboard carousel
    // HOME BILLBOARD CAROUSEL (Alpine component)
    function homeCarousel() {
  const AUTOPLAY_MS = 6000;
  const DRAG_THRESHOLD_PX = 50;
  const CLICK_TAP_MAX_MS = 220;
  const CLICK_MOVE_MAX_PX = 8;
  const RESISTANCE_K = 0.0025;
  const INTENT_THRESHOLD_PX = 8;   // how far before we decide direction
  const H_BIAS = 1.2;              // horizontal must be ~20% stronger than vertical

  return {
    index: 0,
    slides: [],
    templates: {},     // { [id]: { id, classes:{...}, styles:{...}, anim:{...} } }
    timer: null,
    trackEl: null,
    viewportEl: null,
    width: 0,

    // drag / click guard
    pointerDown: false,
    dragging: false,
    lock: null,        // null | 'h' | 'v'
    startX: 0,
    startY: 0,         // ✅ added
    currX: 0,
    currY: 0,          // ✅ added
    lastDX: 0,
    pressT: 0,
    pressX: 0,

    // animation restart nonce (changes when active slide changes)
    animNonce: 0,

    count() { return this.slides.length; },
    isActive(i) { return this.index === i; },

    go(i) {
      if (!this.count()) return;
      const n = this.count();
      const nextIndex = ((i % n) + n) % n;
      if (nextIndex !== this.index) {
        this.index = nextIndex;
        this.bumpAnimNonce();  // replay entry animations on newly active slide
      }
      this.resetAutoplay();
    },
    next() { this.go(this.index + 1); },
    prev() { this.go(this.index - 1); },

    startAutoplay() { this.stopAutoplay(); this.timer = setInterval(()=>this.next(), AUTOPLAY_MS); },
    stopAutoplay()  { if (this.timer) clearInterval(this.timer); this.timer = null; },
    resetAutoplay() { this.stopAutoplay(); this.startAutoplay(); },

    modalId(slide) { return `banner-legal-${slide.id ?? this.slides.indexOf(slide)}`; },
    openModal(slide) { document.getElementById(this.modalId(slide))?.showModal?.(); },

    // ---- TEMPLATE HANDLING ----
    normalizeTemplate(raw) {
      const id = String(raw?.id ?? '');
      if (!id) return null;
      const pick = (obj, paths) => {
        for (const p of paths) {
          const v = p.split('.').reduce((o, k) => (o && o[k] != null) ? o[k] : undefined, obj);
          if (typeof v === 'string' && v.trim()) return v.trim();
        }
        return '';
      };
      const layer = (n) => ({
        cls:  pick(raw, [`layer_${n}.image`, `layer${n}.image`]),
        anim: pick(raw, [`layer_${n}.entry_animation`, `layer${n}.entry_animation`]),
      });
      const L = {}; for (let n=1;n<=6;n++) L[`layer_${n}`] = layer(n);

      return {
        id,
        classes: {
          wrapper:    pick(raw, ['wrapper','container']),
          background: pick(raw, ['background']),
          title:      pick(raw, ['title']),
          text:       pick(raw, ['text.long','text.short','text']),
          cta:        pick(raw, ['cta.button','cta','button']),
          legal_link: pick(raw, ['legal.button','legal_link']),
          layer_1: L.layer_1.cls, layer_2: L.layer_2.cls, layer_3: L.layer_3.cls,
          layer_4: L.layer_4.cls, layer_5: L.layer_5.cls, layer_6: L.layer_6.cls,
        },
        styles: { background_color: pick(raw, ['background_color']) },
        anim: {
          layer_1: L.layer_1.anim, layer_2: L.layer_2.anim, layer_3: L.layer_3.anim,
          layer_4: L.layer_4.anim, layer_5: L.layer_5.anim, layer_6: L.layer_6.anim,
        }
      };
    },

    // Class / style / animation lookups
    cls(slide, key) {
      const sVal = slide?.classes?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim();
      const tid = String(slide?.banner_template_id ?? '');
      const t = this.templates[tid];
      const c = t?.classes?.[key];
      return (typeof c === 'string' && c.trim()) ? c.trim() : '';
    },
    tcls(slide, key) { return this.cls(slide, key); }, // legacy alias

    style(slide, key) {
      const sVal = slide?.styles?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim();
      const tid = String(slide?.banner_template_id ?? '');
      const t = this.templates[tid];
      const v = t?.styles?.[key];
      return (typeof v === 'string' && v.trim()) ? v.trim() : '';
    },

    // copy helper (handles text.long / text.short)
    txt(slide) {
      const t = slide?.text;
      if (typeof t === 'string') return t;
      if (t && typeof t === 'object') return t.long || t.short || '';
      return slide?.subtitle || '';
    },
    // CTA helpers (from slide data)
    ctaHref(slide)  { return slide?.cta?.link   || slide?.href || '#/products'; },
    ctaLabel(slide) { return slide?.cta?.label  || slide?.cta?.button || 'Nakoupit'; },
    ctaIcon(slide)  { return slide?.cta?.icon   || 'fa-solid fa-arrow-right'; },

    // animation class only for active slide; animNonce forces replay
    anim(slide, key, i) {
      if (!this.isActive(i)) return '';
      const sVal = slide?.animations?.[key];
      if (typeof sVal === 'string' && sVal.trim()) return sVal.trim() + ` anim-${this.animNonce}`;
      const tid = String(slide?.banner_template_id ?? '');
      const t   = this.templates[tid];
      const v   = t?.anim?.[key];
      return (typeof v === 'string' && v.trim()) ? v.trim() + ` anim-${this.animNonce}` : '';
    },
    bumpAnimNonce() { this.animNonce = (this.animNonce + 1) % 1e9; },

    // ---- RENDER / INTERACTION ----
    trackStyle() {
      const baseX = -(this.index * this.width);
      let dragOffset = 0;
      if (this.dragging) {
        const dx = this.currX - this.startX;
        dragOffset = dx * (1 - Math.min(Math.abs(dx) * RESISTANCE_K, 0.35));
      }
      const x = baseX + dragOffset;
      return `transform: translate3d(${x}px,0,0); transition: ${this.dragging ? 'none' : 'transform 500ms ease'};`;
    },

    measure() {
      if (!this.viewportEl) return;
      this.width = this.viewportEl.clientWidth;
    },

    // Tap vs drag guard (single definition)
    onSlideClick(e) {
      const dt = performance.now() - this.pressT;
      const moved = Math.abs(this.currX - this.pressX);
      const isTap = dt <= CLICK_TAP_MAX_MS && moved <= CLICK_MOVE_MAX_PX && !this.dragging && this.lock !== 'h';
      if (!isTap) { e.preventDefault(); e.stopPropagation(); this.resetAutoplay(); }
    },

    onPointerDown(e) {
    // don't preventDefault yet
    this.pointerDown = true;            // 👈 NEW
    this.measure();
    this.lock = null;
    this.dragging = false;

    const x = (e.touches?.[0]?.clientX) ?? e.clientX ?? 0;
    const y = (e.touches?.[0]?.clientY) ?? e.clientY ?? 0;
    this.startX = this.currX = x;
    this.startY = this.currY = y;
    this.lastDX = 0;

    this.pressT = performance.now();
    this.pressX = x;
  },

  onPointerMove(e) {
    // ❗ Ignore all desktop mousemoves unless a button is held
    if (!this.pointerDown) return;                     // 👈 NEW (fixes “follows cursor”)
    if (!e.touches && e.buttons === 0) return;         // 👈 extra guard for stray moves

    const x = (e.touches?.[0]?.clientX) ?? e.clientX ?? 0;
    const y = (e.touches?.[0]?.clientY) ?? e.clientY ?? 0;
    this.currX = x; this.currY = y;

    const dx = this.currX - this.startX;
    const dy = this.currY - this.startY;
    const adx = Math.abs(dx), ady = Math.abs(dy);

    if (this.lock === null) {
      if (adx < INTENT_THRESHOLD_PX && ady < INTENT_THRESHOLD_PX) return;

      if (adx > ady * H_BIAS) {
        this.lock = 'h';
        this.dragging = true;
        this.stopAutoplay();
        e.preventDefault?.();
      } else {
        this.lock = 'v';
        this.dragging = false;
        return;
      }
    }

    if (this.lock === 'v') return;

    this.lastDX = dx;
    e.preventDefault?.();
  },

  onPointerUp() {
    // clear pointer state first
    this.pointerDown = false;        // 👈 NEW
    if (this.lock !== 'h') { this.lock = null; return; }

    const moved = this.lastDX;
    this.dragging = false;
    this.lock = null;

    if (Math.abs(moved) > DRAG_THRESHOLD_PX) (moved < 0) ? this.next() : this.prev();
    else this.go(this.index);
    this.resetAutoplay();
  },

    onKeydown(e) { if (e.key === 'ArrowLeft') this.prev(); if (e.key === 'ArrowRight') this.next(); },

    async loadData() {
      const [slides, tpls] = await Promise.all([
        fetch('data/slides.json').then(r => r.json()).catch(() => []),
        fetch('data/banner_templates.json').then(r => r.json()).catch(() => []),
      ]);

      const map = {};
      (Array.isArray(tpls) ? tpls : []).forEach(t => {
        const norm = this.normalizeTemplate(t);
        if (norm) map[norm.id] = norm;
      });
      this.templates = map;

      this.slides = (Array.isArray(slides) ? slides : []).map(s => ({
        ...s,
        banner_template_id: s.banner_template_id != null ? String(s.banner_template_id) : '',
        classes: (s.classes && typeof s.classes === 'object') ? s.classes : null,
        styles:  (s.styles  && typeof s.styles  === 'object') ? s.styles  : null,
        animations: (s.animations && typeof s.animations === 'object') ? s.animations : null,
      }));
    },

    async init() {
      this.trackEl = this.$refs.track;
      this.viewportEl = this.$refs.viewport;

      await this.loadData();
      this.startAutoplay();

      // Hover pause (desktop)
      this.$root.addEventListener('mouseenter', () => this.stopAutoplay(), { passive: true });
      this.$root.addEventListener('mouseleave', () => this.startAutoplay(), { passive: true });

      // Mouse / touch
      this.$root.addEventListener('mousedown', (e)=>this.onPointerDown(e));
      window.addEventListener('mousemove', (e)=>this.onPointerMove(e));
      window.addEventListener('mouseup', ()=>this.onPointerUp());

      // Important: touch listeners must be non-passive for move so we can preventDefault after lock
      this.$root.addEventListener('touchstart', (e)=>this.onPointerDown(e), { passive: true });
      this.$root.addEventListener('touchmove',  (e)=>this.onPointerMove(e),  { passive: false });
      this.$root.addEventListener('touchend',   ()=>this.onPointerUp(),      { passive: true  });
      this.$root.addEventListener('touchcancel',()=>this.onPointerUp(),      { passive: true  });

      // Keyboard
      this.$root.addEventListener('keydown', (e)=>this.onKeydown(e));

      // Sizing
      const ro = new ResizeObserver(()=>this.measure());
      ro.observe(this.$root);
      ro.observe(this.viewportEl);
      this.measure();

      window.__homeCarousel = this;
    },
  };
}

    </script>

<!-- TOAST OUTLET -->
<div x-data x-cloak class="fixed inset-0 z-50 pointer-events-none">
  <div
    class="toast toast-end toast-bottom gap-2 p-4"
    style="padding-bottom: calc(env(safe-area-inset-bottom, 0) + 1rem);"
  >
    <template x-for="t in $store.toast.items" :key="t.id">
      <div
        x-show="t.show"
        x-transition:enter="transform ease-out duration-300"
        x-transition:enter-start="translate-y-4 opacity-0"
        x-transition:enter-end="translate-y-0 opacity-100"
        x-transition:leave="transform ease-in duration-300"
        x-transition:leave-start="translate-y-0 opacity-100"
        x-transition:leave-end="translate-y-4 opacity-0"
        class="alert pointer-events-auto cursor-pointer min-w-[240px] max-w-[92vw] sm:max-w-sm shadow"
        :class="{
          'alert-success': t.type === 'success',
          'alert-warning': t.type === 'warning',
          'alert-error'  : t.type === 'error',
          'alert-info'   : !t.type || t.type === 'info'
        }"
        :role="t.type === 'error' ? 'alert' : 'status'"
        aria-live="polite"
        @click="$store.toast.hide(t.id)"
        @mouseenter="clearTimeout(t._lifeTimer)"
        @mouseleave="t._lifeTimer = setTimeout(() => $store.toast.hide(t.id), 1200)"
      >
        <!-- Icon per type -->
        <template x-if="t.type === 'success'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </template>
        <template x-if="t.type === 'warning'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          </svg>
        </template>
        <template x-if="t.type === 'error'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07"/>
          </svg>
        </template>
        <template x-if="!t.type || t.type === 'info'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
          </svg>
        </template>

        <span class="pr-6" x-text="t.text"></span>

        <!-- Close (optional; still clickable anywhere) -->
        <button
          class="btn btn-xs btn-ghost absolute right-2 top-2"
          type="button"
          aria-label="Zavřít"
          @click.stop="$store.toast.hide(t.id)"
        >✕</button>
      </div>
    </template>
  </div>

<!-- MENU PORTAL (place near end of <body>) -->
  <div x-data x-cloak class="fixed inset-0 z-[11000] pointer-events-none">

    <!-- BACKDROP -->
    <div
      x-show="$store.menu.open"
      x-transition.opacity.duration.150ms
      class="absolute inset-0 bg-black/50 pointer-events-auto"
      @click="$store.menu.close()"
      @keydown.escape.window="$store.menu.close()"
      aria-hidden="true">
    </div>
  
    <!-- PANEL -->
    <aside
      class="absolute inset-y-0 left-0 w-[100dvw] max-w-full lg:max-w-md bg-base-100 shadow-2xl
             transform transition-transform duration-200 ease-out
             -translate-x-full pointer-events-auto flex flex-col"
      :class="{ 'translate-x-0': $store.menu.open }"
      role="dialog"
      aria-modal="true"
      aria-label="Menu"
    >
      <!-- Top bar -->
      <div class="sticky top-0 z-10 bg-base-100 border-b border-base-200 h-18 px-3">
        <div class="h-full flex items-center gap-2">
          <!-- Left: Back OR Account -->
          <div class="shrink-0">
            <template x-if="$store.menu.canGoBack()">
              <button class="btn btn-ghost btn-sm" @click.stop="$store.menu.back()" aria-label="Zpět">
                <i class="fa-solid fa-chevron-left fa-xl"></i>
              </button>
            </template>
            <template x-if="!$store.menu.canGoBack()">
              <button class="btn btn-ghost btn-sm" @click.stop="$store.menu.goToMenu(9)" aria-label="Můj účet">
                <i class="fa-regular fa-user-circle fa-xl"></i>
              </button>
            </template>
          </div>
  
          <div class="flex-1"></div>
  
          <!-- Right: Close -->
          <button class="btn btn-ghost btn-sm shrink-0" @click.stop="$store.menu.close()" aria-label="Zavřít">
            <i class="fa-solid fa-xmark fa-xl"></i>
          </button>
        </div>
  
        <div class="absolute inset-x-14 top-1/2 -translate-y-1/2 text-center font-semibold">
          <span class="block truncate" x-text="$store.menu.current?.name || 'Menu'"></span>
        </div>
      </div>
  
      <!-- Content (slides on menu change) -->
      <div
        class="flex-1 min-h-0 overflow-y-auto p-2"
        :class="$store.menu.slideDir === 1 ? 'slide-in-right' : 'slide-in-left'"
        :key="$store.menu.viewKey"
      >
        <!-- Loading / Error -->
        <template x-if="$store.menu.loading">
          <div class="p-4 space-y-2">
            <div class="skeleton h-6 w-48"></div>
            <div class="skeleton h-4 w-64"></div>
            <div class="skeleton h-4 w-56"></div>
          </div>
        </template>
  
        <template x-if="$store.menu.error">
          <div class="alert alert-error m-2" x-text="$store.menu.error"></div>
        </template>
  
        <!-- Current menu -->
        <template x-if="$store.menu.current && !$store.menu.loading && !$store.menu.error">
          <div>
            <!-- root items (optional) -->
            <div class="divide-y divide-base-200">
              <template x-for="(it, i) in ($store.menu.current.items || [])" :key="'root-'+i">
                <button
                  class="w-full text-left py-3 px-3 flex items-center gap-3 hover:bg-base-200/60 rounded-lg transition cursor-pointer"
                  @click.stop="$store.menu.onItemClick(it)"
                >
                  <!-- left icon (only if present) -->
                  <template x-if="it.icon || it.iconSet">
                    <i :class="[
                          it.iconSet === 'custom' && it.icon === 'check' ? 'fa-solid fa-circle-check' :
                          it.iconSet === 'custom' && it.icon === 'empty' ? 'fa-regular fa-circle' :
                          (it.iconSet || 'fa-regular') + ' fa-' + (it.icon || ''),
                          it.rowType === 'bold' ? 'text-error' : 'text-base-content/70'
                        ]"></i>
                  </template>
  
                  <div class="flex-1">
                    <div :class="it.rowType === 'bold' ? 'text-error font-semibold' : 'font-medium'">
                      <span x-text="it.name"></span>
                    </div>
                    <div x-show="it.description" class="text-xs opacity-70 mt-0.5" x-text="it.description"></div>
                  </div>
  
                  <i x-show="it.linkMenuId" class="fa-solid fa-chevron-right text-base-content/40 self-center"></i>
                </button>
              </template>
            </div>
  
            <!-- sections -->
            <div class="mt-2 space-y-3 mb-12">
              <template x-for="(sec, si) in ($store.menu.current.sections || [])" :key="'sec-'+si">
                <section>
                  <h3 class="px-3 pt-3 pb-2 text-xs font-semibold tracking-wide uppercase text-base-content/50" x-text="sec.name"></h3>
  
                  <!-- special: loyalty card -->
                  <template x-if="sec.type === 'loyalty'">
                    <div class="px-3 pb-2">
                      <div class="rounded-xl border border-base-300 p-3 bg-gradient-to-br from-base-100 to-base-200">
                        <div class="flex items-center justify-between">
                          <img src="./images/logoDrmax.svg" alt="Dr. Max" class="h-6">
                          <span class="text-xs font-semibold text-success">Celková úspora: 123 Kč</span>
                        </div>
                        <div class="mt-3 text-center">
                          <div class="font-mono text-lg tracking-widest">1234 5678 9012</div>
                          <div class="mt-2 bg-white h-14 rounded-sm flex items-center justify-center">
                            <img src="./images/barcode.png" alt="Čárový kód" class="h-16 w-auto">
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
  
                  <!-- special: language list (radio-like) -->
                  <template x-if="sec.type === 'language'">
                    <div class="divide-y divide-base-200 bg-base-100 rounded-lg mx-2">
                      <template x-for="(it, i) in (sec.items || [])" :key="'lang-'+i">
                        <button class="w-full text-left py-3 px-3 flex items-center gap-3 hover:bg-base-200/60 transition">
                          <i :class="it.icon === 'check' ? 'fa-solid fa-circle-check text-success' : 'fa-regular fa-circle text-base-content/40'"></i>
                          <span class="font-medium" x-text="it.name"></span>
                        </button>
                      </template>
                    </div>
                  </template>
  
                  <!-- default: list -->
                  <template x-if="!sec.type || sec.type === 'list'">
                    <div class="divide-y divide-base-200 bg-base-100 rounded-lg mx-2">
                      <template x-for="(it, i) in (sec.items || [])" :key="'item-'+i">
                        <button
                          class="w-full text-left py-4 px-3 flex items-center gap-3 hover:bg-max-gray-50 border-0 transition cursor-pointer"
                          @click.stop="$store.menu.onItemClick(it)"
                        >
                          <template x-if="it.icon || it.iconSet">
                            <i :class="[
                                  it.iconSet === 'custom' && it.icon === 'check' ? 'fa-solid fa-circle-check fa-xl ' :
                                  it.iconSet === 'custom' && it.icon === 'empty' ? 'fa-regular fa-circle fa-xl ' :
                                  (it.iconSet || 'fa-regular') + ' fa-xl fa-' + (it.icon || ''),
                                  it.rowType === 'bold' ? 'text-error' : 'fa-light text-max-green-500 fa-xl'
                                ]"></i>
                          </template>
  
                          <div class="flex-1">
                            <div :class="it.rowType === 'bold' ? 'text-error font-semibold' : 'font-normal'">
                              <span x-text="it.name"></span>
                            </div>
                            <div x-show="it.description" class="text-xs opacity-70 mt-0.5" x-text="it.description"></div>
                          </div>
  
                          <i x-show="it.linkMenuId" class="fa-regular fa-chevron-right text-base-content/40 self-center"></i>
                        </button>
                      </template>
                    </div>
                  </template>
                </section>
              </template>
            </div>
          </div>
        </template>
      </div>
    </aside>
  </div>
<!-- MOBILE SEARCH OVERLAY -->
<template x-teleport="body">
  <div
    data-mobile-search-overlay
    x-data="mobileSearchOverlayShell()"
    x-show="isOpen"
    x-transition.opacity
    class="fixed inset-0 z-[12050] pointer-events-auto" 
    role="dialog" aria-modal="true"

    @open-mobile-search.window="openOverlay()"
    @mobile-search-close.window="closeOverlay($event?.detail || { reason:'ui' })"

    @pointerdown.stop
    @click.stop
  >
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/40 z-[12050]" @click="closeOverlay()"></div>

    <!-- Panel -->
    <section
      class="absolute inset-x-0 top-0 bg-base-100 z-[12051] flex flex-col"
      :style="panelStyle"
      @click.stop
      @keydown.escape.stop.prevent="closeOverlay()"
    >
      <!-- Reuse your existing searchBox -->
      <div
        x-data="searchBox({
          getProducts:   () => products,
          getCategories: () => navCategories,
          getLinks:      () => infoLinks,
          goTo:          (id) => go(`product/${id}`)
        })"
        x-init="open = true"
        class="flex flex-col h-full pt-4"
      >
        <!-- Top bar -->
        <div class="flex items-center gap-2 p-3 pb-2 sticky top-0 bg-base-100 z-[12052]" style="padding-top: env(safe-area-inset-top)">
          <button
          type="button"
          class="btn btn-ghost btn-square"
          @click.stop="$dispatch('mobile-search-close', { reason:'ui' })"
          aria-label="Zavřít vyhledávání">
            <i class="fa-regular fa-arrow-left"></i>
          </button>

          <!-- type=text to avoid native clear '×' -->
          <label
            class="relative input input-lg pl-4 pr-10 input-bordered rounded-full items-center gap-2 w-full max-input-gradient"
            @pointerdown.capture.stop
          >
            <i class="fa-classic fa-regular fa-search"></i>
            <input
            data-mobile-search-input
            x-ref="input"
            type="text"
            inputmode="search"
            enterkeyhint="search"
            autocapitalize="none"
            autocorrect="off"
            class="grow min-w-0 bg-transparent outline-none"
            placeholder="Hledej dle názvu"
            x-model.debounce.150ms="q"
            @input="onInput()"
            @keydown="(e) => { onKeydown(e); if(e.key==='Enter'){ $dispatch('mobile-search-close', { reason:'navigate' }) } }"
            role="combobox"
            aria-autocomplete="list"
            :aria-expanded="true"
            :aria-controls="listId"
            :aria-activedescendant="activeDesc()"
          />
            <span
            role="button"
            tabindex="0"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1"
            x-show="q.length"
            @mousedown.prevent.stop="q=''; onInput(); $nextTick(()=> $refs.input.focus())"
            aria-label="Smazat dotaz">
            <i class="fa-regular fa-xmark"></i>
          </span>
          </label>
        </div>

        <!-- Results (same as you have, with safe keys and pointerdown) -->
        <div class="flex-1 overflow-y-auto overscroll-contain" style="padding-bottom: env(safe-area-inset-bottom)">
          <template x-if="q.trim().length < minChars">
            <ul class="p-3 pb-8 w-full flex flex-col space-y-3" :id="listId" role="listbox">
              <li class="px-2 py-1 text-xs font-semibold text-base-content/60">Naposledy hledané</li>
              <template x-if="!recentItems().length">
                <li class="w-full px-2 py-3 text-sm text-base-content/60">Začněte psát váš dotaz…</li>
              </template>
              <template x-for="(item, i) in recentItems()" :key="`${item.t}-${item.k ?? i}`">
                <li :id="itemId(i)" role="option" @mouseenter="highlighted = i">
                  <a href="#"
                  @click.prevent.stop="onSelect(item); $dispatch('mobile-search-close', { reason:'navigate' })"
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                    <!-- thumbs/icons same as your code -->
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-10 h-10 object-contain rounded bg-base-200/40" />
                    </template>
                    <template x-if="!item.img">
                      <span class="w-10 h-10 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
                  </a>
                </li>
              </template>
            </ul>
          </template>

          <template x-if="q.trim().length >= minChars">
            <ul class="p-3 pb-8 w-full flex flex-col space-y-3" :id="listId" role="listbox">
              <template x-if="!suggestions().length">
                <li class="w-full px-2 py-6 font-medium text-base text-center text-max-gray-400">Žádné výsledky</li>
              </template>

              <template x-for="(item, i) in suggestions()" :key="`${item.t}-${item.k ?? i}`">
                <li :id="itemId(i)" role="option" @mouseenter="highlighted = i">
                  <a href="#"
                  @click.prevent.stop="onSelect(item); $dispatch('mobile-search-close', { reason:'navigate' })"
                  class="flex w-full items-center gap-3 min-h-12 px-2 rounded-lg"
                  :class="i===highlighted ? 'bg-base-200' : 'hover:bg-base-200'">
                    <template x-if="item.img">
                      <img :src="item.img" alt="" class="w-10 h-10 object-contain rounded bg-base-200/40" />
                    </template>
                    <template x-if="!item.img">
                      <span class="w-10 h-10 rounded-full bg-base-200 grid place-items-center">
                        <i :class="item.icon || 'fa-regular fa-circle-info'"></i>
                      </span>
                    </template>
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-base truncate" x-text="item.name"></div>
                      <div class="text-sm font-medium text-base-content/60 truncate" x-text="item.sub"></div>
                    </div>
                    <span class="badge badge-ghost badge-sm shrink-0"
                          x-text="item.t === 'product' ? 'Produkt' : (item.t==='category' ? 'Kategorie' : 'Info')"></span>
                  </a>
                </li>
              </template>

              <li class="pt-4">
                <button class="btn btn-block btn-outline"
                        @pointerdown.prevent.stop="$dispatch('mobile-search-close', { reason:'navigate' }); $dispatch('see-all', { q })">
                  Zobrazit všechny výsledky
                </button>
              </li>
            </ul>
          </template>
        </div>
      </div>
    </section>
  </div>
</template>

<!-- PRE-BASKET MODAL -->
<dialog
  id="precart_modal"
  x-data="precartModal()"
  x-ref="dlg"
  x-effect="
    const s = $store.precart;
    if (s && s.isOpen) { $refs.dlg.open || $refs.dlg.showModal(); }
    else { $refs.dlg.open && $refs.dlg.close(); }
  "
  @click.self="close()"
  @keydown.escape.window="close()"
  class="modal"
>
  <div class="modal-box w-11/12 max-w-3xl bg-base-200 lg:px-8 lg:py-10">

    <!-- Header / confirmation -->
    <h2 class="text-2xl font-medium text-max-green-500 mb-2">
      <i class="fa-classic fa-md fa-solid fa-check-circle"></i> Přidáno do košíku
    </h2>

    <!-- Context product -->

    
    <template x-if="$store.precart.product">
      <div x-transition.opacity.duration.200ms class="py-4 w-auto mx-auto items-stretch">
        <article class="h-full" x-data="{ product: $store.precart.product }">
        <div class="card card-side h-full relative px-2 items-center bg-base-100">
          <!-- BADGES -->
          <div x-show="product.badges?.length" class="absolute left-2 top-2 z-10 flex flex-col gap-1">
            <template x-for="(b,i) in (product?.badges || [])" :key="i">
              <span class="badge badge-error badge-sm font-semibold" x-text="b"></span>
            </template>
          </div>

          <!-- IMAGE (clickable) -->
          <figure class="w-36 flex items-center justify-center overflow-hidden">
            <a :href="link('product', { id: product.id })"
               @click="close()"
               class="block w-full h-full">
              <img :src="product.image" class="object-contain max-h-full w-full h-full" :alt="product.name" />
            </a>
          </figure>

          <!-- BODY -->
          <div class="card-body min-w-0 flex flex-col">
            <h3 class="text-xl font-medium">
              <a :href="link('product', { id: product.id })"
                 @click="close()"
                 class="hover:underline focus:outline-none focus:ring-2 focus:ring-primary/50"
                 x-text="product.name"></a>
            </h3>

            <div class="card-actions mt-0 justify-between items-center">

              <!-- PRICE with LEGAL TOOLTIP -->
              <div
                class="tooltip cursor-help"
                x-init="$store.legal.init()"
                x-data="{
                  get paras(){
                    const hasDisc = !!(product.discounted_price && product.discounted_price < product.price);
                    const original = hasDisc ? product.price : product.price; // original comes from product.price in your list
                    const discounted = hasDisc ? product.discounted_price : null;
                    return $store.legal.paragraphsFor({ price: original, discounted_price: discounted });
                  }
                }"
              >
                <div class="tooltip-content lg:p-3">
                  <template x-for="(p, idx) in paras" :key="idx">
                    <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                  </template>
                </div>

                <div class="flex flex-col leading-tight">
                  <span
                    x-show="product.discounted_price && product.discounted_price < product.price"
                    class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                    x-text="koruny(product.discounted_price)"
                  ></span>
                  <span
                    x-show="product.discounted_price && product.discounted_price < product.price"
                    class="text-sm line-through text-base-content/60 -mt-0.5"
                    x-text="koruny(product.price)"
                  ></span>
                  <span
                    x-show="!product.discounted_price || !(product.discounted_price < product.price)"
                    class="font-medium text-lg underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                    x-text="koruny(product.price)"
                  ></span>
                </div>
              </div>

              <!-- CTA or STEPPER -->
              <template x-if="!$store.cart.inCart(product.id)">
                <button class="btn btn-primary btn-md font-semibold" @click="$store.cart.add(product)">
                  Do košíku
                </button>
              </template>
              <template x-if="$store.cart.inCart(product.id)">
                <div class="join">
                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.decrement(product.id)"
                          aria-label="Odebrat kus">−</button>

                  <input type="text" inputmode="numeric" pattern="[0-9]*"
                         class="input input-bordered input-md w-10 text-center join-item"
                         :value="$store.cart.qty(product.id)"
                         @input="$store.cart.setQty(product.id, $event.target.value.replace(/[^0-9]/g,''))"
                         @keydown.enter.prevent
                         aria-label="Počet kusů" />

                  <button class="btn btn-square btn-md join-item"
                          @click="$store.cart.increment(product.id)"
                          aria-label="Přidat kus">+</button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </article>
    </div>
  </template>

    <!-- Upsell -->
    <h4 class="text-sm font-medium my-4">Ostatní k tomuto produktu kupují</h4>

    <div class="grid grid-cols-1 gap-2 max-h-80 overflow-auto">
      <ul
        class="max-h-80 overflow-y-auto w-full flex flex-col space-y-1"
        :id="listId"
        role="listbox"
        x-data="{ highlighted: -1, get items(){ return ($store.precart?.recommend?.(8) || []); } }"     
      >
        <template x-for="(item, i) in items" :key="item.id">
          <li
            :id="itemId(i)"
            class="w-full rounded-xl bg-white px-2 py-4"
            role="option"
            @mouseenter="highlighted = i"
            :class="i===highlighted ? 'bg-white' : 'hover:bg-base-200'"
          >
            <a :href="link('product', { id: item.id })"
               @click.prevent="goDetail(item)"
               class="flex w-full items-center gap-3 min-h-12">
              <img :src="item.image" alt="" class="w-14 h-14 object-contain rounded" />

              <div class="min-w-0 flex-1">
                <div class="text-base font-medium truncate" x-text="item.name"></div>
                <div class="text-sm font-medium text-base-content/60 truncate max-w-5/6" x-text="item.description"></div>
                <div class="text-xs font-medium text-base-content/60">Sponzorováno</div>
              </div>

              <!-- price block (desktop only) -->
              <div class="hidden md:flex flex-col leading-tight">
                <span
                  x-show="item.discounted_price && item.discounted_price < item.price"
                  class="font-bold text-lg text-error underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                  x-text="koruny(item.discounted_price)"
                ></span>
                <span
                  x-show="item.discounted_price && item.discounted_price < item.price"
                  class="text-sm line-through text-base-content/60 -mt-0.5"
                  x-text="koruny(item.price)"
                ></span>

                <!-- LEGAL TOOLTIP (desktop) -->
                <div
                  class="tooltip tooltip-left cursor-help"
                  x-init="$store.legal.init()"
                  x-data="{
                    get paras(){
                      const hasDisc = !!(item.discounted_price && item.discounted_price < item.price);
                      const original = item.price;
                      const discounted = hasDisc ? item.discounted_price : null;
                      return $store.legal.paragraphsFor({ price: original, discounted_price: discounted });
                    }
                  }"
                >
                  <div class="tooltip-content lg:p-3">
                    <template x-for="(p, idx) in paras" :key="idx">
                      <p :class="idx > 0 ? 'mt-1 border-t-1 border-base-300/20 pt-1' : ''" x-text="p"></p>
                    </template>
                  </div>
                  <span
                    x-show="!item.discounted_price || !(item.discounted_price < item.price)"
                    class="font-medium text-base underline decoration-dotted underline-offset-4 decoration-max-gray-400"
                    x-text="koruny(item.price)"
                  ></span>
                </div>
              </div>

              <!-- Quick add -->
              <button
                class="hidden md:block btn btn-sm shrink-0 w-16"
                :class="$store.precart.isQuickAdded(item.id) ? 'btn-ghost btn-disabled text-max-green-500' : ''"
                @click.stop="quickAdd(item)"
                x-text="$store.precart.isQuickAdded(item.id) ? 'Přidáno' : 'Přidat'">
              </button>
            </a>
          </li>
        </template>

      </ul>
    </div>

    <!-- Footer / free shipping + actions -->
    <div class="modal-action grid-cols-2 items-center">
      <!-- Free shipping bar -->
      <div class="py-4 free-ship-bar select-none w-3/6 mr-auto">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Doprava zdarma</span>

          <span class="hidden md:block text-sm text-base-content/70" x-show="$store.cart.totalToPay() < $store.cart.freeShipThreshold">
            Ještě <strong x-text="koruny($store.cart.freeShipMissing())"></strong>
          </span>

          <span class="text-sm text-success" x-show="$store.cart.totalToPay() >= $store.cart.freeShipThreshold">
            <i class="fa-classic fa-sm fa-solid fa-check"></i>
          </span>
        </div>

        <!-- Track -->
        <div class="relative h-3 rounded-full bg-base-300 overflow-hidden"
             role="progressbar"
             :aria-valuemin="0" :aria-valuemax="100"
             :aria-valuenow="$store.cart.freeShipProgress()">

          <!-- Fill -->
          <div class="fill h-full rounded-full transition-[width] duration-500"
               :class="{
                 'bg-success' : $store.cart.hasFreeShipping(),
                 'bg-primary/80 shimmer' : !$store.cart.hasFreeShipping()
               }"
               :style="`width: ${$store.cart.freeShipProgress()}%`">
          </div>
        </div>
      </div>

      <!-- Close / go to cart -->
      <form method="dialog">
        <button class="btn btn-md btn-circle btn-ghost absolute right-2 top-2"
                @click.prevent="close()"
                aria-label="Zavřít">
          <i class="fa-solid fa-xmark fa-lg text-max-gray-500" aria-hidden="true"></i>
        </button>

        <button class="btn btn-primary" @click.prevent="goCart()">
          Přejít do košíku
        </button>
      </form>
    </div>
  </div>
</dialog>

  
<script>
function precartModal() {
  const randId = Math.random().toString(36).slice(2, 9);
  return {
    // accessibility helpers
    listId: 'precart-list-' + randId,
    itemId(i) { return `precart-item-${randId}-${i}`; },

    // price formatter; fallback if global isn't present
    koruny(v) {
      if (window.koruny) return window.koruny(v);
      try { return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(v); }
      catch { return `${v} Kč`; }
    },

    // link builder; use your existing global link() if available
    link(name, params) {
      if (typeof window.link === 'function') return window.link(name, params);
      // fallback hash routes
      if (name === 'product') return `#/product/${params?.id ?? ''}`;
      if (name === 'cart') return '#/cart';
      return '#';
    },

    // actions
    close() { Alpine.store('precart').close(); },
    goCart() {
      this.close();
      window.location.href = this.link('cart');
    },
    goDetail(item) {
      this.close();
      window.location.href = this.link('product', { id: item.id });
    },
    quickAdd(item) {
      Alpine.store('cart').silentAdd(item);
      Alpine.store('precart').markQuickAdded(item.id);
    },
  };
}
</script>


</body>
</html>
